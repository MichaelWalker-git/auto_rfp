version: 1
applications:
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            # Install pnpm and enable corepack
            - corepack enable
            - corepack prepare pnpm@10.10.0 --activate
            # Install all workspace dependencies from the monorepo root
            # No lockfile flags needed â€” pnpm-lock.yaml is gitignored
            - cd ../..
            - pnpm install
            - cd apps/web
        build:
          commands:
            # Build shared packages first (core types/schemas)
            - cd ../..
            - pnpm --filter @auto-rfp/core build
            - cd apps/web
            # Build the Next.js app (standalone output)
            - pnpm run build
            # Prepare standalone output for Amplify SSR deployment
            - cp -r public .next/standalone/public
            - cp -r .next/static .next/standalone/.next/static
      artifacts:
        # Amplify Hosting SSR (WEB_COMPUTE) expects artifacts in .next
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          # Cache Next.js build cache for faster incremental builds
          - .next/cache/**/*
          # Cache the pnpm content-addressable store (shared across all packages)
          # This avoids re-downloading packages on every build even without a lockfile
          - /root/.local/share/pnpm/store/**/*
