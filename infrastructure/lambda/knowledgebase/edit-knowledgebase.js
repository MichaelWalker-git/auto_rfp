"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.updateKnowledgeBase = updateKnowledgeBase;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const knowledge_base_1 = require("../schemas/knowledge-base");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --- Main Handler ---
const handler = async (event) => {
    const { orgId, kbId } = event.pathParameters || {};
    if (!orgId || !kbId) {
        return (0, api_1.apiResponse)(400, {
            message: 'Missing required path parameters: orgId and kbId',
        });
    }
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Validate body with Zod
        const validationResult = knowledge_base_1.UpdateKnowledgeBaseSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const validatedData = validationResult.data;
        const updatedKb = await updateKnowledgeBase(orgId, kbId, validatedData);
        return (0, api_1.apiResponse)(200, updatedKb);
    }
    catch (err) {
        console.error('Error in updateKnowledgeBase handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- Business Logic Function ---
async function updateKnowledgeBase(orgId, kbId, data) {
    const now = new Date().toISOString();
    const sk = `${orgId}#${kbId}`;
    // Build dynamic UpdateExpression
    let updateExpression = 'SET #updatedAt = :updatedAt';
    const expressionAttributeNames = {
        '#updatedAt': 'updatedAt',
        '#pk': common_1.PK_NAME,
    };
    const expressionAttributeValues = {
        ':updatedAt': now,
    };
    if (typeof data.name === 'string') {
        updateExpression += ', #name = :name';
        expressionAttributeNames['#name'] = 'name';
        expressionAttributeValues[':name'] = data.name;
    }
    if (data.description !== undefined) {
        updateExpression += ', #description = :description';
        expressionAttributeNames['#description'] = 'description';
        expressionAttributeValues[':description'] = data.description;
    }
    const command = new lib_dynamodb_1.UpdateCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: organization_1.KNOWLEDGE_BASE_PK,
            [common_1.SK_NAME]: sk,
        },
        UpdateExpression: updateExpression,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(#pk)', // 404 if not found
        ReturnValues: 'ALL_NEW',
    });
    try {
        const result = await docClient.send(command);
        if (!result.Attributes) {
            throw new Error('Update succeeded but no attributes returned');
        }
        const item = result.Attributes;
        // Map DB item -> API shape
        return {
            id: kbId,
            name: item.name,
            description: item.description,
            createdAt: item.createdAt,
            updatedAt: item.updatedAt,
            _count: item._count ?? { questions: 0 },
        };
    }
    catch (err) {
        if (err?.name === 'ConditionalCheckFailedException') {
            // Not found
            throw new Error('Knowledge base not found');
        }
        throw err;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC1rbm93bGVkZ2ViYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZWRpdC1rbm93bGVkZ2ViYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQTRFQSxrREFxRUM7QUFoSkQsOERBQTBEO0FBQzFELHdEQUErRTtBQUUvRSxnREFBdUQ7QUFDdkQsNERBQThEO0FBQzlELHdDQUE2QztBQUM3Qyw4REFBa0g7QUFFbEgsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtLQUM1QjtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELHVCQUF1QjtBQUNoQixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDO0lBRW5ELElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLGtEQUFrRDtTQUM1RCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7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RUQsTUFBTSxHQUFHLENBQUM7SUFDWixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgVXBkYXRlQ29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBLTk9XTEVER0VfQkFTRV9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9vcmdhbml6YXRpb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBLbm93bGVkZ2VCYXNlSXRlbSwgVXBkYXRlS25vd2xlZGdlQmFzZURUTywgVXBkYXRlS25vd2xlZGdlQmFzZVNjaGVtYSwgfSBmcm9tICcuLi9zY2hlbWFzL2tub3dsZWRnZS1iYXNlJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuLy8gLS0tIE1haW4gSGFuZGxlciAtLS1cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgY29uc3QgeyBvcmdJZCwga2JJZCB9ID0gZXZlbnQucGF0aFBhcmFtZXRlcnMgfHwge307XG5cbiAgaWYgKCFvcmdJZCB8fCAha2JJZCkge1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdNaXNzaW5nIHJlcXVpcmVkIHBhdGggcGFyYW1ldGVyczogb3JnSWQgYW5kIGtiSWQnLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByYXdCb2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcblxuICAgIC8vIDEuIFZhbGlkYXRlIGJvZHkgd2l0aCBab2RcbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gVXBkYXRlS25vd2xlZGdlQmFzZVNjaGVtYS5zYWZlUGFyc2UocmF3Qm9keSk7XG5cbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZXJyb3JEZXRhaWxzID0gdmFsaWRhdGlvblJlc3VsdC5lcnJvci5pc3N1ZXMubWFwKChpc3N1ZTogYW55KSA9PiAoe1xuICAgICAgICBwYXRoOiBpc3N1ZS5wYXRoLmpvaW4oJy4nKSxcbiAgICAgICAgbWVzc2FnZTogaXNzdWUubWVzc2FnZSxcbiAgICAgIH0pKTtcblxuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICBlcnJvcnM6IGVycm9yRGV0YWlscyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkYXRlZERhdGE6IFVwZGF0ZUtub3dsZWRnZUJhc2VEVE8gPSB2YWxpZGF0aW9uUmVzdWx0LmRhdGE7XG5cbiAgICBjb25zdCB1cGRhdGVkS2IgPSBhd2FpdCB1cGRhdGVLbm93bGVkZ2VCYXNlKG9yZ0lkLCBrYklkLCB2YWxpZGF0ZWREYXRhKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHVwZGF0ZWRLYik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHVwZGF0ZUtub3dsZWRnZUJhc2UgaGFuZGxlcjonLCBlcnIpO1xuXG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG4vLyAtLS0gQnVzaW5lc3MgTG9naWMgRnVuY3Rpb24gLS0tXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlS25vd2xlZGdlQmFzZShcbiAgb3JnSWQ6IHN0cmluZyxcbiAga2JJZDogc3RyaW5nLFxuICBkYXRhOiBVcGRhdGVLbm93bGVkZ2VCYXNlRFRPLFxuKSB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgY29uc3Qgc2sgPSBgJHtvcmdJZH0jJHtrYklkfWA7XG5cbiAgLy8gQnVpbGQgZHluYW1pYyBVcGRhdGVFeHByZXNzaW9uXG4gIGxldCB1cGRhdGVFeHByZXNzaW9uID0gJ1NFVCAjdXBkYXRlZEF0ID0gOnVwZGF0ZWRBdCc7XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAnI3VwZGF0ZWRBdCc6ICd1cGRhdGVkQXQnLFxuICAgICcjcGsnOiBQS19OQU1FLFxuICB9O1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICc6dXBkYXRlZEF0Jzogbm93LFxuICB9O1xuXG4gIGlmICh0eXBlb2YgZGF0YS5uYW1lID09PSAnc3RyaW5nJykge1xuICAgIHVwZGF0ZUV4cHJlc3Npb24gKz0gJywgI25hbWUgPSA6bmFtZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzWycjbmFtZSddID0gJ25hbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpuYW1lJ10gPSBkYXRhLm5hbWU7XG4gIH1cblxuICBpZiAoZGF0YS5kZXNjcmlwdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbiArPSAnLCAjZGVzY3JpcHRpb24gPSA6ZGVzY3JpcHRpb24nO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI2Rlc2NyaXB0aW9uJ10gPSAnZGVzY3JpcHRpb24nO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpkZXNjcmlwdGlvbiddID0gZGF0YS5kZXNjcmlwdGlvbjtcbiAgfVxuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgIEtleToge1xuICAgICAgW1BLX05BTUVdOiBLTk9XTEVER0VfQkFTRV9QSyxcbiAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgfSxcbiAgICBVcGRhdGVFeHByZXNzaW9uOiB1cGRhdGVFeHByZXNzaW9uLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogJ2F0dHJpYnV0ZV9leGlzdHMoI3BrKScsIC8vIDQwNCBpZiBub3QgZm91bmRcbiAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJyxcbiAgfSk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIGlmICghcmVzdWx0LkF0dHJpYnV0ZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVXBkYXRlIHN1Y2NlZWRlZCBidXQgbm8gYXR0cmlidXRlcyByZXR1cm5lZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGl0ZW0gPSByZXN1bHQuQXR0cmlidXRlcyBhcyBLbm93bGVkZ2VCYXNlSXRlbTtcblxuICAgIC8vIE1hcCBEQiBpdGVtIC0+IEFQSSBzaGFwZVxuICAgIHJldHVybiB7XG4gICAgICBpZDoga2JJZCxcbiAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiBpdGVtLmRlc2NyaXB0aW9uLFxuICAgICAgY3JlYXRlZEF0OiBpdGVtLmNyZWF0ZWRBdCxcbiAgICAgIHVwZGF0ZWRBdDogaXRlbS51cGRhdGVkQXQsXG4gICAgICBfY291bnQ6IGl0ZW0uX2NvdW50ID8/IHsgcXVlc3Rpb25zOiAwIH0sXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICBpZiAoZXJyPy5uYW1lID09PSAnQ29uZGl0aW9uYWxDaGVja0ZhaWxlZEV4Y2VwdGlvbicpIHtcbiAgICAgIC8vIE5vdCBmb3VuZFxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdLbm93bGVkZ2UgYmFzZSBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cbiJdfQ==