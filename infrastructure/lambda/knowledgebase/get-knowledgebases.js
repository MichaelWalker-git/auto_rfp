"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.listKnowledgeBasesForOrg = listKnowledgeBasesForOrg;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
const organization_1 = require("../constants/organization");
const document_1 = require("../constants/document");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --- Main Handler ---
const handler = async (event) => {
    try {
        const { orgId } = event.queryStringParameters || {};
        if (!orgId) {
            return (0, api_1.apiResponse)(400, {
                message: 'Missing required path parameter: orgId',
            });
        }
        const knowledgeBases = await listKnowledgeBasesForOrg(orgId);
        return (0, api_1.apiResponse)(200, knowledgeBases);
    }
    catch (err) {
        console.error('Error in getKnowledgeBases handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- List KBs for org ----
async function listKnowledgeBasesForOrg(orgId) {
    const items = [];
    let ExclusiveStartKey = undefined;
    const skPrefix = `${orgId}#`;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :pkValue AND begins_with(#sk, :skPrefix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':pkValue': organization_1.KNOWLEDGE_BASE_PK,
                ':skPrefix': skPrefix,
            },
            ExclusiveStartKey,
        }));
        if (res.Items && res.Items.length > 0) {
            items.push(...res.Items);
        }
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    // For each KB, compute documents count (PK = DOCUMENT_PK, SK begins_with "KB#<kbId>")
    return await Promise.all(items.map(async (item) => {
        const sk = item[common_1.SK_NAME];
        const kbId = sk.split('#')[1];
        const documentsCount = await getDocumentCountForKnowledgeBase(kbId);
        return {
            id: kbId,
            name: item.name,
            description: item.description,
            createdAt: item.createdAt,
            updatedAt: item.updatedAt,
            _count: {
                questions: item._count?.questions ?? 0,
                documents: documentsCount,
            },
        };
    }));
}
// --- Helper: count documents for a KB ---
//
// Document items:
//   PK = DOCUMENT_PK
//   SK starts with `KB#${knowledgeBaseId}`
async function getDocumentCountForKnowledgeBase(knowledgeBaseId) {
    const skPrefix = `KB#${knowledgeBaseId}`;
    let count = 0;
    let ExclusiveStartKey = undefined;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :pkValue AND begins_with(#sk, :skPrefix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':pkValue': document_1.DOCUMENT_PK,
                ':skPrefix': skPrefix,
            },
            Select: 'COUNT',
            ExclusiveStartKey,
        }));
        count += res.Count ?? 0;
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    return count;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWtub3dsZWRnZWJhc2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2V0LWtub3dsZWRnZWJhc2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQW9EQSw0REF3REM7QUEzR0QsOERBQTBEO0FBQzFELHdEQUE2RTtBQUU3RSxnREFBdUQ7QUFDdkQsd0NBQTZDO0FBQzdDLDREQUE4RDtBQUM5RCxvREFBb0Q7QUFHcEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtLQUM1QjtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELHVCQUF1QjtBQUVoQixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQztRQUVwRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSx3Q0FBd0M7YUFDbEQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sY0FBYyxHQUFHLE1BQU0sd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFN0QsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFB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QWdEO1lBQ2xELHdCQUF3QixFQUFFO2dCQUN4QixLQUFLLEVBQUUsZ0JBQU87Z0JBQ2QsS0FBSyxFQUFFLGdCQUFPO2FBQ2Y7WUFDRCx5QkFBeUIsRUFBRTtnQkFDekIsVUFBVSxFQUFFLHNCQUFXO2dCQUN2QixXQUFXLEVBQUUsUUFBUTthQUN0QjtZQUNELE1BQU0sRUFBRSxPQUFPO1lBQ2YsaUJBQWlCO1NBQ2xCLENBQUMsQ0FDSCxDQUFDO1FBRUYsS0FBSyxJQUFJLEdBQUcsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ3hCLGlCQUFpQixHQUFHLEdBQUcsQ0FBQyxnQkFFWCxDQUFDO0lBQ2hCLENBQUMsUUFBUSxpQkFBaUIsRUFBRTtJQUU1QixPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcblxuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBLTk9XTEVER0VfQkFTRV9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9vcmdhbml6YXRpb24nO1xuaW1wb3J0IHsgRE9DVU1FTlRfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvZG9jdW1lbnQnO1xuaW1wb3J0IHsgS25vd2xlZGdlQmFzZSwgS25vd2xlZGdlQmFzZUl0ZW0gfSBmcm9tICcuLi9zY2hlbWFzL2tub3dsZWRnZS1iYXNlJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuLy8gLS0tIE1haW4gSGFuZGxlciAtLS1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgb3JnSWQgfSA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcblxuICAgIGlmICghb3JnSWQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ01pc3NpbmcgcmVxdWlyZWQgcGF0aCBwYXJhbWV0ZXI6IG9yZ0lkJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGtub3dsZWRnZUJhc2VzID0gYXdhaXQgbGlzdEtub3dsZWRnZUJhc2VzRm9yT3JnKG9yZ0lkKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIGtub3dsZWRnZUJhc2VzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZ2V0S25vd2xlZGdlQmFzZXMgaGFuZGxlcjonLCBlcnIpO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tIExpc3QgS0JzIGZvciBvcmcgLS0tLVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdEtub3dsZWRnZUJhc2VzRm9yT3JnKFxuICBvcmdJZDogc3RyaW5nLFxuKTogUHJvbWlzZTxLbm93bGVkZ2VCYXNlW10+IHtcbiAgY29uc3QgaXRlbXM6IEtub3dsZWRnZUJhc2VJdGVtW10gPSBbXTtcbiAgbGV0IEV4Y2x1c2l2ZVN0YXJ0S2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0IHNrUHJlZml4ID0gYCR7b3JnSWR9I2A7XG5cbiAgZG8ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjpcbiAgICAgICAgICAnI3BrID0gOnBrVmFsdWUgQU5EIGJlZ2luc193aXRoKCNzaywgOnNrUHJlZml4KScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgICAgICcjc2snOiBTS19OQU1FLFxuICAgICAgICB9LFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwa1ZhbHVlJzogS05PV0xFREdFX0JBU0VfUEssXG4gICAgICAgICAgJzpza1ByZWZpeCc6IHNrUHJlZml4LFxuICAgICAgICB9LFxuICAgICAgICBFeGNsdXNpdmVTdGFydEtleSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBpZiAocmVzLkl0ZW1zICYmIHJlcy5JdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICBpdGVtcy5wdXNoKC4uLihyZXMuSXRlbXMgYXMgS25vd2xlZGdlQmFzZUl0ZW1bXSkpO1xuICAgIH1cblxuICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5ID0gcmVzLkxhc3RFdmFsdWF0ZWRLZXkgYXNcbiAgICAgIHwgUmVjb3JkPHN0cmluZywgYW55PlxuICAgICAgfCB1bmRlZmluZWQ7XG4gIH0gd2hpbGUgKEV4Y2x1c2l2ZVN0YXJ0S2V5KTtcblxuICAvLyBGb3IgZWFjaCBLQiwgY29tcHV0ZSBkb2N1bWVudHMgY291bnQgKFBLID0gRE9DVU1FTlRfUEssIFNLIGJlZ2luc193aXRoIFwiS0IjPGtiSWQ+XCIpXG4gIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBpdGVtcy5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IHNrID0gaXRlbVtTS19OQU1FXSBhcyBzdHJpbmc7XG4gICAgICBjb25zdCBrYklkID0gc2suc3BsaXQoJyMnKVsxXTtcblxuICAgICAgY29uc3QgZG9jdW1lbnRzQ291bnQgPSBhd2FpdCBnZXREb2N1bWVudENvdW50Rm9yS25vd2xlZGdlQmFzZShrYklkKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IGtiSWQsXG4gICAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGl0ZW0uZGVzY3JpcHRpb24sXG4gICAgICAgIGNyZWF0ZWRBdDogaXRlbS5jcmVhdGVkQXQsXG4gICAgICAgIHVwZGF0ZWRBdDogaXRlbS51cGRhdGVkQXQsXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHF1ZXN0aW9uczogaXRlbS5fY291bnQ/LnF1ZXN0aW9ucyA/PyAwLFxuICAgICAgICAgIGRvY3VtZW50czogZG9jdW1lbnRzQ291bnQsXG4gICAgICAgIH0sXG4gICAgICB9IGFzIEtub3dsZWRnZUJhc2U7XG4gICAgfSksXG4gICk7XG59XG5cbi8vIC0tLSBIZWxwZXI6IGNvdW50IGRvY3VtZW50cyBmb3IgYSBLQiAtLS1cbi8vXG4vLyBEb2N1bWVudCBpdGVtczpcbi8vICAgUEsgPSBET0NVTUVOVF9QS1xuLy8gICBTSyBzdGFydHMgd2l0aCBgS0IjJHtrbm93bGVkZ2VCYXNlSWR9YFxuYXN5bmMgZnVuY3Rpb24gZ2V0RG9jdW1lbnRDb3VudEZvcktub3dsZWRnZUJhc2UoXG4gIGtub3dsZWRnZUJhc2VJZDogc3RyaW5nLFxuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgY29uc3Qgc2tQcmVmaXggPSBgS0IjJHtrbm93bGVkZ2VCYXNlSWR9YDtcbiAgbGV0IGNvdW50ID0gMDtcbiAgbGV0IEV4Y2x1c2l2ZVN0YXJ0S2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGRvIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246XG4gICAgICAgICAgJyNwayA9IDpwa1ZhbHVlIEFORCBiZWdpbnNfd2l0aCgjc2ssIDpza1ByZWZpeCknLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICAgICAnI3NrJzogU0tfTkFNRSxcbiAgICAgICAgfSxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICc6cGtWYWx1ZSc6IERPQ1VNRU5UX1BLLFxuICAgICAgICAgICc6c2tQcmVmaXgnOiBza1ByZWZpeCxcbiAgICAgICAgfSxcbiAgICAgICAgU2VsZWN0OiAnQ09VTlQnLFxuICAgICAgICBFeGNsdXNpdmVTdGFydEtleSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb3VudCArPSByZXMuQ291bnQgPz8gMDtcbiAgICBFeGNsdXNpdmVTdGFydEtleSA9IHJlcy5MYXN0RXZhbHVhdGVkS2V5IGFzXG4gICAgICB8IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgICAgIHwgdW5kZWZpbmVkO1xuICB9IHdoaWxlIChFeGNsdXNpdmVTdGFydEtleSk7XG5cbiAgcmV0dXJuIGNvdW50O1xufVxuIl19