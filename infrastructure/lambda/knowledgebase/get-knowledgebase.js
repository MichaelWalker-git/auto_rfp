"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.getKnowledgeBase = getKnowledgeBase;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error("DB_TABLE_NAME environment variable is not set");
}
const handler = async (event) => {
    try {
        const { orgId, kbId } = event.queryStringParameters || {};
        if (!orgId || !kbId) {
            return (0, api_1.apiResponse)(400, {
                message: "Missing required query params: orgId, kbId",
            });
        }
        const knowledgeBase = await getKnowledgeBase(orgId, kbId);
        if (!knowledgeBase) {
            return (0, api_1.apiResponse)(404, {
                message: "Knowledge Base not found",
            });
        }
        return (0, api_1.apiResponse)(200, knowledgeBase);
    }
    catch (err) {
        console.error("Error in getKnowledgeBase handler:", err);
        return (0, api_1.apiResponse)(500, {
            message: "Internal server error",
            error: err instanceof Error ? err.message : "Unknown error",
        });
    }
};
exports.handler = handler;
async function getKnowledgeBase(orgId, kbId) {
    const sk = `${orgId}#${kbId}`;
    const res = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: organization_1.KNOWLEDGE_BASE_PK,
            [common_1.SK_NAME]: sk,
        },
    }));
    if (!res.Item)
        return null;
    const item = res.Item;
    return {
        id: kbId,
        name: item.name,
        description: item.description,
        createdAt: item.createdAt,
        updatedAt: item.updatedAt,
        _count: {
            questions: item._count?.questions ?? 0,
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWtub3dsZWRnZWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQta25vd2xlZGdlYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFtREEsNENBOEJDO0FBaEZELDhEQUEwRDtBQUMxRCx3REFBNEU7QUFFNUUsZ0RBQXVEO0FBQ3ZELDREQUE4RDtBQUM5RCx3Q0FBNkM7QUFHN0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFLEVBQUUscUJBQXFCLEVBQUUsSUFBSSxFQUFFO0NBQ2pELENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVNLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQztRQUUxRCxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDcEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsNENBQTRDO2FBQ3RELENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLGFBQWEsR0FBRyxNQUFNLGdCQUFnQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDbkIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsMEJBQTBCO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXpELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUE3QlcsUUFBQSxPQUFPLFdBNkJsQjtBQUVLLEtBQUssVUFBVSxnQkFBZ0IsQ0FDcEMsS0FBYSxFQUNiLElBQVk7SUFFWixNQUFNLEVBQUUsR0FBRyxHQUFHLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUU5QixNQUFNLEdBQUcsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQzlCLElBQUkseUJBQVUsQ0FBQztRQUNiLFNBQVMsRUFBRSxhQUFhO1FBQ3hCLEdBQUcsRUFBRTtZQUNILENBQUMsZ0JBQU8sQ0FBQyxFQUFFLGdDQUFpQjtZQUM1QixDQUFDLGdCQUFPLENBQUMsRUFBRSxFQUFFO1NBQ2Q7S0FDRixDQUFDLENBQ0gsQ0FBQztJQUVGLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSTtRQUFFLE9BQU8sSUFBSSxDQUFDO0lBRTNCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUF5QixDQUFDO0lBRTNDLE9BQU87UUFDTCxFQUFFLEVBQUUsSUFBSTtRQUNSLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtRQUNmLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztRQUM3QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7UUFDekIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1FBQ3pCLE1BQU0sRUFBRTtZQUNOLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsSUFBSSxDQUFDO1NBQ3ZDO0tBQ0YsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcblxuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgS05PV0xFREdFX0JBU0VfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvb3JnYW5pemF0aW9uJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuaW1wb3J0IHsgS25vd2xlZGdlQmFzZSwgS25vd2xlZGdlQmFzZUl0ZW0sIH0gZnJvbSAnLi4vc2NoZW1hcy9rbm93bGVkZ2UtYmFzZSc7XG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50LCB7XG4gIG1hcnNoYWxsT3B0aW9uczogeyByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUgfSxcbn0pO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcihcIkRCX1RBQkxFX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldFwiKTtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBvcmdJZCwga2JJZCB9ID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuXG4gICAgaWYgKCFvcmdJZCB8fCAha2JJZCkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiBcIk1pc3NpbmcgcmVxdWlyZWQgcXVlcnkgcGFyYW1zOiBvcmdJZCwga2JJZFwiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qga25vd2xlZGdlQmFzZSA9IGF3YWl0IGdldEtub3dsZWRnZUJhc2Uob3JnSWQsIGtiSWQpO1xuXG4gICAgaWYgKCFrbm93bGVkZ2VCYXNlKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDA0LCB7XG4gICAgICAgIG1lc3NhZ2U6IFwiS25vd2xlZGdlIEJhc2Ugbm90IGZvdW5kXCIsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCBrbm93bGVkZ2VCYXNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGluIGdldEtub3dsZWRnZUJhc2UgaGFuZGxlcjpcIiwgZXJyKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6IFwiSW50ZXJuYWwgc2VydmVyIGVycm9yXCIsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwiLFxuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0S25vd2xlZGdlQmFzZShcbiAgb3JnSWQ6IHN0cmluZyxcbiAga2JJZDogc3RyaW5nXG4pOiBQcm9taXNlPEtub3dsZWRnZUJhc2UgfCBudWxsPiB7XG4gIGNvbnN0IHNrID0gYCR7b3JnSWR9IyR7a2JJZH1gO1xuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgIEtleToge1xuICAgICAgICBbUEtfTkFNRV06IEtOT1dMRURHRV9CQVNFX1BLLFxuICAgICAgICBbU0tfTkFNRV06IHNrLFxuICAgICAgfSxcbiAgICB9KVxuICApO1xuXG4gIGlmICghcmVzLkl0ZW0pIHJldHVybiBudWxsO1xuXG4gIGNvbnN0IGl0ZW0gPSByZXMuSXRlbSBhcyBLbm93bGVkZ2VCYXNlSXRlbTtcblxuICByZXR1cm4ge1xuICAgIGlkOiBrYklkLFxuICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICBkZXNjcmlwdGlvbjogaXRlbS5kZXNjcmlwdGlvbixcbiAgICBjcmVhdGVkQXQ6IGl0ZW0uY3JlYXRlZEF0LFxuICAgIHVwZGF0ZWRBdDogaXRlbS51cGRhdGVkQXQsXG4gICAgX2NvdW50OiB7XG4gICAgICBxdWVzdGlvbnM6IGl0ZW0uX2NvdW50Py5xdWVzdGlvbnMgPz8gMCxcbiAgICB9LFxuICB9O1xufVxuIl19