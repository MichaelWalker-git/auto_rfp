"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.createKnowledgeBase = createKnowledgeBase;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const knowledge_base_1 = require("../schemas/knowledge-base");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --- Main Handler ---
const handler = async (event) => {
    const { orgId } = event.queryStringParameters || {};
    if (!orgId) {
        return (0, api_1.apiResponse)(400, { message: 'Org Id is required' });
    }
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Runtime validation using Zod
        const validationResult = knowledge_base_1.CreateKnowledgeBaseSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const validatedKbData = validationResult.data;
        const newKb = await createKnowledgeBase(orgId, validatedKbData);
        return (0, api_1.apiResponse)(201, newKb);
    }
    catch (err) {
        console.error('Error in createKnowledgeBase handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- Business Logic Function ---
async function createKnowledgeBase(orgId, kbData) {
    const now = new Date().toISOString();
    const kbId = (0, uuid_1.v4)();
    const knowledgeBaseItem = {
        [common_1.PK_NAME]: organization_1.KNOWLEDGE_BASE_PK,
        [common_1.SK_NAME]: `${orgId}#${kbId}`,
        orgId,
        name: kbData.name,
        description: kbData.description ?? undefined,
        createdAt: now,
        updatedAt: now,
        _count: {
            questions: 0,
        },
    };
    const command = new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: knowledgeBaseItem,
    });
    await docClient.send(command);
    return {
        id: kbId,
        name: knowledgeBaseItem.name,
        description: knowledgeBaseItem.description,
        createdAt: knowledgeBaseItem.createdAt,
        updatedAt: knowledgeBaseItem.updatedAt,
        _count: knowledgeBaseItem._count,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWtub3dsZWRnZWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmVhdGUta25vd2xlZGdlYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFnRkEsa0RBbUNDO0FBbEhELDhEQUEwRDtBQUMxRCx3REFBNEU7QUFDNUUsK0JBQW9DO0FBRXBDLGdEQUF1RDtBQUN2RCw0REFBOEQ7QUFDOUQsd0NBQTZDO0FBQzdDLDhEQUttQztBQUVuQyxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUU7UUFDZixxQkFBcUIsRUFBRSxJQUFJO0tBQzVCO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7QUFFaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUNuRSxDQUFDO0FBRUQsdUJBQXVCO0FBQ2hCLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxLQUFLLENBQUMscUJBQXFCLElBQUksRUFBRSxDQUFDO0lBRXBELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNYLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRUQsSUFB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QixDQUFDLFNBQVM7UUFDdEMsTUFBTSxFQUFFLGlCQUFpQixDQUFDLE1BQU07S0FDakMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQsIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBLTk9XTEVER0VfQkFTRV9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9vcmdhbml6YXRpb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQge1xuICBDcmVhdGVLbm93bGVkZ2VCYXNlRFRPLFxuICBDcmVhdGVLbm93bGVkZ2VCYXNlU2NoZW1hLFxuICBLbm93bGVkZ2VCYXNlLFxuICBLbm93bGVkZ2VCYXNlSXRlbSxcbn0gZnJvbSAnLi4vc2NoZW1hcy9rbm93bGVkZ2UtYmFzZSc7XG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50LCB7XG4gIG1hcnNoYWxsT3B0aW9uczoge1xuICAgIHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSxcbiAgfSxcbn0pO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbi8vIC0tLSBNYWluIEhhbmRsZXIgLS0tXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIGNvbnN0IHsgb3JnSWQgfSA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcblxuICBpZiAoIW9yZ0lkKSB7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnT3JnIElkIGlzIHJlcXVpcmVkJyB9KTtcbiAgfVxuXG4gIGlmICghZXZlbnQuYm9keSkge1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBpcyBtaXNzaW5nJyB9KTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgcmF3Qm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG5cbiAgICAvLyAxLiBSdW50aW1lIHZhbGlkYXRpb24gdXNpbmcgWm9kXG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IENyZWF0ZUtub3dsZWRnZUJhc2VTY2hlbWEuc2FmZVBhcnNlKHJhd0JvZHkpO1xuXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGVycm9yRGV0YWlscyA9IHZhbGlkYXRpb25SZXN1bHQuZXJyb3IuaXNzdWVzLm1hcCgoaXNzdWUpID0+ICh7XG4gICAgICAgIHBhdGg6IGlzc3VlLnBhdGguam9pbignLicpLFxuICAgICAgICBtZXNzYWdlOiBpc3N1ZS5tZXNzYWdlLFxuICAgICAgfSkpO1xuXG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGVycm9yczogZXJyb3JEZXRhaWxzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhdGVkS2JEYXRhOiBDcmVhdGVLbm93bGVkZ2VCYXNlRFRPID0gdmFsaWRhdGlvblJlc3VsdC5kYXRhO1xuXG4gICAgY29uc3QgbmV3S2IgPSBhd2FpdCBjcmVhdGVLbm93bGVkZ2VCYXNlKG9yZ0lkLCB2YWxpZGF0ZWRLYkRhdGEpO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMSwgbmV3S2IpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBjcmVhdGVLbm93bGVkZ2VCYXNlIGhhbmRsZXI6JywgZXJyKTtcblxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGluIHJlcXVlc3QgYm9keScgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tIEJ1c2luZXNzIExvZ2ljIEZ1bmN0aW9uIC0tLVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUtub3dsZWRnZUJhc2UoXG4gIG9yZ0lkOiBzdHJpbmcsXG4gIGtiRGF0YTogQ3JlYXRlS25vd2xlZGdlQmFzZURUTyxcbik6IFByb21pc2U8S25vd2xlZGdlQmFzZT4ge1xuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gIGNvbnN0IGtiSWQgPSB1dWlkdjQoKTtcblxuICBjb25zdCBrbm93bGVkZ2VCYXNlSXRlbTogS25vd2xlZGdlQmFzZUl0ZW0gPSB7XG4gICAgW1BLX05BTUVdOiBLTk9XTEVER0VfQkFTRV9QSyxcbiAgICBbU0tfTkFNRV06IGAke29yZ0lkfSMke2tiSWR9YCxcbiAgICBvcmdJZCxcbiAgICBuYW1lOiBrYkRhdGEubmFtZSxcbiAgICBkZXNjcmlwdGlvbjoga2JEYXRhLmRlc2NyaXB0aW9uID8/IHVuZGVmaW5lZCxcbiAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICB1cGRhdGVkQXQ6IG5vdyxcbiAgICBfY291bnQ6IHtcbiAgICAgIHF1ZXN0aW9uczogMCxcbiAgICB9LFxuICB9IGFzIEtub3dsZWRnZUJhc2VJdGVtO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgIEl0ZW06IGtub3dsZWRnZUJhc2VJdGVtLFxuICB9KTtcblxuICBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICByZXR1cm4ge1xuICAgIGlkOiBrYklkLFxuICAgIG5hbWU6IGtub3dsZWRnZUJhc2VJdGVtLm5hbWUsXG4gICAgZGVzY3JpcHRpb246IGtub3dsZWRnZUJhc2VJdGVtLmRlc2NyaXB0aW9uLFxuICAgIGNyZWF0ZWRBdDoga25vd2xlZGdlQmFzZUl0ZW0uY3JlYXRlZEF0LFxuICAgIHVwZGF0ZWRBdDoga25vd2xlZGdlQmFzZUl0ZW0udXBkYXRlZEF0LFxuICAgIF9jb3VudDoga25vd2xlZGdlQmFzZUl0ZW0uX2NvdW50LFxuICB9O1xufVxuIl19