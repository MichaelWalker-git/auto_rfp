"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const question_file_1 = require("../constants/question-file");
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME env var is not set');
}
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const handler = async (event) => {
    try {
        const qs = event.queryStringParameters || {};
        const projectId = qs.projectId;
        const questionFileId = qs.id || qs.questionFileId;
        if (!projectId || !questionFileId) {
            return (0, api_1.apiResponse)(400, {
                message: 'projectId and id (questionFileId) are required query parameters',
            });
        }
        const item = await getQuestionFile(projectId, questionFileId);
        if (!item) {
            return (0, api_1.apiResponse)(404, {
                message: 'Question file not found',
                projectId,
                questionFileId,
            });
        }
        return (0, api_1.apiResponse)(200, {
            questionFileId: item.id,
            projectId: item.projectId,
            status: item.status,
            fileKey: item.fileKey,
            textFileKey: item.textFileKey,
            createdAt: item.createdAt,
            updatedAt: item.updatedAt,
        });
    }
    catch (err) {
        console.error('get-question-file error:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
async function getQuestionFile(projectId, questionFileId) {
    const sk = `${projectId}#${questionFileId}`;
    const res = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: question_file_1.QUESTION_FILE_PK,
            [common_1.SK_NAME]: sk,
        },
    }));
    if (!res.Item) {
        return null;
    }
    const item = res.Item;
    // If you didnâ€™t store `id`/`projectId` explicitly, derive them from SK:
    if (!item.id) {
        item.id = questionFileId;
    }
    if (!item.projectId) {
        item.projectId = projectId;
    }
    return item;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXF1ZXN0aW9uLWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQtcXVlc3Rpb24tZmlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSw4REFBMEQ7QUFDMUQsd0RBQTRFO0FBRTVFLHdDQUE2QztBQUM3QyxnREFBdUQ7QUFDdkQsOERBQThEO0FBRTlELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ2hELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUVELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFrQkksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQztRQUM3QyxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDO1FBQy9CLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLGNBQWMsQ0FBQztRQUVsRCxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDbEMsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsaUVBQWlFO2FBQzNFLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLGVBQWUsQ0FBQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUseUJBQXlCO2dCQUNsQyxTQUFTO2dCQUNULGNBQWM7YUFDZixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRTtZQUN2QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztTQUMxQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0MsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSx1QkFBdUI7WUFDaEMsS0FBSyxFQUFFLEdBQUcsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7U0FDNUQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQztBQXhDVyxRQUFBLE9BQU8sV0F3Q2xCO0FBRUYsS0FBSyxVQUFVLGVBQWUsQ0FDNUIsU0FBaUIsRUFDakIsY0FBc0I7SUFFdEIsTUFBTSxFQUFFLEdBQUcsR0FBRyxTQUFTLElBQUksY0FBYyxFQUFFLENBQUM7SUFFNUMsTUFBTSxHQUFHLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUM5QixJQUFJLHlCQUFVLENBQUM7UUFDYixTQUFTLEVBQUUsYUFBYTtRQUN4QixHQUFHLEVBQUU7WUFDSCxDQUFDLGdCQUFPLENBQUMsRUFBRSxnQ0FBZ0I7WUFDM0IsQ0FBQyxnQkFBTyxDQUFDLEVBQUUsRUFBRTtTQUNkO0tBQ0YsQ0FBQyxDQUNILENBQUM7SUFFRixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBR2hCLENBQUM7SUFFRix3RUFBd0U7SUFDeEUsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxFQUFFLEdBQUcsY0FBYyxDQUFDO0lBQzNCLENBQUM7SUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzdCLENBQUM7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFFVRVNUSU9OX0ZJTEVfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvcXVlc3Rpb24tZmlsZSc7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnYgdmFyIGlzIG5vdCBzZXQnKTtcbn1cblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbnR5cGUgUXVlc3Rpb25GaWxlU3RhdHVzID1cbiAgfCAncHJvY2Vzc2luZydcbiAgfCAndGV4dF9yZWFkeSdcbiAgfCAncXVlc3Rpb25zX2V4dHJhY3RlZCdcbiAgfCAnZXJyb3InO1xuXG5pbnRlcmZhY2UgUXVlc3Rpb25GaWxlSXRlbSB7XG4gIGlkOiBzdHJpbmc7XG4gIHByb2plY3RJZDogc3RyaW5nO1xuICBmaWxlS2V5OiBzdHJpbmc7XG4gIHRleHRGaWxlS2V5Pzogc3RyaW5nO1xuICBzdGF0dXM6IFF1ZXN0aW9uRmlsZVN0YXR1cztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XG4gICAgY29uc3QgcHJvamVjdElkID0gcXMucHJvamVjdElkO1xuICAgIGNvbnN0IHF1ZXN0aW9uRmlsZUlkID0gcXMuaWQgfHwgcXMucXVlc3Rpb25GaWxlSWQ7XG5cbiAgICBpZiAoIXByb2plY3RJZCB8fCAhcXVlc3Rpb25GaWxlSWQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ3Byb2plY3RJZCBhbmQgaWQgKHF1ZXN0aW9uRmlsZUlkKSBhcmUgcmVxdWlyZWQgcXVlcnkgcGFyYW1ldGVycycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBpdGVtID0gYXdhaXQgZ2V0UXVlc3Rpb25GaWxlKHByb2plY3RJZCwgcXVlc3Rpb25GaWxlSWQpO1xuXG4gICAgaWYgKCFpdGVtKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDA0LCB7XG4gICAgICAgIG1lc3NhZ2U6ICdRdWVzdGlvbiBmaWxlIG5vdCBmb3VuZCcsXG4gICAgICAgIHByb2plY3RJZCxcbiAgICAgICAgcXVlc3Rpb25GaWxlSWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCB7XG4gICAgICBxdWVzdGlvbkZpbGVJZDogaXRlbS5pZCxcbiAgICAgIHByb2plY3RJZDogaXRlbS5wcm9qZWN0SWQsXG4gICAgICBzdGF0dXM6IGl0ZW0uc3RhdHVzLFxuICAgICAgZmlsZUtleTogaXRlbS5maWxlS2V5LFxuICAgICAgdGV4dEZpbGVLZXk6IGl0ZW0udGV4dEZpbGVLZXksXG4gICAgICBjcmVhdGVkQXQ6IGl0ZW0uY3JlYXRlZEF0LFxuICAgICAgdXBkYXRlZEF0OiBpdGVtLnVwZGF0ZWRBdCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignZ2V0LXF1ZXN0aW9uLWZpbGUgZXJyb3I6JywgZXJyKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRRdWVzdGlvbkZpbGUoXG4gIHByb2plY3RJZDogc3RyaW5nLFxuICBxdWVzdGlvbkZpbGVJZDogc3RyaW5nLFxuKTogUHJvbWlzZTxRdWVzdGlvbkZpbGVJdGVtIHwgbnVsbD4ge1xuICBjb25zdCBzayA9IGAke3Byb2plY3RJZH0jJHtxdWVzdGlvbkZpbGVJZH1gO1xuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgIEtleToge1xuICAgICAgICBbUEtfTkFNRV06IFFVRVNUSU9OX0ZJTEVfUEssXG4gICAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuXG4gIGlmICghcmVzLkl0ZW0pIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGl0ZW0gPSByZXMuSXRlbSBhcyBRdWVzdGlvbkZpbGVJdGVtICYge1xuICAgIFtQS19OQU1FXTogc3RyaW5nO1xuICAgIFtTS19OQU1FXTogc3RyaW5nO1xuICB9O1xuXG4gIC8vIElmIHlvdSBkaWRu4oCZdCBzdG9yZSBgaWRgL2Bwcm9qZWN0SWRgIGV4cGxpY2l0bHksIGRlcml2ZSB0aGVtIGZyb20gU0s6XG4gIGlmICghaXRlbS5pZCkge1xuICAgIGl0ZW0uaWQgPSBxdWVzdGlvbkZpbGVJZDtcbiAgfVxuICBpZiAoIWl0ZW0ucHJvamVjdElkKSB7XG4gICAgaXRlbS5wcm9qZWN0SWQgPSBwcm9qZWN0SWQ7XG4gIH1cblxuICByZXR1cm4gaXRlbTtcbn1cbiJdfQ==