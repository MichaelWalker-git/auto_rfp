"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const question_file_1 = require("../constants/question-file");
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME env var is not set');
}
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
// --------- Handler ---------
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
        }
        let body;
        try {
            body = JSON.parse(event.body);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON body' });
        }
        const validationError = validateBody(body);
        if (validationError) {
            return (0, api_1.apiResponse)(400, { message: validationError });
        }
        const created = await createQuestionFile(body);
        return (0, api_1.apiResponse)(201, created);
    }
    catch (err) {
        console.error('create-question-file error:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --------- Validation ---------
function validateBody(body) {
    if (!body.projectId || typeof body.projectId !== 'string') {
        return 'projectId is required and must be a string';
    }
    if (!body.fileKey || typeof body.fileKey !== 'string') {
        return 'fileKey is required and must be a string';
    }
    return null;
}
// --------- Core Logic ---------
async function createQuestionFile(body) {
    const now = new Date().toISOString();
    const questionFileId = (0, uuid_1.v4)();
    const { projectId, fileKey, originalFileName, mimeType, sourceDocumentId, } = body;
    // SK pattern is already used elsewhere:
    //   SK = `${projectId}#${questionFileId}`
    const sk = `${projectId}#${questionFileId}`;
    const item = {
        [common_1.PK_NAME]: question_file_1.QUESTION_FILE_PK,
        [common_1.SK_NAME]: sk,
        questionFileId,
        projectId,
        fileKey,
        textFileKey: null, // will be filled after Textract
        status: 'uploaded', // pipeline will move it to processing/text_ready/...
        originalFileName: originalFileName ?? null,
        mimeType: mimeType ?? null,
        sourceDocumentId: sourceDocumentId ?? null, // <-- “file id questions were extracted from”
        createdAt: now,
        updatedAt: now,
    };
    await docClient.send(new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: item,
    }));
    return item;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXF1ZXN0aW9uLWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmVhdGUtcXVlc3Rpb24tZmlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSw4REFBMEQ7QUFDMUQsd0RBQTRFO0FBRTVFLCtCQUFvQztBQUVwQyx3Q0FBNkM7QUFDN0MsZ0RBQXVEO0FBQ3ZELDhEQUE4RDtBQUU5RCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUVoRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUUsRUFBRSxxQkFBcUIsRUFBRSxJQUFJLEVBQUU7Q0FDakQsQ0FBQyxDQUFDO0FBWUgsOEJBQThCO0FBRXZCLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBRUQsSUFBSSxJQUE0QixDQUFDO1FBQ2pDLElBQUksQ0FBQztZQUNILElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1AsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRUQsTUFBTSxlQUFlLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLElBQUksZUFBZSxFQUFFLENBQUM7WUFDcEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFL0MsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLHVCQUF1QjtZQUNoQyxLQUFLLEVBQUUsR0FBRyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtTQUM1RCxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBOUJXLFFBQUEsT0FBTyxXQThCbEI7QUFFRixpQ0FBaUM7QUFFakMsU0FBUyxZQUFZLENBQUMsSUFBcUM7SUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksT0FBTyxJQUFJLENBQUMsU0FBUyxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQzFELE9BQU8sNENBQTRDLENBQUM7SUFDdEQsQ0FBQztJQUNELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUN0RCxPQUFPLDBDQUEwQyxDQUFDO0lBQ3BELENBQUM7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFFRCxpQ0FBaUM7QUFFakMsS0FBSyxVQUFVLGtCQUFrQixDQUFDLElBQTRCO0lBQzVELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckMsTUFBTSxjQUFjLEdBQUcsSUFBQSxTQUFNLEdBQUUsQ0FBQztJQUVoQyxNQUFNLEVBQ0osU0FBUyxFQUNULE9BQU8sRUFDUCxnQkFBZ0IsRUFDaEIsUUFBUSxFQUNSLGdCQUFnQixHQUNqQixHQUFHLElBQUksQ0FBQztJQUVULHdDQUF3QztJQUN4QywwQ0FBMEM7SUFDMUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxTQUFTLElBQUksY0FBYyxFQUFFLENBQUM7SUFFNUMsTUFBTSxJQUFJLEdBQXdCO1FBQ2hDLENBQUMsZ0JBQU8sQ0FBQyxFQUFFLGdDQUFnQjtRQUMzQixDQUFDLGdCQUFPLENBQUMsRUFBRSxFQUFFO1FBRWIsY0FBYztRQUNkLFNBQVM7UUFDVCxPQUFPO1FBQ1AsV0FBVyxFQUFFLElBQUksRUFBVyxnQ0FBZ0M7UUFDNUQsTUFBTSxFQUFFLFVBQVUsRUFBVSxxREFBcUQ7UUFDakYsZ0JBQWdCLEVBQUUsZ0JBQWdCLElBQUksSUFBSTtRQUMxQyxRQUFRLEVBQUUsUUFBUSxJQUFJLElBQUk7UUFDMUIsZ0JBQWdCLEVBQUUsZ0JBQWdCLElBQUksSUFBSSxFQUFFLDhDQUE4QztRQUUxRixTQUFTLEVBQUUsR0FBRztRQUNkLFNBQVMsRUFBRSxHQUFHO0tBQ2YsQ0FBQztJQUVGLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDbEIsSUFBSSx5QkFBVSxDQUFDO1FBQ2IsU0FBUyxFQUFFLGFBQWE7UUFDeEIsSUFBSSxFQUFFLElBQUk7S0FDWCxDQUFDLENBQ0gsQ0FBQztJQUVGLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBQdXRDb21tYW5kLCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuXG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFFVRVNUSU9OX0ZJTEVfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvcXVlc3Rpb24tZmlsZSc7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudiB2YXIgaXMgbm90IHNldCcpO1xufVxuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHsgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlIH0sXG59KTtcblxuLy8gLS0tLS0tLS0tIERUTyB0eXBlcyAoc2ltcGxlLCBubyBab2QgaGVyZSkgLS0tLS0tLS0tXG5cbmludGVyZmFjZSBDcmVhdGVRdWVzdGlvbkZpbGVCb2R5IHtcbiAgcHJvamVjdElkOiBzdHJpbmc7XG4gIGZpbGVLZXk6IHN0cmluZzsgICAgICAgICAgICAgIC8vIFMzIGtleSBvZiB1cGxvYWRlZCBmaWxlXG4gIG9yaWdpbmFsRmlsZU5hbWU/OiBzdHJpbmc7ICAgIC8vIG9wdGlvbmFsOiBzaG93biBpbiBVSVxuICBtaW1lVHlwZT86IHN0cmluZzsgICAgICAgICAgICAvLyBvcHRpb25hbDogcGRmL2RvY3gvZXRjXG4gIHNvdXJjZURvY3VtZW50SWQ/OiBzdHJpbmc7ICAgIC8vIG9wdGlvbmFsOiBpZCBvZiBkb2N1bWVudCB0aGlzIGZpbGUgYmVsb25ncyB0b1xufVxuXG4vLyAtLS0tLS0tLS0gSGFuZGxlciAtLS0tLS0tLS1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGlmICghZXZlbnQuYm9keSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnIH0pO1xuICAgIH1cblxuICAgIGxldCBib2R5OiBDcmVhdGVRdWVzdGlvbkZpbGVCb2R5O1xuICAgIHRyeSB7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBib2R5JyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZUJvZHkoYm9keSk7XG4gICAgaWYgKHZhbGlkYXRpb25FcnJvcikge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgY3JlYXRlZCA9IGF3YWl0IGNyZWF0ZVF1ZXN0aW9uRmlsZShib2R5KTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDEsIGNyZWF0ZWQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdjcmVhdGUtcXVlc3Rpb24tZmlsZSBlcnJvcjonLCBlcnIpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgZXJyb3I6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIC0tLS0tLS0tLSBWYWxpZGF0aW9uIC0tLS0tLS0tLVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUJvZHkoYm9keTogUGFydGlhbDxDcmVhdGVRdWVzdGlvbkZpbGVCb2R5Pik6IHN0cmluZyB8IG51bGwge1xuICBpZiAoIWJvZHkucHJvamVjdElkIHx8IHR5cGVvZiBib2R5LnByb2plY3RJZCAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gJ3Byb2plY3RJZCBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIHN0cmluZyc7XG4gIH1cbiAgaWYgKCFib2R5LmZpbGVLZXkgfHwgdHlwZW9mIGJvZHkuZmlsZUtleSAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gJ2ZpbGVLZXkgaXMgcmVxdWlyZWQgYW5kIG11c3QgYmUgYSBzdHJpbmcnO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG4vLyAtLS0tLS0tLS0gQ29yZSBMb2dpYyAtLS0tLS0tLS1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUXVlc3Rpb25GaWxlKGJvZHk6IENyZWF0ZVF1ZXN0aW9uRmlsZUJvZHkpIHtcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICBjb25zdCBxdWVzdGlvbkZpbGVJZCA9IHV1aWR2NCgpO1xuXG4gIGNvbnN0IHtcbiAgICBwcm9qZWN0SWQsXG4gICAgZmlsZUtleSxcbiAgICBvcmlnaW5hbEZpbGVOYW1lLFxuICAgIG1pbWVUeXBlLFxuICAgIHNvdXJjZURvY3VtZW50SWQsXG4gIH0gPSBib2R5O1xuXG4gIC8vIFNLIHBhdHRlcm4gaXMgYWxyZWFkeSB1c2VkIGVsc2V3aGVyZTpcbiAgLy8gICBTSyA9IGAke3Byb2plY3RJZH0jJHtxdWVzdGlvbkZpbGVJZH1gXG4gIGNvbnN0IHNrID0gYCR7cHJvamVjdElkfSMke3F1ZXN0aW9uRmlsZUlkfWA7XG5cbiAgY29uc3QgaXRlbTogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICBbUEtfTkFNRV06IFFVRVNUSU9OX0ZJTEVfUEssXG4gICAgW1NLX05BTUVdOiBzayxcblxuICAgIHF1ZXN0aW9uRmlsZUlkLFxuICAgIHByb2plY3RJZCxcbiAgICBmaWxlS2V5LFxuICAgIHRleHRGaWxlS2V5OiBudWxsLCAgICAgICAgICAvLyB3aWxsIGJlIGZpbGxlZCBhZnRlciBUZXh0cmFjdFxuICAgIHN0YXR1czogJ3VwbG9hZGVkJywgICAgICAgICAvLyBwaXBlbGluZSB3aWxsIG1vdmUgaXQgdG8gcHJvY2Vzc2luZy90ZXh0X3JlYWR5Ly4uLlxuICAgIG9yaWdpbmFsRmlsZU5hbWU6IG9yaWdpbmFsRmlsZU5hbWUgPz8gbnVsbCxcbiAgICBtaW1lVHlwZTogbWltZVR5cGUgPz8gbnVsbCxcbiAgICBzb3VyY2VEb2N1bWVudElkOiBzb3VyY2VEb2N1bWVudElkID8/IG51bGwsIC8vIDwtLSDigJxmaWxlIGlkIHF1ZXN0aW9ucyB3ZXJlIGV4dHJhY3RlZCBmcm9t4oCdXG5cbiAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICB1cGRhdGVkQXQ6IG5vdyxcbiAgfTtcblxuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICBJdGVtOiBpdGVtLFxuICAgIH0pLFxuICApO1xuXG4gIHJldHVybiBpdGVtO1xufVxuIl19