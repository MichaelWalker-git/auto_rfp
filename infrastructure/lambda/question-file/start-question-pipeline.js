"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_sfn_1 = require("@aws-sdk/client-sfn");
const api_1 = require("../helpers/api");
const sfnClient = new client_sfn_1.SFNClient({});
const STATE_MACHINE_ARN = process.env.QUESTION_PIPELINE_STATE_MACHINE_ARN;
if (!STATE_MACHINE_ARN) {
    throw new Error('QUESTION_PIPELINE_STATE_MACHINE_ARN env var is not set');
}
const handler = async (event) => {
    console.log('start-question-pipeline event:', JSON.stringify(event));
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is required' });
    }
    let body;
    try {
        body = JSON.parse(event.body);
    }
    catch {
        return (0, api_1.apiResponse)(400, { message: 'Invalid JSON body' });
    }
    const { questionFileId, projectId } = body;
    if (!questionFileId || !projectId) {
        return (0, api_1.apiResponse)(400, {
            message: 'questionFileId and projectId are required',
        });
    }
    try {
        const res = await sfnClient.send(new client_sfn_1.StartExecutionCommand({
            stateMachineArn: STATE_MACHINE_ARN,
            input: JSON.stringify({
                questionFileId,
                projectId,
            }),
        }));
        return (0, api_1.apiResponse)(202, {
            message: 'Question pipeline started',
            executionArn: res.executionArn,
            startDate: res.startDate,
        });
    }
    catch (err) {
        console.error('Error starting question pipeline:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to start question pipeline',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtcXVlc3Rpb24tcGlwZWxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1xdWVzdGlvbi1waXBlbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxvREFBdUU7QUFDdkUsd0NBQTZDO0FBRTdDLE1BQU0sU0FBUyxHQUFHLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNwQyxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUM7QUFFMUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO0FBQzVFLENBQUM7QUFPTSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUVyRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hCLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVELElBQUksSUFBZSxDQUFDO0lBQ3BCLElBQUksQ0FBQztRQUNILElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBQUMsTUFBTSxDQUFDO1FBQ1AsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsTUFBTSxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFFM0MsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2xDLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsMkNBQTJDO1NBQ3JELENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLEdBQUcsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQzlCLElBQUksa0NBQXFCLENBQUM7WUFDeEIsZUFBZSxFQUFFLGlCQUFpQjtZQUNsQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDcEIsY0FBYztnQkFDZCxTQUFTO2FBQ1YsQ0FBQztTQUNILENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSwyQkFBMkI7WUFDcEMsWUFBWSxFQUFFLEdBQUcsQ0FBQyxZQUFZO1lBQzlCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUztTQUN6QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDeEQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSxtQ0FBbUM7WUFDNUMsS0FBSyxFQUFFLEdBQUcsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7U0FDNUQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQztBQS9DVyxRQUFBLE9BQU8sV0ErQ2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIsIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTRk5DbGllbnQsIFN0YXJ0RXhlY3V0aW9uQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZm4nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5cbmNvbnN0IHNmbkNsaWVudCA9IG5ldyBTRk5DbGllbnQoe30pO1xuY29uc3QgU1RBVEVfTUFDSElORV9BUk4gPSBwcm9jZXNzLmVudi5RVUVTVElPTl9QSVBFTElORV9TVEFURV9NQUNISU5FX0FSTjtcblxuaWYgKCFTVEFURV9NQUNISU5FX0FSTikge1xuICB0aHJvdyBuZXcgRXJyb3IoJ1FVRVNUSU9OX1BJUEVMSU5FX1NUQVRFX01BQ0hJTkVfQVJOIGVudiB2YXIgaXMgbm90IHNldCcpO1xufVxuXG5pbnRlcmZhY2UgU3RhcnRCb2R5IHtcbiAgcXVlc3Rpb25GaWxlSWQ/OiBzdHJpbmc7XG4gIHByb2plY3RJZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICBjb25zb2xlLmxvZygnc3RhcnQtcXVlc3Rpb24tcGlwZWxpbmUgZXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBpZiAoIWV2ZW50LmJvZHkpIHtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnIH0pO1xuICB9XG5cbiAgbGV0IGJvZHk6IFN0YXJ0Qm9keTtcbiAgdHJ5IHtcbiAgICBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgfSBjYXRjaCB7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGJvZHknIH0pO1xuICB9XG5cbiAgY29uc3QgeyBxdWVzdGlvbkZpbGVJZCwgcHJvamVjdElkIH0gPSBib2R5O1xuXG4gIGlmICghcXVlc3Rpb25GaWxlSWQgfHwgIXByb2plY3RJZCkge1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdxdWVzdGlvbkZpbGVJZCBhbmQgcHJvamVjdElkIGFyZSByZXF1aXJlZCcsXG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IFN0YXJ0RXhlY3V0aW9uQ29tbWFuZCh7XG4gICAgICAgIHN0YXRlTWFjaGluZUFybjogU1RBVEVfTUFDSElORV9BUk4sXG4gICAgICAgIGlucHV0OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcXVlc3Rpb25GaWxlSWQsXG4gICAgICAgICAgcHJvamVjdElkLFxuICAgICAgICB9KSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAyLCB7XG4gICAgICBtZXNzYWdlOiAnUXVlc3Rpb24gcGlwZWxpbmUgc3RhcnRlZCcsXG4gICAgICBleGVjdXRpb25Bcm46IHJlcy5leGVjdXRpb25Bcm4sXG4gICAgICBzdGFydERhdGU6IHJlcy5zdGFydERhdGUsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHN0YXJ0aW5nIHF1ZXN0aW9uIHBpcGVsaW5lOicsIGVycik7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBzdGFydCBxdWVzdGlvbiBwaXBlbGluZScsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcbiJdfQ==