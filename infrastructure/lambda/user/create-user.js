"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = exports.CreateSecurityStaffSchema = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_cognito_identity_provider_1 = require("@aws-sdk/client-cognito-identity-provider");
const uuid_1 = require("uuid");
const zod_1 = require("zod");
const common_1 = require("../constants/common");
const user_1 = require("../constants/user"); // or SECURITY_STAFF_PK if you have it
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const cognitoClient = new client_cognito_identity_provider_1.CognitoIdentityProviderClient({});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
const USER_POOL_ID = process.env.USER_POOL_ID;
// GSI for looking up users by email in your table
const USER_BY_EMAIL_INDEX = process.env.USER_BY_EMAIL_INDEX || 'USER_BY_EMAIL_INDEX';
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
if (!USER_POOL_ID) {
    throw new Error('USER_POOL_ID environment variable is not set');
}
// ---------- ZOD SCHEMA ----------
// No password here – password handled fully in Cognito, not stored in DB
exports.CreateSecurityStaffSchema = zod_1.z.object({
    email: zod_1.z.string().email('Email must be valid'),
    name: zod_1.z.string().min(1, 'Name is required'),
    organizationId: zod_1.z.string().optional(), // optional, if you group staff by org
});
// ---------- HANDLER ----------
const handler = async (event) => {
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Validate request body
        const validationResult = exports.CreateSecurityStaffSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const dto = validationResult.data;
        // 2. Ensure user with this email does NOT already exist in our table
        const alreadyExists = await userExistsByEmail(dto.email);
        if (alreadyExists) {
            return (0, api_1.apiResponse)(409, {
                message: `User with email ${dto.email} already exists`,
            });
        }
        // 3. Create user in Cognito and store metadata in DynamoDB
        const staff = await createSecurityStaffInCognitoAndDynamo(dto);
        return (0, api_1.apiResponse)(201, staff);
    }
    catch (err) {
        console.error('Error in createSecurityStaff handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// ---------- BUSINESS LOGIC ----------
// Check via GSI that no user with this email exists yet
async function userExistsByEmail(email) {
    const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
        TableName: DB_TABLE_NAME,
        IndexName: USER_BY_EMAIL_INDEX, // GSI with PK = "email"
        KeyConditionExpression: '#email = :email',
        ExpressionAttributeNames: {
            '#email': 'email',
        },
        ExpressionAttributeValues: {
            ':email': email,
        },
        Limit: 1,
    }));
    return !!(res.Items && res.Items.length > 0);
}
async function createSecurityStaffInCognitoAndDynamo(dto) {
    const { email, name, organizationId } = dto;
    const now = new Date().toISOString();
    // We’ll use email as Cognito username as well
    const username = email;
    // 1. Create user in Cognito
    // No password parameter here – Cognito will send a temporary password / invitation
    // (you can configure this behavior in the User Pool settings)
    const createCmd = new client_cognito_identity_provider_1.AdminCreateUserCommand({
        UserPoolId: USER_POOL_ID,
        Username: username,
        UserAttributes: [
            { Name: 'email', Value: email },
            { Name: 'email_verified', Value: 'true' },
            { Name: 'name', Value: name },
        ],
        // Let Cognito send invite message with temporary password
        // Remove this line if you want the default invite behavior
        // MessageAction: 'SUPPRESS',
    });
    const createRes = await cognitoClient.send(createCmd);
    const subAttr = createRes.User?.Attributes?.find((a) => a.Name === 'sub');
    const userId = subAttr?.Value ?? (0, uuid_1.v4)();
    // 2. Store only metadata in DynamoDB (no password, just for listing)
    const staffItem = {
        [common_1.PK_NAME]: user_1.USER_PK, // or SECURITY_STAFF_PK if you prefer
        [common_1.SK_NAME]: `USER#${userId}`, // you can also use `SEC_STAFF#${userId}`
        id: userId,
        email,
        name,
        organizationId: organizationId,
        createdAt: now,
        updatedAt: now,
        cognitoUsername: username,
        role: 'SECURITY_STAFF',
    };
    const putCmd = new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: staffItem,
        // Extra safety: don't overwrite an existing PK/SK
        ConditionExpression: 'attribute_not_exists(#pk) AND attribute_not_exists(#sk)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
    });
    await docClient.send(putCmd);
    return staffItem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXVzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmVhdGUtdXNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFJQSw4REFBMEQ7QUFDMUQsd0RBSStCO0FBQy9CLGdHQUdtRDtBQUNuRCwrQkFBb0M7QUFDcEMsNkJBQXdCO0FBRXhCLGdEQUF1RDtBQUN2RCw0Q0FBNEMsQ0FBQyxzQ0FBc0M7QUFDbkYsd0NBQTZDO0FBRTdDLE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLGFBQWEsR0FBRyxJQUFJLGdFQUE2QixDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRTVELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ2hELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO0FBQzlDLGtEQUFrRDtBQUNsRCxNQUFNLG1CQUFtQixHQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLHFCQUFxQixDQUFDO0FBRTNELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUNELElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDhDQUE4QyxDQUFDLENBQUM7QUFDbEUsQ0FBQztBQUVELG1DQUFtQztBQUVuQyx5RUFBeUU7QUFDNUQsUUFBQSx5QkFBeUIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2hELEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMs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TyxHQUFHLFNBQVMsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQztJQUMxRSxNQUFNLE1BQU0sR0FBRyxPQUFPLEVBQUUsS0FBSyxJQUFJLElBQUEsU0FBTSxHQUFFLENBQUM7SUFFMUMscUVBQXFFO0lBQ3JFLE1BQU0sU0FBUyxHQUFzQjtRQUNuQyxDQUFDLGdCQUFPLENBQUMsRUFBRSxjQUFPLEVBQW1CLHFDQUFxQztRQUMxRSxDQUFDLGdCQUFPLENBQUMsRUFBRSxRQUFRLE1BQU0sRUFBRSxFQUFVLHlDQUF5QztRQUM5RSxFQUFFLEVBQUUsTUFBTTtRQUNWLEtBQUs7UUFDTCxJQUFJO1FBQ0osY0FBYyxFQUFFLGNBQWM7UUFDOUIsU0FBUyxFQUFFLEdBQUc7UUFDZCxTQUFTLEVBQUUsR0FBRztRQUNkLGVBQWUsRUFBRSxRQUFRO1FBQ3pCLElBQUksRUFBRSxnQkFBZ0I7S0FDdkIsQ0FBQztJQUVGLE1BQU0sTUFBTSxHQUFHLElBQUkseUJBQVUsQ0FBQztRQUM1QixTQUFTLEVBQUUsYUFBYTtRQUN4QixJQUFJLEVBQUUsU0FBUztRQUNmLGtEQUFrRDtRQUNsRCxtQkFBbUIsRUFDakIseURBQXlEO1FBQzNELHdCQUF3QixFQUFFO1lBQ3hCLEtBQUssRUFBRSxnQkFBTztZQUNkLEtBQUssRUFBRSxnQkFBTztTQUNmO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRTdCLE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHRWMixcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBQdXRDb21tYW5kLFxuICBRdWVyeUNvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQge1xuICBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCxcbiAgQWRtaW5DcmVhdGVVc2VyQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNvZ25pdG8taWRlbnRpdHktcHJvdmlkZXInO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcblxuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgVVNFUl9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy91c2VyJzsgLy8gb3IgU0VDVVJJVFlfU1RBRkZfUEsgaWYgeW91IGhhdmUgaXRcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gIH0sXG59KTtcblxuY29uc3QgY29nbml0b0NsaWVudCA9IG5ldyBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCh7fSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuY29uc3QgVVNFUl9QT09MX0lEID0gcHJvY2Vzcy5lbnYuVVNFUl9QT09MX0lEO1xuLy8gR1NJIGZvciBsb29raW5nIHVwIHVzZXJzIGJ5IGVtYWlsIGluIHlvdXIgdGFibGVcbmNvbnN0IFVTRVJfQllfRU1BSUxfSU5ERVggPVxuICBwcm9jZXNzLmVudi5VU0VSX0JZX0VNQUlMX0lOREVYIHx8ICdVU0VSX0JZX0VNQUlMX0lOREVYJztcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5pZiAoIVVTRVJfUE9PTF9JRCkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ1VTRVJfUE9PTF9JRCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbi8vIC0tLS0tLS0tLS0gWk9EIFNDSEVNQSAtLS0tLS0tLS0tXG5cbi8vIE5vIHBhc3N3b3JkIGhlcmUg4oCTIHBhc3N3b3JkIGhhbmRsZWQgZnVsbHkgaW4gQ29nbml0bywgbm90IHN0b3JlZCBpbiBEQlxuZXhwb3J0IGNvbnN0IENyZWF0ZVNlY3VyaXR5U3RhZmZTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCdFbWFpbCBtdXN0IGJlIHZhbGlkJyksXG4gIG5hbWU6IHouc3RyaW5nKCkubWluKDEsICdOYW1lIGlzIHJlcXVpcmVkJyksXG4gIG9yZ2FuaXphdGlvbklkOiB6LnN0cmluZygpLm9wdGlvbmFsKCksIC8vIG9wdGlvbmFsLCBpZiB5b3UgZ3JvdXAgc3RhZmYgYnkgb3JnXG59KTtcblxuZXhwb3J0IHR5cGUgQ3JlYXRlU2VjdXJpdHlTdGFmZkRUTyA9IHouaW5mZXI8dHlwZW9mIENyZWF0ZVNlY3VyaXR5U3RhZmZTY2hlbWE+O1xuXG5leHBvcnQgdHlwZSBTZWN1cml0eVN0YWZmSXRlbSA9IENyZWF0ZVNlY3VyaXR5U3RhZmZEVE8gJiB7XG4gIFtQS19OQU1FXTogc3RyaW5nO1xuICBbU0tfTkFNRV06IHN0cmluZztcbiAgaWQ6IHN0cmluZzsgLy8gaW50ZXJuYWwgdXNlciBpZCAoQ29nbml0byBzdWIpXG4gIGNyZWF0ZWRBdDogc3RyaW5nO1xuICB1cGRhdGVkQXQ6IHN0cmluZztcbiAgY29nbml0b1VzZXJuYW1lOiBzdHJpbmc7XG4gIHJvbGU6ICdTRUNVUklUWV9TVEFGRic7XG59O1xuXG4vLyAtLS0tLS0tLS0tIEhBTkRMRVIgLS0tLS0tLS0tLVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIGlmICghZXZlbnQuYm9keSkge1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBpcyBtaXNzaW5nJyB9KTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgcmF3Qm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG5cbiAgICAvLyAxLiBWYWxpZGF0ZSByZXF1ZXN0IGJvZHlcbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gQ3JlYXRlU2VjdXJpdHlTdGFmZlNjaGVtYS5zYWZlUGFyc2UocmF3Qm9keSk7XG5cbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZXJyb3JEZXRhaWxzID0gdmFsaWRhdGlvblJlc3VsdC5lcnJvci5pc3N1ZXMubWFwKChpc3N1ZSkgPT4gKHtcbiAgICAgICAgcGF0aDogaXNzdWUucGF0aC5qb2luKCcuJyksXG4gICAgICAgIG1lc3NhZ2U6IGlzc3VlLm1lc3NhZ2UsXG4gICAgICB9KSk7XG5cbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgZXJyb3JzOiBlcnJvckRldGFpbHMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBkdG86IENyZWF0ZVNlY3VyaXR5U3RhZmZEVE8gPSB2YWxpZGF0aW9uUmVzdWx0LmRhdGE7XG5cbiAgICAvLyAyLiBFbnN1cmUgdXNlciB3aXRoIHRoaXMgZW1haWwgZG9lcyBOT1QgYWxyZWFkeSBleGlzdCBpbiBvdXIgdGFibGVcbiAgICBjb25zdCBhbHJlYWR5RXhpc3RzID0gYXdhaXQgdXNlckV4aXN0c0J5RW1haWwoZHRvLmVtYWlsKTtcbiAgICBpZiAoYWxyZWFkeUV4aXN0cykge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwOSwge1xuICAgICAgICBtZXNzYWdlOiBgVXNlciB3aXRoIGVtYWlsICR7ZHRvLmVtYWlsfSBhbHJlYWR5IGV4aXN0c2AsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyAzLiBDcmVhdGUgdXNlciBpbiBDb2duaXRvIGFuZCBzdG9yZSBtZXRhZGF0YSBpbiBEeW5hbW9EQlxuICAgIGNvbnN0IHN0YWZmID0gYXdhaXQgY3JlYXRlU2VjdXJpdHlTdGFmZkluQ29nbml0b0FuZER5bmFtbyhkdG8pO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMSwgc3RhZmYpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBjcmVhdGVTZWN1cml0eVN0YWZmIGhhbmRsZXI6JywgZXJyKTtcblxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGluIHJlcXVlc3QgYm9keScgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tLS0tLS0tLSBCVVNJTkVTUyBMT0dJQyAtLS0tLS0tLS0tXG5cbi8vIENoZWNrIHZpYSBHU0kgdGhhdCBubyB1c2VyIHdpdGggdGhpcyBlbWFpbCBleGlzdHMgeWV0XG5hc3luYyBmdW5jdGlvbiB1c2VyRXhpc3RzQnlFbWFpbChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgSW5kZXhOYW1lOiBVU0VSX0JZX0VNQUlMX0lOREVYLCAvLyBHU0kgd2l0aCBQSyA9IFwiZW1haWxcIlxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNlbWFpbCA9IDplbWFpbCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNlbWFpbCc6ICdlbWFpbCcsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmVtYWlsJzogZW1haWwsXG4gICAgICB9LFxuICAgICAgTGltaXQ6IDEsXG4gICAgfSksXG4gICk7XG5cbiAgcmV0dXJuICEhKHJlcy5JdGVtcyAmJiByZXMuSXRlbXMubGVuZ3RoID4gMCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlY3VyaXR5U3RhZmZJbkNvZ25pdG9BbmREeW5hbW8oXG4gIGR0bzogQ3JlYXRlU2VjdXJpdHlTdGFmZkRUTyxcbik6IFByb21pc2U8U2VjdXJpdHlTdGFmZkl0ZW0+IHtcbiAgY29uc3QgeyBlbWFpbCwgbmFtZSwgb3JnYW5pemF0aW9uSWQgfSA9IGR0bztcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gIC8vIFdl4oCZbGwgdXNlIGVtYWlsIGFzIENvZ25pdG8gdXNlcm5hbWUgYXMgd2VsbFxuICBjb25zdCB1c2VybmFtZSA9IGVtYWlsO1xuXG4gIC8vIDEuIENyZWF0ZSB1c2VyIGluIENvZ25pdG9cbiAgLy8gTm8gcGFzc3dvcmQgcGFyYW1ldGVyIGhlcmUg4oCTIENvZ25pdG8gd2lsbCBzZW5kIGEgdGVtcG9yYXJ5IHBhc3N3b3JkIC8gaW52aXRhdGlvblxuICAvLyAoeW91IGNhbiBjb25maWd1cmUgdGhpcyBiZWhhdmlvciBpbiB0aGUgVXNlciBQb29sIHNldHRpbmdzKVxuICBjb25zdCBjcmVhdGVDbWQgPSBuZXcgQWRtaW5DcmVhdGVVc2VyQ29tbWFuZCh7XG4gICAgVXNlclBvb2xJZDogVVNFUl9QT09MX0lEISxcbiAgICBVc2VybmFtZTogdXNlcm5hbWUsXG4gICAgVXNlckF0dHJpYnV0ZXM6IFtcbiAgICAgIHsgTmFtZTogJ2VtYWlsJywgVmFsdWU6IGVtYWlsIH0sXG4gICAgICB7IE5hbWU6ICdlbWFpbF92ZXJpZmllZCcsIFZhbHVlOiAndHJ1ZScgfSxcbiAgICAgIHsgTmFtZTogJ25hbWUnLCBWYWx1ZTogbmFtZSB9LFxuICAgIF0sXG4gICAgLy8gTGV0IENvZ25pdG8gc2VuZCBpbnZpdGUgbWVzc2FnZSB3aXRoIHRlbXBvcmFyeSBwYXNzd29yZFxuICAgIC8vIFJlbW92ZSB0aGlzIGxpbmUgaWYgeW91IHdhbnQgdGhlIGRlZmF1bHQgaW52aXRlIGJlaGF2aW9yXG4gICAgLy8gTWVzc2FnZUFjdGlvbjogJ1NVUFBSRVNTJyxcbiAgfSk7XG5cbiAgY29uc3QgY3JlYXRlUmVzID0gYXdhaXQgY29nbml0b0NsaWVudC5zZW5kKGNyZWF0ZUNtZCk7XG5cbiAgY29uc3Qgc3ViQXR0ciA9IGNyZWF0ZVJlcy5Vc2VyPy5BdHRyaWJ1dGVzPy5maW5kKChhKSA9PiBhLk5hbWUgPT09ICdzdWInKTtcbiAgY29uc3QgdXNlcklkID0gc3ViQXR0cj8uVmFsdWUgPz8gdXVpZHY0KCk7XG5cbiAgLy8gMi4gU3RvcmUgb25seSBtZXRhZGF0YSBpbiBEeW5hbW9EQiAobm8gcGFzc3dvcmQsIGp1c3QgZm9yIGxpc3RpbmcpXG4gIGNvbnN0IHN0YWZmSXRlbTogU2VjdXJpdHlTdGFmZkl0ZW0gPSB7XG4gICAgW1BLX05BTUVdOiBVU0VSX1BLLCAgICAgICAgICAgICAgICAgIC8vIG9yIFNFQ1VSSVRZX1NUQUZGX1BLIGlmIHlvdSBwcmVmZXJcbiAgICBbU0tfTkFNRV06IGBVU0VSIyR7dXNlcklkfWAsICAgICAgICAgLy8geW91IGNhbiBhbHNvIHVzZSBgU0VDX1NUQUZGIyR7dXNlcklkfWBcbiAgICBpZDogdXNlcklkLFxuICAgIGVtYWlsLFxuICAgIG5hbWUsXG4gICAgb3JnYW5pemF0aW9uSWQ6IG9yZ2FuaXphdGlvbklkLFxuICAgIGNyZWF0ZWRBdDogbm93LFxuICAgIHVwZGF0ZWRBdDogbm93LFxuICAgIGNvZ25pdG9Vc2VybmFtZTogdXNlcm5hbWUsXG4gICAgcm9sZTogJ1NFQ1VSSVRZX1NUQUZGJyxcbiAgfTtcblxuICBjb25zdCBwdXRDbWQgPSBuZXcgUHV0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgIEl0ZW06IHN0YWZmSXRlbSxcbiAgICAvLyBFeHRyYSBzYWZldHk6IGRvbid0IG92ZXJ3cml0ZSBhbiBleGlzdGluZyBQSy9TS1xuICAgIENvbmRpdGlvbkV4cHJlc3Npb246XG4gICAgICAnYXR0cmlidXRlX25vdF9leGlzdHMoI3BrKSBBTkQgYXR0cmlidXRlX25vdF9leGlzdHMoI3NrKScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICcjc2snOiBTS19OQU1FLFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKHB1dENtZCk7XG5cbiAgcmV0dXJuIHN0YWZmSXRlbTtcbn1cbiJdfQ==