"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.listOrganizations = listOrganizations;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const organization_1 = require("../constants/organization");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const handler = async (event) => {
    try {
        const list = await listOrganizations();
        const result = await Promise.all(list.map((org) => enrichOrganizationWithCounts(org)));
        return (0, api_1.apiResponse)(200, result);
    }
    catch (err) {
        console.error('Error in organizations handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// ===== Список организаций =====
async function listOrganizations() {
    const items = [];
    let ExclusiveStartKey = undefined;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :orgPk',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
            },
            ExpressionAttributeValues: {
                ':orgPk': organization_1.ORG_PK,
            },
            ExclusiveStartKey,
        }));
        if (res.Items && res.Items.length > 0) {
            items.push(...res.Items);
        }
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    return items;
}
const enrichOrganizationWithCounts = async (org) => {
    const orgId = orgSortKeyToId(org.sort_key);
    const projectsCount = await getProjectCountForOrg(orgId);
    const count = {
        organizationUsers: 0, // TODO:
        projects: projectsCount,
    };
    return {
        ...org,
        _count: count,
        id: orgId,
    };
};
const orgSortKeyToId = (sortKey) => {
    return sortKey.split('#')[1];
};
async function getProjectCountForOrg(orgId) {
    let count = 0;
    let ExclusiveStartKey = undefined;
    const skPrefix = `${orgId}#`;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :projectPk AND begins_with(#sk, :skPrefix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':projectPk': organization_1.PROJECT_PK,
                ':skPrefix': skPrefix,
            },
            Select: 'COUNT',
            ExclusiveStartKey,
        }));
        count += res.Count ?? 0;
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    return count;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LW9yZ2FuaXphdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQtb3JnYW5pemF0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUEwQ0EsOENBMkJDO0FBcEVELDhEQUEwRDtBQUMxRCx3REFBNkU7QUFDN0UsNERBQStEO0FBQy9ELGdEQUF1RDtBQUN2RCx3Q0FBNkM7QUFFN0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtLQUM1QjtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVNLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQWlCLEVBQUUsQ0FBQztRQUV2QyxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQzlCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLDRCQUE0QixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ3JELENBQUM7UUFFRixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdB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QUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBPUkdfUEssIFBST0pFQ1RfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvb3JnYW5pemF0aW9uJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gIH0sXG59KTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5cbmlmICghREJfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RCX1RBQkxFX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgbGlzdCA9IGF3YWl0IGxpc3RPcmdhbml6YXRpb25zKCk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGxpc3QubWFwKChvcmcpID0+IGVucmljaE9yZ2FuaXphdGlvbldpdGhDb3VudHMob3JnKSksXG4gICAgKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHJlc3VsdCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIG9yZ2FuaXphdGlvbnMgaGFuZGxlcjonLCBlcnIpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgZXJyb3I6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vID09PT09INCh0L/QuNGB0L7QuiDQvtGA0LPQsNC90LjQt9Cw0YbQuNC5ID09PT09XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaXN0T3JnYW5pemF0aW9ucygpIHtcbiAgY29uc3QgaXRlbXM6IGFueVtdID0gW107XG4gIGxldCBFeGNsdXNpdmVTdGFydEtleTogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICBkbyB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnI3BrID0gOm9yZ1BrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICAgJyNwayc6IFBLX05BTUUsXG4gICAgICAgIH0sXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOm9yZ1BrJzogT1JHX1BLLFxuICAgICAgICB9LFxuICAgICAgICBFeGNsdXNpdmVTdGFydEtleSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBpZiAocmVzLkl0ZW1zICYmIHJlcy5JdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICBpdGVtcy5wdXNoKC4uLnJlcy5JdGVtcyk7XG4gICAgfVxuXG4gICAgRXhjbHVzaXZlU3RhcnRLZXkgPSByZXMuTGFzdEV2YWx1YXRlZEtleSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xuICB9IHdoaWxlIChFeGNsdXNpdmVTdGFydEtleSk7XG5cbiAgcmV0dXJuIGl0ZW1zO1xufVxuXG50eXBlIE9yZ0l0ZW0gPSB7XG4gIHNvcnRfa2V5OiBzdHJpbmc7XG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn07XG5cbmNvbnN0IGVucmljaE9yZ2FuaXphdGlvbldpdGhDb3VudHMgPSBhc3luYyAob3JnOiBPcmdJdGVtKSA9PiB7XG4gIGNvbnN0IG9yZ0lkID0gb3JnU29ydEtleVRvSWQob3JnLnNvcnRfa2V5KTtcblxuICBjb25zdCBwcm9qZWN0c0NvdW50ID0gYXdhaXQgZ2V0UHJvamVjdENvdW50Rm9yT3JnKG9yZ0lkKTtcblxuICBjb25zdCBjb3VudCA9IHtcbiAgICBvcmdhbml6YXRpb25Vc2VyczogMCwgLy8gVE9ETzpcbiAgICBwcm9qZWN0czogcHJvamVjdHNDb3VudCxcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIC4uLm9yZyxcbiAgICBfY291bnQ6IGNvdW50LFxuICAgIGlkOiBvcmdJZCxcbiAgfTtcbn07XG5cbmNvbnN0IG9yZ1NvcnRLZXlUb0lkID0gKHNvcnRLZXk6IHN0cmluZykgPT4ge1xuICByZXR1cm4gc29ydEtleS5zcGxpdCgnIycpWzFdO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdENvdW50Rm9yT3JnKG9yZ0lkOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICBsZXQgY291bnQgPSAwO1xuICBsZXQgRXhjbHVzaXZlU3RhcnRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgY29uc3Qgc2tQcmVmaXggPSBgJHtvcmdJZH0jYDtcblxuICBkbyB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOlxuICAgICAgICAgICcjcGsgPSA6cHJvamVjdFBrIEFORCBiZWdpbnNfd2l0aCgjc2ssIDpza1ByZWZpeCknLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICAgICAnI3NrJzogU0tfTkFNRSxcbiAgICAgICAgfSxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICc6cHJvamVjdFBrJzogUFJPSkVDVF9QSyxcbiAgICAgICAgICAnOnNrUHJlZml4Jzogc2tQcmVmaXgsXG4gICAgICAgIH0sXG4gICAgICAgIFNlbGVjdDogJ0NPVU5UJyxcbiAgICAgICAgRXhjbHVzaXZlU3RhcnRLZXksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY291bnQgKz0gcmVzLkNvdW50ID8/IDA7XG4gICAgRXhjbHVzaXZlU3RhcnRLZXkgPSByZXMuTGFzdEV2YWx1YXRlZEtleSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xuICB9IHdoaWxlIChFeGNsdXNpdmVTdGFydEtleSk7XG5cbiAgcmV0dXJuIGNvdW50O1xufSJdfQ==