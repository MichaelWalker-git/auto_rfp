"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.getOrganizationById = getOrganizationById;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const organization_1 = require("../constants/organization");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
// --- DynamoDB setup ---
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const handler = async (event) => {
    try {
        const orgId = event.pathParameters?.id || event.pathParameters?.orgId;
        if (!orgId) {
            return (0, api_1.apiResponse)(400, { message: 'Missing required path parameter: id' });
        }
        const orgItem = await getOrganizationById(orgId);
        if (!orgItem) {
            return (0, api_1.apiResponse)(404, { message: 'Organization not found' });
        }
        const enriched = enrichUsersCount(orgItem);
        return (0, api_1.apiResponse)(200, enriched);
    }
    catch (err) {
        console.error('Error in getOrganizationById handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
async function getOrganizationById(orgId) {
    const res = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: organization_1.ORG_PK,
            [common_1.SK_NAME]: `ORG#${orgId}`,
        },
    }));
    return res.Item;
}
const enrichUsersCount = (org) => {
    const count = {
        organizationUsers: 0,
        projects: 0,
    };
    return {
        ...org,
        _count: count,
        id: orgSortKeyToId(org.sort_key),
    };
};
const orgSortKeyToId = (sortKey) => {
    return sortKey.split('#')[1];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LW9yZ2FuaXphdGlvbi1ieS1pZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1vcmdhbml6YXRpb24tYnktaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBeURBLGtEQWNDO0FBbkVELDhEQUEwRDtBQUMxRCx3REFHK0I7QUFDL0IsNERBQW1EO0FBQ25ELGdEQUF1RDtBQUN2RCx3Q0FBNkM7QUFHN0MseUJBQXlCO0FBQ3pCLE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUVoRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO0FBQ25FLENBQUM7QUFFTSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLEVBQUUsSUFBSSxLQUFLLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQztRQUV0RSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUscUNBQXFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWpELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUM7UUFDakUsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTNDLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUNBQXVDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFNUQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSx1QkFBdUI7WUFDaEMsS0FBSyxFQUFFLEdBQUcsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7U0FDNUQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQztBQTNCVyxRQUFBLE9BQU8sV0EyQmxCO0FBRUssS0FBSyxVQUFVLG1CQUFtQixDQUN2QyxLQUFhO0lBRWIsTUFBTSxHQUFHLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUM5QixJQUFJLHlCQUFVLENBQUM7UUFDYixTQUFTLEVBQUUsYUFBYTtRQUN4QixHQUFHLEVBQUU7WUFDSCxDQUFDLGdCQUFPLENBQUMsRUFBRSxxQkFBTTtZQUNqQixDQUFDLGdCQUFPLENBQUMsRUFBRSxPQUFPLEtBQUssRUFBRTtTQUMxQjtLQUNGLENBQUMsQ0FDSCxDQUFDO0lBRUYsT0FBTyxHQUFHLENBQUMsSUFBb0MsQ0FBQztBQUNsRCxDQUFDO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEdBQTRDLEVBQUUsRUFBRTtJQUN4RSxNQUFNLEtBQUssR0FBRztRQUNaLGlCQUFpQixFQUFFLENBQUM7UUFDcEIsUUFBUSxFQUFFLENBQUM7S0FDWixDQUFDO0lBRUYsT0FBTztRQUNMLEdBQUcsR0FBRztRQUNOLE1BQU0sRUFBRSxLQUFLO1FBQ2IsRUFBRSxFQUFFLGNBQWMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO0tBQ2pDLENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUFDLE9BQWUsRUFBRSxFQUFFO0lBQ3pDLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHRWMixcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBHZXRDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgT1JHX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL29yZ2FuaXphdGlvbic7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB0eXBlIHsgT3JnYW5pemF0aW9uSXRlbSB9IGZyb20gJy4uL3NjaGVtYXMvb3JnYW5pemF0aW9uJztcblxuLy8gLS0tIER5bmFtb0RCIHNldHVwIC0tLVxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IG9yZ0lkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LmlkIHx8IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5vcmdJZDtcblxuICAgIGlmICghb3JnSWQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ01pc3NpbmcgcmVxdWlyZWQgcGF0aCBwYXJhbWV0ZXI6IGlkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBvcmdJdGVtID0gYXdhaXQgZ2V0T3JnYW5pemF0aW9uQnlJZChvcmdJZCk7XG5cbiAgICBpZiAoIW9yZ0l0ZW0pIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDQsIHsgbWVzc2FnZTogJ09yZ2FuaXphdGlvbiBub3QgZm91bmQnIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGVucmljaGVkID0gZW5yaWNoVXNlcnNDb3VudChvcmdJdGVtKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIGVucmljaGVkKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZ2V0T3JnYW5pemF0aW9uQnlJZCBoYW5kbGVyOicsIGVycik7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0T3JnYW5pemF0aW9uQnlJZChcbiAgb3JnSWQ6IHN0cmluZyxcbik6IFByb21pc2U8T3JnYW5pemF0aW9uSXRlbSB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgW1BLX05BTUVdOiBPUkdfUEssXG4gICAgICAgIFtTS19OQU1FXTogYE9SRyMke29yZ0lkfWAsXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuXG4gIHJldHVybiByZXMuSXRlbSBhcyBPcmdhbml6YXRpb25JdGVtIHwgdW5kZWZpbmVkO1xufVxuXG5jb25zdCBlbnJpY2hVc2Vyc0NvdW50ID0gKG9yZzogT3JnYW5pemF0aW9uSXRlbSAmIHsgc29ydF9rZXk6IHN0cmluZyB9KSA9PiB7XG4gIGNvbnN0IGNvdW50ID0ge1xuICAgIG9yZ2FuaXphdGlvblVzZXJzOiAwLFxuICAgIHByb2plY3RzOiAwLFxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgLi4ub3JnLFxuICAgIF9jb3VudDogY291bnQsXG4gICAgaWQ6IG9yZ1NvcnRLZXlUb0lkKG9yZy5zb3J0X2tleSksXG4gIH07XG59O1xuXG5jb25zdCBvcmdTb3J0S2V5VG9JZCA9IChzb3J0S2V5OiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIHNvcnRLZXkuc3BsaXQoJyMnKVsxXTtcbn07XG4iXX0=