"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.getProjectById = getProjectById;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const handler = async (event) => {
    try {
        const { id: projectId } = event.pathParameters || {};
        if (!projectId) {
            return (0, api_1.apiResponse)(400, {
                message: 'Missing required query parameter: projectId',
            });
        }
        const project = await getProjectById(projectId);
        if (!project) {
            return (0, api_1.apiResponse)(404, { message: 'Project not found' });
        }
        return (0, api_1.apiResponse)(200, project);
    }
    catch (err) {
        console.error('Error in getProjectById handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
async function getProjectById(projectId) {
    const items = [];
    let ExclusiveStartKey = undefined;
    // Suffix used in SK: "<orgId>#<projectId>"
    const idSuffix = `#${projectId}`;
    do {
        const res = await docClient.send(new lib_dynamodb_1.ScanCommand({
            TableName: DB_TABLE_NAME,
            FilterExpression: '#pk = :pkValue AND contains(#sk, :idSuffix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':pkValue': organization_1.PROJECT_PK,
                ':idSuffix': idSuffix,
            },
            ExclusiveStartKey,
        }));
        if (res.Items && res.Items.length > 0) {
            items.push(...res.Items);
        }
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    if (items.length === 0) {
        return null;
    }
    // From filtered results, pick the one whose SK really ends with "#<projectId>"
    const exact = items.find((item) => {
        const sk = item[common_1.SK_NAME];
        return typeof sk === 'string' && sk.endsWith(idSuffix);
    });
    return exact ?? null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXByb2plY3QtYnktaWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQtcHJvamVjdC1ieS1pZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUF1REEsd0NBMENDO0FBN0ZELDhEQUEwRDtBQUMxRCx3REFHK0I7QUFFL0IsZ0RBQXVEO0FBQ3ZELDREQUF1RDtBQUN2RCx3Q0FBNkM7QUFFN0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtLQUM1QjtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVNLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEdBQUcsS0FBSyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUM7UUFFckQsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2YsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsNkNBQTZDO2FBQ3ZELENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQzVELENBQUM7UUFFRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUExQlcsUUFBQSxPQUFPLFdBMEJsQjtBQUVLLEtBQUssVUFBVSxjQUFjLENBQUMsU0FBaUI7SUFDcEQsTUFBTSxLQUFLLEdBQVUsRUFBRSxDQUFDO0lBQ3hCLElBQUksaUJBQWlCLEdBQW9DLFNBQVMsQ0FBQztJQUVuRSwyQ0FBMkM7SUFDM0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUVqQyxHQUFHLENBQUM7UUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQzlCLElBQUksMEJBQVcsQ0FBQztZQUNkLFNBQVMsRUFBRSxhQUFhO1lBQ3hCLGdCQUFnQixFQUFFLDZDQUE2QztZQUMvRCx3QkFBd0IsRUFBRTtnQkFDeEIsS0FBSyxFQUFFLGdCQUFPO2dCQUNkLEtBQUssRUFBRSxnQkFBTzthQUNmO1lBQ0QseUJBQXlCLEVBQUU7Z0JBQ3pCLFVBQVUsRUFBRSx5QkFBVTtnQkFDdEIsV0FBVyxFQUFFLFFBQVE7YUFDdEI7WUFDRCxpQkFBaUI7U0FDbEIsQ0FBQyxDQUNILENBQUM7UUFFRixJQUFJLEdBQUcsQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdEMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixDQUFDO1FBRUQsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLGdCQUFtRCxDQUFDO0lBQzlFLENBQUMsUUFBUSxpQkFBaUIsRUFBRTtJQUU1QixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDdkIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsK0VBQStFO0lBQy9FLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUNoQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQU8sQ0FBQyxDQUFDO1FBQ3pCLE9BQU8sT0FBTyxFQUFFLEtBQUssUUFBUSxJQUFJLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUM7QUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4gIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFNjYW5Db21tYW5kLCAvLyDirIXvuI8gdXNlIFNjYW5Db21tYW5kIGluc3RlYWQgb2YgUXVlcnlDb21tYW5kXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFBST0pFQ1RfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvb3JnYW5pemF0aW9uJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gIH0sXG59KTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5cbmlmICghREJfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RCX1RBQkxFX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZDogcHJvamVjdElkIH0gPSBldmVudC5wYXRoUGFyYW1ldGVycyB8fCB7fTtcblxuICAgIGlmICghcHJvamVjdElkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdNaXNzaW5nIHJlcXVpcmVkIHF1ZXJ5IHBhcmFtZXRlcjogcHJvamVjdElkJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHByb2plY3QgPSBhd2FpdCBnZXRQcm9qZWN0QnlJZChwcm9qZWN0SWQpO1xuXG4gICAgaWYgKCFwcm9qZWN0KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDA0LCB7IG1lc3NhZ2U6ICdQcm9qZWN0IG5vdCBmb3VuZCcgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwgcHJvamVjdCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGdldFByb2plY3RCeUlkIGhhbmRsZXI6JywgZXJyKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdEJ5SWQocHJvamVjdElkOiBzdHJpbmcpOiBQcm9taXNlPGFueSB8IG51bGw+IHtcbiAgY29uc3QgaXRlbXM6IGFueVtdID0gW107XG4gIGxldCBFeGNsdXNpdmVTdGFydEtleTogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICAvLyBTdWZmaXggdXNlZCBpbiBTSzogXCI8b3JnSWQ+Izxwcm9qZWN0SWQ+XCJcbiAgY29uc3QgaWRTdWZmaXggPSBgIyR7cHJvamVjdElkfWA7XG5cbiAgZG8ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFNjYW5Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnI3BrID0gOnBrVmFsdWUgQU5EIGNvbnRhaW5zKCNzaywgOmlkU3VmZml4KScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgICAgICcjc2snOiBTS19OQU1FLFxuICAgICAgICB9LFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwa1ZhbHVlJzogUFJPSkVDVF9QSyxcbiAgICAgICAgICAnOmlkU3VmZml4JzogaWRTdWZmaXgsXG4gICAgICAgIH0sXG4gICAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGlmIChyZXMuSXRlbXMgJiYgcmVzLkl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIGl0ZW1zLnB1c2goLi4ucmVzLkl0ZW1zKTtcbiAgICB9XG5cbiAgICBFeGNsdXNpdmVTdGFydEtleSA9IHJlcy5MYXN0RXZhbHVhdGVkS2V5IGFzIFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG4gIH0gd2hpbGUgKEV4Y2x1c2l2ZVN0YXJ0S2V5KTtcblxuICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvLyBGcm9tIGZpbHRlcmVkIHJlc3VsdHMsIHBpY2sgdGhlIG9uZSB3aG9zZSBTSyByZWFsbHkgZW5kcyB3aXRoIFwiIzxwcm9qZWN0SWQ+XCJcbiAgY29uc3QgZXhhY3QgPSBpdGVtcy5maW5kKChpdGVtKSA9PiB7XG4gICAgY29uc3Qgc2sgPSBpdGVtW1NLX05BTUVdO1xuICAgIHJldHVybiB0eXBlb2Ygc2sgPT09ICdzdHJpbmcnICYmIHNrLmVuZHNXaXRoKGlkU3VmZml4KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGV4YWN0ID8/IG51bGw7XG59XG4iXX0=