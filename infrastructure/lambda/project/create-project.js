"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = exports.CreateProjectSchema = void 0;
exports.createProject = createProject;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const zod_1 = require("zod");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --------- Zod schema & types ---------
exports.CreateProjectSchema = zod_1.z.object({
    orgId: zod_1.z.string().min(1, 'Organization ID is required'),
    name: zod_1.z.string().min(1, 'Project name is required'),
    description: zod_1.z.string().optional(),
});
// --------- Lambda handler ---------
const handler = async (event) => {
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Validate with Zod
        const validationResult = exports.CreateProjectSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const dto = validationResult.data;
        // 2. Create project
        const project = await createProject(dto);
        return (0, api_1.apiResponse)(201, project);
    }
    catch (err) {
        console.error('Error in createProject handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --------- Business logic ---------
async function createProject(dto) {
    const { orgId, name, description } = dto;
    const now = new Date().toISOString();
    const projectId = (0, uuid_1.v4)();
    // Composite sort key: orgId + projectId
    // Compatible with listProjects() which uses begins_with(SK, orgId)
    const sortKey = `${orgId}#${projectId}`;
    const projectItem = {
        [common_1.PK_NAME]: organization_1.PROJECT_PK,
        [common_1.SK_NAME]: sortKey,
        id: projectId,
        orgId,
        name,
        description,
        createdAt: now,
        updatedAt: now,
    };
    const cmd = new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: projectItem,
        // Optional safety: don't overwrite if somehow exists already
        ConditionExpression: 'attribute_not_exists(#pk) AND attribute_not_exists(#sk)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
    });
    await docClient.send(cmd);
    return projectItem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXByb2plY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcmVhdGUtcHJvamVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFnR0Esc0NBb0NDO0FBaElELDhEQUEwRDtBQUMxRCx3REFHK0I7QUFDL0IsK0JBQW9DO0FBQ3BDLDZCQUF3QjtBQUV4QixnREFBdUQ7QUFDdkQsNERBQXVEO0FBQ3ZELHdDQUE2QztBQUU3QyxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUU7UUFDZixxQkFBcUIsRUFBRSxJQUFJO0tBQzVCO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7QUFFaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUNuRSxDQUFDO0FBRUQseUNBQXlDO0FBRTVCLFFBQUEsbUJBQW1CLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMxQyxLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsNkJBQTZCLENBQUM7SUFDdkQsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLDBCQUEwQixDQUFDO0lBQ25ELFdBQVcsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ25DLENBQUMsQ0FBQztBQVlILHFDQUFxQztBQUU5QixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hCLE9BQU8sSUFB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S0FDRixDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFMUIsT0FBTyxXQUFXLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4gIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFB1dENvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBQUk9KRUNUX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL29yZ2FuaXphdGlvbic7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuLy8gLS0tLS0tLS0tIFpvZCBzY2hlbWEgJiB0eXBlcyAtLS0tLS0tLS1cblxuZXhwb3J0IGNvbnN0IENyZWF0ZVByb2plY3RTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIG9yZ0lkOiB6LnN0cmluZygpLm1pbigxLCAnT3JnYW5pemF0aW9uIElEIGlzIHJlcXVpcmVkJyksXG4gIG5hbWU6IHouc3RyaW5nKCkubWluKDEsICdQcm9qZWN0IG5hbWUgaXMgcmVxdWlyZWQnKSxcbiAgZGVzY3JpcHRpb246IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pO1xuXG5leHBvcnQgdHlwZSBDcmVhdGVQcm9qZWN0RFRPID0gei5pbmZlcjx0eXBlb2YgQ3JlYXRlUHJvamVjdFNjaGVtYT47XG5cbmV4cG9ydCB0eXBlIFByb2plY3RJdGVtID0gQ3JlYXRlUHJvamVjdERUTyAmIHtcbiAgW1BLX05BTUVdOiBzdHJpbmc7XG4gIFtTS19OQU1FXTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbiAgdXBkYXRlZEF0OiBzdHJpbmc7XG59O1xuXG4vLyAtLS0tLS0tLS0gTGFtYmRhIGhhbmRsZXIgLS0tLS0tLS0tXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByYXdCb2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcblxuICAgIC8vIDEuIFZhbGlkYXRlIHdpdGggWm9kXG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IENyZWF0ZVByb2plY3RTY2hlbWEuc2FmZVBhcnNlKHJhd0JvZHkpO1xuXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGVycm9yRGV0YWlscyA9IHZhbGlkYXRpb25SZXN1bHQuZXJyb3IuaXNzdWVzLm1hcCgoaXNzdWUpID0+ICh7XG4gICAgICAgIHBhdGg6IGlzc3VlLnBhdGguam9pbignLicpLFxuICAgICAgICBtZXNzYWdlOiBpc3N1ZS5tZXNzYWdlLFxuICAgICAgfSkpO1xuXG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGVycm9yczogZXJyb3JEZXRhaWxzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZHRvOiBDcmVhdGVQcm9qZWN0RFRPID0gdmFsaWRhdGlvblJlc3VsdC5kYXRhO1xuXG4gICAgLy8gMi4gQ3JlYXRlIHByb2plY3RcbiAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgY3JlYXRlUHJvamVjdChkdG8pO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMSwgcHJvamVjdCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGNyZWF0ZVByb2plY3QgaGFuZGxlcjonLCBlcnIpO1xuXG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG4vLyAtLS0tLS0tLS0gQnVzaW5lc3MgbG9naWMgLS0tLS0tLS0tXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVQcm9qZWN0KGR0bzogQ3JlYXRlUHJvamVjdERUTyk6IFByb21pc2U8UHJvamVjdEl0ZW0+IHtcbiAgY29uc3QgeyBvcmdJZCwgbmFtZSwgZGVzY3JpcHRpb24gfSA9IGR0bztcblxuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gIGNvbnN0IHByb2plY3RJZCA9IHV1aWR2NCgpO1xuXG4gIC8vIENvbXBvc2l0ZSBzb3J0IGtleTogb3JnSWQgKyBwcm9qZWN0SWRcbiAgLy8gQ29tcGF0aWJsZSB3aXRoIGxpc3RQcm9qZWN0cygpIHdoaWNoIHVzZXMgYmVnaW5zX3dpdGgoU0ssIG9yZ0lkKVxuICBjb25zdCBzb3J0S2V5ID0gYCR7b3JnSWR9IyR7cHJvamVjdElkfWA7XG5cbiAgY29uc3QgcHJvamVjdEl0ZW06IFByb2plY3RJdGVtID0ge1xuICAgIFtQS19OQU1FXTogUFJPSkVDVF9QSyxcbiAgICBbU0tfTkFNRV06IHNvcnRLZXksXG4gICAgaWQ6IHByb2plY3RJZCxcbiAgICBvcmdJZCxcbiAgICBuYW1lLFxuICAgIGRlc2NyaXB0aW9uLFxuICAgIGNyZWF0ZWRBdDogbm93LFxuICAgIHVwZGF0ZWRBdDogbm93LFxuICB9O1xuXG4gIGNvbnN0IGNtZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgSXRlbTogcHJvamVjdEl0ZW0sXG4gICAgLy8gT3B0aW9uYWwgc2FmZXR5OiBkb24ndCBvdmVyd3JpdGUgaWYgc29tZWhvdyBleGlzdHMgYWxyZWFkeVxuICAgIENvbmRpdGlvbkV4cHJlc3Npb246XG4gICAgICAnYXR0cmlidXRlX25vdF9leGlzdHMoI3BrKSBBTkQgYXR0cmlidXRlX25vdF9leGlzdHMoI3NrKScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICcjc2snOiBTS19OQU1FLFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNtZCk7XG5cbiAgcmV0dXJuIHByb2plY3RJdGVtO1xufVxuIl19