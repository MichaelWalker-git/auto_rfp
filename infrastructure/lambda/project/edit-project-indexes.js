"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const zod_1 = require("zod");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({}), {
    marshallOptions: { removeUndefinedValues: true },
});
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const UpdateIndexesSchema = zod_1.z.object({
    indexIds: zod_1.z.array(zod_1.z.string()),
});
const handler = async (event) => {
    try {
        const projectId = event.pathParameters?.projectId;
        if (!projectId)
            return (0, api_1.apiResponse)(400, { error: 'projectId is required' });
        if (!event.body)
            return (0, api_1.apiResponse)(400, { error: 'Missing body' });
        const parsed = UpdateIndexesSchema.safeParse(JSON.parse(event.body));
        if (!parsed.success) {
            return (0, api_1.apiResponse)(400, { error: parsed.error.message });
        }
        const { indexIds } = parsed.data;
        const project = await getProject(projectId);
        if (!project)
            return (0, api_1.apiResponse)(404, { error: 'Project not found' });
        if (indexIds.length === 0) {
            await removeAllProjectIndexes(projectId);
            return (0, api_1.apiResponse)(200, {
                success: true,
                projectIndexes: [],
            });
        }
        // Fetch available OpenSearch indexes
        const availableIndexes = await fetchOpenSearchIndexes();
        const availIds = new Set(availableIndexes.map((i) => i.index));
        // Validate
        const invalid = indexIds.filter((id) => !availIds.has(id));
        if (invalid.length > 0) {
            return (0, api_1.apiResponse)(400, {
                error: `Invalid OpenSearch index IDs: ${invalid.join(', ')}`,
            });
        }
        // Remove old
        await removeAllProjectIndexes(projectId);
        // Add new refs
        for (const id of indexIds) {
            await ddb.send(new lib_dynamodb_1.PutCommand({
                TableName: process.env.DB_TABLE_NAME,
                Item: {
                    [common_1.PK_NAME]: organization_1.PROJECT_INDEX_PK,
                    [common_1.SK_NAME]: `${projectId}#${id}`,
                    projectId,
                    indexId: id,
                    indexName: id,
                },
            }));
        }
        return (0, api_1.apiResponse)(200, {
            success: true,
            projectIndexes: indexIds.map((id) => ({ id, name: id })),
        });
    }
    catch (err) {
        console.error('Error updating project indexes:', err);
        return (0, api_1.apiResponse)(500, { error: 'Internal server error' });
    }
};
exports.handler = handler;
// ---- helpers ----
async function getProject(projectId) {
    const idSuffix = `#${projectId}`;
    const res = await ddb.send(new lib_dynamodb_1.QueryCommand({
        TableName: process.env.DB_TABLE_NAME,
        KeyConditionExpression: '#pk = :pk',
        FilterExpression: 'contains(#sk, :suffix)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
        ExpressionAttributeValues: {
            ':pk': organization_1.PROJECT_PK,
            ':suffix': idSuffix,
        },
    }));
    return res.Items?.find((i) => i[common_1.SK_NAME].endsWith(idSuffix)) ?? null;
}
async function removeAllProjectIndexes(projectId) {
    const res = await ddb.send(new lib_dynamodb_1.QueryCommand({
        TableName: process.env.DB_TABLE_NAME,
        KeyConditionExpression: '#pk = :pk AND begins_with(#sk, :prefix)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
        ExpressionAttributeValues: {
            ':pk': organization_1.PROJECT_INDEX_PK,
            ':prefix': `${projectId}#`,
        },
    }));
    for (const item of res.Items ?? []) {
        await ddb.send(new lib_dynamodb_1.DeleteCommand({
            TableName: process.env.DB_TABLE_NAME,
            Key: {
                [common_1.PK_NAME]: organization_1.PROJECT_INDEX_PK,
                [common_1.SK_NAME]: item[common_1.SK_NAME],
            },
        }));
    }
}
async function fetchOpenSearchIndexes() {
    const response = await fetch(`${OPENSEARCH_ENDPOINT}/_cat/indices?format=json`);
    if (!response.ok)
        throw new Error('Failed to fetch OpenSearch indexes');
    return response.json();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC1wcm9qZWN0LWluZGV4ZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJlZGl0LXByb2plY3QtaW5kZXhlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFJQSx3REFBd0c7QUFDeEcsd0NBQTZDO0FBQzdDLDZCQUF3QjtBQUN4QixnREFBdUQ7QUFDdkQsNERBQXlFO0FBQ3pFLDhEQUEwRDtBQUUxRCxNQUFNLEdBQUcsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0lBQzlELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFFSCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFFNUQsTUFBTSxtQkFBbUIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ25DLFFBQVEsRUFBRSxPQUFDLENBQUMsS0FBSyxDQUFDLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztDQUM5QixDQUFDLENBQUM7QUFFSSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQztRQUNsRCxJQUFJLENBQUMsU0FBUztZQUFFLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7UUFFNUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQUUsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFFcEUsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFRCxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUVqQyxNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTztZQUFFLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxDQUFDLENBQUM7UUFFdEUsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzFCLE1BQU0sdUJBQXVCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekMsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsSUFBSTtnQkFDYixjQUFjLEVBQUUsRUFBRTthQUNuQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQscUNBQXFDO1FBQ3JDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxzQkFBc0IsRUFBRSxDQUFDO1FBQ3hELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFcEUsV0FBVztRQUNYLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzNELElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN2QixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLEtBQUssRUFBRSxpQ0FBaUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTthQUM3RCxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsYUFBYTtRQUNiLE1BQU0sdUJBQXVCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFekMsZUFBZTtRQUNmLEtBQUssTUFBTSxFQUFFLElBQUksUUFBUSxFQUFFLENBQUM7WUFDMUIsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUNaLElBQUkseUJBQVUsQ0FBQztnQkFDYixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjO2dCQUNyQyxJQUFJLEVBQUU7b0JBQ0osQ0FBQyxnQkFBTyxDQUFDLEVBQUUsK0JBQWdCO29CQUMzQixDQUFDLGdCQUFPLENBQUMsRUFBRSxHQUFHLFNBQVMsSUFBSSxFQUFFLEVBQUU7b0JBQy9CLFNBQVM7b0JBQ1QsT0FBTyxFQUFFLEVBQUU7b0JBQ1gsU0FBUyxFQUFFLEVBQUU7aUJBQ2Q7YUFDRixDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLElBQUk7WUFDYixjQUFjLEVBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUN6RCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdEQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztJQUM5RCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBbEVXLFFBQUEsT0FBTyxXQWtFbEI7QUFFRixvQkFBb0I7QUFFcEIsS0FBSyxVQUFVLFVBQVUsQ0FBQyxTQUFpQjtJQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO0lBQ2pDLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FDeEIsSUFBSSwyQkFBWSxDQUFDO1FBQ2YsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYztRQUNyQyxzQkFBc0IsRUFBRSxXQUFXO1FBQ25DLGdCQUFnQixFQUFFLHdCQUF3QjtRQUMxQyx3QkFBd0IsRUFBRTtZQUN4QixLQUFLLEVBQUUsZ0JBQU87WUFDZCxLQUFLLEVBQUUsZ0JBQU87U0FDZjtRQUNELHlCQUF5QixFQUFFO1lBQ3pCLEtBQUssRUFBRSx5QkFBVTtZQUNqQixTQUFTLEVBQUUsUUFBUTtTQUNwQjtLQUNGLENBQUMsQ0FDSCxDQUFDO0lBRUYsT0FBTyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGdCQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7QUFDdkUsQ0FBQztBQUVELEtBQUssVUFBVSx1QkFBdUIsQ0FBQyxTQUFpQjtJQUN0RCxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ3hCLElBQUksMkJBQVksQ0FBQztRQUNmLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWM7UUFDckMsc0JBQXNCLEVBQUUseUNBQXlDO1FBQ2pFLHdCQUF3QixFQUFFO1lBQ3hCLEtBQUssRUFBRSxnQkFBTztZQUNkLEtBQUssRUFBRSxnQkFBTztTQUNmO1FBQ0QseUJBQXlCLEVBQUU7WUFDekIsS0FBSyxFQUFFLCtCQUFnQjtZQUN2QixTQUFTLEVBQUUsR0FBRyxTQUFTLEdBQUc7U0FDM0I7S0FDRixDQUFDLENBQ0gsQ0FBQztJQUVGLEtBQUssTUFBTSxJQUFJLElBQUksR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUNuQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ1osSUFBSSw0QkFBYSxDQUFDO1lBQ2hCLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWM7WUFDckMsR0FBRyxFQUFFO2dCQUNILENBQUMsZ0JBQU8sQ0FBQyxFQUFFLCtCQUFnQjtnQkFDM0IsQ0FBQyxnQkFBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLGdCQUFPLENBQUM7YUFDekI7U0FDRixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBRUQsS0FBSyxVQUFVLHNCQUFzQjtJQUNuQyxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLG1CQUFtQiwyQkFBMkIsQ0FBQyxDQUFDO0lBQ2hGLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUN4RSxPQUFPLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUN6QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbiAgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIsXG59IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgRGVsZXRlQ29tbWFuZCwgUHV0Q29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBQUk9KRUNUX1BLLCBQUk9KRUNUX0lOREVYX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL29yZ2FuaXphdGlvbic7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5cbmNvbnN0IGRkYiA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShuZXcgRHluYW1vREJDbGllbnQoe30pLCB7XG4gIG1hcnNoYWxsT3B0aW9uczogeyByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUgfSxcbn0pO1xuXG5jb25zdCBPUEVOU0VBUkNIX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9FTkRQT0lOVDtcblxuY29uc3QgVXBkYXRlSW5kZXhlc1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgaW5kZXhJZHM6IHouYXJyYXkoei5zdHJpbmcoKSksXG59KTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHByb2plY3RJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5wcm9qZWN0SWQ7XG4gICAgaWYgKCFwcm9qZWN0SWQpIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgZXJyb3I6ICdwcm9qZWN0SWQgaXMgcmVxdWlyZWQnIH0pO1xuXG4gICAgaWYgKCFldmVudC5ib2R5KSByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IGVycm9yOiAnTWlzc2luZyBib2R5JyB9KTtcblxuICAgIGNvbnN0IHBhcnNlZCA9IFVwZGF0ZUluZGV4ZXNTY2hlbWEuc2FmZVBhcnNlKEpTT04ucGFyc2UoZXZlbnQuYm9keSkpO1xuICAgIGlmICghcGFyc2VkLnN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgZXJyb3I6IHBhcnNlZC5lcnJvci5tZXNzYWdlIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgaW5kZXhJZHMgfSA9IHBhcnNlZC5kYXRhO1xuXG4gICAgY29uc3QgcHJvamVjdCA9IGF3YWl0IGdldFByb2plY3QocHJvamVjdElkKTtcbiAgICBpZiAoIXByb2plY3QpIHJldHVybiBhcGlSZXNwb25zZSg0MDQsIHsgZXJyb3I6ICdQcm9qZWN0IG5vdCBmb3VuZCcgfSk7XG5cbiAgICBpZiAoaW5kZXhJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBhd2FpdCByZW1vdmVBbGxQcm9qZWN0SW5kZXhlcyhwcm9qZWN0SWQpO1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBwcm9qZWN0SW5kZXhlczogW10sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBGZXRjaCBhdmFpbGFibGUgT3BlblNlYXJjaCBpbmRleGVzXG4gICAgY29uc3QgYXZhaWxhYmxlSW5kZXhlcyA9IGF3YWl0IGZldGNoT3BlblNlYXJjaEluZGV4ZXMoKTtcbiAgICBjb25zdCBhdmFpbElkcyA9IG5ldyBTZXQoYXZhaWxhYmxlSW5kZXhlcy5tYXAoKGk6IGFueSkgPT4gaS5pbmRleCkpO1xuXG4gICAgLy8gVmFsaWRhdGVcbiAgICBjb25zdCBpbnZhbGlkID0gaW5kZXhJZHMuZmlsdGVyKChpZCkgPT4gIWF2YWlsSWRzLmhhcyhpZCkpO1xuICAgIGlmIChpbnZhbGlkLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgZXJyb3I6IGBJbnZhbGlkIE9wZW5TZWFyY2ggaW5kZXggSURzOiAke2ludmFsaWQuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIG9sZFxuICAgIGF3YWl0IHJlbW92ZUFsbFByb2plY3RJbmRleGVzKHByb2plY3RJZCk7XG5cbiAgICAvLyBBZGQgbmV3IHJlZnNcbiAgICBmb3IgKGNvbnN0IGlkIG9mIGluZGV4SWRzKSB7XG4gICAgICBhd2FpdCBkZGIuc2VuZChcbiAgICAgICAgbmV3IFB1dENvbW1hbmQoe1xuICAgICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSEsXG4gICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgW1BLX05BTUVdOiBQUk9KRUNUX0lOREVYX1BLLFxuICAgICAgICAgICAgW1NLX05BTUVdOiBgJHtwcm9qZWN0SWR9IyR7aWR9YCxcbiAgICAgICAgICAgIHByb2plY3RJZCxcbiAgICAgICAgICAgIGluZGV4SWQ6IGlkLFxuICAgICAgICAgICAgaW5kZXhOYW1lOiBpZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHByb2plY3RJbmRleGVzOiBpbmRleElkcy5tYXAoKGlkKSA9PiAoeyBpZCwgbmFtZTogaWQgfSkpLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1cGRhdGluZyBwcm9qZWN0IGluZGV4ZXM6JywgZXJyKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcbiAgfVxufTtcblxuLy8gLS0tLSBoZWxwZXJzIC0tLS1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdChwcm9qZWN0SWQ6IHN0cmluZykge1xuICBjb25zdCBpZFN1ZmZpeCA9IGAjJHtwcm9qZWN0SWR9YDtcbiAgY29uc3QgcmVzID0gYXdhaXQgZGRiLnNlbmQoXG4gICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUUhLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNwayA9IDpwaycsXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnY29udGFpbnMoI3NrLCA6c3VmZml4KScsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNwayc6IFBLX05BTUUsXG4gICAgICAgICcjc2snOiBTS19OQU1FLFxuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IFBST0pFQ1RfUEssXG4gICAgICAgICc6c3VmZml4JzogaWRTdWZmaXgsXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuXG4gIHJldHVybiByZXMuSXRlbXM/LmZpbmQoKGkpID0+IGlbU0tfTkFNRV0uZW5kc1dpdGgoaWRTdWZmaXgpKSA/PyBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZW1vdmVBbGxQcm9qZWN0SW5kZXhlcyhwcm9qZWN0SWQ6IHN0cmluZykge1xuICBjb25zdCByZXMgPSBhd2FpdCBkZGIuc2VuZChcbiAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSEsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnI3BrID0gOnBrIEFORCBiZWdpbnNfd2l0aCgjc2ssIDpwcmVmaXgpJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICAgJyNzayc6IFNLX05BTUUsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBrJzogUFJPSkVDVF9JTkRFWF9QSyxcbiAgICAgICAgJzpwcmVmaXgnOiBgJHtwcm9qZWN0SWR9I2AsXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuXG4gIGZvciAoY29uc3QgaXRlbSBvZiByZXMuSXRlbXMgPz8gW10pIHtcbiAgICBhd2FpdCBkZGIuc2VuZChcbiAgICAgIG5ldyBEZWxldGVDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FISxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgW1BLX05BTUVdOiBQUk9KRUNUX0lOREVYX1BLLFxuICAgICAgICAgIFtTS19OQU1FXTogaXRlbVtTS19OQU1FXSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hPcGVuU2VhcmNoSW5kZXhlcygpIHtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtPUEVOU0VBUkNIX0VORFBPSU5UfS9fY2F0L2luZGljZXM/Zm9ybWF0PWpzb25gKTtcbiAgaWYgKCFyZXNwb25zZS5vaykgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggT3BlblNlYXJjaCBpbmRleGVzJyk7XG4gIHJldHVybiByZXNwb25zZS5qc29uKCk7XG59XG4iXX0=