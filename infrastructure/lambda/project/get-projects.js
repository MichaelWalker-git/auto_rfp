"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.listProjects = listProjects;
exports.allProjects = allProjects;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
const organization_1 = require("../constants/organization");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const handler = async (event) => {
    const { orgId } = event?.queryStringParameters || {};
    try {
        const list = orgId ? await listProjects(orgId) : await allProjects();
        return (0, api_1.apiResponse)(200, list);
    }
    catch (err) {
        console.error('Error in projects handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
async function listProjects(orgId) {
    const items = [];
    let ExclusiveStartKey = undefined;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :pkValue AND begins_with(#sk, :skPrefix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':pkValue': organization_1.PROJECT_PK,
                ':skPrefix': orgId,
            },
            ExclusiveStartKey,
        }));
        if (res.Items && res.Items.length > 0) {
            items.push(...res.Items);
        }
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    return items;
}
async function allProjects() {
    const items = [];
    let ExclusiveStartKey = undefined;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :pkValue',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
            },
            ExpressionAttributeValues: {
                ':pkValue': organization_1.PROJECT_PK,
            },
            ExclusiveStartKey,
        }));
        if (res.Items && res.Items.length > 0) {
            items.push(...res.Items);
        }
        ExclusiveStartKey = res.LastEvaluatedKey;
    } while (ExclusiveStartKey);
    return items;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXByb2plY3RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2V0LXByb2plY3RzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQWtDQSxvQ0ErQkM7QUFFRCxrQ0EyQkM7QUE3RkQsOERBQTBEO0FBQzFELHdEQUE4RTtBQUM5RSxnREFBdUQ7QUFDdkQsd0NBQTZDO0FBQzdDLDREQUF1RDtBQUV2RCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUU7UUFDZixxQkFBcUIsRUFBRSxJQUFJO0tBQzVCO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7QUFFaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUNuRSxDQUFDO0FBRU0sTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTZCLEVBQW9DLEVBQUU7SUFDL0YsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEtBQUssRUFBRSxxQkFBcUIsSUFBSSxFQUFFLENBQUM7SUFDckQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxXQUFXLEVBQUUsQ0FBQztRQUNyRSxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUFaVyxRQUFBLE9BQU8sV0FZbEI7QUFFSyxLQUFLLFVBQVUsWUFBWSxDQUFDLEtBQWE7SUFDOUMsTUFBTSxLQUFLLEdBQVUsRUFBRSxDQUFDO0lBQ3hCLElBQUksaUJBQWlCLEdBQW9DLFNBQVMsQ0FBQztJQUVuRSxHQUFHLENBQUM7UUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQzlCLElBQUksMkJBQVksQ0FBQztZQUNmLFNBQVMsRUFBRSxhQUFhO1lBRXhCLHNCQUFzQixFQUFFLGdEQUFnRDtZQUV4RSx3QkFBd0IsRUFBRTtnQkFDeEIsS0FBSyxFQUFFLGdCQUFPO2dCQUNkLEtBQUssRUFBRSxnQkFBTzthQUNmO1lBQ0QseUJBQXlCLEVBQUU7Z0JBQ3pCLFVBQVUsRUFBRSx5QkFBVTtnQkFDdEIsV0FBVyxFQUFFLEtBQUs7YUFDbkI7WUFDRCxpQkFBaUI7U0FDbEIsQ0FBQyxDQUNILENBQUM7UUFFRixJQUFJLEdBQUcsQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdEMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixDQUFDO1FBRUQsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLGdCQUFtRCxDQUFDO0lBQzlFLENBQUMsUUFBUSxpQkFBaUIsRUFBRTtJQUU1QixPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFTSxLQUFLLFVBQVUsV0FBVztJQUMvQixNQUFNLEtBQUssR0FBVSxFQUFFLENBQUM7SUFDeEIsSUFBSSxpQkFBaUIsR0FBb0MsU0FBUyxDQUFDO0lBRW5FLEdBQUcsQ0FBQztRQUNGLE1BQU0sR0FBRyxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDOUIsSUFBSSwyQkFBWSxDQUFDO1lBQ2YsU0FBUyxFQUFFLGFBQWE7WUFDeEIsc0JBQXNCLEVBQUUsZ0JBQWdCO1lBQ3hDLHdCQUF3QixFQUFFO2dCQUN4QixLQUFLLEVBQUUsZ0JBQU87YUFDZjtZQUNELHlCQUF5QixFQUFFO2dCQUN6QixVQUFVLEVBQUUseUJBQVU7YUFDdkI7WUFDRCxpQkFBaUI7U0FDbEIsQ0FBQyxDQUNILENBQUM7UUFFRixJQUFJLEdBQUcsQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdEMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixDQUFDO1FBRUQsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLGdCQUFtRCxDQUFDO0lBQzlFLENBQUMsUUFBUSxpQkFBaUIsRUFBRTtJQUU1QixPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBQUk9KRUNUX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL29yZ2FuaXphdGlvbic7XG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50LCB7XG4gIG1hcnNoYWxsT3B0aW9uczoge1xuICAgIHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSxcbiAgfSxcbn0pO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICBjb25zdCB7IG9yZ0lkIH0gPSBldmVudD8ucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuICB0cnkge1xuICAgIGNvbnN0IGxpc3QgPSBvcmdJZCA/IGF3YWl0IGxpc3RQcm9qZWN0cyhvcmdJZCkgOiBhd2FpdCBhbGxQcm9qZWN0cygpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIGxpc3QpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBwcm9qZWN0cyBoYW5kbGVyOicsIGVycik7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RQcm9qZWN0cyhvcmdJZDogc3RyaW5nKTogUHJvbWlzZTxhbnlbXT4ge1xuICBjb25zdCBpdGVtczogYW55W10gPSBbXTtcbiAgbGV0IEV4Y2x1c2l2ZVN0YXJ0S2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gIGRvIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG5cbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNwayA9IDpwa1ZhbHVlIEFORCBiZWdpbnNfd2l0aCgjc2ssIDpza1ByZWZpeCknLFxuXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgICAgICcjc2snOiBTS19OQU1FLFxuICAgICAgICB9LFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwa1ZhbHVlJzogUFJPSkVDVF9QSyxcbiAgICAgICAgICAnOnNrUHJlZml4Jzogb3JnSWQsXG4gICAgICAgIH0sXG4gICAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGlmIChyZXMuSXRlbXMgJiYgcmVzLkl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIGl0ZW1zLnB1c2goLi4ucmVzLkl0ZW1zKTtcbiAgICB9XG5cbiAgICBFeGNsdXNpdmVTdGFydEtleSA9IHJlcy5MYXN0RXZhbHVhdGVkS2V5IGFzIFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG4gIH0gd2hpbGUgKEV4Y2x1c2l2ZVN0YXJ0S2V5KTtcblxuICByZXR1cm4gaXRlbXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhbGxQcm9qZWN0cygpOiBQcm9taXNlPGFueVtdPiB7XG4gIGNvbnN0IGl0ZW1zOiBhbnlbXSA9IFtdO1xuICBsZXQgRXhjbHVzaXZlU3RhcnRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgZG8ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNwayA9IDpwa1ZhbHVlJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICAgJyNwayc6IFBLX05BTUUsXG4gICAgICAgIH0sXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOnBrVmFsdWUnOiBQUk9KRUNUX1BLLFxuICAgICAgICB9LFxuICAgICAgICBFeGNsdXNpdmVTdGFydEtleSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBpZiAocmVzLkl0ZW1zICYmIHJlcy5JdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICBpdGVtcy5wdXNoKC4uLnJlcy5JdGVtcyk7XG4gICAgfVxuXG4gICAgRXhjbHVzaXZlU3RhcnRLZXkgPSByZXMuTGFzdEV2YWx1YXRlZEtleSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xuICB9IHdoaWxlIChFeGNsdXNpdmVTdGFydEtleSk7XG5cbiAgcmV0dXJuIGl0ZW1zO1xufSJdfQ==