"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = exports.UpdateProjectSchema = void 0;
exports.updateProject = updateProject;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const zod_1 = require("zod");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const api_1 = require("../helpers/api");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --- Zod schema for updates (partial) ---
exports.UpdateProjectSchema = zod_1.z.object({
    name: zod_1.z.string().min(1, 'Project name cannot be empty').optional(),
    description: zod_1.z.string().optional(),
});
// --- Lambda handler ---
// Example route: PATCH /projects?orgId=...&projectId=...
const handler = async (event) => {
    try {
        const { orgId, projectId } = event.queryStringParameters || {};
        if (!orgId || !projectId) {
            return (0, api_1.apiResponse)(400, {
                message: 'Missing required query parameters: orgId and projectId',
            });
        }
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
        }
        const rawBody = JSON.parse(event.body);
        // 1. Validate body (partial)
        const validationResult = exports.UpdateProjectSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const dto = validationResult.data;
        // If nothing to update (empty body), you can either no-op or return 400
        if (!dto.name && dto.description === undefined) {
            return (0, api_1.apiResponse)(400, {
                message: 'No updatable fields provided',
            });
        }
        const updated = await updateProject(orgId, projectId, dto);
        return (0, api_1.apiResponse)(200, updated);
    }
    catch (err) {
        console.error('Error in updateProject handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        if (err?.name === 'ConditionalCheckFailedException') {
            return (0, api_1.apiResponse)(404, { message: 'Project not found' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- Business logic ---
async function updateProject(orgId, projectId, dto) {
    const now = new Date().toISOString();
    const key = {
        [common_1.PK_NAME]: organization_1.PROJECT_PK,
        [common_1.SK_NAME]: `${orgId}#${projectId}`, // same pattern as createProject
    };
    // Dynamic UpdateExpression
    const expressionAttributeNames = {
        '#updatedAt': 'updatedAt',
    };
    const expressionAttributeValues = {
        ':updatedAt': now,
    };
    const setExpressions = ['#updatedAt = :updatedAt'];
    if (dto.name !== undefined) {
        expressionAttributeNames['#name'] = 'name';
        expressionAttributeValues[':name'] = dto.name;
        setExpressions.push('#name = :name');
    }
    if (dto.description !== undefined) {
        expressionAttributeNames['#description'] = 'description';
        expressionAttributeValues[':description'] = dto.description;
        setExpressions.push('#description = :description');
    }
    const cmd = new lib_dynamodb_1.UpdateCommand({
        TableName: DB_TABLE_NAME,
        Key: key,
        UpdateExpression: 'SET ' + setExpressions.join(', '),
        ExpressionAttributeNames: {
            ...expressionAttributeNames,
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
        ExpressionAttributeValues: expressionAttributeValues,
        ConditionExpression: 'attribute_exists(#pk) AND attribute_exists(#sk)', // ensure project exists
        ReturnValues: 'ALL_NEW',
    });
    const res = await docClient.send(cmd);
    return res.Attributes; // will include id, orgId, etc. as stored
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC1wcm9qZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZWRpdC1wcm9qZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQXdHQSxzQ0FtREM7QUF2SkQsOERBQTBEO0FBQzFELHdEQUcrQjtBQUMvQiw2QkFBd0I7QUFFeEIsZ0RBQXVEO0FBQ3ZELDREQUF1RDtBQUN2RCx3Q0FBNkM7QUFFN0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtLQUM1QjtDQUNGLENBQUMsQ0FBQztBQUVILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELDJDQUEyQztBQUU5QixRQUFBLG1CQUFtQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDMUMsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLDhCQUE4QixDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ2xFLFdBQVcsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ25DLENBQUMsQ0FBQztBQUlILHlCQUF5QjtBQUN6Qix5REFBeUQ7QUFDbEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxLQUFLLENBQUMscUJBQXFCLElBQUksRUFBRSxDQUFDO1FBRS9ELElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUN6QixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSx3REFBd0Q7YUFDbEUsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdkMsNkJBQTZCO1FBQzdCLE1BQU0sZ0JBQWdCLEdBQUcsMkJBQW1CLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWhFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM5QixNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDakUsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztnQkFDMUIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2FBQ3ZCLENBQUMsQ0FBQyxDQUFDO1lBRUosT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsbUJBQW1CO2dCQUM1QixNQUFNLEVBQUUsWUFBWTthQUNyQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxHQUFHLEdBQXFCLGdCQUFnQixDQUFDLElBQUksQ0FBQztRQUVwRCx3RUFBd0U7UUFDeEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLFdBQVcsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUMvQyxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSw4QkFBOEI7YUFDeEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sYUFBYSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFM0QsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFBQyxPQUFPLEdBQVEsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFdEQsSUFBSSxHQUFHLFlBQVksV0FBVyxFQUFFLENBQUM7WUFDL0IsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLENBQUMsQ0FBQztRQUN2RSxDQUFDO1FBRUQsSUFBSSxHQUFHLEVBQUUsSUFBSSxLQUFLLGlDQUFpQyxFQUFFLENBQUM7WUFDcEQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRUQsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSx1QkFBdUI7WUFDaEMsS0FBSyxFQUFFLEdBQUcsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7U0FDNUQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQztBQTdEVyxRQUFBLE9BQU8sV0E2RGxCO0FBRUYseUJBQXlCO0FBRWxCLEtBQUssVUFBVSxhQUFhLENBQ2pDLEtBQWEsRUFDYixTQUFpQixFQUNqQixHQUFxQjtJQUVyQixNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXJDLE1BQU0sR0FBRyxHQUFHO1FBQ1YsQ0FBQyxnQkFBTyxDQUFDLEVBQUUseUJBQVU7UUFDckIsQ0FBQyxnQkFBTyxDQUFDLEVBQUUsR0FBRyxLQUFLLElBQUksU0FBUyxFQUFFLEVBQUUsZ0NBQWdDO0tBQ3JFLENBQUM7SUFFRiwyQkFBMkI7SUFDM0IsTUFBTSx3QkFBd0IsR0FBMkI7UUFDdkQsWUFBWSxFQUFFLFdBQVc7S0FDMUIsQ0FBQztJQUNGLE1BQU0seUJBQXlCLEdBQXdCO1FBQ3JELFlBQVksRUFBRSxHQUFHO0tBQ2xCLENBQUM7SUFDRixNQUFNLGNBQWMsR0FBYSxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFFN0QsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO1FBQzNCLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUMzQyx5QkFBeUIsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzlDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELElBQUksR0FBRyxDQUFDLFdBQVcsS0FBSyxTQUFTLEVBQUUsQ0FBQztRQUNsQyx3QkFBd0IsQ0FBQyxjQUFjLENBQUMsR0FBRyxhQUFhLENBQUM7UUFDekQseUJBQXlCLENBQUMsY0FBYyxDQUFDLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQztRQUM1RCxjQUFjLENBQUMsSUFBSSxDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELE1BQU0sR0FBRyxHQUFHLElBQUksNEJBQWEsQ0FBQztRQUM1QixTQUFTLEVBQUUsYUFBYTtRQUN4QixHQUFHLEVBQUUsR0FBRztRQUNSLGdCQUFnQixFQUFFLE1BQU0sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNwRCx3QkFBd0IsRUFBRTtZQUN4QixHQUFHLHdCQUF3QjtZQUMzQixLQUFLLEVBQUUsZ0JBQU87WUFDZCxLQUFLLEVBQUUsZ0JBQU87U0FDZjtRQUNELHlCQUF5QixFQUFFLHlCQUF5QjtRQUNwRCxtQkFBbUIsRUFDakIsaURBQWlELEVBQUUsd0JBQXdCO1FBQzdFLFlBQVksRUFBRSxTQUFTO0tBQ3hCLENBQUMsQ0FBQztJQUVILE1BQU0sR0FBRyxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV0QyxPQUFPLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyx5Q0FBeUM7QUFDbEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4gIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFVwZGF0ZUNvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcblxuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgUFJPSkVDVF9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9vcmdhbml6YXRpb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50LCB7XG4gIG1hcnNoYWxsT3B0aW9uczoge1xuICAgIHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSxcbiAgfSxcbn0pO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbi8vIC0tLSBab2Qgc2NoZW1hIGZvciB1cGRhdGVzIChwYXJ0aWFsKSAtLS1cblxuZXhwb3J0IGNvbnN0IFVwZGF0ZVByb2plY3RTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIG5hbWU6IHouc3RyaW5nKCkubWluKDEsICdQcm9qZWN0IG5hbWUgY2Fubm90IGJlIGVtcHR5Jykub3B0aW9uYWwoKSxcbiAgZGVzY3JpcHRpb246IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pO1xuXG5leHBvcnQgdHlwZSBVcGRhdGVQcm9qZWN0RFRPID0gei5pbmZlcjx0eXBlb2YgVXBkYXRlUHJvamVjdFNjaGVtYT47XG5cbi8vIC0tLSBMYW1iZGEgaGFuZGxlciAtLS1cbi8vIEV4YW1wbGUgcm91dGU6IFBBVENIIC9wcm9qZWN0cz9vcmdJZD0uLi4mcHJvamVjdElkPS4uLlxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgb3JnSWQsIHByb2plY3RJZCB9ID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuXG4gICAgaWYgKCFvcmdJZCB8fCAhcHJvamVjdElkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdNaXNzaW5nIHJlcXVpcmVkIHF1ZXJ5IHBhcmFtZXRlcnM6IG9yZ0lkIGFuZCBwcm9qZWN0SWQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgaXMgbWlzc2luZycgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmF3Qm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG5cbiAgICAvLyAxLiBWYWxpZGF0ZSBib2R5IChwYXJ0aWFsKVxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBVcGRhdGVQcm9qZWN0U2NoZW1hLnNhZmVQYXJzZShyYXdCb2R5KTtcblxuICAgIGlmICghdmFsaWRhdGlvblJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBjb25zdCBlcnJvckRldGFpbHMgPSB2YWxpZGF0aW9uUmVzdWx0LmVycm9yLmlzc3Vlcy5tYXAoKGlzc3VlKSA9PiAoe1xuICAgICAgICBwYXRoOiBpc3N1ZS5wYXRoLmpvaW4oJy4nKSxcbiAgICAgICAgbWVzc2FnZTogaXNzdWUubWVzc2FnZSxcbiAgICAgIH0pKTtcblxuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICBlcnJvcnM6IGVycm9yRGV0YWlscyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGR0bzogVXBkYXRlUHJvamVjdERUTyA9IHZhbGlkYXRpb25SZXN1bHQuZGF0YTtcblxuICAgIC8vIElmIG5vdGhpbmcgdG8gdXBkYXRlIChlbXB0eSBib2R5KSwgeW91IGNhbiBlaXRoZXIgbm8tb3Agb3IgcmV0dXJuIDQwMFxuICAgIGlmICghZHRvLm5hbWUgJiYgZHRvLmRlc2NyaXB0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ05vIHVwZGF0YWJsZSBmaWVsZHMgcHJvdmlkZWQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZVByb2plY3Qob3JnSWQsIHByb2plY3RJZCwgZHRvKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHVwZGF0ZWQpO1xuICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHVwZGF0ZVByb2plY3QgaGFuZGxlcjonLCBlcnIpO1xuXG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgICB9XG5cbiAgICBpZiAoZXJyPy5uYW1lID09PSAnQ29uZGl0aW9uYWxDaGVja0ZhaWxlZEV4Y2VwdGlvbicpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDQsIHsgbWVzc2FnZTogJ1Byb2plY3Qgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG4vLyAtLS0gQnVzaW5lc3MgbG9naWMgLS0tXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVQcm9qZWN0KFxuICBvcmdJZDogc3RyaW5nLFxuICBwcm9qZWN0SWQ6IHN0cmluZyxcbiAgZHRvOiBVcGRhdGVQcm9qZWN0RFRPLFxuKSB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICBjb25zdCBrZXkgPSB7XG4gICAgW1BLX05BTUVdOiBQUk9KRUNUX1BLLFxuICAgIFtTS19OQU1FXTogYCR7b3JnSWR9IyR7cHJvamVjdElkfWAsIC8vIHNhbWUgcGF0dGVybiBhcyBjcmVhdGVQcm9qZWN0XG4gIH07XG5cbiAgLy8gRHluYW1pYyBVcGRhdGVFeHByZXNzaW9uXG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAnI3VwZGF0ZWRBdCc6ICd1cGRhdGVkQXQnLFxuICB9O1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICc6dXBkYXRlZEF0Jzogbm93LFxuICB9O1xuICBjb25zdCBzZXRFeHByZXNzaW9uczogc3RyaW5nW10gPSBbJyN1cGRhdGVkQXQgPSA6dXBkYXRlZEF0J107XG5cbiAgaWYgKGR0by5uYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNuYW1lJ10gPSAnbmFtZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOm5hbWUnXSA9IGR0by5uYW1lO1xuICAgIHNldEV4cHJlc3Npb25zLnB1c2goJyNuYW1lID0gOm5hbWUnKTtcbiAgfVxuXG4gIGlmIChkdG8uZGVzY3JpcHRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI2Rlc2NyaXB0aW9uJ10gPSAnZGVzY3JpcHRpb24nO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpkZXNjcmlwdGlvbiddID0gZHRvLmRlc2NyaXB0aW9uO1xuICAgIHNldEV4cHJlc3Npb25zLnB1c2goJyNkZXNjcmlwdGlvbiA9IDpkZXNjcmlwdGlvbicpO1xuICB9XG5cbiAgY29uc3QgY21kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICBLZXk6IGtleSxcbiAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICcgKyBzZXRFeHByZXNzaW9ucy5qb2luKCcsICcpLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgLi4uZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgJyNwayc6IFBLX05BTUUsXG4gICAgICAnI3NrJzogU0tfTkFNRSxcbiAgICB9LFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgQ29uZGl0aW9uRXhwcmVzc2lvbjpcbiAgICAgICdhdHRyaWJ1dGVfZXhpc3RzKCNwaykgQU5EIGF0dHJpYnV0ZV9leGlzdHMoI3NrKScsIC8vIGVuc3VyZSBwcm9qZWN0IGV4aXN0c1xuICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnLFxuICB9KTtcblxuICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjbWQpO1xuXG4gIHJldHVybiByZXMuQXR0cmlidXRlczsgLy8gd2lsbCBpbmNsdWRlIGlkLCBvcmdJZCwgZXRjLiBhcyBzdG9yZWRcbn1cbiJdfQ==