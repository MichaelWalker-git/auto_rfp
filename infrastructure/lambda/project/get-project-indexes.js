"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({}), {
    marshallOptions: { removeUndefinedValues: true },
});
// OS Serverless API endpoint
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const handler = async (event) => {
    try {
        const projectId = event.pathParameters?.projectId;
        if (!projectId) {
            return (0, api_1.apiResponse)(400, { error: 'projectId is required' });
        }
        // 1. Get project
        const project = await getProject(projectId);
        if (!project) {
            return (0, api_1.apiResponse)(404, { error: 'Project not found' });
        }
        const { orgId } = project;
        // 2. Get current project indexes (Dynamo)
        const currentIndexRefs = await listProjectIndexes(projectId);
        // 3. Fetch indexes from OpenSearch
        const osIndexes = await fetchOpenSearchIndexes();
        const availableIndexes = osIndexes.map((idx) => ({
            id: idx.index,
            name: idx.index,
        }));
        const availableIds = new Set(availableIndexes.map((i) => i.id));
        // 4. Filter only existing indexes
        const currentIndexes = currentIndexRefs.filter((ref) => availableIds.has(ref.indexId));
        // 5. Delete stale index references
        const stale = currentIndexRefs.filter((ref) => !availableIds.has(ref.indexId));
        for (const staleRef of stale) {
            await removeProjectIndex(projectId, staleRef.indexId);
        }
        return (0, api_1.apiResponse)(200, {
            project: {
                id: projectId,
                name: project.name,
                orgId,
            },
            currentIndexes: currentIndexes.map((i) => ({
                id: i.indexId,
                name: i.indexName,
            })),
            availableIndexes,
        });
    }
    catch (err) {
        console.error('Error in getProjectIndexes:', err);
        return (0, api_1.apiResponse)(500, { error: 'Internal server error' });
    }
};
exports.handler = handler;
// ----- Helper Functions -----
async function getProject(projectId) {
    // Query by PK=PROJECT_PK and SK ends with projectId
    const idSuffix = `#${projectId}`;
    const res = await ddb.send(new lib_dynamodb_1.QueryCommand({
        TableName: process.env.DB_TABLE_NAME,
        KeyConditionExpression: '#pk = :pk',
        FilterExpression: 'contains(#sk, :suffix)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
        ExpressionAttributeValues: {
            ':pk': organization_1.PROJECT_PK,
            ':suffix': idSuffix,
        },
    }));
    return res.Items?.find((item) => item[common_1.SK_NAME].endsWith(idSuffix)) ?? null;
}
async function listProjectIndexes(projectId) {
    const res = await ddb.send(new lib_dynamodb_1.QueryCommand({
        TableName: process.env.DB_TABLE_NAME,
        KeyConditionExpression: '#pk = :pk AND begins_with(#sk, :skPrefix)',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
            '#sk': common_1.SK_NAME,
        },
        ExpressionAttributeValues: {
            ':pk': organization_1.PROJECT_INDEX_PK,
            ':skPrefix': `${projectId}#`,
        },
    }));
    return res.Items ?? [];
}
async function removeProjectIndex(projectId, indexId) {
    await ddb.send(new lib_dynamodb_1.DeleteCommand({
        TableName: process.env.DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: organization_1.PROJECT_INDEX_PK,
            [common_1.SK_NAME]: `${projectId}#${indexId}`,
        },
    }));
}
async function fetchOpenSearchIndexes() {
    const response = await fetch(`${OPENSEARCH_ENDPOINT}/_cat/indices?format=json`);
    if (!response.ok) {
        throw new Error('Failed to fetch OpenSearch indexes');
    }
    return response.json();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXByb2plY3QtaW5kZXhlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1wcm9qZWN0LWluZGV4ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEsOERBQTBEO0FBQzFELHdEQUkrQjtBQUMvQix3Q0FBNkM7QUFDN0MsZ0RBQXVEO0FBQ3ZELDREQUF5RTtBQUV6RSxNQUFNLEdBQUcsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0lBQzlELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFFSCw2QkFBNkI7QUFDN0IsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDO0FBRXJELE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDO1FBRWxELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELGlCQUFpQjtRQUNqQixNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBRTFCLDBDQUEwQztRQUMxQyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sa0JBQWtCLENBQUMsU0FBUyxDQUFDLENB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R0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ3hCLElBQUksMkJBQVksQ0FBQztRQUNmLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWM7UUFDckMsc0JBQXNCLEVBQUUsMkNBQTJDO1FBQ25FLHdCQUF3QixFQUFFO1lBQ3hCLEtBQUssRUFBRSxnQkFBTztZQUNkLEtBQUssRUFBRSxnQkFBTztTQUNmO1FBQ0QseUJBQXlCLEVBQUU7WUFDekIsS0FBSyxFQUFFLCtCQUFnQjtZQUN2QixXQUFXLEVBQUUsR0FBRyxTQUFTLEdBQUc7U0FDN0I7S0FDRixDQUFDLENBQ0gsQ0FBQztJQUNGLE9BQU8sR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7QUFDekIsQ0FBQztBQUVELEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxTQUFpQixFQUFFLE9BQWU7SUFDbEUsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUNaLElBQUksNEJBQWEsQ0FBQztRQUNoQixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjO1FBQ3JDLEdBQUcsRUFBRTtZQUNILENBQUMsZ0JBQU8sQ0FBQyxFQUFFLCtCQUFnQjtZQUMzQixDQUFDLGdCQUFPLENBQUMsRUFBRSxHQUFHLFNBQVMsSUFBSSxPQUFPLEVBQUU7U0FDckM7S0FDRixDQUFDLENBQ0gsQ0FBQztBQUNKLENBQUM7QUFFRCxLQUFLLFVBQVUsc0JBQXNCO0lBQ25DLE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLEdBQUcsbUJBQW1CLDJCQUEyQixDQUFDLENBQUM7SUFDaEYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUNELE9BQU8sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHRWMixcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBRdWVyeUNvbW1hbmQsXG4gIERlbGV0ZUNvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFBST0pFQ1RfUEssIFBST0pFQ1RfSU5ERVhfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvb3JnYW5pemF0aW9uJztcblxuY29uc3QgZGRiID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKG5ldyBEeW5hbW9EQkNsaWVudCh7fSksIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbi8vIE9TIFNlcnZlcmxlc3MgQVBJIGVuZHBvaW50XG5jb25zdCBPUEVOU0VBUkNIX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9FTkRQT0lOVDtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHByb2plY3RJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5wcm9qZWN0SWQ7XG5cbiAgICBpZiAoIXByb2plY3RJZCkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBlcnJvcjogJ3Byb2plY3RJZCBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgLy8gMS4gR2V0IHByb2plY3RcbiAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgZ2V0UHJvamVjdChwcm9qZWN0SWQpO1xuICAgIGlmICghcHJvamVjdCkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwNCwgeyBlcnJvcjogJ1Byb2plY3Qgbm90IGZvdW5kJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IG9yZ0lkIH0gPSBwcm9qZWN0O1xuXG4gICAgLy8gMi4gR2V0IGN1cnJlbnQgcHJvamVjdCBpbmRleGVzIChEeW5hbW8pXG4gICAgY29uc3QgY3VycmVudEluZGV4UmVmcyA9IGF3YWl0IGxpc3RQcm9qZWN0SW5kZXhlcyhwcm9qZWN0SWQpO1xuXG4gICAgLy8gMy4gRmV0Y2ggaW5kZXhlcyBmcm9tIE9wZW5TZWFyY2hcbiAgICBjb25zdCBvc0luZGV4ZXMgPSBhd2FpdCBmZXRjaE9wZW5TZWFyY2hJbmRleGVzKCk7XG5cbiAgICBjb25zdCBhdmFpbGFibGVJbmRleGVzID0gb3NJbmRleGVzLm1hcCgoaWR4OiBhbnkpID0+ICh7XG4gICAgICBpZDogaWR4LmluZGV4LFxuICAgICAgbmFtZTogaWR4LmluZGV4LFxuICAgIH0pKTtcblxuICAgIGNvbnN0IGF2YWlsYWJsZUlkcyA9IG5ldyBTZXQoYXZhaWxhYmxlSW5kZXhlcy5tYXAoKGk6IGFueSkgPT4gaS5pZCkpO1xuXG4gICAgLy8gNC4gRmlsdGVyIG9ubHkgZXhpc3RpbmcgaW5kZXhlc1xuICAgIGNvbnN0IGN1cnJlbnRJbmRleGVzID0gY3VycmVudEluZGV4UmVmcy5maWx0ZXIoKHJlZikgPT5cbiAgICAgIGF2YWlsYWJsZUlkcy5oYXMocmVmLmluZGV4SWQpLFxuICAgICk7XG5cbiAgICAvLyA1LiBEZWxldGUgc3RhbGUgaW5kZXggcmVmZXJlbmNlc1xuICAgIGNvbnN0IHN0YWxlID0gY3VycmVudEluZGV4UmVmcy5maWx0ZXIoXG4gICAgICAocmVmKSA9PiAhYXZhaWxhYmxlSWRzLmhhcyhyZWYuaW5kZXhJZCksXG4gICAgKTtcblxuICAgIGZvciAoY29uc3Qgc3RhbGVSZWYgb2Ygc3RhbGUpIHtcbiAgICAgIGF3YWl0IHJlbW92ZVByb2plY3RJbmRleChwcm9qZWN0SWQsIHN0YWxlUmVmLmluZGV4SWQpO1xuICAgIH1cblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHtcbiAgICAgIHByb2plY3Q6IHtcbiAgICAgICAgaWQ6IHByb2plY3RJZCxcbiAgICAgICAgbmFtZTogcHJvamVjdC5uYW1lLFxuICAgICAgICBvcmdJZCxcbiAgICAgIH0sXG4gICAgICBjdXJyZW50SW5kZXhlczogY3VycmVudEluZGV4ZXMubWFwKChpKSA9PiAoe1xuICAgICAgICBpZDogaS5pbmRleElkLFxuICAgICAgICBuYW1lOiBpLmluZGV4TmFtZSxcbiAgICAgIH0pKSxcbiAgICAgIGF2YWlsYWJsZUluZGV4ZXMsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGdldFByb2plY3RJbmRleGVzOicsIGVycik7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwgeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XG4gIH1cbn07XG5cbi8vIC0tLS0tIEhlbHBlciBGdW5jdGlvbnMgLS0tLS1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdChwcm9qZWN0SWQ6IHN0cmluZykge1xuICAvLyBRdWVyeSBieSBQSz1QUk9KRUNUX1BLIGFuZCBTSyBlbmRzIHdpdGggcHJvamVjdElkXG4gIGNvbnN0IGlkU3VmZml4ID0gYCMke3Byb2plY3RJZH1gO1xuICBjb25zdCByZXMgPSBhd2FpdCBkZGIuc2VuZChcbiAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSEsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnI3BrID0gOnBrJyxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdjb250YWlucygjc2ssIDpzdWZmaXgpJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3BrJzogUEtfTkFNRSxcbiAgICAgICAgJyNzayc6IFNLX05BTUUsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBrJzogUFJPSkVDVF9QSyxcbiAgICAgICAgJzpzdWZmaXgnOiBpZFN1ZmZpeCxcbiAgICAgIH0sXG4gICAgfSksXG4gICk7XG5cbiAgcmV0dXJuIHJlcy5JdGVtcz8uZmluZCgoaXRlbSkgPT4gaXRlbVtTS19OQU1FXS5lbmRzV2l0aChpZFN1ZmZpeCkpID8/IG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxpc3RQcm9qZWN0SW5kZXhlcyhwcm9qZWN0SWQ6IHN0cmluZykge1xuICBjb25zdCByZXMgPSBhd2FpdCBkZGIuc2VuZChcbiAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSEsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnI3BrID0gOnBrIEFORCBiZWdpbnNfd2l0aCgjc2ssIDpza1ByZWZpeCknLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgICAnI3NrJzogU0tfTkFNRSxcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6cGsnOiBQUk9KRUNUX0lOREVYX1BLLFxuICAgICAgICAnOnNrUHJlZml4JzogYCR7cHJvamVjdElkfSNgLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcbiAgcmV0dXJuIHJlcy5JdGVtcyA/PyBbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlUHJvamVjdEluZGV4KHByb2plY3RJZDogc3RyaW5nLCBpbmRleElkOiBzdHJpbmcpIHtcbiAgYXdhaXQgZGRiLnNlbmQoXG4gICAgbmV3IERlbGV0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FISxcbiAgICAgIEtleToge1xuICAgICAgICBbUEtfTkFNRV06IFBST0pFQ1RfSU5ERVhfUEssXG4gICAgICAgIFtTS19OQU1FXTogYCR7cHJvamVjdElkfSMke2luZGV4SWR9YCxcbiAgICAgIH0sXG4gICAgfSksXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoT3BlblNlYXJjaEluZGV4ZXMoKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7T1BFTlNFQVJDSF9FTkRQT0lOVH0vX2NhdC9pbmRpY2VzP2Zvcm1hdD1qc29uYCk7XG4gIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBPcGVuU2VhcmNoIGluZGV4ZXMnKTtcbiAgfVxuICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xufVxuIl19