"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_textract_1 = require("@aws-sdk/client-textract");
const client_s3_1 = require("@aws-sdk/client-s3");
const api_1 = require("../helpers/api");
const REGION = process.env.AWS_REGION || 'us-east-1';
const DEFAULT_BUCKET = process.env.DOCUMENTS_BUCKET;
if (!DEFAULT_BUCKET) {
    throw new Error('DOCUMENTS_BUCKET environment variable is not set');
}
const textractClient = new client_textract_1.TextractClient({ region: REGION });
const s3Client = new client_s3_1.S3Client({ region: REGION });
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is required' });
        }
        const rawBody = event.isBase64Encoded
            ? Buffer.from(event.body, 'base64').toString('utf-8')
            : event.body;
        let body;
        try {
            body = JSON.parse(rawBody);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        const { jobId, s3Key, s3Bucket } = body;
        if (!jobId) {
            return (0, api_1.apiResponse)(400, { message: "'jobId' is required in the request body" });
        }
        if (!s3Key) {
            return (0, api_1.apiResponse)(400, { message: "'s3Key' is required in the request body" });
        }
        const bucketToUse = s3Bucket || DEFAULT_BUCKET;
        // 1) Call Textract once to check current status
        const textractResp = await textractClient.send(new client_textract_1.GetDocumentTextDetectionCommand({ JobId: jobId }));
        const status = textractResp.JobStatus || 'UNKNOWN';
        // Still running → nothing to build, just tell caller to poll again
        if (status === 'IN_PROGRESS' || status === 'PARTIAL_SUCCESS') {
            return (0, api_1.apiResponse)(200, {
                status,
                jobId,
            });
        }
        // Failed → bubble error
        if (status === 'FAILED') {
            return (0, api_1.apiResponse)(500, {
                status,
                jobId,
                message: textractResp.StatusMessage || 'Textract job failed',
            });
        }
        if (status !== 'SUCCEEDED') {
            // Something unexpected like UNKNOWN
            return (0, api_1.apiResponse)(500, {
                status,
                jobId,
                message: `Unexpected Textract status: ${status}`,
            });
        }
        // 2) SUCCEEDED → collect all pages and flatten lines into text
        const allBlocks = [];
        if (textractResp.Blocks) {
            allBlocks.push(...textractResp.Blocks);
        }
        let nextToken = textractResp.NextToken;
        while (nextToken) {
            const page = await textractClient.send(new client_textract_1.GetDocumentTextDetectionCommand({
                JobId: jobId,
                NextToken: nextToken,
            }));
            if (page.Blocks) {
                allBlocks.push(...page.Blocks);
            }
            nextToken = page.NextToken;
        }
        const text = buildTextFromBlocks(allBlocks);
        if (!text.trim()) {
            return (0, api_1.apiResponse)(400, {
                status: 'SUCCEEDED',
                jobId,
                message: 'Textract job succeeded but extracted text is empty',
            });
        }
        // 3) Build txt key next to original
        const txtKey = buildTxtKey(s3Key);
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: bucketToUse,
            Key: txtKey,
            Body: Buffer.from(text, 'utf-8'),
            ContentType: 'text/plain; charset=utf-8',
        }));
        // 4) Return what caller really needs
        return (0, api_1.apiResponse)(200, {
            status: 'SUCCEEDED',
            jobId,
            bucket: bucketToUse,
            txtKey,
            textLength: text.length,
        });
    }
    catch (error) {
        console.error('Error in check-text-extraction handler:', error);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to check text extraction status',
            error: error instanceof Error ? error.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
function buildTxtKey(originalKey) {
    const idx = originalKey.lastIndexOf('.');
    if (idx === -1) {
        return `${originalKey}.txt`;
    }
    return `${originalKey.slice(0, idx)}.txt`;
}
function buildTextFromBlocks(blocks) {
    const lines = blocks
        .filter((b) => b.BlockType === 'LINE' && b.Text)
        .map((b) => b.Text.trim());
    return lines.join('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXJlc3VsdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1yZXN1bHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQW1HO0FBQ25HLGtEQUFpRTtBQUNqRSx3Q0FBNkM7QUFFN0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxDQUFDO0FBQ3JELE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7QUFFcEQsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztBQUN0RSxDQUFDO0FBRUQsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDOUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFRM0MsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsZUFBZTtZQUNuQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7WUFDckQsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFFZixJQUFJLElBQWdDLENBQUM7UUFDckMsSUFBSSxDQUFDO1lBQ0gsSUFBSSxHQUFHLElBQUksQ0FBQyxL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T0FBTyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUM7QUFDNUMsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsTUFBZTtJQUMxQyxNQUFNLEtBQUssR0FBRyxNQUFNO1NBQ2pCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxNQUFNLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQztTQUMvQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUU5QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQmxvY2ssIEdldERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQsIFRleHRyYWN0Q2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10ZXh0cmFjdCc7XG5pbXBvcnQgeyBQdXRPYmplY3RDb21tYW5kLCBTM0NsaWVudCwgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5cbmNvbnN0IFJFR0lPTiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMSc7XG5jb25zdCBERUZBVUxUX0JVQ0tFVCA9IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19CVUNLRVQ7XG5cbmlmICghREVGQVVMVF9CVUNLRVQpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdET0NVTUVOVFNfQlVDS0VUIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuY29uc3QgdGV4dHJhY3RDbGllbnQgPSBuZXcgVGV4dHJhY3RDbGllbnQoeyByZWdpb246IFJFR0lPTiB9KTtcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG5cbmludGVyZmFjZSBDaGVja0V4dHJhY3Rpb25SZXF1ZXN0Qm9keSB7XG4gIGpvYklkPzogc3RyaW5nO1xuICBzM0tleT86IHN0cmluZztcbiAgczNCdWNrZXQ/OiBzdHJpbmc7IC8vIG9wdGlvbmFsLCBkZWZhdWx0cyB0byBET0NVTUVOVFNfQlVDS0VUXG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgdHJ5IHtcbiAgICBpZiAoIWV2ZW50LmJvZHkpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmF3Qm9keSA9IGV2ZW50LmlzQmFzZTY0RW5jb2RlZFxuICAgICAgPyBCdWZmZXIuZnJvbShldmVudC5ib2R5LCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0Zi04JylcbiAgICAgIDogZXZlbnQuYm9keTtcblxuICAgIGxldCBib2R5OiBDaGVja0V4dHJhY3Rpb25SZXF1ZXN0Qm9keTtcbiAgICB0cnkge1xuICAgICAgYm9keSA9IEpTT04ucGFyc2UocmF3Qm9keSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGpvYklkLCBzM0tleSwgczNCdWNrZXQgfSA9IGJvZHk7XG5cbiAgICBpZiAoIWpvYklkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6IFwiJ2pvYklkJyBpcyByZXF1aXJlZCBpbiB0aGUgcmVxdWVzdCBib2R5XCIgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFzM0tleSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiBcIidzM0tleScgaXMgcmVxdWlyZWQgaW4gdGhlIHJlcXVlc3QgYm9keVwiIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJ1Y2tldFRvVXNlID0gczNCdWNrZXQgfHwgREVGQVVMVF9CVUNLRVQ7XG5cbiAgICAvLyAxKSBDYWxsIFRleHRyYWN0IG9uY2UgdG8gY2hlY2sgY3VycmVudCBzdGF0dXNcbiAgICBjb25zdCB0ZXh0cmFjdFJlc3AgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQoeyBKb2JJZDogam9iSWQgfSksXG4gICAgKTtcblxuICAgIGNvbnN0IHN0YXR1cyA9IHRleHRyYWN0UmVzcC5Kb2JTdGF0dXMgfHwgJ1VOS05PV04nO1xuXG4gICAgLy8gU3RpbGwgcnVubmluZyDihpIgbm90aGluZyB0byBidWlsZCwganVzdCB0ZWxsIGNhbGxlciB0byBwb2xsIGFnYWluXG4gICAgaWYgKHN0YXR1cyA9PT0gJ0lOX1BST0dSRVNTJyB8fCBzdGF0dXMgPT09ICdQQVJUSUFMX1NVQ0NFU1MnKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCB7XG4gICAgICAgIHN0YXR1cyxcbiAgICAgICAgam9iSWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBGYWlsZWQg4oaSIGJ1YmJsZSBlcnJvclxuICAgIGlmIChzdGF0dXMgPT09ICdGQUlMRUQnKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICAgIHN0YXR1cyxcbiAgICAgICAgam9iSWQsXG4gICAgICAgIG1lc3NhZ2U6IHRleHRyYWN0UmVzcC5TdGF0dXNNZXNzYWdlIHx8ICdUZXh0cmFjdCBqb2IgZmFpbGVkJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChzdGF0dXMgIT09ICdTVUNDRUVERUQnKSB7XG4gICAgICAvLyBTb21ldGhpbmcgdW5leHBlY3RlZCBsaWtlIFVOS05PV05cbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICBqb2JJZCxcbiAgICAgICAgbWVzc2FnZTogYFVuZXhwZWN0ZWQgVGV4dHJhY3Qgc3RhdHVzOiAke3N0YXR1c31gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gMikgU1VDQ0VFREVEIOKGkiBjb2xsZWN0IGFsbCBwYWdlcyBhbmQgZmxhdHRlbiBsaW5lcyBpbnRvIHRleHRcbiAgICBjb25zdCBhbGxCbG9ja3M6IEJsb2NrW10gPSBbXTtcbiAgICBpZiAodGV4dHJhY3RSZXNwLkJsb2Nrcykge1xuICAgICAgYWxsQmxvY2tzLnB1c2goLi4udGV4dHJhY3RSZXNwLkJsb2Nrcyk7XG4gICAgfVxuXG4gICAgbGV0IG5leHRUb2tlbiA9IHRleHRyYWN0UmVzcC5OZXh0VG9rZW47XG4gICAgd2hpbGUgKG5leHRUb2tlbikge1xuICAgICAgY29uc3QgcGFnZSA9IGF3YWl0IHRleHRyYWN0Q2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kKHtcbiAgICAgICAgICBKb2JJZDogam9iSWQsXG4gICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgaWYgKHBhZ2UuQmxvY2tzKSB7XG4gICAgICAgIGFsbEJsb2Nrcy5wdXNoKC4uLnBhZ2UuQmxvY2tzKTtcbiAgICAgIH1cbiAgICAgIG5leHRUb2tlbiA9IHBhZ2UuTmV4dFRva2VuO1xuICAgIH1cblxuICAgIGNvbnN0IHRleHQgPSBidWlsZFRleHRGcm9tQmxvY2tzKGFsbEJsb2Nrcyk7XG5cbiAgICBpZiAoIXRleHQudHJpbSgpKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIHN0YXR1czogJ1NVQ0NFRURFRCcsXG4gICAgICAgIGpvYklkLFxuICAgICAgICBtZXNzYWdlOiAnVGV4dHJhY3Qgam9iIHN1Y2NlZWRlZCBidXQgZXh0cmFjdGVkIHRleHQgaXMgZW1wdHknLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gMykgQnVpbGQgdHh0IGtleSBuZXh0IHRvIG9yaWdpbmFsXG4gICAgY29uc3QgdHh0S2V5ID0gYnVpbGRUeHRLZXkoczNLZXkpO1xuXG4gICAgYXdhaXQgczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBidWNrZXRUb1VzZSxcbiAgICAgICAgS2V5OiB0eHRLZXksXG4gICAgICAgIEJvZHk6IEJ1ZmZlci5mcm9tKHRleHQsICd1dGYtOCcpLFxuICAgICAgICBDb250ZW50VHlwZTogJ3RleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIDQpIFJldHVybiB3aGF0IGNhbGxlciByZWFsbHkgbmVlZHNcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCB7XG4gICAgICBzdGF0dXM6ICdTVUNDRUVERUQnLFxuICAgICAgam9iSWQsXG4gICAgICBidWNrZXQ6IGJ1Y2tldFRvVXNlLFxuICAgICAgdHh0S2V5LFxuICAgICAgdGV4dExlbmd0aDogdGV4dC5sZW5ndGgsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gY2hlY2stdGV4dC1leHRyYWN0aW9uIGhhbmRsZXI6JywgZXJyb3IpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gY2hlY2sgdGV4dCBleHRyYWN0aW9uIHN0YXR1cycsXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGJ1aWxkVHh0S2V5KG9yaWdpbmFsS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBpZHggPSBvcmlnaW5hbEtleS5sYXN0SW5kZXhPZignLicpO1xuICBpZiAoaWR4ID09PSAtMSkge1xuICAgIHJldHVybiBgJHtvcmlnaW5hbEtleX0udHh0YDtcbiAgfVxuICByZXR1cm4gYCR7b3JpZ2luYWxLZXkuc2xpY2UoMCwgaWR4KX0udHh0YDtcbn1cblxuZnVuY3Rpb24gYnVpbGRUZXh0RnJvbUJsb2NrcyhibG9ja3M6IEJsb2NrW10pOiBzdHJpbmcge1xuICBjb25zdCBsaW5lcyA9IGJsb2Nrc1xuICAgIC5maWx0ZXIoKGIpID0+IGIuQmxvY2tUeXBlID09PSAnTElORScgJiYgYi5UZXh0KVxuICAgIC5tYXAoKGIpID0+IGIuVGV4dCEudHJpbSgpKTtcblxuICByZXR1cm4gbGluZXMuam9pbignXFxuJyk7XG59XG4iXX0=