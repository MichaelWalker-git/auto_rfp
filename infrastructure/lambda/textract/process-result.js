"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_textract_1 = require("@aws-sdk/client-textract");
const bedrock_http_client_1 = require("../helpers/bedrock-http-client");
const signature_v4_1 = require("@aws-sdk/signature-v4");
const sha256_js_1 = require("@aws-crypto/sha256-js");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const protocol_http_1 = require("@aws-sdk/protocol-http");
const https_1 = __importDefault(require("https"));
const client_s3_1 = require("@aws-sdk/client-s3");
const common_1 = require("../constants/common");
const document_1 = require("../constants/document");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const textractClient = new client_textract_1.TextractClient({});
const s3Client = new client_s3_1.S3Client({});
const REGION = process.env.REGION ||
    process.env.AWS_REGION ||
    process.env.BEDROCK_REGION ||
    'us-east-1';
const DOCUMENTS_TABLE_NAME = process.env.DOCUMENTS_TABLE_NAME;
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const BEDROCK_MODEL_ID = process.env.BEDROCK_EMBEDDING_MODEL_ID || 'amazon.titan-embed-text-v2:0';
const DOCUMENTS_BUCKET = process.env.DOCUMENTS_BUCKET;
if (!DOCUMENTS_TABLE_NAME) {
    throw new Error('DOCUMENTS_TABLE_NAME env var is not set');
}
if (!OPENSEARCH_ENDPOINT) {
    throw new Error('OPENSEARCH_ENDPOINT env var is not set');
}
if (!DOCUMENTS_BUCKET) {
    throw new Error('TEXT_BUCKET_NAME / DOCUMENTS_BUCKET env var is not set');
}
// --- Main handler ---
const handler = async (event, _context) => {
    console.log('process-result event:', JSON.stringify(event));
    const documentId = event.documentId;
    const jobId = event.jobId;
    const knowledgeBaseId = event.knowledgeBaseId;
    if (!documentId || !jobId || !knowledgeBaseId) {
        throw new Error('documentId, jobId and knowledgeBaseId are required');
    }
    // 1) Fetch full text from Textract
    const { text, status } = await getTextractText(jobId);
    if (status !== 'SUCCEEDED') {
        console.warn(`Textract job ${jobId} finished with status=${status}`);
        await updateDocument(documentId, knowledgeBaseId, 'error');
        return { status: 'FAILED' };
    }
    // 2) Generate embeddings with Bedrock
    const embedding = await embedText(text);
    // 3) Index into OpenSearch Serverless (AOSS)
    const indexName = 'documents'; // or `${stage}-documents` etc.
    await indexToOpenSearch(indexName, documentId, {
        documentId,
        text,
        embedding,
    });
    // 3b) Load original document to derive textFileKey path
    const { fileKey } = await getDocument(knowledgeBaseId, documentId);
    const textFileKey = `${jobId}/${documentId}/${fileKey}.txt`;
    console.log('Computed textFileKey:', textFileKey);
    // 3c) Save extracted text to S3
    await saveTextFileToS3(textFileKey, text);
    // 4) Update DynamoDB indexStatus + textFileKey
    await updateDocument(documentId, knowledgeBaseId, 'indexed', textFileKey);
    return { status: 'SUCCEEDED' };
};
exports.handler = handler;
// --- Textract helpers ---
async function getTextractText(jobId) {
    let nextToken = undefined;
    const lines = [];
    let jobStatus;
    do {
        const res = await textractClient.send(new client_textract_1.GetDocumentTextDetectionCommand({
            JobId: jobId,
            NextToken: nextToken,
        }));
        jobStatus = res.JobStatus;
        if (!jobStatus) {
            return { text: '', status: 'UNKNOWN' };
        }
        if (jobStatus !== 'SUCCEEDED') {
            // For callback-based pattern we expect only final status here
            return { text: '', status: jobStatus };
        }
        if (res.Blocks) {
            for (const block of res.Blocks) {
                if (block.BlockType === 'LINE' && block.Text) {
                    lines.push(block.Text);
                }
            }
        }
        nextToken = res.NextToken;
    } while (nextToken);
    return {
        text: lines.join('\n'),
        status: jobStatus,
    };
}
// --- Bedrock embeddings ---
async function embedText(text) {
    const payload = {
        inputText: text,
    };
    const responseBody = await (0, bedrock_http_client_1.invokeModel)(BEDROCK_MODEL_ID, JSON.stringify(payload), 'application/json', 'application/json');
    const json = JSON.parse(new TextDecoder('utf-8').decode(responseBody));
    // Titan style; adjust if you change model
    const embedding = json.embedding ?? json.vector ?? json.embeddings?.[0];
    if (!embedding) {
        throw new Error(`Unexpected embedding response: ${JSON.stringify(json).slice(0, 500)}`);
    }
    return embedding;
}
// --- OpenSearch Serverless (AOSS) indexing ---
async function indexToOpenSearch(indexName, id, // kept for logging / body, but not used in path
body) {
    const endpointUrl = new URL(OPENSEARCH_ENDPOINT);
    const payload = JSON.stringify(body);
    const request = new protocol_http_1.HttpRequest({
        method: 'POST', // no ID in path for AOSS index API
        protocol: endpointUrl.protocol,
        hostname: endpointUrl.hostname,
        path: `/${indexName}/_doc`,
        headers: {
            'Content-Type': 'application/json',
            'Content-Length': Buffer.byteLength(payload).toString(),
            host: endpointUrl.hostname,
        },
        body: payload,
    });
    const signer = new signature_v4_1.SignatureV4({
        service: 'aoss',
        region: REGION,
        credentials: (0, credential_provider_node_1.defaultProvider)(),
        sha256: sha256_js_1.Sha256,
    });
    const signed = await signer.sign(request);
    await new Promise((resolve, reject) => {
        const req = https_1.default.request({
            method: signed.method,
            hostname: signed.hostname,
            path: signed.path,
            headers: signed.headers,
        }, (res) => {
            const chunks = [];
            res.on('data', (chunk) => chunks.push(chunk));
            res.on('end', () => {
                const bodyStr = Buffer.concat(chunks).toString('utf-8');
                if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {
                    resolve();
                }
                else {
                    reject(new Error(`OpenSearch index error: ${res.statusCode} ${res.statusMessage} - ${bodyStr}`));
                }
            });
        });
        req.on('error', reject);
        if (signed.body) {
            req.write(signed.body);
        }
        req.end();
    });
}
// --- Dynamo helpers ---
async function getDocument(knowledgeBaseId, documentId) {
    const sk = `KB#${knowledgeBaseId}#DOC#${documentId}`;
    console.log('getDocument: fetching from Dynamo', {
        table: DOCUMENTS_TABLE_NAME,
        pk: document_1.DOCUMENT_PK,
        sk,
    });
    const res = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DOCUMENTS_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: document_1.DOCUMENT_PK,
            [common_1.SK_NAME]: sk,
        },
    }));
    if (!res.Item) {
        throw new Error(`Document not found in DynamoDB for PK=${document_1.DOCUMENT_PK}, SK=${sk}`);
    }
    const item = res.Item;
    if (!item.fileKey) {
        console.warn(`getDocument: item has no fileKey (PK=${document_1.DOCUMENT_PK}, SK=${sk})`);
    }
    return item;
}
async function updateDocument(documentId, knowledgeBaseId, status, textFileKey) {
    const sk = `KB#${knowledgeBaseId}#DOC#${documentId}`;
    const expressionAttributeNames = {
        '#indexStatus': 'indexStatus',
        '#updatedAt': 'updatedAt',
    };
    const expressionAttributeValues = {
        ':status': status,
        ':updatedAt': new Date().toISOString(),
    };
    let updateExpression = 'SET #indexStatus = :status, #updatedAt = :updatedAt';
    if (textFileKey) {
        expressionAttributeNames['#textFileKey'] = 'textFileKey';
        expressionAttributeValues[':textFileKey'] = textFileKey;
        updateExpression += ', #textFileKey = :textFileKey';
    }
    console.log('updateDocument: updating Dynamo', {
        table: DOCUMENTS_TABLE_NAME,
        pk: document_1.DOCUMENT_PK,
        sk,
        status,
        textFileKey,
    });
    await docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: DOCUMENTS_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: document_1.DOCUMENT_PK,
            [common_1.SK_NAME]: sk,
        },
        UpdateExpression: updateExpression,
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
    }));
}
// --- S3 helper ---
async function saveTextFileToS3(key, text) {
    console.log('saveTextFileToS3:', {
        bucket: DOCUMENTS_BUCKET,
        key,
        textLength: text.length,
    });
    await s3Client.send(new client_s3_1.PutObjectCommand({
        Bucket: DOCUMENTS_BUCKET,
        Key: key,
        Body: text,
        ContentType: 'text/plain; charset=utf-8',
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1yZXN1bHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm9jZXNzLXJlc3VsdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTJGO0FBQzNGLDhEQUE0RjtBQUM1Rix3RUFBNkQ7QUFDN0Qsd0RBQW9EO0FBQ3BELHFEQUErQztBQUMvQyxnRkFBb0U7QUFDcEUsMERBQXFEO0FBQ3JELGtEQUEwQjtBQUMxQixrREFBZ0U7QUFFaEUsZ0RBQXVEO0FBQ3ZELG9EQUFvRDtBQUdwRCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUUsRUFBRSxxQkFBcUIsRUFBRSxJQUFJLEVBQUU7Q0FDakQsQ0FBQyxDQUFDO0FBRUgsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVsQyxNQUFNLE1BQU0sR0FDVixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU07SUFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO0lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztJQUMxQixXQUFXLENBQUM7QUFFZCxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUM7QUFDOUQsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDO0FBQzVELE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsSUFBSSw4QkFBOEIsQ0FBQztBQUNsRyxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7QUFFdEQs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RSxFQUFFO1NBQ2Q7UUFDRCxnQkFBZ0IsRUFBRSxnQkFBZ0I7UUFDbEMsd0JBQXdCLEVBQUUsd0JBQXdCO1FBQ2xELHlCQUF5QixFQUFFLHlCQUF5QjtLQUNyRCxDQUFDLENBQ0gsQ0FBQztBQUNKLENBQUM7QUFFRCxvQkFBb0I7QUFFcEIsS0FBSyxVQUFVLGdCQUFnQixDQUM3QixHQUFXLEVBQ1gsSUFBWTtJQUVaLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUU7UUFDL0IsTUFBTSxFQUFFLGdCQUFnQjtRQUN4QixHQUFHO1FBQ0gsVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNO0tBQ3hCLENBQUMsQ0FBQztJQUVILE1BQU0sUUFBUSxDQUFDLElBQUksQ0FDakIsSUFBSSw0QkFBZ0IsQ0FBQztRQUNuQixNQUFNLEVBQUUsZ0JBQWdCO1FBQ3hCLEdBQUcsRUFBRSxHQUFHO1FBQ1IsSUFBSSxFQUFFLElBQUk7UUFDVixXQUFXLEVBQUUsMkJBQTJCO0tBQ3pDLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIFVwZGF0ZUNvbW1hbmQsIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEdldERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQsIFRleHRyYWN0Q2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10ZXh0cmFjdCc7XG5pbXBvcnQgeyBpbnZva2VNb2RlbCB9IGZyb20gJy4uL2hlbHBlcnMvYmVkcm9jay1odHRwLWNsaWVudCc7XG5pbXBvcnQgeyBTaWduYXR1cmVWNCB9IGZyb20gJ0Bhd3Mtc2RrL3NpZ25hdHVyZS12NCc7XG5pbXBvcnQgeyBTaGEyNTYgfSBmcm9tICdAYXdzLWNyeXB0by9zaGEyNTYtanMnO1xuaW1wb3J0IHsgZGVmYXVsdFByb3ZpZGVyIH0gZnJvbSAnQGF3cy1zZGsvY3JlZGVudGlhbC1wcm92aWRlci1ub2RlJztcbmltcG9ydCB7IEh0dHBSZXF1ZXN0IH0gZnJvbSAnQGF3cy1zZGsvcHJvdG9jb2wtaHR0cCc7XG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnO1xuaW1wb3J0IHsgUHV0T2JqZWN0Q29tbWFuZCwgUzNDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBET0NVTUVOVF9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9kb2N1bWVudCc7XG5pbXBvcnQgeyBEb2N1bWVudEl0ZW0gfSBmcm9tICcuLi9zY2hlbWFzL2RvY3VtZW50JztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbmNvbnN0IHRleHRyYWN0Q2xpZW50ID0gbmV3IFRleHRyYWN0Q2xpZW50KHt9KTtcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuY29uc3QgUkVHSU9OID1cbiAgcHJvY2Vzcy5lbnYuUkVHSU9OIHx8XG4gIHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHxcbiAgcHJvY2Vzcy5lbnYuQkVEUk9DS19SRUdJT04gfHxcbiAgJ3VzLWVhc3QtMSc7XG5cbmNvbnN0IERPQ1VNRU5UU19UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX1RBQkxFX05BTUU7XG5jb25zdCBPUEVOU0VBUkNIX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9FTkRQT0lOVDtcbmNvbnN0IEJFRFJPQ0tfTU9ERUxfSUQgPSBwcm9jZXNzLmVudi5CRURST0NLX0VNQkVERElOR19NT0RFTF9JRCB8fCAnYW1hem9uLnRpdGFuLWVtYmVkLXRleHQtdjI6MCc7XG5jb25zdCBET0NVTUVOVFNfQlVDS0VUID0gcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX0JVQ0tFVDtcblxuaWYgKCFET0NVTUVOVFNfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RPQ1VNRU5UU19UQUJMRV9OQU1FIGVudiB2YXIgaXMgbm90IHNldCcpO1xufVxuaWYgKCFPUEVOU0VBUkNIX0VORFBPSU5UKSB7XG4gIHRocm93IG5ldyBFcnJvcignT1BFTlNFQVJDSF9FTkRQT0lOVCBlbnYgdmFyIGlzIG5vdCBzZXQnKTtcbn1cbmlmICghRE9DVU1FTlRTX0JVQ0tFVCkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ1RFWFRfQlVDS0VUX05BTUUgLyBET0NVTUVOVFNfQlVDS0VUIGVudiB2YXIgaXMgbm90IHNldCcpO1xufVxuXG4vLyAtLS0gVHlwZXMgLS0tXG5pbnRlcmZhY2UgUHJvY2Vzc0V2ZW50IHtcbiAgZG9jdW1lbnRJZD86IHN0cmluZztcbiAgam9iSWQ/OiBzdHJpbmc7XG4gIGtub3dsZWRnZUJhc2VJZD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEdldFRleHRyYWN0UmVzdWx0IHtcbiAgdGV4dDogc3RyaW5nO1xuICBzdGF0dXM6IHN0cmluZztcbn1cblxuLy8gLS0tIE1haW4gaGFuZGxlciAtLS1cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogUHJvY2Vzc0V2ZW50LFxuICBfY29udGV4dDogQ29udGV4dCxcbik6IFByb21pc2U8eyBzdGF0dXM6IHN0cmluZyB9PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdwcm9jZXNzLXJlc3VsdCBldmVudDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGRvY3VtZW50SWQgPSBldmVudC5kb2N1bWVudElkO1xuICBjb25zdCBqb2JJZCA9IGV2ZW50LmpvYklkO1xuICBjb25zdCBrbm93bGVkZ2VCYXNlSWQgPSBldmVudC5rbm93bGVkZ2VCYXNlSWQ7XG5cbiAgaWYgKCFkb2N1bWVudElkIHx8ICFqb2JJZCB8fCAha25vd2xlZGdlQmFzZUlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdkb2N1bWVudElkLCBqb2JJZCBhbmQga25vd2xlZGdlQmFzZUlkIGFyZSByZXF1aXJlZCcpO1xuICB9XG5cbiAgLy8gMSkgRmV0Y2ggZnVsbCB0ZXh0IGZyb20gVGV4dHJhY3RcbiAgY29uc3QgeyB0ZXh0LCBzdGF0dXMgfSA9IGF3YWl0IGdldFRleHRyYWN0VGV4dChqb2JJZCk7XG5cbiAgaWYgKHN0YXR1cyAhPT0gJ1NVQ0NFRURFRCcpIHtcbiAgICBjb25zb2xlLndhcm4oYFRleHRyYWN0IGpvYiAke2pvYklkfSBmaW5pc2hlZCB3aXRoIHN0YXR1cz0ke3N0YXR1c31gKTtcbiAgICBhd2FpdCB1cGRhdGVEb2N1bWVudChkb2N1bWVudElkLCBrbm93bGVkZ2VCYXNlSWQsICdlcnJvcicpO1xuICAgIHJldHVybiB7IHN0YXR1czogJ0ZBSUxFRCcgfTtcbiAgfVxuXG4gIC8vIDIpIEdlbmVyYXRlIGVtYmVkZGluZ3Mgd2l0aCBCZWRyb2NrXG4gIGNvbnN0IGVtYmVkZGluZyA9IGF3YWl0IGVtYmVkVGV4dCh0ZXh0KTtcblxuICAvLyAzKSBJbmRleCBpbnRvIE9wZW5TZWFyY2ggU2VydmVybGVzcyAoQU9TUylcbiAgY29uc3QgaW5kZXhOYW1lID0gJ2RvY3VtZW50cyc7IC8vIG9yIGAke3N0YWdlfS1kb2N1bWVudHNgIGV0Yy5cblxuICBhd2FpdCBpbmRleFRvT3BlblNlYXJjaChpbmRleE5hbWUsIGRvY3VtZW50SWQsIHtcbiAgICBkb2N1bWVudElkLFxuICAgIHRleHQsXG4gICAgZW1iZWRkaW5nLFxuICB9KTtcblxuICAvLyAzYikgTG9hZCBvcmlnaW5hbCBkb2N1bWVudCB0byBkZXJpdmUgdGV4dEZpbGVLZXkgcGF0aFxuICBjb25zdCB7IGZpbGVLZXkgfSA9IGF3YWl0IGdldERvY3VtZW50KGtub3dsZWRnZUJhc2VJZCwgZG9jdW1lbnRJZCk7XG5cbiAgY29uc3QgdGV4dEZpbGVLZXkgPSBgJHtqb2JJZH0vJHtkb2N1bWVudElkfS8ke2ZpbGVLZXl9LnR4dGA7XG4gIGNvbnNvbGUubG9nKCdDb21wdXRlZCB0ZXh0RmlsZUtleTonLCB0ZXh0RmlsZUtleSk7XG5cbiAgLy8gM2MpIFNhdmUgZXh0cmFjdGVkIHRleHQgdG8gUzNcbiAgYXdhaXQgc2F2ZVRleHRGaWxlVG9TMyh0ZXh0RmlsZUtleSwgdGV4dCk7XG5cbiAgLy8gNCkgVXBkYXRlIER5bmFtb0RCIGluZGV4U3RhdHVzICsgdGV4dEZpbGVLZXlcbiAgYXdhaXQgdXBkYXRlRG9jdW1lbnQoZG9jdW1lbnRJZCwga25vd2xlZGdlQmFzZUlkLCAnaW5kZXhlZCcsIHRleHRGaWxlS2V5KTtcblxuICByZXR1cm4geyBzdGF0dXM6ICdTVUNDRUVERUQnIH07XG59O1xuXG4vLyAtLS0gVGV4dHJhY3QgaGVscGVycyAtLS1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VGV4dHJhY3RUZXh0KGpvYklkOiBzdHJpbmcpOiBQcm9taXNlPEdldFRleHRyYWN0UmVzdWx0PiB7XG4gIGxldCBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG4gIGxldCBqb2JTdGF0dXM6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBkbyB7XG4gICAgY29uc3QgcmVzOiBhbnkgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQoe1xuICAgICAgICBKb2JJZDogam9iSWQsXG4gICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGpvYlN0YXR1cyA9IHJlcy5Kb2JTdGF0dXM7XG4gICAgaWYgKCFqb2JTdGF0dXMpIHtcbiAgICAgIHJldHVybiB7IHRleHQ6ICcnLCBzdGF0dXM6ICdVTktOT1dOJyB9O1xuICAgIH1cblxuICAgIGlmIChqb2JTdGF0dXMgIT09ICdTVUNDRUVERUQnKSB7XG4gICAgICAvLyBGb3IgY2FsbGJhY2stYmFzZWQgcGF0dGVybiB3ZSBleHBlY3Qgb25seSBmaW5hbCBzdGF0dXMgaGVyZVxuICAgICAgcmV0dXJuIHsgdGV4dDogJycsIHN0YXR1czogam9iU3RhdHVzIH07XG4gICAgfVxuXG4gICAgaWYgKHJlcy5CbG9ja3MpIHtcbiAgICAgIGZvciAoY29uc3QgYmxvY2sgb2YgcmVzLkJsb2Nrcykge1xuICAgICAgICBpZiAoYmxvY2suQmxvY2tUeXBlID09PSAnTElORScgJiYgYmxvY2suVGV4dCkge1xuICAgICAgICAgIGxpbmVzLnB1c2goYmxvY2suVGV4dCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBuZXh0VG9rZW4gPSByZXMuTmV4dFRva2VuO1xuICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuXG4gIHJldHVybiB7XG4gICAgdGV4dDogbGluZXMuam9pbignXFxuJyksXG4gICAgc3RhdHVzOiBqb2JTdGF0dXMsXG4gIH07XG59XG5cbi8vIC0tLSBCZWRyb2NrIGVtYmVkZGluZ3MgLS0tXG5cbmFzeW5jIGZ1bmN0aW9uIGVtYmVkVGV4dCh0ZXh0OiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcltdPiB7XG4gIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgaW5wdXRUZXh0OiB0ZXh0LFxuICB9O1xuXG4gIGNvbnN0IHJlc3BvbnNlQm9keSA9IGF3YWl0IGludm9rZU1vZGVsKFxuICAgIEJFRFJPQ0tfTU9ERUxfSUQsXG4gICAgSlNPTi5zdHJpbmdpZnkocGF5bG9hZCksXG4gICAgJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdhcHBsaWNhdGlvbi9qc29uJ1xuICApO1xuXG4gIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKG5ldyBUZXh0RGVjb2RlcigndXRmLTgnKS5kZWNvZGUocmVzcG9uc2VCb2R5KSk7XG5cbiAgLy8gVGl0YW4gc3R5bGU7IGFkanVzdCBpZiB5b3UgY2hhbmdlIG1vZGVsXG4gIGNvbnN0IGVtYmVkZGluZzogbnVtYmVyW10gPVxuICAgIGpzb24uZW1iZWRkaW5nID8/IGpzb24udmVjdG9yID8/IGpzb24uZW1iZWRkaW5ncz8uWzBdO1xuXG4gIGlmICghZW1iZWRkaW5nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFVuZXhwZWN0ZWQgZW1iZWRkaW5nIHJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KGpzb24pLnNsaWNlKDAsIDUwMCl9YCxcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGVtYmVkZGluZztcbn1cblxuLy8gLS0tIE9wZW5TZWFyY2ggU2VydmVybGVzcyAoQU9TUykgaW5kZXhpbmcgLS0tXG5cbmFzeW5jIGZ1bmN0aW9uIGluZGV4VG9PcGVuU2VhcmNoKFxuICBpbmRleE5hbWU6IHN0cmluZyxcbiAgaWQ6IHN0cmluZywgLy8ga2VwdCBmb3IgbG9nZ2luZyAvIGJvZHksIGJ1dCBub3QgdXNlZCBpbiBwYXRoXG4gIGJvZHk6IHVua25vd24sXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgZW5kcG9pbnRVcmwgPSBuZXcgVVJMKE9QRU5TRUFSQ0hfRU5EUE9JTlQhKTtcbiAgY29uc3QgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuXG4gIGNvbnN0IHJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3Qoe1xuICAgIG1ldGhvZDogJ1BPU1QnLCAvLyBubyBJRCBpbiBwYXRoIGZvciBBT1NTIGluZGV4IEFQSVxuICAgIHByb3RvY29sOiBlbmRwb2ludFVybC5wcm90b2NvbCxcbiAgICBob3N0bmFtZTogZW5kcG9pbnRVcmwuaG9zdG5hbWUsXG4gICAgcGF0aDogYC8ke2luZGV4TmFtZX0vX2RvY2AsXG4gICAgaGVhZGVyczoge1xuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICdDb250ZW50LUxlbmd0aCc6IEJ1ZmZlci5ieXRlTGVuZ3RoKHBheWxvYWQpLnRvU3RyaW5nKCksXG4gICAgICBob3N0OiBlbmRwb2ludFVybC5ob3N0bmFtZSxcbiAgICB9LFxuICAgIGJvZHk6IHBheWxvYWQsXG4gIH0pO1xuXG4gIGNvbnN0IHNpZ25lciA9IG5ldyBTaWduYXR1cmVWNCh7XG4gICAgc2VydmljZTogJ2Fvc3MnLFxuICAgIHJlZ2lvbjogUkVHSU9OLFxuICAgIGNyZWRlbnRpYWxzOiBkZWZhdWx0UHJvdmlkZXIoKSxcbiAgICBzaGEyNTY6IFNoYTI1NixcbiAgfSk7XG5cbiAgY29uc3Qgc2lnbmVkID0gYXdhaXQgc2lnbmVyLnNpZ24ocmVxdWVzdCk7XG5cbiAgYXdhaXQgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IHJlcSA9IGh0dHBzLnJlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIG1ldGhvZDogc2lnbmVkLm1ldGhvZCxcbiAgICAgICAgaG9zdG5hbWU6IHNpZ25lZC5ob3N0bmFtZSxcbiAgICAgICAgcGF0aDogc2lnbmVkLnBhdGgsXG4gICAgICAgIGhlYWRlcnM6IHNpZ25lZC5oZWFkZXJzIGFzIGFueSxcbiAgICAgIH0sXG4gICAgICAocmVzKSA9PiB7XG4gICAgICAgIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiBjaHVua3MucHVzaChjaHVuaykpO1xuICAgICAgICByZXMub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICBjb25zdCBib2R5U3RyID0gQnVmZmVyLmNvbmNhdChjaHVua3MpLnRvU3RyaW5nKCd1dGYtOCcpO1xuICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSAmJiByZXMuc3RhdHVzQ29kZSA+PSAyMDAgJiYgcmVzLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYE9wZW5TZWFyY2ggaW5kZXggZXJyb3I6ICR7cmVzLnN0YXR1c0NvZGV9ICR7cmVzLnN0YXR1c01lc3NhZ2V9IC0gJHtib2R5U3RyfWAsXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICByZXEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICBpZiAoc2lnbmVkLmJvZHkpIHtcbiAgICAgIHJlcS53cml0ZShzaWduZWQuYm9keSk7XG4gICAgfVxuICAgIHJlcS5lbmQoKTtcbiAgfSk7XG59XG5cbi8vIC0tLSBEeW5hbW8gaGVscGVycyAtLS1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RG9jdW1lbnQoXG4gIGtub3dsZWRnZUJhc2VJZDogc3RyaW5nLFxuICBkb2N1bWVudElkOiBzdHJpbmcsXG4pOiBQcm9taXNlPERvY3VtZW50SXRlbSAmIHsgZmlsZUtleT86IHN0cmluZzsgdGV4dEZpbGVLZXk/OiBzdHJpbmcgfT4ge1xuICBjb25zdCBzayA9IGBLQiMke2tub3dsZWRnZUJhc2VJZH0jRE9DIyR7ZG9jdW1lbnRJZH1gO1xuXG4gIGNvbnNvbGUubG9nKCdnZXREb2N1bWVudDogZmV0Y2hpbmcgZnJvbSBEeW5hbW8nLCB7XG4gICAgdGFibGU6IERPQ1VNRU5UU19UQUJMRV9OQU1FLFxuICAgIHBrOiBET0NVTUVOVF9QSyxcbiAgICBzayxcbiAgfSk7XG5cbiAgY29uc3QgcmVzID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBET0NVTUVOVFNfVEFCTEVfTkFNRSxcbiAgICAgIEtleToge1xuICAgICAgICBbUEtfTkFNRV06IERPQ1VNRU5UX1BLLFxuICAgICAgICBbU0tfTkFNRV06IHNrLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcblxuICBpZiAoIXJlcy5JdGVtKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYERvY3VtZW50IG5vdCBmb3VuZCBpbiBEeW5hbW9EQiBmb3IgUEs9JHtET0NVTUVOVF9QS30sIFNLPSR7c2t9YCxcbiAgICApO1xuICB9XG5cbiAgY29uc3QgaXRlbSA9IHJlcy5JdGVtIGFzIERvY3VtZW50SXRlbSAmIHtcbiAgICBmaWxlS2V5Pzogc3RyaW5nO1xuICAgIHRleHRGaWxlS2V5Pzogc3RyaW5nO1xuICB9O1xuXG4gIGlmICghaXRlbS5maWxlS2V5KSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgYGdldERvY3VtZW50OiBpdGVtIGhhcyBubyBmaWxlS2V5IChQSz0ke0RPQ1VNRU5UX1BLfSwgU0s9JHtza30pYCxcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGl0ZW07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURvY3VtZW50KFxuICBkb2N1bWVudElkOiBzdHJpbmcsXG4gIGtub3dsZWRnZUJhc2VJZDogc3RyaW5nLFxuICBzdGF0dXM6ICdwcm9jZXNzaW5nJyB8ICdpbmRleGVkJyB8ICdlcnJvcicsXG4gIHRleHRGaWxlS2V5Pzogc3RyaW5nLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHNrID0gYEtCIyR7a25vd2xlZGdlQmFzZUlkfSNET0MjJHtkb2N1bWVudElkfWA7XG5cbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICcjaW5kZXhTdGF0dXMnOiAnaW5kZXhTdGF0dXMnLFxuICAgICcjdXBkYXRlZEF0JzogJ3VwZGF0ZWRBdCcsXG4gIH07XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XG4gICAgJzpzdGF0dXMnOiBzdGF0dXMsXG4gICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gIH07XG5cbiAgbGV0IHVwZGF0ZUV4cHJlc3Npb24gPVxuICAgICdTRVQgI2luZGV4U3RhdHVzID0gOnN0YXR1cywgI3VwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnO1xuXG4gIGlmICh0ZXh0RmlsZUtleSkge1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3RleHRGaWxlS2V5J10gPSAndGV4dEZpbGVLZXknO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzp0ZXh0RmlsZUtleSddID0gdGV4dEZpbGVLZXk7XG4gICAgdXBkYXRlRXhwcmVzc2lvbiArPSAnLCAjdGV4dEZpbGVLZXkgPSA6dGV4dEZpbGVLZXknO1xuICB9XG5cbiAgY29uc29sZS5sb2coJ3VwZGF0ZURvY3VtZW50OiB1cGRhdGluZyBEeW5hbW8nLCB7XG4gICAgdGFibGU6IERPQ1VNRU5UU19UQUJMRV9OQU1FLFxuICAgIHBrOiBET0NVTUVOVF9QSyxcbiAgICBzayxcbiAgICBzdGF0dXMsXG4gICAgdGV4dEZpbGVLZXksXG4gIH0pO1xuXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogRE9DVU1FTlRTX1RBQkxFX05BTUUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgW1BLX05BTUVdOiBET0NVTUVOVF9QSyxcbiAgICAgICAgW1NLX05BTUVdOiBzayxcbiAgICAgIH0sXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiB1cGRhdGVFeHByZXNzaW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgIH0pLFxuICApO1xufVxuXG4vLyAtLS0gUzMgaGVscGVyIC0tLVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlVGV4dEZpbGVUb1MzKFxuICBrZXk6IHN0cmluZyxcbiAgdGV4dDogc3RyaW5nLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnNvbGUubG9nKCdzYXZlVGV4dEZpbGVUb1MzOicsIHtcbiAgICBidWNrZXQ6IERPQ1VNRU5UU19CVUNLRVQsXG4gICAga2V5LFxuICAgIHRleHRMZW5ndGg6IHRleHQubGVuZ3RoLFxuICB9KTtcblxuICBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogRE9DVU1FTlRTX0JVQ0tFVCxcbiAgICAgIEtleToga2V5LFxuICAgICAgQm9keTogdGV4dCxcbiAgICAgIENvbnRlbnRUeXBlOiAndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcsXG4gICAgfSksXG4gICk7XG59XG4iXX0=