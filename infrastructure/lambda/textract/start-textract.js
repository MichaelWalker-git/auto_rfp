"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_textract_1 = require("@aws-sdk/client-textract");
const common_1 = require("../constants/common");
const document_1 = require("../constants/document");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const textractClient = new client_textract_1.TextractClient({});
// Use the same env var as your app table
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
const DOCUMENTS_BUCKET_NAME = process.env.DOCUMENTS_BUCKET_NAME;
const SNS_TOPIC_ARN = process.env.SNS_TOPIC_ARN;
const TEXTRACT_ROLE_ARN = process.env.TEXTRACT_ROLE_ARN;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME env var is not set');
}
if (!DOCUMENTS_BUCKET_NAME) {
    throw new Error('DOCUMENTS_BUCKET_NAME env var is not set');
}
if (!SNS_TOPIC_ARN) {
    throw new Error('SNS_TOPIC_ARN env var is not set');
}
if (!TEXTRACT_ROLE_ARN) {
    throw new Error('TEXTRACT_ROLE_ARN env var is not set');
}
const handler = async (event, _context) => {
    console.log('start-textract event:', JSON.stringify(event));
    const { documentId, taskToken } = event;
    if (!documentId) {
        throw new Error('documentId is required');
    }
    if (!taskToken) {
        throw new Error('taskToken is required for callback pattern');
    }
    // Our SK pattern:
    const skSuffix = `#DOC#${documentId}`;
    // 1) Load document metadata from DynamoDB using:
    //    PK = DOCUMENT_PK
    //    and SK that *ends with* the suffix above (checked in code)
    const queryRes = await docClient.send(new lib_dynamodb_1.QueryCommand({
        TableName: DB_TABLE_NAME,
        KeyConditionExpression: '#pk = :pk',
        ExpressionAttributeNames: {
            '#pk': common_1.PK_NAME,
        },
        ExpressionAttributeValues: {
            ':pk': document_1.DOCUMENT_PK,
        },
    }));
    const items = (queryRes.Items || []);
    const docItem = items.find((it) => String(it[common_1.SK_NAME]).endsWith(skSuffix));
    if (!docItem) {
        throw new Error(`Document not found for PK=${document_1.DOCUMENT_PK} and SK ending with ${skSuffix}`);
    }
    const pk = docItem[common_1.PK_NAME];
    const sk = docItem[common_1.SK_NAME];
    const s3Key = docItem.fileKey;
    if (!s3Key) {
        throw new Error(`Document ${documentId} does not have fileKey attribute in DynamoDB`);
    }
    // optional: derive knowledgeBaseId from SK = "KB#<kbId>#DOC#<docId>"
    let knowledgeBaseId;
    const skParts = String(sk).split('#'); // ["KB", "<kbId>", "DOC", "<docId>"]
    if (skParts.length >= 4) {
        knowledgeBaseId = skParts[1];
    }
    // 2) Start Textract async job
    const jobTag = documentId; // under 64 chars
    console.log('Starting Textract job with params:', {
        bucket: DOCUMENTS_BUCKET_NAME,
        key: s3Key,
        snsTopic: SNS_TOPIC_ARN,
        textractRole: TEXTRACT_ROLE_ARN,
        jobTag,
        jobTagLength: jobTag.length,
    });
    const startRes = await textractClient.send(new client_textract_1.StartDocumentTextDetectionCommand({
        DocumentLocation: {
            S3Object: {
                Bucket: DOCUMENTS_BUCKET_NAME,
                Name: s3Key,
            },
        },
        NotificationChannel: {
            SNSTopicArn: SNS_TOPIC_ARN,
            RoleArn: TEXTRACT_ROLE_ARN,
        },
        JobTag: jobTag,
    }));
    const jobId = startRes.JobId;
    if (!jobId) {
        throw new Error('Textract did not return a JobId');
    }
    // 3) Update Dynamo â€“ store jobId + indexStatus + taskToken using the same PK/SK
    await docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: pk,
            [common_1.SK_NAME]: sk,
        },
        UpdateExpression: 'SET #jobId = :jobId, #indexStatus = :status, #taskToken = :taskToken, #updatedAt = :updatedAt',
        ExpressionAttributeNames: {
            '#jobId': 'jobId',
            '#indexStatus': 'indexStatus',
            '#taskToken': 'taskToken',
            '#updatedAt': 'updatedAt',
        },
        ExpressionAttributeValues: {
            ':jobId': jobId,
            ':status': 'processing',
            ':taskToken': taskToken,
            ':updatedAt': new Date().toISOString(),
        },
    }));
    const result = {
        documentId,
        jobId,
        knowledgeBaseId,
        status: 'STARTED',
    };
    console.log('start-textract result:', JSON.stringify(result));
    return result;
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtdGV4dHJhY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC10ZXh0cmFjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTZGO0FBQzdGLDhEQUE4RjtBQUU5RixnREFBdUQ7QUFDdkQsb0RBQW9EO0FBR3BELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFFSCxNQUFNLGNBQWMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFOUMseUNBQXlDO0FBQ3pDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ2hELE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQztBQUNoRSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUNoRCxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUM7QUFFeEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBQ0QsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0FBQzlELENBQUM7QUFDRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFDRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUs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QzlELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQXRJVyxRQUFBLE9BQU8sV0FzSWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUXVlcnlDb21tYW5kLCBVcGRhdGVDb21tYW5kLCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTdGFydERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQsIFRleHRyYWN0Q2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10ZXh0cmFjdCc7XG5cbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IERPQ1VNRU5UX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL2RvY3VtZW50JztcbmltcG9ydCB7IERvY3VtZW50SXRlbSB9IGZyb20gJy4uL3NjaGVtYXMvZG9jdW1lbnQnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHsgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlIH0sXG59KTtcblxuY29uc3QgdGV4dHJhY3RDbGllbnQgPSBuZXcgVGV4dHJhY3RDbGllbnQoe30pO1xuXG4vLyBVc2UgdGhlIHNhbWUgZW52IHZhciBhcyB5b3VyIGFwcCB0YWJsZVxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5jb25zdCBET0NVTUVOVFNfQlVDS0VUX05BTUUgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUX05BTUU7XG5jb25zdCBTTlNfVE9QSUNfQVJOID0gcHJvY2Vzcy5lbnYuU05TX1RPUElDX0FSTjtcbmNvbnN0IFRFWFRSQUNUX1JPTEVfQVJOID0gcHJvY2Vzcy5lbnYuVEVYVFJBQ1RfUk9MRV9BUk47XG5cbmlmICghREJfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RCX1RBQkxFX05BTUUgZW52IHZhciBpcyBub3Qgc2V0Jyk7XG59XG5pZiAoIURPQ1VNRU5UU19CVUNLRVRfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RPQ1VNRU5UU19CVUNLRVRfTkFNRSBlbnYgdmFyIGlzIG5vdCBzZXQnKTtcbn1cbmlmICghU05TX1RPUElDX0FSTikge1xuICB0aHJvdyBuZXcgRXJyb3IoJ1NOU19UT1BJQ19BUk4gZW52IHZhciBpcyBub3Qgc2V0Jyk7XG59XG5pZiAoIVRFWFRSQUNUX1JPTEVfQVJOKSB7XG4gIHRocm93IG5ldyBFcnJvcignVEVYVFJBQ1RfUk9MRV9BUk4gZW52IHZhciBpcyBub3Qgc2V0Jyk7XG59XG5cbmludGVyZmFjZSBTdGFydFRleHRyYWN0RXZlbnQge1xuICBkb2N1bWVudElkPzogc3RyaW5nO1xuICAvLyBQcm92aWRlZCBieSBTdGVwIEZ1bmN0aW9ucyBjYWxsYmFjayBwYXR0ZXJuXG4gIHRhc2tUb2tlbj86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFN0YXJ0VGV4dHJhY3RSZXN1bHQge1xuICBqb2JJZDogc3RyaW5nO1xuICBkb2N1bWVudElkOiBzdHJpbmc7XG4gIGtub3dsZWRnZUJhc2VJZD86IHN0cmluZztcbiAgc3RhdHVzOiAnU1RBUlRFRCc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogU3RhcnRUZXh0cmFjdEV2ZW50LFxuICBfY29udGV4dDogQ29udGV4dCxcbik6IFByb21pc2U8U3RhcnRUZXh0cmFjdFJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnc3RhcnQtdGV4dHJhY3QgZXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBjb25zdCB7IGRvY3VtZW50SWQsIHRhc2tUb2tlbiB9ID0gZXZlbnQ7XG5cbiAgaWYgKCFkb2N1bWVudElkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdkb2N1bWVudElkIGlzIHJlcXVpcmVkJyk7XG4gIH1cbiAgaWYgKCF0YXNrVG9rZW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Rhc2tUb2tlbiBpcyByZXF1aXJlZCBmb3IgY2FsbGJhY2sgcGF0dGVybicpO1xuICB9XG5cbiAgLy8gT3VyIFNLIHBhdHRlcm46XG4gIGNvbnN0IHNrU3VmZml4ID0gYCNET0MjJHtkb2N1bWVudElkfWA7XG5cbiAgLy8gMSkgTG9hZCBkb2N1bWVudCBtZXRhZGF0YSBmcm9tIER5bmFtb0RCIHVzaW5nOlxuICAvLyAgICBQSyA9IERPQ1VNRU5UX1BLXG4gIC8vICAgIGFuZCBTSyB0aGF0ICplbmRzIHdpdGgqIHRoZSBzdWZmaXggYWJvdmUgKGNoZWNrZWQgaW4gY29kZSlcbiAgY29uc3QgcXVlcnlSZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICcjcGsgPSA6cGsnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IERPQ1VNRU5UX1BLLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcblxuICBjb25zdCBpdGVtcyA9XG4gICAgKHF1ZXJ5UmVzLkl0ZW1zIHx8IFtdKSBhcyAoRG9jdW1lbnRJdGVtICYge1xuICAgICAgW1BLX05BTUVdOiBzdHJpbmc7XG4gICAgICBbU0tfTkFNRV06IHN0cmluZztcbiAgICB9KVtdO1xuXG4gIGNvbnN0IGRvY0l0ZW0gPSBpdGVtcy5maW5kKChpdCkgPT5cbiAgICBTdHJpbmcoaXRbU0tfTkFNRV0pLmVuZHNXaXRoKHNrU3VmZml4KSxcbiAgKTtcblxuICBpZiAoIWRvY0l0ZW0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgRG9jdW1lbnQgbm90IGZvdW5kIGZvciBQSz0ke0RPQ1VNRU5UX1BLfSBhbmQgU0sgZW5kaW5nIHdpdGggJHtza1N1ZmZpeH1gLFxuICAgICk7XG4gIH1cblxuICBjb25zdCBwayA9IGRvY0l0ZW1bUEtfTkFNRV07XG4gIGNvbnN0IHNrID0gZG9jSXRlbVtTS19OQU1FXTtcbiAgY29uc3QgczNLZXkgPSBkb2NJdGVtLmZpbGVLZXk7XG5cbiAgaWYgKCFzM0tleSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBEb2N1bWVudCAke2RvY3VtZW50SWR9IGRvZXMgbm90IGhhdmUgZmlsZUtleSBhdHRyaWJ1dGUgaW4gRHluYW1vREJgLFxuICAgICk7XG4gIH1cblxuICAvLyBvcHRpb25hbDogZGVyaXZlIGtub3dsZWRnZUJhc2VJZCBmcm9tIFNLID0gXCJLQiM8a2JJZD4jRE9DIzxkb2NJZD5cIlxuICBsZXQga25vd2xlZGdlQmFzZUlkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGNvbnN0IHNrUGFydHMgPSBTdHJpbmcoc2spLnNwbGl0KCcjJyk7IC8vIFtcIktCXCIsIFwiPGtiSWQ+XCIsIFwiRE9DXCIsIFwiPGRvY0lkPlwiXVxuICBpZiAoc2tQYXJ0cy5sZW5ndGggPj0gNCkge1xuICAgIGtub3dsZWRnZUJhc2VJZCA9IHNrUGFydHNbMV07XG4gIH1cblxuICAvLyAyKSBTdGFydCBUZXh0cmFjdCBhc3luYyBqb2JcbiAgY29uc3Qgam9iVGFnID0gZG9jdW1lbnRJZDsgLy8gdW5kZXIgNjQgY2hhcnNcblxuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgVGV4dHJhY3Qgam9iIHdpdGggcGFyYW1zOicsIHtcbiAgICBidWNrZXQ6IERPQ1VNRU5UU19CVUNLRVRfTkFNRSxcbiAgICBrZXk6IHMzS2V5LFxuICAgIHNuc1RvcGljOiBTTlNfVE9QSUNfQVJOLFxuICAgIHRleHRyYWN0Um9sZTogVEVYVFJBQ1RfUk9MRV9BUk4sXG4gICAgam9iVGFnLFxuICAgIGpvYlRhZ0xlbmd0aDogam9iVGFnLmxlbmd0aCxcbiAgfSk7XG5cbiAgY29uc3Qgc3RhcnRSZXMgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxuICAgIG5ldyBTdGFydERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQoe1xuICAgICAgRG9jdW1lbnRMb2NhdGlvbjoge1xuICAgICAgICBTM09iamVjdDoge1xuICAgICAgICAgIEJ1Y2tldDogRE9DVU1FTlRTX0JVQ0tFVF9OQU1FLFxuICAgICAgICAgIE5hbWU6IHMzS2V5LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIE5vdGlmaWNhdGlvbkNoYW5uZWw6IHtcbiAgICAgICAgU05TVG9waWNBcm46IFNOU19UT1BJQ19BUk4sXG4gICAgICAgIFJvbGVBcm46IFRFWFRSQUNUX1JPTEVfQVJOLFxuICAgICAgfSxcbiAgICAgIEpvYlRhZzogam9iVGFnLFxuICAgIH0pLFxuICApO1xuXG4gIGNvbnN0IGpvYklkID0gc3RhcnRSZXMuSm9iSWQ7XG4gIGlmICgham9iSWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RleHRyYWN0IGRpZCBub3QgcmV0dXJuIGEgSm9iSWQnKTtcbiAgfVxuXG4gIC8vIDMpIFVwZGF0ZSBEeW5hbW8g4oCTIHN0b3JlIGpvYklkICsgaW5kZXhTdGF0dXMgKyB0YXNrVG9rZW4gdXNpbmcgdGhlIHNhbWUgUEsvU0tcbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgS2V5OiB7XG4gICAgICAgIFtQS19OQU1FXTogcGssXG4gICAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjpcbiAgICAgICAgJ1NFVCAjam9iSWQgPSA6am9iSWQsICNpbmRleFN0YXR1cyA9IDpzdGF0dXMsICN0YXNrVG9rZW4gPSA6dGFza1Rva2VuLCAjdXBkYXRlZEF0ID0gOnVwZGF0ZWRBdCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyNqb2JJZCc6ICdqb2JJZCcsXG4gICAgICAgICcjaW5kZXhTdGF0dXMnOiAnaW5kZXhTdGF0dXMnLFxuICAgICAgICAnI3Rhc2tUb2tlbic6ICd0YXNrVG9rZW4nLFxuICAgICAgICAnI3VwZGF0ZWRBdCc6ICd1cGRhdGVkQXQnLFxuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpqb2JJZCc6IGpvYklkLFxuICAgICAgICAnOnN0YXR1cyc6ICdwcm9jZXNzaW5nJyxcbiAgICAgICAgJzp0YXNrVG9rZW4nOiB0YXNrVG9rZW4sXG4gICAgICAgICc6dXBkYXRlZEF0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfSxcbiAgICB9KSxcbiAgKTtcblxuICBjb25zdCByZXN1bHQ6IFN0YXJ0VGV4dHJhY3RSZXN1bHQgPSB7XG4gICAgZG9jdW1lbnRJZCxcbiAgICBqb2JJZCxcbiAgICBrbm93bGVkZ2VCYXNlSWQsXG4gICAgc3RhdHVzOiAnU1RBUlRFRCcsXG4gIH07XG5cbiAgY29uc29sZS5sb2coJ3N0YXJ0LXRleHRyYWN0IHJlc3VsdDonLCBKU09OLnN0cmluZ2lmeShyZXN1bHQpKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG4iXX0=