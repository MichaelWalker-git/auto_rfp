"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_sfn_1 = require("@aws-sdk/client-sfn");
const common_1 = require("../constants/common");
const document_1 = require("../constants/document");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const stepFunctionsClient = new client_sfn_1.SFNClient({});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME env var is not set');
}
const handler = async (event, _context) => {
    console.log('callback-handler raw event:', JSON.stringify(event));
    for (const record of event.Records) {
        const sns = record.Sns;
        const messageStr = sns.Message;
        let message;
        try {
            message = JSON.parse(messageStr);
        }
        catch (e) {
            console.warn('SNS message is not JSON, skipping:', messageStr);
            continue;
        }
        console.log('Parsed Textract SNS message:', JSON.stringify(message));
        const jobId = message.JobId;
        const status = message.Status;
        const jobTag = message.JobTag; // JobTag = documentId
        console.log(`Textract notification: jobId=${jobId}, status=${status}, jobTag=${jobTag}`);
        if (!jobId || !status) {
            console.warn('Missing JobId or Status in Textract message, skipping');
            continue;
        }
        if (!jobTag) {
            console.warn('No JobTag in Textract message; JobTag must be set when starting the job');
            continue;
        }
        const documentId = jobTag;
        const docSuffix = `#DOC#${documentId}`;
        let taskToken;
        let knowledgeBaseId;
        try {
            const queryRes = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: DB_TABLE_NAME,
                KeyConditionExpression: '#pk = :pk',
                ExpressionAttributeNames: {
                    '#pk': common_1.PK_NAME,
                },
                ExpressionAttributeValues: {
                    ':pk': document_1.DOCUMENT_PK,
                },
            }));
            const items = (queryRes.Items || []);
            const docItem = items.find((it) => String(it[common_1.SK_NAME]).endsWith(docSuffix));
            if (!docItem) {
                console.warn(`No document with SK ending in ${docSuffix} found for documentId=${documentId}`);
            }
            else {
                const sk = String(docItem[common_1.SK_NAME]);
                const skParts = sk.split('#'); // ["KB", "<kbId>", "DOC", "<docId>"]
                if (skParts.length >= 4) {
                    knowledgeBaseId = skParts[1];
                }
                if (typeof docItem.taskToken === 'string') {
                    taskToken = docItem.taskToken;
                }
                else {
                    console.warn(`Document item for SK=${sk} has no taskToken`);
                }
            }
        }
        catch (err) {
            console.error(`Error querying DynamoDB for documentId=${documentId} to get TaskToken:`, err);
        }
        if (!taskToken) {
            console.warn(`⚠️ No taskToken found for documentId=${documentId}. ` +
                'Ensure your Step Function stores the taskToken on the document item before waiting.');
            continue;
        }
        try {
            if (status === 'SUCCEEDED') {
                await stepFunctionsClient.send(new client_sfn_1.SendTaskSuccessCommand({
                    taskToken,
                    output: JSON.stringify({
                        jobId,
                        documentId,
                        knowledgeBaseId,
                        status,
                    }),
                }));
                console.log(`Sent task success for jobId=${jobId}`);
            }
            else {
                await stepFunctionsClient.send(new client_sfn_1.SendTaskFailureCommand({
                    taskToken,
                    error: 'TextractFailed',
                    cause: `Textract job ${jobId} finished with status=${status}`,
                }));
                console.log(`Sent task failure for jobId=${jobId}`);
            }
        }
        catch (err) {
            console.error('Error calling Step Functions:', err);
            throw err;
        }
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsbGJhY2staGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhbGxiYWNrLWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBEO0FBQzFELHdEQUE4RTtBQUM5RSxvREFBaUc7QUFFakcsZ0RBQXVEO0FBQ3ZELG9EQUFvRDtBQUdwRCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2RCxlQUFlLEVBQUUsRUFBRSxxQkFBcUIsRUFBRSxJQUFJLEVBQUU7Q0FDakQsQ0FBQyxDQUFDO0FBRUgsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFOUMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7QUFFaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBRU0sTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUFlLEVBQ2YsUUFBaUIsRUFDRixFQUFFO0lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRWxFLEtBQUssTUFBTSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ25DLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUUvQixJQUFJLE9BQVksQ0FBQztRQUNqQixJQUFJLENBQUM7WUFDSCxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuQyxDQUFD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Q0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxJQUFJLENBQ1Ysd0NBQXdDLFVBQVUsSUFBSTtnQkFDdEQscUZBQXFGLENBQ3RGLENBQUM7WUFDRixTQUFTO1FBQ1gsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILElBQUksTUFBTSxLQUFLLFdBQVcsRUFBRSxDQUFDO2dCQUMzQixNQUFNLG1CQUFtQixDQUFDLElBQUksQ0FDNUIsSUFBSSxtQ0FBc0IsQ0FBQztvQkFDekIsU0FBUztvQkFDVCxNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQzt3QkFDckIsS0FBSzt3QkFDTCxVQUFVO3dCQUNWLGVBQWU7d0JBQ2YsTUFBTTtxQkFDUCxDQUFDO2lCQUNILENBQUMsQ0FDSCxDQUFDO2dCQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDdEQsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE1BQU0sbUJBQW1CLENBQUMsSUFBSSxDQUM1QixJQUFJLG1DQUFzQixDQUFDO29CQUN6QixTQUFTO29CQUNULEtBQUssRUFBRSxnQkFBZ0I7b0JBQ3ZCLEtBQUssRUFBRSxnQkFBZ0IsS0FBSyx5QkFBeUIsTUFBTSxFQUFFO2lCQUM5RCxDQUFDLENBQ0gsQ0FBQztnQkFDRixPQUFPLENBQUMsR0FBRyxDQUFDLCtCQUErQixLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3RELENBQUM7UUFDSCxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDcEQsTUFBTSxHQUFHLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUMsQ0FBQztBQW5JVyxRQUFBLE9BQU8sV0FtSWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udGV4dCwgU05TRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgU2VuZFRhc2tGYWlsdXJlQ29tbWFuZCwgU2VuZFRhc2tTdWNjZXNzQ29tbWFuZCwgU0ZOQ2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZm4nO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBET0NVTUVOVF9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9kb2N1bWVudCc7XG5pbXBvcnQgeyBEb2N1bWVudEl0ZW0gfSBmcm9tICcuLi9zY2hlbWFzL2RvY3VtZW50JztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbmNvbnN0IHN0ZXBGdW5jdGlvbnNDbGllbnQgPSBuZXcgU0ZOQ2xpZW50KHt9KTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5cbmlmICghREJfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RCX1RBQkxFX05BTUUgZW52IHZhciBpcyBub3Qgc2V0Jyk7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogU05TRXZlbnQsXG4gIF9jb250ZXh0OiBDb250ZXh0LFxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnNvbGUubG9nKCdjYWxsYmFjay1oYW5kbGVyIHJhdyBldmVudDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcbiAgICBjb25zdCBzbnMgPSByZWNvcmQuU25zO1xuICAgIGNvbnN0IG1lc3NhZ2VTdHIgPSBzbnMuTWVzc2FnZTtcblxuICAgIGxldCBtZXNzYWdlOiBhbnk7XG4gICAgdHJ5IHtcbiAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKG1lc3NhZ2VTdHIpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUud2FybignU05TIG1lc3NhZ2UgaXMgbm90IEpTT04sIHNraXBwaW5nOicsIG1lc3NhZ2VTdHIpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ1BhcnNlZCBUZXh0cmFjdCBTTlMgbWVzc2FnZTonLCBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSk7XG5cbiAgICBjb25zdCBqb2JJZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gbWVzc2FnZS5Kb2JJZDtcbiAgICBjb25zdCBzdGF0dXM6IHN0cmluZyB8IHVuZGVmaW5lZCA9IG1lc3NhZ2UuU3RhdHVzO1xuICAgIGNvbnN0IGpvYlRhZzogc3RyaW5nIHwgdW5kZWZpbmVkID0gbWVzc2FnZS5Kb2JUYWc7IC8vIEpvYlRhZyA9IGRvY3VtZW50SWRcblxuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYFRleHRyYWN0IG5vdGlmaWNhdGlvbjogam9iSWQ9JHtqb2JJZH0sIHN0YXR1cz0ke3N0YXR1c30sIGpvYlRhZz0ke2pvYlRhZ31gLFxuICAgICk7XG5cbiAgICBpZiAoIWpvYklkIHx8ICFzdGF0dXMpIHtcbiAgICAgIGNvbnNvbGUud2FybignTWlzc2luZyBKb2JJZCBvciBTdGF0dXMgaW4gVGV4dHJhY3QgbWVzc2FnZSwgc2tpcHBpbmcnKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmICgham9iVGFnKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICdObyBKb2JUYWcgaW4gVGV4dHJhY3QgbWVzc2FnZTsgSm9iVGFnIG11c3QgYmUgc2V0IHdoZW4gc3RhcnRpbmcgdGhlIGpvYicsXG4gICAgICApO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc3QgZG9jdW1lbnRJZCA9IGpvYlRhZztcbiAgICBjb25zdCBkb2NTdWZmaXggPSBgI0RPQyMke2RvY3VtZW50SWR9YDtcblxuICAgIGxldCB0YXNrVG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQga25vd2xlZGdlQmFzZUlkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcXVlcnlSZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICcjcGsgPSA6cGsnLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICAgJyNwayc6IFBLX05BTUUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAnOnBrJzogRE9DVU1FTlRfUEssXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICBjb25zdCBpdGVtcyA9IChxdWVyeVJlcy5JdGVtcyB8fCBbXSkgYXMgKERvY3VtZW50SXRlbSAmIHtcbiAgICAgICAgW1BLX05BTUVdOiBzdHJpbmc7XG4gICAgICAgIFtTS19OQU1FXTogc3RyaW5nO1xuICAgICAgICB0YXNrVG9rZW4/OiBzdHJpbmc7XG4gICAgICB9KVtdO1xuXG4gICAgICBjb25zdCBkb2NJdGVtID0gaXRlbXMuZmluZCgoaXQpID0+XG4gICAgICAgIFN0cmluZyhpdFtTS19OQU1FXSkuZW5kc1dpdGgoZG9jU3VmZml4KSxcbiAgICAgICk7XG5cbiAgICAgIGlmICghZG9jSXRlbSkge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYE5vIGRvY3VtZW50IHdpdGggU0sgZW5kaW5nIGluICR7ZG9jU3VmZml4fSBmb3VuZCBmb3IgZG9jdW1lbnRJZD0ke2RvY3VtZW50SWR9YCxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHNrID0gU3RyaW5nKGRvY0l0ZW1bU0tfTkFNRV0pO1xuICAgICAgICBjb25zdCBza1BhcnRzID0gc2suc3BsaXQoJyMnKTsgLy8gW1wiS0JcIiwgXCI8a2JJZD5cIiwgXCJET0NcIiwgXCI8ZG9jSWQ+XCJdXG4gICAgICAgIGlmIChza1BhcnRzLmxlbmd0aCA+PSA0KSB7XG4gICAgICAgICAga25vd2xlZGdlQmFzZUlkID0gc2tQYXJ0c1sxXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgZG9jSXRlbS50YXNrVG9rZW4gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgdGFza1Rva2VuID0gZG9jSXRlbS50YXNrVG9rZW47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBEb2N1bWVudCBpdGVtIGZvciBTSz0ke3NrfSBoYXMgbm8gdGFza1Rva2VuYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIGBFcnJvciBxdWVyeWluZyBEeW5hbW9EQiBmb3IgZG9jdW1lbnRJZD0ke2RvY3VtZW50SWR9IHRvIGdldCBUYXNrVG9rZW46YCxcbiAgICAgICAgZXJyLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIXRhc2tUb2tlbikge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBg4pqg77iPIE5vIHRhc2tUb2tlbiBmb3VuZCBmb3IgZG9jdW1lbnRJZD0ke2RvY3VtZW50SWR9LiBgICtcbiAgICAgICAgJ0Vuc3VyZSB5b3VyIFN0ZXAgRnVuY3Rpb24gc3RvcmVzIHRoZSB0YXNrVG9rZW4gb24gdGhlIGRvY3VtZW50IGl0ZW0gYmVmb3JlIHdhaXRpbmcuJyxcbiAgICAgICk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHN0YXR1cyA9PT0gJ1NVQ0NFRURFRCcpIHtcbiAgICAgICAgYXdhaXQgc3RlcEZ1bmN0aW9uc0NsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBTZW5kVGFza1N1Y2Nlc3NDb21tYW5kKHtcbiAgICAgICAgICAgIHRhc2tUb2tlbixcbiAgICAgICAgICAgIG91dHB1dDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBqb2JJZCxcbiAgICAgICAgICAgICAgZG9jdW1lbnRJZCxcbiAgICAgICAgICAgICAga25vd2xlZGdlQmFzZUlkLFxuICAgICAgICAgICAgICBzdGF0dXMsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc29sZS5sb2coYFNlbnQgdGFzayBzdWNjZXNzIGZvciBqb2JJZD0ke2pvYklkfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgc3RlcEZ1bmN0aW9uc0NsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBTZW5kVGFza0ZhaWx1cmVDb21tYW5kKHtcbiAgICAgICAgICAgIHRhc2tUb2tlbixcbiAgICAgICAgICAgIGVycm9yOiAnVGV4dHJhY3RGYWlsZWQnLFxuICAgICAgICAgICAgY2F1c2U6IGBUZXh0cmFjdCBqb2IgJHtqb2JJZH0gZmluaXNoZWQgd2l0aCBzdGF0dXM9JHtzdGF0dXN9YCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc29sZS5sb2coYFNlbnQgdGFzayBmYWlsdXJlIGZvciBqb2JJZD0ke2pvYklkfWApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY2FsbGluZyBTdGVwIEZ1bmN0aW9uczonLCBlcnIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxufTtcbiJdfQ==