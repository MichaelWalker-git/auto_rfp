"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_textract_1 = require("@aws-sdk/client-textract");
const api_1 = require("../helpers/api");
const REGION = process.env.AWS_REGION || 'us-east-1';
const DEFAULT_BUCKET = process.env.DOCUMENTS_BUCKET;
if (!DEFAULT_BUCKET) {
    throw new Error('DOCUMENTS_BUCKET environment variable is not set');
}
const textractClient = new client_textract_1.TextractClient({ region: REGION });
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is required' });
        }
        const rawBody = event.isBase64Encoded
            ? Buffer.from(event.body, 'base64').toString('utf-8')
            : event.body;
        let body;
        try {
            body = JSON.parse(rawBody);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        const { s3Key, s3Bucket } = body;
        if (!s3Key) {
            return (0, api_1.apiResponse)(400, {
                message: "'s3Key' is required in the request body",
            });
        }
        const bucketToUse = s3Bucket || DEFAULT_BUCKET;
        // Start Textract async text detection job
        const startRes = await textractClient.send(new client_textract_1.StartDocumentTextDetectionCommand({
            DocumentLocation: {
                S3Object: {
                    Bucket: bucketToUse,
                    Name: s3Key,
                },
            },
        }));
        const jobId = startRes.JobId;
        if (!jobId) {
            return (0, api_1.apiResponse)(500, {
                message: 'Textract did not return a JobId',
            });
        }
        return (0, api_1.apiResponse)(200, {
            jobId,
            s3Key,
            s3Bucket: bucketToUse,
        });
    }
    catch (error) {
        console.error('Error in start-text-extraction handler:', error);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to start text extraction',
            error: error instanceof Error ? error.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVnaW4tZXh0cmFjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJlZ2luLWV4dHJhY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQThGO0FBQzlGLHdDQUE2QztBQUU3QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXLENBQUM7QUFDckQsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztBQUVwRCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQ3RFLENBQUM7QUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQU92RCxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hCLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxlQUFlO1lBQ25DLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUNyRCxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztRQUVmLElBQUksSUFBZ0MsQ0FBQztRQUNyQyxJQUFJLENBQUM7WUFDSCxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3QixDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1AsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLENBQUMsQ0FBQztRQUN2RSxDQUFDO1FBRUQsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFFakMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1gsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUseUNBQXlDO2FBQ25ELENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLFdBQVcsR0FBRyxRQUFRLElBQUksY0FBYyxDQUFDO1FBRS9DLDBDQUEwQztRQUMxQyxNQUFNLFFBQVEsR0FBRyxNQUFNLGNBQWMsQ0FBQyxJQUFJLENBQ3hDLElBQUksbURBQWlDLENBQUM7WUFDcEMsZ0JBQWdCLEVBQUU7Z0JBQ2hCLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUUsV0FBVztvQkFDbkIsSUFBSSxFQUFFLEtBQUs7aUJBQ1o7YUFDRjtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBRUYsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSxpQ0FBaUM7YUFDM0MsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixLQUFLO1lBQ0wsS0FBSztZQUNMLFFBQVEsRUFBRSxXQUFXO1NBQ3RCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRSxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLGlDQUFpQztZQUMxQyxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtTQUNoRSxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBNURXLFFBQUEsT0FBTyxXQTREbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFN0YXJ0RG9jdW1lbnRUZXh0RGV0ZWN0aW9uQ29tbWFuZCwgVGV4dHJhY3RDbGllbnQsIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXRleHRyYWN0JztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuXG5jb25zdCBSRUdJT04gPSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnO1xuY29uc3QgREVGQVVMVF9CVUNLRVQgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUO1xuXG5pZiAoIURFRkFVTFRfQlVDS0VUKSB7XG4gIHRocm93IG5ldyBFcnJvcignRE9DVU1FTlRTX0JVQ0tFVCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbmNvbnN0IHRleHRyYWN0Q2xpZW50ID0gbmV3IFRleHRyYWN0Q2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG5cbmludGVyZmFjZSBTdGFydEV4dHJhY3Rpb25SZXF1ZXN0Qm9keSB7XG4gIHMzS2V5Pzogc3RyaW5nO1xuICBzM0J1Y2tldD86IHN0cmluZzsgLy8gb3B0aW9uYWwsIGRlZmF1bHRzIHRvIERPQ1VNRU5UU19CVUNLRVRcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGlmICghZXZlbnQuYm9keSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByYXdCb2R5ID0gZXZlbnQuaXNCYXNlNjRFbmNvZGVkXG4gICAgICA/IEJ1ZmZlci5mcm9tKGV2ZW50LmJvZHksICdiYXNlNjQnKS50b1N0cmluZygndXRmLTgnKVxuICAgICAgOiBldmVudC5ib2R5O1xuXG4gICAgbGV0IGJvZHk6IFN0YXJ0RXh0cmFjdGlvblJlcXVlc3RCb2R5O1xuICAgIHRyeSB7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShyYXdCb2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBpbiByZXF1ZXN0IGJvZHknIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgczNLZXksIHMzQnVja2V0IH0gPSBib2R5O1xuXG4gICAgaWYgKCFzM0tleSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiBcIidzM0tleScgaXMgcmVxdWlyZWQgaW4gdGhlIHJlcXVlc3QgYm9keVwiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgYnVja2V0VG9Vc2UgPSBzM0J1Y2tldCB8fCBERUZBVUxUX0JVQ0tFVDtcblxuICAgIC8vIFN0YXJ0IFRleHRyYWN0IGFzeW5jIHRleHQgZGV0ZWN0aW9uIGpvYlxuICAgIGNvbnN0IHN0YXJ0UmVzID0gYXdhaXQgdGV4dHJhY3RDbGllbnQuc2VuZChcbiAgICAgIG5ldyBTdGFydERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQoe1xuICAgICAgICBEb2N1bWVudExvY2F0aW9uOiB7XG4gICAgICAgICAgUzNPYmplY3Q6IHtcbiAgICAgICAgICAgIEJ1Y2tldDogYnVja2V0VG9Vc2UsXG4gICAgICAgICAgICBOYW1lOiBzM0tleSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIGNvbnN0IGpvYklkID0gc3RhcnRSZXMuSm9iSWQ7XG4gICAgaWYgKCFqb2JJZCkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgICBtZXNzYWdlOiAnVGV4dHJhY3QgZGlkIG5vdCByZXR1cm4gYSBKb2JJZCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCB7XG4gICAgICBqb2JJZCxcbiAgICAgIHMzS2V5LFxuICAgICAgczNCdWNrZXQ6IGJ1Y2tldFRvVXNlLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHN0YXJ0LXRleHQtZXh0cmFjdGlvbiBoYW5kbGVyOicsIGVycm9yKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHN0YXJ0IHRleHQgZXh0cmFjdGlvbicsXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn07XG4iXX0=