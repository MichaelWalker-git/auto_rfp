"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const bedrock_http_client_1 = require("../helpers/bedrock-http-client");
const opensearch_1 = require("@opensearch-project/opensearch");
const api_1 = require("../helpers/api");
const embeddings_1 = require("../helpers/embeddings");
const REGION = process.env.AWS_REGION || 'us-east-1';
const DEFAULT_BUCKET = process.env.DOCUMENTS_BUCKET;
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const OPENSEARCH_INDEX = process.env.OPENSEARCH_INDEX || 'rfp-rag-index';
const EMBEDDING_MODEL_ID = process.env.BEDROCK_EMBEDDING_MODEL_ID || 'amazon.titan-embed-text-v2:0';
if (!DEFAULT_BUCKET) {
    throw new Error('DOCUMENTS_BUCKET environment variable is not set');
}
if (!OPENSEARCH_ENDPOINT) {
    throw new Error('OPENSEARCH_ENDPOINT environment variable is not set');
}
const s3Client = new client_s3_1.S3Client({ region: REGION });
const bedrockClient = (0, bedrock_http_client_1.createBedrockClient)();
// Simple basic-auth client for OpenSearch (dev-friendly);
// switch to SigV4 if you use IAM-auth.
const opensearchClient = new opensearch_1.Client({
    node: OPENSEARCH_ENDPOINT,
    auth: process.env.OPENSEARCH_USERNAME
        ? {
            username: process.env.OPENSEARCH_USERNAME,
            password: process.env.OPENSEARCH_PASSWORD || '',
        }
        : undefined,
});
/**
 * Main handler: given s3Key => read text => chunk => embed => index into OpenSearch.
 */
const handler = async (event) => {
    try {
        const method = event.requestContext.http?.method ??
            event.httpMethod;
        if (method !== 'POST') {
            return (0, api_1.apiResponse)(405, { message: 'Method Not Allowed. Use POST.' });
        }
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is required' });
        }
        const rawBody = event.isBase64Encoded
            ? Buffer.from(event.body, 'base64').toString('utf-8')
            : event.body;
        let body;
        try {
            body = JSON.parse(rawBody);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        const { s3Key, s3Bucket, docId } = body;
        if (!s3Key) {
            return (0, api_1.apiResponse)(400, {
                message: "'s3Key' is required in the request body",
            });
        }
        const bucketToUse = s3Bucket || DEFAULT_BUCKET;
        // 1) Resolve txt key: if not .txt, assume normalized key is same path with .txt
        const txtKey = ensureTxtKey(s3Key);
        // 2) Read text from S3
        const text = await getObjectAsString(bucketToUse, txtKey);
        if (!text || !text.trim()) {
            return (0, api_1.apiResponse)(400, {
                message: `Text content is empty for key ${txtKey}`,
            });
        }
        // 3) Chunk the text for RAG
        const chunks = chunkText(text, {
            maxChars: 2000,
            overlap: 200,
        });
        // 4) Generate embeddings for each chunk via Bedrock
        const embeddedChunks = await embedChunks(chunks, {
            fileKey: s3Key,
            txtKey,
            docId,
        });
        // 5) Index into OpenSearch
        await indexChunksToOpenSearch(embeddedChunks);
        return (0, api_1.apiResponse)(200, {
            message: 'Indexed chunks successfully',
            bucket: bucketToUse,
            inputKey: s3Key,
            txtKey,
            index: OPENSEARCH_INDEX,
            indexedChunks: embeddedChunks.length,
        });
    }
    catch (error) {
        console.error('Error in create-index-from-file handler:', error);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to create index from file',
            error: error instanceof Error ? error.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// -------- S3 helpers --------
async function getObjectAsString(bucket, key) {
    const res = await s3Client.send(new client_s3_1.GetObjectCommand({ Bucket: bucket, Key: key }));
    if (!res.Body) {
        throw new Error('Empty S3 object body');
    }
    const body = res.Body;
    if (typeof body.transformToString === 'function') {
        return await body.transformToString();
    }
    return await new Promise((resolve, reject) => {
        const chunks = [];
        body.on('data', (chunk) => chunks.push(chunk));
        body.on('error', reject);
        body.on('end', () => resolve(Buffer.concat(chunks).toString('utf-8')));
    });
}
function ensureTxtKey(key) {
    const lastDot = key.lastIndexOf('.');
    if (lastDot === -1) {
        return `${key}.txt`;
    }
    const ext = key.slice(lastDot + 1).toLowerCase();
    if (ext === 'txt')
        return key;
    return `${key.slice(0, lastDot)}.txt`;
}
function chunkText(text, options) {
    const { maxChars, overlap } = options;
    const chunks = [];
    const normalized = text.replace(/\r\n/g, '\n').trim();
    let start = 0;
    let idx = 0;
    while (start < normalized.length) {
        const end = Math.min(start + maxChars, normalized.length);
        const slice = normalized.slice(start, end);
        chunks.push({
            id: `chunk_${idx}`,
            index: idx,
            content: slice,
        });
        if (end === normalized.length)
            break;
        start = end - overlap;
        if (start < 0)
            start = 0;
        idx += 1;
    }
    return chunks;
}
async function embedChunks(chunks, ctx) {
    const result = [];
    for (const chunk of chunks) {
        const embedding = await (0, embeddings_1.getEmbedding)(bedrockClient, EMBEDDING_MODEL_ID, chunk.content);
        result.push({
            ...chunk,
            embedding,
            fileKey: ctx.fileKey,
            txtKey: ctx.txtKey,
            docId: ctx.docId,
        });
    }
    return result;
}
// -------- OpenSearch helpers --------
async function indexChunksToOpenSearch(chunks) {
    if (!chunks.length)
        return;
    const body = [];
    for (const chunk of chunks) {
        const docId = `${chunk.fileKey}::${chunk.id}`;
        body.push({
            index: { _index: OPENSEARCH_INDEX, _id: docId },
        });
        body.push({
            fileKey: chunk.fileKey,
            txtKey: chunk.txtKey,
            docId: chunk.docId,
            chunkId: chunk.id,
            chunkIndex: chunk.index,
            content: chunk.content,
            embedding: chunk.embedding,
            createdAt: new Date().toISOString(),
        });
    }
    const resp = await opensearchClient.bulk({
        index: OPENSEARCH_INDEX,
        body,
        refresh: 'true',
    });
    if (resp.body.errors) {
        console.error('Bulk indexing errors:', JSON.stringify(resp.body, null, 2));
        throw new Error('Failed to index some chunks into OpenSearch');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLWluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGtEQUFpRTtBQUVqRSx3RUFBcUU7QUFDckUsK0RBQTRFO0FBQzVFLHdDQUE2QztBQUM3QyxzREFBcUQ7QUFFckQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxDQUFDO0FBQ3JELE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7QUFFcEQsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDO0FBQzVELE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxlQUFlLENBQUM7QUFDekUsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixJQUFJLDhCQUE4QixDQUFDO0FBRXBHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7QUFDdEUsQ0FBQztBQUNELElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQztBQUN6RSxDQUFDO0FBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDbEQsTUFBTSxhQUFhLEdBQUcsSUFBQSx5Q0FBbUIsR0FBRSxDQUFDO0FBRTVDLDBEQUEwRDtBQUMxRCx1Q0FBdUM7QUFDdkMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLG1CQUFnQixDQUFDO0lBQzVDLElBQUksRUFBRSxtQkFBbUI7SUFDekIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQ25DLENB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SSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzRSxNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7SUFDakUsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IEdldE9iamVjdENvbW1hbmQsIFMzQ2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBCZWRyb2NrUnVudGltZUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1iZWRyb2NrLXJ1bnRpbWUnO1xuaW1wb3J0IHsgY3JlYXRlQmVkcm9ja0NsaWVudCB9IGZyb20gJy4uL2hlbHBlcnMvYmVkcm9jay1odHRwLWNsaWVudCc7XG5pbXBvcnQgeyBDbGllbnQgYXMgT3BlblNlYXJjaENsaWVudCB9IGZyb20gJ0BvcGVuc2VhcmNoLXByb2plY3Qvb3BlbnNlYXJjaCc7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IGdldEVtYmVkZGluZyB9IGZyb20gJy4uL2hlbHBlcnMvZW1iZWRkaW5ncyc7XG5cbmNvbnN0IFJFR0lPTiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMSc7XG5jb25zdCBERUZBVUxUX0JVQ0tFVCA9IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19CVUNLRVQ7XG5cbmNvbnN0IE9QRU5TRUFSQ0hfRU5EUE9JTlQgPSBwcm9jZXNzLmVudi5PUEVOU0VBUkNIX0VORFBPSU5UO1xuY29uc3QgT1BFTlNFQVJDSF9JTkRFWCA9IHByb2Nlc3MuZW52Lk9QRU5TRUFSQ0hfSU5ERVggfHwgJ3JmcC1yYWctaW5kZXgnO1xuY29uc3QgRU1CRURESU5HX01PREVMX0lEID0gcHJvY2Vzcy5lbnYuQkVEUk9DS19FTUJFRERJTkdfTU9ERUxfSUQgfHwgJ2FtYXpvbi50aXRhbi1lbWJlZC10ZXh0LXYyOjAnO1xuXG5pZiAoIURFRkFVTFRfQlVDS0VUKSB7XG4gIHRocm93IG5ldyBFcnJvcignRE9DVU1FTlRTX0JVQ0tFVCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5pZiAoIU9QRU5TRUFSQ0hfRU5EUE9JTlQpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdPUEVOU0VBUkNIX0VORFBPSU5UIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IFJFR0lPTiB9KTtcbmNvbnN0IGJlZHJvY2tDbGllbnQgPSBjcmVhdGVCZWRyb2NrQ2xpZW50KCk7XG5cbi8vIFNpbXBsZSBiYXNpYy1hdXRoIGNsaWVudCBmb3IgT3BlblNlYXJjaCAoZGV2LWZyaWVuZGx5KTtcbi8vIHN3aXRjaCB0byBTaWdWNCBpZiB5b3UgdXNlIElBTS1hdXRoLlxuY29uc3Qgb3BlbnNlYXJjaENsaWVudCA9IG5ldyBPcGVuU2VhcmNoQ2xpZW50KHtcbiAgbm9kZTogT1BFTlNFQVJDSF9FTkRQT0lOVCxcbiAgYXV0aDogcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9VU0VSTkFNRVxuICAgID8ge1xuICAgICAgdXNlcm5hbWU6IHByb2Nlc3MuZW52Lk9QRU5TRUFSQ0hfVVNFUk5BTUUsXG4gICAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9QQVNTV09SRCB8fCAnJyxcbiAgICB9XG4gICAgOiB1bmRlZmluZWQsXG59KTtcblxuaW50ZXJmYWNlIENyZWF0ZUluZGV4UmVxdWVzdEJvZHkge1xuICBzM0tleT86IHN0cmluZzsgICAgIC8vIGtleSBvZiBvcmlnaW5hbCBvciB0eHQgZmlsZVxuICBzM0J1Y2tldD86IHN0cmluZzsgIC8vIG9wdGlvbmFsLCBkZWZhdWx0cyB0byBET0NVTUVOVFNfQlVDS0VUXG4gIGRvY0lkPzogc3RyaW5nOyAgICAgLy8gb3B0aW9uYWwgaGlnaGVyLWxldmVsIGlkIChlLmcuIHByb2plY3RJZC1kb2N1bWVudElkKVxufVxuXG4vKipcbiAqIE1haW4gaGFuZGxlcjogZ2l2ZW4gczNLZXkgPT4gcmVhZCB0ZXh0ID0+IGNodW5rID0+IGVtYmVkID0+IGluZGV4IGludG8gT3BlblNlYXJjaC5cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IG1ldGhvZCA9XG4gICAgICBldmVudC5yZXF1ZXN0Q29udGV4dC5odHRwPy5tZXRob2QgPz9cbiAgICAgIChldmVudCBhcyBhbnkpLmh0dHBNZXRob2Q7XG5cbiAgICBpZiAobWV0aG9kICE9PSAnUE9TVCcpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDUsIHsgbWVzc2FnZTogJ01ldGhvZCBOb3QgQWxsb3dlZC4gVXNlIFBPU1QuJyB9KTtcbiAgICB9XG5cbiAgICBpZiAoIWV2ZW50LmJvZHkpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmF3Qm9keSA9IGV2ZW50LmlzQmFzZTY0RW5jb2RlZFxuICAgICAgPyBCdWZmZXIuZnJvbShldmVudC5ib2R5LCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0Zi04JylcbiAgICAgIDogZXZlbnQuYm9keTtcblxuICAgIGxldCBib2R5OiBDcmVhdGVJbmRleFJlcXVlc3RCb2R5O1xuICAgIHRyeSB7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShyYXdCb2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBpbiByZXF1ZXN0IGJvZHknIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgczNLZXksIHMzQnVja2V0LCBkb2NJZCB9ID0gYm9keTtcblxuICAgIGlmICghczNLZXkpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogXCInczNLZXknIGlzIHJlcXVpcmVkIGluIHRoZSByZXF1ZXN0IGJvZHlcIixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJ1Y2tldFRvVXNlID0gczNCdWNrZXQgfHwgREVGQVVMVF9CVUNLRVQ7XG5cbiAgICAvLyAxKSBSZXNvbHZlIHR4dCBrZXk6IGlmIG5vdCAudHh0LCBhc3N1bWUgbm9ybWFsaXplZCBrZXkgaXMgc2FtZSBwYXRoIHdpdGggLnR4dFxuICAgIGNvbnN0IHR4dEtleSA9IGVuc3VyZVR4dEtleShzM0tleSk7XG5cbiAgICAvLyAyKSBSZWFkIHRleHQgZnJvbSBTM1xuICAgIGNvbnN0IHRleHQgPSBhd2FpdCBnZXRPYmplY3RBc1N0cmluZyhidWNrZXRUb1VzZSwgdHh0S2V5KTtcblxuICAgIGlmICghdGV4dCB8fCAhdGV4dC50cmltKCkpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogYFRleHQgY29udGVudCBpcyBlbXB0eSBmb3Iga2V5ICR7dHh0S2V5fWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyAzKSBDaHVuayB0aGUgdGV4dCBmb3IgUkFHXG4gICAgY29uc3QgY2h1bmtzID0gY2h1bmtUZXh0KHRleHQsIHtcbiAgICAgIG1heENoYXJzOiAyMDAwLFxuICAgICAgb3ZlcmxhcDogMjAwLFxuICAgIH0pO1xuXG4gICAgLy8gNCkgR2VuZXJhdGUgZW1iZWRkaW5ncyBmb3IgZWFjaCBjaHVuayB2aWEgQmVkcm9ja1xuICAgIGNvbnN0IGVtYmVkZGVkQ2h1bmtzID0gYXdhaXQgZW1iZWRDaHVua3MoY2h1bmtzLCB7XG4gICAgICBmaWxlS2V5OiBzM0tleSxcbiAgICAgIHR4dEtleSxcbiAgICAgIGRvY0lkLFxuICAgIH0pO1xuXG4gICAgLy8gNSkgSW5kZXggaW50byBPcGVuU2VhcmNoXG4gICAgYXdhaXQgaW5kZXhDaHVua3NUb09wZW5TZWFyY2goZW1iZWRkZWRDaHVua3MpO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgbWVzc2FnZTogJ0luZGV4ZWQgY2h1bmtzIHN1Y2Nlc3NmdWxseScsXG4gICAgICBidWNrZXQ6IGJ1Y2tldFRvVXNlLFxuICAgICAgaW5wdXRLZXk6IHMzS2V5LFxuICAgICAgdHh0S2V5LFxuICAgICAgaW5kZXg6IE9QRU5TRUFSQ0hfSU5ERVgsXG4gICAgICBpbmRleGVkQ2h1bmtzOiBlbWJlZGRlZENodW5rcy5sZW5ndGgsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gY3JlYXRlLWluZGV4LWZyb20tZmlsZSBoYW5kbGVyOicsIGVycm9yKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGNyZWF0ZSBpbmRleCBmcm9tIGZpbGUnLFxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG4vLyAtLS0tLS0tLSBTMyBoZWxwZXJzIC0tLS0tLS0tXG5cbmFzeW5jIGZ1bmN0aW9uIGdldE9iamVjdEFzU3RyaW5nKGJ1Y2tldDogc3RyaW5nLCBrZXk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoXG4gICAgbmV3IEdldE9iamVjdENvbW1hbmQoeyBCdWNrZXQ6IGJ1Y2tldCwgS2V5OiBrZXkgfSksXG4gICk7XG5cbiAgaWYgKCFyZXMuQm9keSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgUzMgb2JqZWN0IGJvZHknKTtcbiAgfVxuXG4gIGNvbnN0IGJvZHk6IGFueSA9IHJlcy5Cb2R5O1xuXG4gIGlmICh0eXBlb2YgYm9keS50cmFuc2Zvcm1Ub1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBhd2FpdCBib2R5LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY2h1bmtzOiBCdWZmZXJbXSA9IFtdO1xuICAgIGJvZHkub24oJ2RhdGEnLCAoY2h1bms6IEJ1ZmZlcikgPT4gY2h1bmtzLnB1c2goY2h1bmspKTtcbiAgICBib2R5Lm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgYm9keS5vbignZW5kJywgKCkgPT5cbiAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdChjaHVua3MpLnRvU3RyaW5nKCd1dGYtOCcpKSxcbiAgICApO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZW5zdXJlVHh0S2V5KGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbGFzdERvdCA9IGtleS5sYXN0SW5kZXhPZignLicpO1xuICBpZiAobGFzdERvdCA9PT0gLTEpIHtcbiAgICByZXR1cm4gYCR7a2V5fS50eHRgO1xuICB9XG4gIGNvbnN0IGV4dCA9IGtleS5zbGljZShsYXN0RG90ICsgMSkudG9Mb3dlckNhc2UoKTtcbiAgaWYgKGV4dCA9PT0gJ3R4dCcpIHJldHVybiBrZXk7XG4gIHJldHVybiBgJHtrZXkuc2xpY2UoMCwgbGFzdERvdCl9LnR4dGA7XG59XG5cbi8vIC0tLS0tLS0tIENodW5raW5nIGhlbHBlcnMgLS0tLS0tLS1cblxuaW50ZXJmYWNlIENodW5rT3B0aW9ucyB7XG4gIG1heENoYXJzOiBudW1iZXI7XG4gIG92ZXJsYXA6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFRleHRDaHVuayB7XG4gIGlkOiBzdHJpbmc7XG4gIGluZGV4OiBudW1iZXI7XG4gIGNvbnRlbnQ6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY2h1bmtUZXh0KHRleHQ6IHN0cmluZywgb3B0aW9uczogQ2h1bmtPcHRpb25zKTogVGV4dENodW5rW10ge1xuICBjb25zdCB7IG1heENoYXJzLCBvdmVybGFwIH0gPSBvcHRpb25zO1xuICBjb25zdCBjaHVua3M6IFRleHRDaHVua1tdID0gW107XG5cbiAgY29uc3Qgbm9ybWFsaXplZCA9IHRleHQucmVwbGFjZSgvXFxyXFxuL2csICdcXG4nKS50cmltKCk7XG4gIGxldCBzdGFydCA9IDA7XG4gIGxldCBpZHggPSAwO1xuXG4gIHdoaWxlIChzdGFydCA8IG5vcm1hbGl6ZWQubGVuZ3RoKSB7XG4gICAgY29uc3QgZW5kID0gTWF0aC5taW4oc3RhcnQgKyBtYXhDaGFycywgbm9ybWFsaXplZC5sZW5ndGgpO1xuICAgIGNvbnN0IHNsaWNlID0gbm9ybWFsaXplZC5zbGljZShzdGFydCwgZW5kKTtcblxuICAgIGNodW5rcy5wdXNoKHtcbiAgICAgIGlkOiBgY2h1bmtfJHtpZHh9YCxcbiAgICAgIGluZGV4OiBpZHgsXG4gICAgICBjb250ZW50OiBzbGljZSxcbiAgICB9KTtcblxuICAgIGlmIChlbmQgPT09IG5vcm1hbGl6ZWQubGVuZ3RoKSBicmVhaztcblxuICAgIHN0YXJ0ID0gZW5kIC0gb3ZlcmxhcDtcbiAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IDA7XG4gICAgaWR4ICs9IDE7XG4gIH1cblxuICByZXR1cm4gY2h1bmtzO1xufVxuXG4vLyAtLS0tLS0tLSBFbWJlZGRpbmcgaGVscGVycyAtLS0tLS0tLVxuXG5pbnRlcmZhY2UgRW1iZWRkZWRDaHVuayBleHRlbmRzIFRleHRDaHVuayB7XG4gIGVtYmVkZGluZzogbnVtYmVyW107XG4gIGZpbGVLZXk6IHN0cmluZztcbiAgdHh0S2V5OiBzdHJpbmc7XG4gIGRvY0lkPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgRW1iZWRDb250ZXh0IHtcbiAgZmlsZUtleTogc3RyaW5nO1xuICB0eHRLZXk6IHN0cmluZztcbiAgZG9jSWQ/OiBzdHJpbmc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVtYmVkQ2h1bmtzKFxuICBjaHVua3M6IFRleHRDaHVua1tdLFxuICBjdHg6IEVtYmVkQ29udGV4dCxcbik6IFByb21pc2U8RW1iZWRkZWRDaHVua1tdPiB7XG4gIGNvbnN0IHJlc3VsdDogRW1iZWRkZWRDaHVua1tdID0gW107XG5cbiAgZm9yIChjb25zdCBjaHVuayBvZiBjaHVua3MpIHtcbiAgICBjb25zdCBlbWJlZGRpbmcgPSBhd2FpdCBnZXRFbWJlZGRpbmcoYmVkcm9ja0NsaWVudCwgRU1CRURESU5HX01PREVMX0lELCBjaHVuay5jb250ZW50KTtcbiAgICByZXN1bHQucHVzaCh7XG4gICAgICAuLi5jaHVuayxcbiAgICAgIGVtYmVkZGluZyxcbiAgICAgIGZpbGVLZXk6IGN0eC5maWxlS2V5LFxuICAgICAgdHh0S2V5OiBjdHgudHh0S2V5LFxuICAgICAgZG9jSWQ6IGN0eC5kb2NJZCxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxuLy8gLS0tLS0tLS0gT3BlblNlYXJjaCBoZWxwZXJzIC0tLS0tLS0tXG5cbmFzeW5jIGZ1bmN0aW9uIGluZGV4Q2h1bmtzVG9PcGVuU2VhcmNoKFxuICBjaHVua3M6IEVtYmVkZGVkQ2h1bmtbXSxcbik6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoIWNodW5rcy5sZW5ndGgpIHJldHVybjtcblxuICBjb25zdCBib2R5OiBhbnlbXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgY2h1bmsgb2YgY2h1bmtzKSB7XG4gICAgY29uc3QgZG9jSWQgPSBgJHtjaHVuay5maWxlS2V5fTo6JHtjaHVuay5pZH1gO1xuICAgIGJvZHkucHVzaCh7XG4gICAgICBpbmRleDogeyBfaW5kZXg6IE9QRU5TRUFSQ0hfSU5ERVgsIF9pZDogZG9jSWQgfSxcbiAgICB9KTtcbiAgICBib2R5LnB1c2goe1xuICAgICAgZmlsZUtleTogY2h1bmsuZmlsZUtleSxcbiAgICAgIHR4dEtleTogY2h1bmsudHh0S2V5LFxuICAgICAgZG9jSWQ6IGNodW5rLmRvY0lkLFxuICAgICAgY2h1bmtJZDogY2h1bmsuaWQsXG4gICAgICBjaHVua0luZGV4OiBjaHVuay5pbmRleCxcbiAgICAgIGNvbnRlbnQ6IGNodW5rLmNvbnRlbnQsXG4gICAgICBlbWJlZGRpbmc6IGNodW5rLmVtYmVkZGluZyxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IG9wZW5zZWFyY2hDbGllbnQuYnVsayh7XG4gICAgaW5kZXg6IE9QRU5TRUFSQ0hfSU5ERVgsXG4gICAgYm9keSxcbiAgICByZWZyZXNoOiAndHJ1ZScsXG4gIH0pO1xuXG4gIGlmICgocmVzcC5ib2R5IGFzIGFueSkuZXJyb3JzKSB7XG4gICAgY29uc29sZS5lcnJvcignQnVsayBpbmRleGluZyBlcnJvcnM6JywgSlNPTi5zdHJpbmdpZnkocmVzcC5ib2R5LCBudWxsLCAyKSk7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gaW5kZXggc29tZSBjaHVua3MgaW50byBPcGVuU2VhcmNoJyk7XG4gIH1cbn1cbiJdfQ==