"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const answer_1 = require("../constants/answer");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME env var is missing');
}
const handler = async (event) => {
    try {
        const projectId = event.pathParameters?.id;
        if (!projectId) {
            return (0, api_1.apiResponse)(400, { message: 'Missing projectId' });
        }
        const answers = await loadAnswers(projectId);
        const byQuestion = groupAnswersByQuestion(answers);
        return (0, api_1.apiResponse)(200, byQuestion);
    }
    catch (err) {
        console.error('get-answers error', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal error',
            error: err instanceof Error ? err.message : 'Unknown',
        });
    }
};
exports.handler = handler;
// ---------- LOAD ANSWERS FROM DYNAMODB ----------
async function loadAnswers(projectId) {
    let items = [];
    let LastKey;
    const prefix = `${projectId}#`;
    do {
        const res = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: DB_TABLE_NAME,
            KeyConditionExpression: '#pk = :pk AND begins_with(#sk, :prefix)',
            ExpressionAttributeNames: {
                '#pk': common_1.PK_NAME,
                '#sk': common_1.SK_NAME,
            },
            ExpressionAttributeValues: {
                ':pk': answer_1.ANSWER_PK,
                ':prefix': prefix,
            },
            ExclusiveStartKey: LastKey,
        }));
        if (res.Items)
            items.push(...res.Items);
        LastKey = res.LastEvaluatedKey;
    } while (LastKey);
    return items;
}
// ---------- GROUP BY questionId & PICK LATEST ----------
/**
 * Result shape: {
 *   [questionId: string]: {
 *     text: string;
 *     source?: string | null;
 *     id?: string;
 *     organizationId?: string | null;
 *     createdAt?: string;
 *     updatedAt?: string;
 *   }
 * }
 */
function groupAnswersByQuestion(flatAnswers) {
    const map = {};
    for (const item of flatAnswers) {
        const questionId = item.questionId;
        if (!questionId)
            continue;
        const current = map[questionId];
        const candidate = {
            id: item.id,
            questionId: item.questionId,
            projectId: item.projectId,
            organizationId: item.organizationId ?? null,
            text: item.text,
            source: item.source ?? null,
            createdAt: item.createdAt,
            updatedAt: item.updatedAt,
        };
        if (!current) {
            map[questionId] = candidate;
            continue;
        }
        // pick the latest by updatedAt, then createdAt
        const curTime = new Date(current.updatedAt || current.createdAt || 0).getTime();
        const candTime = new Date(candidate.updatedAt || candidate.createdAt || 0).getTime();
        if (candTime > curTime) {
            map[questionId] = candidate;
        }
    }
    return map;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWFuc3dlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQtYW5zd2Vycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQThFO0FBRTlFLHdDQUE2QztBQUM3QyxnREFBdUQ7QUFDdkQsZ0RBQWdEO0FBRWhELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFFSCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUNoRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFFTSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDZixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQzVELENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM3QyxNQUFNLFVBQVUsR0FBRyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVuRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMs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UUFDOUIsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IEFOU1dFUl9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9hbnN3ZXInO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHsgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlIH0sXG59KTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudiB2YXIgaXMgbWlzc2luZycpO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcHJvamVjdElkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LmlkO1xuICAgIGlmICghcHJvamVjdElkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdNaXNzaW5nIHByb2plY3RJZCcgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgYW5zd2VycyA9IGF3YWl0IGxvYWRBbnN3ZXJzKHByb2plY3RJZCk7XG4gICAgY29uc3QgYnlRdWVzdGlvbiA9IGdyb3VwQW5zd2Vyc0J5UXVlc3Rpb24oYW5zd2Vycyk7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCBieVF1ZXN0aW9uKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignZ2V0LWFuc3dlcnMgZXJyb3InLCBlcnIpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdJbnRlcm5hbCBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duJyxcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tLS0tLS0tLSBMT0FEIEFOU1dFUlMgRlJPTSBEWU5BTU9EQiAtLS0tLS0tLS0tXG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRBbnN3ZXJzKHByb2plY3RJZDogc3RyaW5nKTogUHJvbWlzZTxhbnlbXT4ge1xuICBsZXQgaXRlbXM6IGFueVtdID0gW107XG4gIGxldCBMYXN0S2V5OiBhbnkgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3QgcHJlZml4ID0gYCR7cHJvamVjdElkfSNgO1xuXG4gIGRvIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246XG4gICAgICAgICAgJyNwayA9IDpwayBBTkQgYmVnaW5zX3dpdGgoI3NrLCA6cHJlZml4KScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICcjcGsnOiBQS19OQU1FLFxuICAgICAgICAgICcjc2snOiBTS19OQU1FLFxuICAgICAgICB9LFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwayc6IEFOU1dFUl9QSyxcbiAgICAgICAgICAnOnByZWZpeCc6IHByZWZpeCxcbiAgICAgICAgfSxcbiAgICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IExhc3RLZXksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgaWYgKHJlcy5JdGVtcykgaXRlbXMucHVzaCguLi5yZXMuSXRlbXMpO1xuICAgIExhc3RLZXkgPSByZXMuTGFzdEV2YWx1YXRlZEtleTtcbiAgfSB3aGlsZSAoTGFzdEtleSk7XG5cbiAgcmV0dXJuIGl0ZW1zO1xufVxuXG4vLyAtLS0tLS0tLS0tIEdST1VQIEJZIHF1ZXN0aW9uSWQgJiBQSUNLIExBVEVTVCAtLS0tLS0tLS0tXG5cbi8qKlxuICogUmVzdWx0IHNoYXBlOiB7XG4gKiAgIFtxdWVzdGlvbklkOiBzdHJpbmddOiB7XG4gKiAgICAgdGV4dDogc3RyaW5nO1xuICogICAgIHNvdXJjZT86IHN0cmluZyB8IG51bGw7XG4gKiAgICAgaWQ/OiBzdHJpbmc7XG4gKiAgICAgb3JnYW5pemF0aW9uSWQ/OiBzdHJpbmcgfCBudWxsO1xuICogICAgIGNyZWF0ZWRBdD86IHN0cmluZztcbiAqICAgICB1cGRhdGVkQXQ/OiBzdHJpbmc7XG4gKiAgIH1cbiAqIH1cbiAqL1xuZnVuY3Rpb24gZ3JvdXBBbnN3ZXJzQnlRdWVzdGlvbihmbGF0QW5zd2VyczogYW55W10pIHtcbiAgY29uc3QgbWFwOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgZm9yIChjb25zdCBpdGVtIG9mIGZsYXRBbnN3ZXJzKSB7XG4gICAgY29uc3QgcXVlc3Rpb25JZCA9IGl0ZW0ucXVlc3Rpb25JZDtcbiAgICBpZiAoIXF1ZXN0aW9uSWQpIGNvbnRpbnVlO1xuXG4gICAgY29uc3QgY3VycmVudCA9IG1hcFtxdWVzdGlvbklkXTtcblxuICAgIGNvbnN0IGNhbmRpZGF0ZSA9IHtcbiAgICAgIGlkOiBpdGVtLmlkLFxuICAgICAgcXVlc3Rpb25JZDogaXRlbS5xdWVzdGlvbklkLFxuICAgICAgcHJvamVjdElkOiBpdGVtLnByb2plY3RJZCxcbiAgICAgIG9yZ2FuaXphdGlvbklkOiBpdGVtLm9yZ2FuaXphdGlvbklkID8/IG51bGwsXG4gICAgICB0ZXh0OiBpdGVtLnRleHQsXG4gICAgICBzb3VyY2U6IGl0ZW0uc291cmNlID8/IG51bGwsXG4gICAgICBjcmVhdGVkQXQ6IGl0ZW0uY3JlYXRlZEF0LFxuICAgICAgdXBkYXRlZEF0OiBpdGVtLnVwZGF0ZWRBdCxcbiAgICB9O1xuXG4gICAgaWYgKCFjdXJyZW50KSB7XG4gICAgICBtYXBbcXVlc3Rpb25JZF0gPSBjYW5kaWRhdGU7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICAvLyBwaWNrIHRoZSBsYXRlc3QgYnkgdXBkYXRlZEF0LCB0aGVuIGNyZWF0ZWRBdFxuICAgIGNvbnN0IGN1clRpbWUgPSBuZXcgRGF0ZShjdXJyZW50LnVwZGF0ZWRBdCB8fCBjdXJyZW50LmNyZWF0ZWRBdCB8fCAwKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgY2FuZFRpbWUgPSBuZXcgRGF0ZShjYW5kaWRhdGUudXBkYXRlZEF0IHx8IGNhbmRpZGF0ZS5jcmVhdGVkQXQgfHwgMCkuZ2V0VGltZSgpO1xuXG4gICAgaWYgKGNhbmRUaW1lID4gY3VyVGltZSkge1xuICAgICAgbWFwW3F1ZXN0aW9uSWRdID0gY2FuZGlkYXRlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYXA7XG59XG4iXX0=