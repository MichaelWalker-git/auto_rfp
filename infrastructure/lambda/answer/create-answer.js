"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.createAnswer = createAnswer;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
const answer_1 = require("../schemas/answer");
const answer_2 = require("../constants/answer");
// --- Dynamo client setup ---
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
// --- Main Handler ---
const handler = async (event) => {
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Runtime validation with Zod
        const validationResult = answer_1.CreateAnswerDTOSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const dto = validationResult.data;
        // 2. Create answer item in Dynamo
        const newAnswer = await createAnswer(dto);
        return (0, api_1.apiResponse)(201, newAnswer);
    }
    catch (err) {
        console.error('Error in createAnswer handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- Business Logic ---
// Input is guaranteed valid CreateAnswerDTO thanks to Zod
async function createAnswer(dto) {
    const now = new Date().toISOString();
    const answerId = (0, uuid_1.v4)();
    const { questionId, text, projectId, organizationId, } = dto;
    const sortKey = `${projectId}#${questionId}#${answerId}`;
    const answerItem = {
        [common_1.PK_NAME]: answer_2.ANSWER_PK,
        [common_1.SK_NAME]: sortKey,
        id: answerId,
        questionId,
        projectId,
        organizationId,
        text,
        source: 'manual', // we know this is user-entered
        createdAt: now,
        updatedAt: now,
    };
    const command = new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: answerItem,
    });
    await docClient.send(command);
    return answerItem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWFuc3dlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNyZWF0ZS1hbnN3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBMkVBLG9DQXVDQztBQWpIRCw4REFBMEQ7QUFDMUQsd0RBQTRFO0FBQzVFLCtCQUFvQztBQUVwQyxnREFBdUQ7QUFDdkQsd0NBQTZDO0FBQzdDLDhDQUF3RjtBQUN4RixnREFBZ0Q7QUFFaEQsOEJBQThCO0FBRTlCLE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUVoRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO0FBQ25FLENBQUM7QUFFRCx1QkFBdUI7QUFFaEIsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2QyxpQ0FBaUM7UUFDakMsTUFBTSxnQkFBZ0IsR0FBRyw4QkFBcUIsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzlCLE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO2dCQUMxQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87YUFDdkIsQ0FBQyxDQUFDLENBQUM7WUFFSixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSxtQkFBbUI7Z0JBQzVCLE1BQU0sRUFBRSxZQUFZO2FBQ3JCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBb0IsZ0JBQWdCLENBQUMsSUFBSSxDQUFDO1FBRW5ELGtDQUFrQztRQUNsQyxNQUFNLFNBQVMsR0FBRyxNQUFNLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUxQyxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXJELElBQUksR0FBRyxZQUFZLFdBQVcsRUFBRSxDQUFDO1lBQy9CLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxDQUFDLENBQUM7UUFDdkUsQ0FBQztRQUVELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUEzQ1csUUFBQSxPQUFPLFdBMkNsQjtBQUVGLHlCQUF5QjtBQUN6QiwwREFBMEQ7QUFFbkQsS0FBSyxVQUFVLFlBQVksQ0FDaEMsR0FBb0I7SUFFcEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFBLFNBQU0sR0FBRSxDQUFDO0lBRTFCLE1BQU0sRUFDSixVQUFVLEVBQ1YsSUFBSSxFQUNKLFNBQVMsRUFDVCxjQUFjLEdBQ2YsR0FBRyxHQUFHLENBQUM7SUFHUixNQUFNLE9BQU8sR0FBRyxHQUFHLFNBQVMsSUFBSSxVQUFVLElBQUksUUFBUSxFQUFFLENBQUM7SUFFekQsTUFBTSxVQUFVLEdBQXFDO1FBQ25ELENBQUMsZ0JBQU8sQ0FBQyxFQUFFLGtCQUFTO1FBQ3BCLENBQUMsZ0JBQU8sQ0FBQyxFQUFFLE9BQU87UUFFbEIsRUFBRSxFQUFFLFFBQVE7UUFDWixVQUFVO1FBQ1YsU0FBUztRQUNULGNBQWM7UUFDZCxJQUFJO1FBQ0osTUFBTSxFQUFFLFFBQVEsRUFBSSwrQkFBK0I7UUFFbkQsU0FBUyxFQUFFLEdBQUc7UUFDZCxTQUFTLEVBQUUsR0FBRztLQUNmLENBQUM7SUFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLHlCQUFVLENBQUM7UUFDN0IsU0FBUyxFQUFFLGFBQWE7UUFDeEIsSUFBSSxFQUFFLFVBQVU7S0FDakIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlCLE9BQU8sVUFBd0IsQ0FBQztBQUNsQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIsIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBQdXRDb21tYW5kLCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgUEtfTkFNRSwgU0tfTkFNRSB9IGZyb20gJy4uL2NvbnN0YW50cy9jb21tb24nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBBbnN3ZXJJdGVtLCBDcmVhdGVBbnN3ZXJEVE8sIENyZWF0ZUFuc3dlckRUT1NjaGVtYSwgfSBmcm9tICcuLi9zY2hlbWFzL2Fuc3dlcic7XG5pbXBvcnQgeyBBTlNXRVJfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvYW5zd2VyJztcblxuLy8gLS0tIER5bmFtbyBjbGllbnQgc2V0dXAgLS0tXG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50LCB7XG4gIG1hcnNoYWxsT3B0aW9uczoge1xuICAgIHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSxcbiAgfSxcbn0pO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbi8vIC0tLSBNYWluIEhhbmRsZXIgLS0tXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByYXdCb2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcblxuICAgIC8vIDEuIFJ1bnRpbWUgdmFsaWRhdGlvbiB3aXRoIFpvZFxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBDcmVhdGVBbnN3ZXJEVE9TY2hlbWEuc2FmZVBhcnNlKHJhd0JvZHkpO1xuXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGVycm9yRGV0YWlscyA9IHZhbGlkYXRpb25SZXN1bHQuZXJyb3IuaXNzdWVzLm1hcCgoaXNzdWUpID0+ICh7XG4gICAgICAgIHBhdGg6IGlzc3VlLnBhdGguam9pbignLicpLFxuICAgICAgICBtZXNzYWdlOiBpc3N1ZS5tZXNzYWdlLFxuICAgICAgfSkpO1xuXG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGVycm9yczogZXJyb3JEZXRhaWxzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZHRvOiBDcmVhdGVBbnN3ZXJEVE8gPSB2YWxpZGF0aW9uUmVzdWx0LmRhdGE7XG5cbiAgICAvLyAyLiBDcmVhdGUgYW5zd2VyIGl0ZW0gaW4gRHluYW1vXG4gICAgY29uc3QgbmV3QW5zd2VyID0gYXdhaXQgY3JlYXRlQW5zd2VyKGR0byk7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAxLCBuZXdBbnN3ZXIpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBjcmVhdGVBbnN3ZXIgaGFuZGxlcjonLCBlcnIpO1xuXG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG4vLyAtLS0gQnVzaW5lc3MgTG9naWMgLS0tXG4vLyBJbnB1dCBpcyBndWFyYW50ZWVkIHZhbGlkIENyZWF0ZUFuc3dlckRUTyB0aGFua3MgdG8gWm9kXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVBbnN3ZXIoXG4gIGR0bzogQ3JlYXRlQW5zd2VyRFRPLFxuKTogUHJvbWlzZTxBbnN3ZXJJdGVtPiB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgY29uc3QgYW5zd2VySWQgPSB1dWlkdjQoKTtcblxuICBjb25zdCB7XG4gICAgcXVlc3Rpb25JZCxcbiAgICB0ZXh0LFxuICAgIHByb2plY3RJZCxcbiAgICBvcmdhbml6YXRpb25JZCxcbiAgfSA9IGR0bztcblxuXG4gIGNvbnN0IHNvcnRLZXkgPSBgJHtwcm9qZWN0SWR9IyR7cXVlc3Rpb25JZH0jJHthbnN3ZXJJZH1gO1xuXG4gIGNvbnN0IGFuc3dlckl0ZW06IEFuc3dlckl0ZW0gJiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgIFtQS19OQU1FXTogQU5TV0VSX1BLLFxuICAgIFtTS19OQU1FXTogc29ydEtleSxcblxuICAgIGlkOiBhbnN3ZXJJZCxcbiAgICBxdWVzdGlvbklkLFxuICAgIHByb2plY3RJZCxcbiAgICBvcmdhbml6YXRpb25JZCxcbiAgICB0ZXh0LFxuICAgIHNvdXJjZTogJ21hbnVhbCcsICAgLy8gd2Uga25vdyB0aGlzIGlzIHVzZXItZW50ZXJlZFxuXG4gICAgY3JlYXRlZEF0OiBub3csXG4gICAgdXBkYXRlZEF0OiBub3csXG4gIH07XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgSXRlbTogYW5zd2VySXRlbSxcbiAgfSk7XG5cbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgcmV0dXJuIGFuc3dlckl0ZW0gYXMgQW5zd2VySXRlbTtcbn1cbiJdfQ==