"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const bedrock_http_client_1 = require("../helpers/bedrock-http-client");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const organization_1 = require("../constants/organization");
const REGION = process.env.AWS_REGION ||
    process.env.BEDROCK_REGION ||
    'us-east-1';
const MODEL_ID = process.env.BEDROCK_MODEL_ID || 'anthropic.claude-3-haiku-20240307-v1:0';
const MAX_TOKENS = Number(process.env.BEDROCK_MAX_TOKENS ?? 4000);
const TEMPERATURE = Number(process.env.BEDROCK_TEMPERATURE ?? 0.1);
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const s3Client = new client_s3_1.S3Client({ region: REGION });
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DEFAULT_BUCKET = process.env.DOCUMENTS_BUCKET;
async function getObjectAsString(bucket, key) {
    const res = await s3Client.send(new client_s3_1.GetObjectCommand({
        Bucket: bucket,
        Key: key,
    }));
    if (!res.Body) {
        throw new Error('Empty S3 object body');
    }
    const body = res.Body;
    if (typeof body.transformToString === 'function') {
        return await body.transformToString();
    }
    return await new Promise((resolve, reject) => {
        const chunks = [];
        body.on('data', (chunk) => chunks.push(chunk));
        body.on('error', reject);
        body.on('end', () => resolve(Buffer.concat(chunks).toString('utf-8')));
    });
}
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, {
                message: 'Request body is required',
            });
        }
        // Handle potential base64-encoded body
        const rawBody = event.isBase64Encoded
            ? Buffer.from(event.body, 'base64').toString('utf-8')
            : event.body;
        let body;
        try {
            body = JSON.parse(rawBody);
        }
        catch {
            return (0, api_1.apiResponse)(400, {
                message: 'Invalid JSON in request body',
            });
        }
        const { s3Key, s3Bucket, projectId } = body;
        if (!projectId) {
            return (0, api_1.apiResponse)(400, {
                message: '\'projectId\' is required in the request body',
            });
        }
        const bucketToUse = s3Bucket || DEFAULT_BUCKET;
        if (!bucketToUse) {
            return (0, api_1.apiResponse)(400, {
                message: '\'s3Bucket\' is required in body or DOCUMENTS_BUCKET env var must be set',
            });
        }
        let sourceContent;
        try {
            sourceContent = await getObjectAsString(bucketToUse, s3Key);
        }
        catch (err) {
            console.error(`Failed to read S3 object ${bucketToUse}/${s3Key}:`, err);
            return (0, api_1.apiResponse)(500, {
                message: 'Failed to read document from S3',
            });
        }
        if (!sourceContent) {
            return (0, api_1.apiResponse)(400, {
                message: 'Document content is empty',
            });
        }
        const extracted = await extractQuestionsWithBedrock(sourceContent);
        // === Save questions into DynamoDB in the context of the project ===
        await saveQuestionsToDynamo(projectId, extracted);
        // Return sections back to the caller
        return (0, api_1.apiResponse)(200, {
            sections: extracted.sections ?? [],
        });
    }
    catch (error) {
        console.error('Error in extract-questions handler:', error);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to extract questions',
            error: error instanceof Error ? error.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
async function extractQuestionsWithBedrock(content) {
    const systemPrompt = buildSystemPrompt();
    const userPrompt = buildUserPrompt(content);
    const body = {
        anthropic_version: "bedrock-2023-05-31", // REQUIRED
        system: systemPrompt, // <-- TOP LEVEL SYSTEM
        messages: [
            {
                role: "user", // ONLY user or assistant allowed
                content: userPrompt,
            },
        ],
        max_tokens: MAX_TOKENS,
        temperature: TEMPERATURE,
    };
    const responseBody = await (0, bedrock_http_client_1.invokeModel)(MODEL_ID, JSON.stringify(body), "application/json", "application/json");
    const jsonTxt = new TextDecoder("utf-8").decode(responseBody);
    let outer;
    try {
        outer = JSON.parse(jsonTxt);
    }
    catch {
        console.error("Bad response JSON:", jsonTxt);
        throw new Error("Invalid JSON envelope from Bedrock");
    }
    const assistantText = outer?.content?.[0]?.text;
    if (!assistantText)
        throw new Error("Model returned no text");
    let parsed;
    try {
        parsed = JSON.parse(assistantText);
    }
    catch (err) {
        console.error("Model output was not JSON:", assistantText);
        throw new Error("Invalid JSON returned by the model");
    }
    if (!Array.isArray(parsed.sections))
        throw new Error("Response missing required sections[]");
    return parsed;
}
/**
 * Save all extracted questions for a given projectId into DynamoDB.
 * PK = QUESTION_PK (e.g. "QUESTION")
 * SK = `${projectId}#${questionId}`
 */
async function saveQuestionsToDynamo(projectId, extracted) {
    const now = new Date().toISOString();
    for (const section of extracted.sections) {
        for (const q of section.questions) {
            const sortKey = `${projectId}#${q.id}`;
            const item = {
                [common_1.PK_NAME]: organization_1.QUESTION_PK,
                [common_1.SK_NAME]: sortKey,
                projectId,
                questionId: q.id,
                questionText: q.question,
                sectionId: section.id,
                sectionTitle: section.title,
                sectionDescription: section.description ?? null,
                createdAt: now,
                updatedAt: now,
            };
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: DB_TABLE_NAME,
                Item: item,
            }));
        }
    }
}
function buildSystemPrompt() {
    const timestamp = Date.now();
    return `
You are an expert at analyzing RFP (Request for Proposal) documents and extracting structured information.
Given a document that contains RFP questions, extract all sections and questions into a structured format.

Carefully identify:
1. Different sections (usually numbered like 1.1, 1.2, etc.)
2. The questions within each section
3. Any descriptive text that provides context for the section

Format the output as a JSON object with the following structure:
{
  "sections": [
    {
      "id": "section_${timestamp}_1",
      "title": "Section Title",
      "description": "Optional description text for the section",
      "questions": [
        {
          "id": "q_${timestamp}_1_1",
          "question": "The exact text of the question"
        }
      ]
    }
  ]
}

Requirements:
- Generate unique reference IDs using the format: q_${timestamp}_<section>_<question> for questions
- Generate unique reference IDs using the format: section_${timestamp}_<number> for sections  
- Preserve the exact text of questions
- Include all questions found in the document
- Group questions correctly under their sections
- If a section has subsections, create separate sections for each subsection
- The timestamp prefix (${timestamp}) ensures uniqueness across different document uploads

Return ONLY the JSON object, with no additional text.
  `.trim();
}
function buildUserPrompt(content) {
    return `Document Content:\n${content}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdC1xdWVzdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJleHRyYWN0LXF1ZXN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSx3RUFBNkQ7QUFDN0Qsa0RBQWlFO0FBQ2pFLDhEQUEyRDtBQUMzRCx3REFBNEU7QUFFNUUsd0NBQTZDO0FBQzdDLGdEQUF1RDtBQUN2RCw0REFBd0Q7QUFFeEQsTUFBTSxNQUFNLEdBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO0lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztJQUMxQixXQUFXLENBQUM7QUFFZCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLHdDQUF3QyxDQUFDO0FBRTFGLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQyxDQUFDO0FBQ2xFLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBRW5FLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ2hELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBRWxELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFvQkgs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QUNkLFNBQVMsRUFBRSxHQUFHO2FBQ2YsQ0FBQztZQUVGLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDbEIsSUFBSSx5QkFBVSxDQUFDO2dCQUNiLFNBQVMsRUFBRSxhQUFhO2dCQUN4QixJQUFJLEVBQUUsSUFBSTthQUNYLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDO0FBRUQsU0FBUyxpQkFBaUI7SUFDeEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzdCLE9BQU87Ozs7Ozs7Ozs7Ozs7dUJBYWMsU0FBUzs7Ozs7cUJBS1gsU0FBUzs7Ozs7Ozs7O3NEQVN3QixTQUFTOzREQUNILFNBQVM7Ozs7OzBCQUszQyxTQUFTOzs7R0FHaEMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxPQUFlO0lBQ3RDLE9BQU8sc0JBQXNCLE9BQU8sRUFBRSxDQUFDO0FBQ3pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IGludm9rZU1vZGVsIH0gZnJvbSAnLi4vaGVscGVycy9iZWRyb2NrLWh0dHAtY2xpZW50JztcbmltcG9ydCB7IEdldE9iamVjdENvbW1hbmQsIFMzQ2xpZW50LCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFFVRVNUSU9OX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL29yZ2FuaXphdGlvbic7XG5cbmNvbnN0IFJFR0lPTiA9XG4gIHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHxcbiAgcHJvY2Vzcy5lbnYuQkVEUk9DS19SRUdJT04gfHxcbiAgJ3VzLWVhc3QtMSc7XG5cbmNvbnN0IE1PREVMX0lEID0gcHJvY2Vzcy5lbnYuQkVEUk9DS19NT0RFTF9JRCB8fCAnYW50aHJvcGljLmNsYXVkZS0zLWhhaWt1LTIwMjQwMzA3LXYxOjAnO1xuXG5jb25zdCBNQVhfVE9LRU5TID0gTnVtYmVyKHByb2Nlc3MuZW52LkJFRFJPQ0tfTUFYX1RPS0VOUyA/PyA0MDAwKTtcbmNvbnN0IFRFTVBFUkFUVVJFID0gTnVtYmVyKHByb2Nlc3MuZW52LkJFRFJPQ0tfVEVNUEVSQVRVUkUgPz8gMC4xKTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IFJFR0lPTiB9KTtcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmludGVyZmFjZSBFeHRyYWN0UXVlc3Rpb25zUmVxdWVzdEJvZHkge1xuICBzM0tleTogc3RyaW5nO1xuICBzM0J1Y2tldD86IHN0cmluZzsgIC8vIG9wdGlvbmFsIOKAkyBmYWxscyBiYWNrIHRvIERPQ1VNRU5UU19CVUNLRVRcbiAgcHJvamVjdElkOiBzdHJpbmc7ICAvLyBSRVFVSVJFRCBmb3Igc2F2aW5nIHF1ZXN0aW9uc1xufVxuXG50eXBlIEV4dHJhY3RlZFF1ZXN0aW9ucyA9IHtcbiAgc2VjdGlvbnM6IEFycmF5PHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmcgfCBudWxsO1xuICAgIHF1ZXN0aW9uczogQXJyYXk8e1xuICAgICAgaWQ6IHN0cmluZztcbiAgICAgIHF1ZXN0aW9uOiBzdHJpbmc7XG4gICAgfT47XG4gIH0+O1xufTtcblxuY29uc3QgREVGQVVMVF9CVUNLRVQgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRPYmplY3RBc1N0cmluZyhidWNrZXQ6IHN0cmluZywga2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCByZXMgPSBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgS2V5OiBrZXksXG4gICAgfSksXG4gICk7XG5cbiAgaWYgKCFyZXMuQm9keSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgUzMgb2JqZWN0IGJvZHknKTtcbiAgfVxuXG4gIGNvbnN0IGJvZHk6IGFueSA9IHJlcy5Cb2R5O1xuXG4gIGlmICh0eXBlb2YgYm9keS50cmFuc2Zvcm1Ub1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBhd2FpdCBib2R5LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY2h1bmtzOiBCdWZmZXJbXSA9IFtdO1xuICAgIGJvZHkub24oJ2RhdGEnLCAoY2h1bms6IEJ1ZmZlcikgPT4gY2h1bmtzLnB1c2goY2h1bmspKTtcbiAgICBib2R5Lm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgYm9keS5vbignZW5kJywgKCkgPT5cbiAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdChjaHVua3MpLnRvU3RyaW5nKCd1dGYtOCcpKSxcbiAgICApO1xuICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGlmICghZXZlbnQuYm9keSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBwb3RlbnRpYWwgYmFzZTY0LWVuY29kZWQgYm9keVxuICAgIGNvbnN0IHJhd0JvZHkgPSBldmVudC5pc0Jhc2U2NEVuY29kZWRcbiAgICAgID8gQnVmZmVyLmZyb20oZXZlbnQuYm9keSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGYtOCcpXG4gICAgICA6IGV2ZW50LmJvZHk7XG5cbiAgICBsZXQgYm9keTogRXh0cmFjdFF1ZXN0aW9uc1JlcXVlc3RCb2R5O1xuICAgIHRyeSB7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShyYXdCb2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBpbiByZXF1ZXN0IGJvZHknLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBzM0tleSwgczNCdWNrZXQsIHByb2plY3RJZCB9ID0gYm9keTtcblxuICAgIGlmICghcHJvamVjdElkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdcXCdwcm9qZWN0SWRcXCcgaXMgcmVxdWlyZWQgaW4gdGhlIHJlcXVlc3QgYm9keScsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBidWNrZXRUb1VzZSA9IHMzQnVja2V0IHx8IERFRkFVTFRfQlVDS0VUO1xuICAgIGlmICghYnVja2V0VG9Vc2UpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAnXFwnczNCdWNrZXRcXCcgaXMgcmVxdWlyZWQgaW4gYm9keSBvciBET0NVTUVOVFNfQlVDS0VUIGVudiB2YXIgbXVzdCBiZSBzZXQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHNvdXJjZUNvbnRlbnQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICAgIHRyeSB7XG4gICAgICBzb3VyY2VDb250ZW50ID0gYXdhaXQgZ2V0T2JqZWN0QXNTdHJpbmcoYnVja2V0VG9Vc2UsIHMzS2V5KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gcmVhZCBTMyBvYmplY3QgJHtidWNrZXRUb1VzZX0vJHtzM0tleX06YCxcbiAgICAgICAgZXJyLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byByZWFkIGRvY3VtZW50IGZyb20gUzMnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFzb3VyY2VDb250ZW50KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdEb2N1bWVudCBjb250ZW50IGlzIGVtcHR5JyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dHJhY3RlZCA9IGF3YWl0IGV4dHJhY3RRdWVzdGlvbnNXaXRoQmVkcm9jayhzb3VyY2VDb250ZW50KTtcblxuICAgIC8vID09PSBTYXZlIHF1ZXN0aW9ucyBpbnRvIER5bmFtb0RCIGluIHRoZSBjb250ZXh0IG9mIHRoZSBwcm9qZWN0ID09PVxuICAgIGF3YWl0IHNhdmVRdWVzdGlvbnNUb0R5bmFtbyhwcm9qZWN0SWQsIGV4dHJhY3RlZCk7XG5cbiAgICAvLyBSZXR1cm4gc2VjdGlvbnMgYmFjayB0byB0aGUgY2FsbGVyXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgc2VjdGlvbnM6IGV4dHJhY3RlZC5zZWN0aW9ucyA/PyBbXSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBleHRyYWN0LXF1ZXN0aW9ucyBoYW5kbGVyOicsIGVycm9yKTtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGV4dHJhY3QgcXVlc3Rpb25zJyxcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFF1ZXN0aW9uc1dpdGhCZWRyb2NrKFxuICBjb250ZW50OiBzdHJpbmcsXG4pOiBQcm9taXNlPEV4dHJhY3RlZFF1ZXN0aW9ucz4ge1xuICBjb25zdCBzeXN0ZW1Qcm9tcHQgPSBidWlsZFN5c3RlbVByb21wdCgpO1xuICBjb25zdCB1c2VyUHJvbXB0ID0gYnVpbGRVc2VyUHJvbXB0KGNvbnRlbnQpO1xuXG4gIGNvbnN0IGJvZHkgPSB7XG4gICAgYW50aHJvcGljX3ZlcnNpb246IFwiYmVkcm9jay0yMDIzLTA1LTMxXCIsICAgLy8gUkVRVUlSRURcbiAgICBzeXN0ZW06IHN5c3RlbVByb21wdCwgICAgICAgICAgICAgICAgICAgICAgLy8gPC0tIFRPUCBMRVZFTCBTWVNURU1cbiAgICBtZXNzYWdlczogW1xuICAgICAge1xuICAgICAgICByb2xlOiBcInVzZXJcIiwgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9OTFkgdXNlciBvciBhc3Npc3RhbnQgYWxsb3dlZFxuICAgICAgICBjb250ZW50OiB1c2VyUHJvbXB0LFxuICAgICAgfSxcbiAgICBdLFxuICAgIG1heF90b2tlbnM6IE1BWF9UT0tFTlMsXG4gICAgdGVtcGVyYXR1cmU6IFRFTVBFUkFUVVJFLFxuICB9O1xuXG4gIGNvbnN0IHJlc3BvbnNlQm9keSA9IGF3YWl0IGludm9rZU1vZGVsKFxuICAgIE1PREVMX0lELFxuICAgIEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgIFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgIFwiYXBwbGljYXRpb24vanNvblwiXG4gICk7XG5cbiAgY29uc3QganNvblR4dCA9IG5ldyBUZXh0RGVjb2RlcihcInV0Zi04XCIpLmRlY29kZShyZXNwb25zZUJvZHkpO1xuXG4gIGxldCBvdXRlcjtcbiAgdHJ5IHtcbiAgICBvdXRlciA9IEpTT04ucGFyc2UoanNvblR4dCk7XG4gIH0gY2F0Y2gge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJCYWQgcmVzcG9uc2UgSlNPTjpcIiwganNvblR4dCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBKU09OIGVudmVsb3BlIGZyb20gQmVkcm9ja1wiKTtcbiAgfVxuXG4gIGNvbnN0IGFzc2lzdGFudFRleHQgPSBvdXRlcj8uY29udGVudD8uWzBdPy50ZXh0O1xuICBpZiAoIWFzc2lzdGFudFRleHQpXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTW9kZWwgcmV0dXJuZWQgbm8gdGV4dFwiKTtcblxuICBsZXQgcGFyc2VkO1xuICB0cnkge1xuICAgIHBhcnNlZCA9IEpTT04ucGFyc2UoYXNzaXN0YW50VGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJNb2RlbCBvdXRwdXQgd2FzIG5vdCBKU09OOlwiLCBhc3Npc3RhbnRUZXh0KTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIEpTT04gcmV0dXJuZWQgYnkgdGhlIG1vZGVsXCIpO1xuICB9XG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KHBhcnNlZC5zZWN0aW9ucykpXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUmVzcG9uc2UgbWlzc2luZyByZXF1aXJlZCBzZWN0aW9uc1tdXCIpO1xuXG4gIHJldHVybiBwYXJzZWQgYXMgRXh0cmFjdGVkUXVlc3Rpb25zO1xufVxuXG5cbi8qKlxuICogU2F2ZSBhbGwgZXh0cmFjdGVkIHF1ZXN0aW9ucyBmb3IgYSBnaXZlbiBwcm9qZWN0SWQgaW50byBEeW5hbW9EQi5cbiAqIFBLID0gUVVFU1RJT05fUEsgKGUuZy4gXCJRVUVTVElPTlwiKVxuICogU0sgPSBgJHtwcm9qZWN0SWR9IyR7cXVlc3Rpb25JZH1gXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNhdmVRdWVzdGlvbnNUb0R5bmFtbyhcbiAgcHJvamVjdElkOiBzdHJpbmcsXG4gIGV4dHJhY3RlZDogRXh0cmFjdGVkUXVlc3Rpb25zLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICBmb3IgKGNvbnN0IHNlY3Rpb24gb2YgZXh0cmFjdGVkLnNlY3Rpb25zKSB7XG4gICAgZm9yIChjb25zdCBxIG9mIHNlY3Rpb24ucXVlc3Rpb25zKSB7XG4gICAgICBjb25zdCBzb3J0S2V5ID0gYCR7cHJvamVjdElkfSMke3EuaWR9YDtcblxuICAgICAgY29uc3QgaXRlbSA9IHtcbiAgICAgICAgW1BLX05BTUVdOiBRVUVTVElPTl9QSyxcbiAgICAgICAgW1NLX05BTUVdOiBzb3J0S2V5LFxuICAgICAgICBwcm9qZWN0SWQsXG4gICAgICAgIHF1ZXN0aW9uSWQ6IHEuaWQsXG4gICAgICAgIHF1ZXN0aW9uVGV4dDogcS5xdWVzdGlvbixcbiAgICAgICAgc2VjdGlvbklkOiBzZWN0aW9uLmlkLFxuICAgICAgICBzZWN0aW9uVGl0bGU6IHNlY3Rpb24udGl0bGUsXG4gICAgICAgIHNlY3Rpb25EZXNjcmlwdGlvbjogc2VjdGlvbi5kZXNjcmlwdGlvbiA/PyBudWxsLFxuICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgdXBkYXRlZEF0OiBub3csXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgICAgbmV3IFB1dENvbW1hbmQoe1xuICAgICAgICAgIFRhYmxlTmFtZTogREJfVEFCTEVfTkFNRSxcbiAgICAgICAgICBJdGVtOiBpdGVtLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGJ1aWxkU3lzdGVtUHJvbXB0KCk6IHN0cmluZyB7XG4gIGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gIHJldHVybiBgXG5Zb3UgYXJlIGFuIGV4cGVydCBhdCBhbmFseXppbmcgUkZQIChSZXF1ZXN0IGZvciBQcm9wb3NhbCkgZG9jdW1lbnRzIGFuZCBleHRyYWN0aW5nIHN0cnVjdHVyZWQgaW5mb3JtYXRpb24uXG5HaXZlbiBhIGRvY3VtZW50IHRoYXQgY29udGFpbnMgUkZQIHF1ZXN0aW9ucywgZXh0cmFjdCBhbGwgc2VjdGlvbnMgYW5kIHF1ZXN0aW9ucyBpbnRvIGEgc3RydWN0dXJlZCBmb3JtYXQuXG5cbkNhcmVmdWxseSBpZGVudGlmeTpcbjEuIERpZmZlcmVudCBzZWN0aW9ucyAodXN1YWxseSBudW1iZXJlZCBsaWtlIDEuMSwgMS4yLCBldGMuKVxuMi4gVGhlIHF1ZXN0aW9ucyB3aXRoaW4gZWFjaCBzZWN0aW9uXG4zLiBBbnkgZGVzY3JpcHRpdmUgdGV4dCB0aGF0IHByb3ZpZGVzIGNvbnRleHQgZm9yIHRoZSBzZWN0aW9uXG5cbkZvcm1hdCB0aGUgb3V0cHV0IGFzIGEgSlNPTiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHN0cnVjdHVyZTpcbntcbiAgXCJzZWN0aW9uc1wiOiBbXG4gICAge1xuICAgICAgXCJpZFwiOiBcInNlY3Rpb25fJHt0aW1lc3RhbXB9XzFcIixcbiAgICAgIFwidGl0bGVcIjogXCJTZWN0aW9uIFRpdGxlXCIsXG4gICAgICBcImRlc2NyaXB0aW9uXCI6IFwiT3B0aW9uYWwgZGVzY3JpcHRpb24gdGV4dCBmb3IgdGhlIHNlY3Rpb25cIixcbiAgICAgIFwicXVlc3Rpb25zXCI6IFtcbiAgICAgICAge1xuICAgICAgICAgIFwiaWRcIjogXCJxXyR7dGltZXN0YW1wfV8xXzFcIixcbiAgICAgICAgICBcInF1ZXN0aW9uXCI6IFwiVGhlIGV4YWN0IHRleHQgb2YgdGhlIHF1ZXN0aW9uXCJcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH1cbiAgXVxufVxuXG5SZXF1aXJlbWVudHM6XG4tIEdlbmVyYXRlIHVuaXF1ZSByZWZlcmVuY2UgSURzIHVzaW5nIHRoZSBmb3JtYXQ6IHFfJHt0aW1lc3RhbXB9XzxzZWN0aW9uPl88cXVlc3Rpb24+IGZvciBxdWVzdGlvbnNcbi0gR2VuZXJhdGUgdW5pcXVlIHJlZmVyZW5jZSBJRHMgdXNpbmcgdGhlIGZvcm1hdDogc2VjdGlvbl8ke3RpbWVzdGFtcH1fPG51bWJlcj4gZm9yIHNlY3Rpb25zICBcbi0gUHJlc2VydmUgdGhlIGV4YWN0IHRleHQgb2YgcXVlc3Rpb25zXG4tIEluY2x1ZGUgYWxsIHF1ZXN0aW9ucyBmb3VuZCBpbiB0aGUgZG9jdW1lbnRcbi0gR3JvdXAgcXVlc3Rpb25zIGNvcnJlY3RseSB1bmRlciB0aGVpciBzZWN0aW9uc1xuLSBJZiBhIHNlY3Rpb24gaGFzIHN1YnNlY3Rpb25zLCBjcmVhdGUgc2VwYXJhdGUgc2VjdGlvbnMgZm9yIGVhY2ggc3Vic2VjdGlvblxuLSBUaGUgdGltZXN0YW1wIHByZWZpeCAoJHt0aW1lc3RhbXB9KSBlbnN1cmVzIHVuaXF1ZW5lc3MgYWNyb3NzIGRpZmZlcmVudCBkb2N1bWVudCB1cGxvYWRzXG5cblJldHVybiBPTkxZIHRoZSBKU09OIG9iamVjdCwgd2l0aCBubyBhZGRpdGlvbmFsIHRleHQuXG4gIGAudHJpbSgpO1xufVxuXG5mdW5jdGlvbiBidWlsZFVzZXJQcm9tcHQoY29udGVudDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGBEb2N1bWVudCBDb250ZW50OlxcbiR7Y29udGVudH1gO1xufVxuIl19