"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const api_1 = require("../helpers/api");
const REGION = process.env.AWS_REGION || 'us-east-1';
const BUCKET_NAME = process.env.DOCUMENTS_BUCKET;
if (!BUCKET_NAME) {
    throw new Error('DOCUMENTS_BUCKET environment variable is not set');
}
const s3Client = new client_s3_1.S3Client({ region: REGION });
/**
 * Read an S3 object and return its content as UTF-8 string.
 */
async function getObjectAsString(bucket, key) {
    const res = await s3Client.send(new client_s3_1.GetObjectCommand({
        Bucket: bucket,
        Key: key,
    }));
    if (!res.Body) {
        throw new Error('Empty S3 object body');
    }
    const body = res.Body;
    // In AWS SDK v3 on Node.js, Body often has transformToString()
    if (typeof body.transformToString === 'function') {
        return await body.transformToString();
    }
    // Fallback: manual stream handling
    return await new Promise((resolve, reject) => {
        const chunks = [];
        body.on('data', (chunk) => chunks.push(chunk));
        body.on('error', reject);
        body.on('end', () => resolve(Buffer.concat(chunks).toString('utf-8')));
    });
}
const handler = async (event) => {
    try {
        // Support HTTP API v2 (requestContext.http.method) and REST (httpMethod) just in case
        const method = event.requestContext.http?.method ??
            event.httpMethod;
        if (method !== 'POST') {
            return (0, api_1.apiResponse)(405, {
                message: 'Method Not Allowed. Use POST.',
            });
        }
        if (!event.body) {
            return (0, api_1.apiResponse)(400, {
                message: 'Request body is required',
            });
        }
        // Handle potential base64-encoded body (HTTP API can do this)
        const rawBody = event.isBase64Encoded
            ? Buffer.from(event.body, 'base64').toString('utf-8')
            : event.body;
        let body;
        try {
            body = JSON.parse(rawBody);
        }
        catch {
            return (0, api_1.apiResponse)(400, {
                message: 'Invalid JSON in request body',
            });
        }
        const { s3Key } = body;
        if (!s3Key) {
            return (0, api_1.apiResponse)(400, {
                message: "'s3Key' is required in the request body",
            });
        }
        let content;
        try {
            content = await getObjectAsString(BUCKET_NAME, s3Key);
        }
        catch (err) {
            console.error(`Failed to read S3 object ${BUCKET_NAME}/${s3Key}:`, err);
            return (0, api_1.apiResponse)(500, {
                message: 'Failed to read document from S3',
            });
        }
        if (!content) {
            return (0, api_1.apiResponse)(400, {
                message: 'Document content is empty',
            });
        }
        // Main output: plain text content
        return (0, api_1.apiResponse)(200, {
            content,
            bucket: BUCKET_NAME,
            key: s3Key,
            metadata: {
                wordCount: wordCount(content),
            }
        });
    }
    catch (error) {
        console.error('Error in extract-text handler:', error);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to extract text',
            error: error instanceof Error ? error.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
function wordCount(text) {
    return text
        .trim()
        .split(/\s+/)
        .filter(Boolean).length;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdC10ZXh0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXh0cmFjdC10ZXh0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUlBLGtEQUFnRTtBQUNoRSx3Q0FBNkM7QUFFN0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxDQUFDO0FBQ3JELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7QUFFakQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztBQUN0RSxDQUFDO0FBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFNbEQ7O0dBRUc7QUFDSCxLQUFLLFVBQVUsaUJBQWlCLENBQUMsTUFBYyxFQUFFLEdBQVc7SUFDMUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUM3QixJQUFJLDRCQUFnQixDQUFDO1FBQ25CLE1BQU0sRUFBRSxNQUFNO1FBQ2QsR0FBRyxFQUFFLEdBQUc7S0FDVCxDQUFDLENBQ0gsQ0FBQztJQUVGLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELE1BQU0sSUFBSSxHQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFFM0IsK0RBQStEO0lBQy9ELElBQUksT0FBTyxJQUFJLENBQUMsaUJBQWlCLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDakQsT0FBTyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxtQ0FBbUM7SUFDbkMsT0FBTyxNQUFNLElBQUksT0FBTyxDQUFTLENBQUMsT0FBTyxFQUFFLE1BQU0s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QUNWLFFBQVEsRUFBRTtnQkFDUixTQUFTLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQzthQUM5QjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLHdCQUF3QjtZQUNqQyxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtTQUNoRSxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBM0VXLFFBQUEsT0FBTyxXQTJFbEI7QUFHRixTQUFTLFNBQVMsQ0FBQyxJQUFZO0lBQzdCLE9BQU8sSUFBSTtTQUNSLElBQUksRUFBRTtTQUNOLEtBQUssQ0FBQyxLQUFLLENBQUM7U0FDWixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHRWMixcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcblxuY29uc3QgUkVHSU9OID0gcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAndXMtZWFzdC0xJztcbmNvbnN0IEJVQ0tFVF9OQU1FID0gcHJvY2Vzcy5lbnYuRE9DVU1FTlRTX0JVQ0tFVDtcblxuaWYgKCFCVUNLRVRfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0RPQ1VNRU5UU19CVUNLRVQgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xufVxuXG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogUkVHSU9OIH0pO1xuXG5pbnRlcmZhY2UgRXh0cmFjdFRleHRSZXF1ZXN0Qm9keSB7XG4gIHMzS2V5Pzogc3RyaW5nO1xufVxuXG4vKipcbiAqIFJlYWQgYW4gUzMgb2JqZWN0IGFuZCByZXR1cm4gaXRzIGNvbnRlbnQgYXMgVVRGLTggc3RyaW5nLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRPYmplY3RBc1N0cmluZyhidWNrZXQ6IHN0cmluZywga2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCByZXMgPSBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgS2V5OiBrZXksXG4gICAgfSksXG4gICk7XG5cbiAgaWYgKCFyZXMuQm9keSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgUzMgb2JqZWN0IGJvZHknKTtcbiAgfVxuXG4gIGNvbnN0IGJvZHk6IGFueSA9IHJlcy5Cb2R5O1xuXG4gIC8vIEluIEFXUyBTREsgdjMgb24gTm9kZS5qcywgQm9keSBvZnRlbiBoYXMgdHJhbnNmb3JtVG9TdHJpbmcoKVxuICBpZiAodHlwZW9mIGJvZHkudHJhbnNmb3JtVG9TdHJpbmcgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gYXdhaXQgYm9keS50cmFuc2Zvcm1Ub1N0cmluZygpO1xuICB9XG5cbiAgLy8gRmFsbGJhY2s6IG1hbnVhbCBzdHJlYW0gaGFuZGxpbmdcbiAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgICBib2R5Lm9uKCdkYXRhJywgKGNodW5rOiBCdWZmZXIpID0+IGNodW5rcy5wdXNoKGNodW5rKSk7XG4gICAgYm9keS5vbignZXJyb3InLCByZWplY3QpO1xuICAgIGJvZHkub24oJ2VuZCcsICgpID0+XG4gICAgICByZXNvbHZlKEJ1ZmZlci5jb25jYXQoY2h1bmtzKS50b1N0cmluZygndXRmLTgnKSksXG4gICAgKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMixcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBTdXBwb3J0IEhUVFAgQVBJIHYyIChyZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZCkgYW5kIFJFU1QgKGh0dHBNZXRob2QpIGp1c3QgaW4gY2FzZVxuICAgIGNvbnN0IG1ldGhvZCA9XG4gICAgICBldmVudC5yZXF1ZXN0Q29udGV4dC5odHRwPy5tZXRob2QgPz9cbiAgICAgIChldmVudCBhcyBhbnkpLmh0dHBNZXRob2Q7XG5cbiAgICBpZiAobWV0aG9kICE9PSAnUE9TVCcpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDUsIHtcbiAgICAgICAgbWVzc2FnZTogJ01ldGhvZCBOb3QgQWxsb3dlZC4gVXNlIFBPU1QuJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghZXZlbnQuYm9keSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBwb3RlbnRpYWwgYmFzZTY0LWVuY29kZWQgYm9keSAoSFRUUCBBUEkgY2FuIGRvIHRoaXMpXG4gICAgY29uc3QgcmF3Qm9keSA9IGV2ZW50LmlzQmFzZTY0RW5jb2RlZFxuICAgICAgPyBCdWZmZXIuZnJvbShldmVudC5ib2R5LCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0Zi04JylcbiAgICAgIDogZXZlbnQuYm9keTtcblxuICAgIGxldCBib2R5OiBFeHRyYWN0VGV4dFJlcXVlc3RCb2R5O1xuICAgIHRyeSB7XG4gICAgICBib2R5ID0gSlNPTi5wYXJzZShyYXdCb2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBpbiByZXF1ZXN0IGJvZHknLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBzM0tleSB9ID0gYm9keTtcblxuICAgIGlmICghczNLZXkpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogXCInczNLZXknIGlzIHJlcXVpcmVkIGluIHRoZSByZXF1ZXN0IGJvZHlcIixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxldCBjb250ZW50OiBzdHJpbmc7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnRlbnQgPSBhd2FpdCBnZXRPYmplY3RBc1N0cmluZyhCVUNLRVRfTkFNRSwgczNLZXkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIHJlYWQgUzMgb2JqZWN0ICR7QlVDS0VUX05BTUV9LyR7czNLZXl9OmAsIGVycik7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gcmVhZCBkb2N1bWVudCBmcm9tIFMzJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghY29udGVudCkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnRG9jdW1lbnQgY29udGVudCBpcyBlbXB0eScsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBNYWluIG91dHB1dDogcGxhaW4gdGV4dCBjb250ZW50XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgY29udGVudCxcbiAgICAgIGJ1Y2tldDogQlVDS0VUX05BTUUsXG4gICAgICBrZXk6IHMzS2V5LFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgd29yZENvdW50OiB3b3JkQ291bnQoY29udGVudCksXG4gICAgICB9XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZXh0cmFjdC10ZXh0IGhhbmRsZXI6JywgZXJyb3IpO1xuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZXh0cmFjdCB0ZXh0JyxcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuXG5mdW5jdGlvbiB3b3JkQ291bnQodGV4dDogc3RyaW5nKTogbnVtYmVyIHtcbiAgcmV0dXJuIHRleHRcbiAgICAudHJpbSgpXG4gICAgLnNwbGl0KC9cXHMrLylcbiAgICAuZmlsdGVyKEJvb2xlYW4pLmxlbmd0aDtcbn0iXX0=