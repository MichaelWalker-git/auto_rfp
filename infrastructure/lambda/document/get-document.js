"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.getDocument = getDocument;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error("DB_TABLE_NAME environment variable is not set");
}
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
// ----------------------------------------------------
// Handler
// GET /documents/get-document?kbId=<kbId>&id=<documentId>
// ----------------------------------------------------
const handler = async (event) => {
    try {
        const kbId = event.queryStringParameters?.kbId ||
            event.pathParameters?.kbId;
        const documentId = event.queryStringParameters?.id ||
            event.pathParameters?.id;
        if (!kbId) {
            return (0, api_1.apiResponse)(400, {
                message: "Missing required parameter: kbId",
            });
        }
        if (!documentId) {
            return (0, api_1.apiResponse)(400, {
                message: "Missing required parameter: id (documentId)",
            });
        }
        const document = await getDocument(kbId, documentId);
        if (!document) {
            return (0, api_1.apiResponse)(404, {
                message: "Document not found",
            });
        }
        return (0, api_1.apiResponse)(200, document);
    }
    catch (err) {
        console.error("Error in get-document handler:", err);
        return (0, api_1.apiResponse)(500, {
            message: "Internal server error",
            error: err instanceof Error ? err.message : "Unknown error",
        });
    }
};
exports.handler = handler;
// ----------------------------------------------------
// Core: get a single document by kbId + documentId
// ----------------------------------------------------
async function getDocument(knowledgeBaseId, documentId) {
    const sk = `KB#${knowledgeBaseId}#DOC#${documentId}`;
    const res = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: "DOCUMENT",
            [common_1.SK_NAME]: sk,
        },
    }));
    if (!res.Item) {
        return null;
    }
    // Attach plain "id" field for FE convenience
    return {
        ...res.Item,
        id: documentId,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWRvY3VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2V0LWRvY3VtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQXVFQSxrQ0F5QkM7QUE5RkQsOERBQTBEO0FBQzFELHdEQUE0RTtBQUU1RSx3Q0FBNkM7QUFDN0MsZ0RBQXVEO0FBRXZELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFFSCx1REFBdUQ7QUFDdkQsVUFBVTtBQUNWLDBEQUEwRDtBQUMxRCx1REFBdUQ7QUFDaEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQ1IsS0FBSyxDQUFDLHFCQUFxQixFQUFFLElBQUk7WUFDakMsS0FBSyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUM7UUFFN0IsTUFBTSxVQUFVLEdBQ2QsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEVBQUU7WUFDL0IsS0FBSyxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUM7UUFFM0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsa0NBQWtDO2FBQzVDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsNkNBQTZDO2FBQ3ZELENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLFdBQVcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFckQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2QsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsb0JBQW9CO2FBQzlCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXJELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUF6Q1csUUFBQSxPQUFPLFdBeUNsQjtBQUVGLHVEQUF1RDtBQUN2RCxtREFBbUQ7QUFDbkQsdURBQXVEO0FBQ2hELEtBQUssVUFBVSxXQUFXLENBQy9CLGVBQXVCLEVBQ3ZCLFVBQWtCO0lBRWxCLE1BQU0sRUFBRSxHQUFHLE1BQU0sZUFBZSxRQUFRLFVBQVUsRUFBRSxDQUFDO0lBRXJELE1BQU0sR0FBRyxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDOUIsSUFBSSx5QkFBVSxDQUFDO1FBQ2IsU0FBUyxFQUFFLGFBQWE7UUFDeEIsR0FBRyxFQUFFO1lBQ0gsQ0FBQyxnQkFBTyxDQUFDLEVBQUUsVUFBVTtZQUNyQixDQUFDLGdCQUFPLENBQUMsRUFBRSxFQUFFO1NBQ2Q7S0FDRixDQUFDLENBQ0gsQ0FBQztJQUVGLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCw2Q0FBNkM7SUFDN0MsT0FBTztRQUNMLEdBQUcsR0FBRyxDQUFDLElBQUk7UUFDWCxFQUFFLEVBQUUsVUFBVTtLQUNmLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIsIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcblxuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKFwiREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0XCIpO1xufVxuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gIH0sXG59KTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gSGFuZGxlclxuLy8gR0VUIC9kb2N1bWVudHMvZ2V0LWRvY3VtZW50P2tiSWQ9PGtiSWQ+JmlkPTxkb2N1bWVudElkPlxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qga2JJZCA9XG4gICAgICBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmtiSWQgfHxcbiAgICAgIGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5rYklkO1xuXG4gICAgY29uc3QgZG9jdW1lbnRJZCA9XG4gICAgICBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmlkIHx8XG4gICAgICBldmVudC5wYXRoUGFyYW1ldGVycz8uaWQ7XG5cbiAgICBpZiAoIWtiSWQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogXCJNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlcjoga2JJZFwiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKCFkb2N1bWVudElkKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6IFwiTWlzc2luZyByZXF1aXJlZCBwYXJhbWV0ZXI6IGlkIChkb2N1bWVudElkKVwiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBnZXREb2N1bWVudChrYklkLCBkb2N1bWVudElkKTtcblxuICAgIGlmICghZG9jdW1lbnQpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDQsIHtcbiAgICAgICAgbWVzc2FnZTogXCJEb2N1bWVudCBub3QgZm91bmRcIixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIGRvY3VtZW50KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGluIGdldC1kb2N1bWVudCBoYW5kbGVyOlwiLCBlcnIpO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIixcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCIsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIENvcmU6IGdldCBhIHNpbmdsZSBkb2N1bWVudCBieSBrYklkICsgZG9jdW1lbnRJZFxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldERvY3VtZW50KFxuICBrbm93bGVkZ2VCYXNlSWQ6IHN0cmluZyxcbiAgZG9jdW1lbnRJZDogc3RyaW5nXG4pOiBQcm9taXNlPGFueSB8IG51bGw+IHtcbiAgY29uc3Qgc2sgPSBgS0IjJHtrbm93bGVkZ2VCYXNlSWR9I0RPQyMke2RvY3VtZW50SWR9YDtcblxuICBjb25zdCByZXMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgW1BLX05BTUVdOiBcIkRPQ1VNRU5UXCIsXG4gICAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgICB9LFxuICAgIH0pXG4gICk7XG5cbiAgaWYgKCFyZXMuSXRlbSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gQXR0YWNoIHBsYWluIFwiaWRcIiBmaWVsZCBmb3IgRkUgY29udmVuaWVuY2VcbiAgcmV0dXJuIHtcbiAgICAuLi5yZXMuSXRlbSxcbiAgICBpZDogZG9jdW1lbnRJZCxcbiAgfTtcbn1cbiJdfQ==