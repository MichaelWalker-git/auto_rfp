"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
exports.createDocument = createDocument;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const api_1 = require("../helpers/api");
const document_1 = require("../schemas/document");
const uuid_1 = require("uuid");
const document_2 = require("../constants/document");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
const DOCUMENT_INDEXER_FUNCTION_NAME = process.env.DOCUMENT_INDEXER_FUNCTION_NAME;
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const handler = async (event) => {
    if (!event.body) {
        return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
    }
    try {
        const rawBody = JSON.parse(event.body);
        // 1. Runtime validation with Zod
        const validationResult = document_1.CreateDocumentDTOSchema.safeParse(rawBody);
        if (!validationResult.success) {
            const errorDetails = validationResult.error.issues.map((issue) => ({
                path: issue.path.join('.'),
                message: issue.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors: errorDetails,
            });
        }
        const dto = validationResult.data;
        // 2. Create document item in Dynamo
        const newDocument = await createDocument(dto);
        return (0, api_1.apiResponse)(201, newDocument);
    }
    catch (err) {
        console.error('Error in createDocument handler:', err);
        if (err instanceof SyntaxError) {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// --- Business Logic ---
// Input is guaranteed valid CreateDocumentDTO thanks to Zod
async function createDocument(dto) {
    const now = new Date().toISOString();
    const docId = (0, uuid_1.v4)();
    const { knowledgeBaseId, name, fileKey, textFileKey } = dto;
    const documentItem = {
        [common_1.PK_NAME]: document_2.DOCUMENT_PK,
        [common_1.SK_NAME]: `KB#${knowledgeBaseId}#DOC#${docId}`,
        id: docId,
        knowledgeBaseId,
        name,
        fileKey,
        textFileKey,
        indexStatus: 'pending', // indexing pipeline will update this
        createdAt: now,
        updatedAt: now,
        // indexVectorKey is optional, omitted here
    };
    const command = new lib_dynamodb_1.PutCommand({
        TableName: DB_TABLE_NAME,
        Item: documentItem,
    });
    await docClient.send(command);
    return documentItem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWRvY3VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLWRvY3VtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQXdFQSx3Q0E4QkM7QUFyR0QsOERBQTBEO0FBQzFELHdEQUEyRTtBQUczRSxnREFBdUQ7QUFDdkQsd0NBQTZDO0FBQzdDLGtEQUFnRztBQUNoRywrQkFBb0M7QUFDcEMsb0RBQW9EO0FBRXBELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztBQUNoRCxNQUFNLDhCQUE4QixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLENBQUM7QUFFbEYsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUNuRSxDQUFDO0FBRU0sTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2QyxpQ0FBaUM7UUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxrQ0FBdUIsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFcEUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzlCLE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO2dCQUMxQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87YUFDdkIsQ0FBQyxDQUFDLENBQUM7WUFFSixPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSxtQkFBbUI7Z0JBQzVCLE1BQU0sRUFBRSxZQUFZO2FBQ3JCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBc0IsZ0JBQWdCLENBQUMsSUFBSSxDQUFDO1FBRXJELG9DQUFvQztRQUNwQyxNQUFNLFdBQVcsR0FBRyxNQUFNLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5QyxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXZELElBQUksR0FBRyxZQUFZLFdBQVcsRUFBRSxDQUFDO1lBQy9CLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxDQUFDLENBQUM7UUFDdkUsQ0FBQztRQUVELE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLEVBQUUsdUJBQXVCO1lBQ2hDLEtBQUssRUFBRSxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO1NBQzVELENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUEzQ1csUUFBQSxPQUFPLFdBMkNsQjtBQUVGLHlCQUF5QjtBQUN6Qiw0REFBNEQ7QUFDckQsS0FBSyxVQUFVLGNBQWMsQ0FDbEMsR0FBc0I7SUFFdEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQyxNQUFNLEtBQUssR0FBRyxJQUFBLFNBQU0sR0FBRSxDQUFDO0lBRXZCLE1BQU0sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsR0FBRyxHQUFHLENBQUM7SUFFNUQsTUFBTSxZQUFZLEdBQWlCO1FBQ2pDLENBQUMsZ0JBQU8sQ0FBQyxFQUFFLHNCQUFXO1FBQ3RCLENBQUMsZ0JBQU8sQ0FBQyxFQUFFLE1BQU0sZUFBZSxRQUFRLEtBQUssRUFBRTtRQUMvQyxFQUFFLEVBQUUsS0FBSztRQUNULGVBQWU7UUFDZixJQUFJO1FBQ0osT0FBTztRQUNQLFdBQVc7UUFDWCxXQUFXLEVBQUUsU0FBUyxFQUFFLHFDQUFxQztRQUM3RCxTQUFTLEVBQUUsR0FBRztRQUNkLFNBQVMsRUFBRSxHQUFHO1FBQ2QsMkNBQTJDO0tBQzVDLENBQUM7SUFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLHlCQUFVLENBQUM7UUFDN0IsU0FBUyxFQUFFLGFBQWE7UUFDeEIsSUFBSSxFQUFFLFlBQVk7S0FDbkIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlCLE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgTGFtYmRhQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWxhbWJkYSc7XG5cbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuaW1wb3J0IHsgQ3JlYXRlRG9jdW1lbnREVE8sIENyZWF0ZURvY3VtZW50RFRPU2NoZW1hLCBEb2N1bWVudEl0ZW0sIH0gZnJvbSAnLi4vc2NoZW1hcy9kb2N1bWVudCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IERPQ1VNRU5UX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL2RvY3VtZW50JztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICB9LFxufSk7XG5cbmNvbnN0IERCX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQl9UQUJMRV9OQU1FO1xuY29uc3QgRE9DVU1FTlRfSU5ERVhFUl9GVU5DVElPTl9OQU1FID0gcHJvY2Vzcy5lbnYuRE9DVU1FTlRfSU5ERVhFUl9GVU5DVElPTl9OQU1FO1xuXG5pZiAoIURCX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdEQl9UQUJMRV9OQU1FIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICBpZiAoIWV2ZW50LmJvZHkpIHtcbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgaXMgbWlzc2luZycgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHJhd0JvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuXG4gICAgLy8gMS4gUnVudGltZSB2YWxpZGF0aW9uIHdpdGggWm9kXG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IENyZWF0ZURvY3VtZW50RFRPU2NoZW1hLnNhZmVQYXJzZShyYXdCb2R5KTtcblxuICAgIGlmICghdmFsaWRhdGlvblJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBjb25zdCBlcnJvckRldGFpbHMgPSB2YWxpZGF0aW9uUmVzdWx0LmVycm9yLmlzc3Vlcy5tYXAoKGlzc3VlKSA9PiAoe1xuICAgICAgICBwYXRoOiBpc3N1ZS5wYXRoLmpvaW4oJy4nKSxcbiAgICAgICAgbWVzc2FnZTogaXNzdWUubWVzc2FnZSxcbiAgICAgIH0pKTtcblxuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICBlcnJvcnM6IGVycm9yRGV0YWlscyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGR0bzogQ3JlYXRlRG9jdW1lbnREVE8gPSB2YWxpZGF0aW9uUmVzdWx0LmRhdGE7XG5cbiAgICAvLyAyLiBDcmVhdGUgZG9jdW1lbnQgaXRlbSBpbiBEeW5hbW9cbiAgICBjb25zdCBuZXdEb2N1bWVudCA9IGF3YWl0IGNyZWF0ZURvY3VtZW50KGR0byk7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAxLCBuZXdEb2N1bWVudCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGNyZWF0ZURvY3VtZW50IGhhbmRsZXI6JywgZXJyKTtcblxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGluIHJlcXVlc3QgYm9keScgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tIEJ1c2luZXNzIExvZ2ljIC0tLVxuLy8gSW5wdXQgaXMgZ3VhcmFudGVlZCB2YWxpZCBDcmVhdGVEb2N1bWVudERUTyB0aGFua3MgdG8gWm9kXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlRG9jdW1lbnQoXG4gIGR0bzogQ3JlYXRlRG9jdW1lbnREVE8sXG4pOiBQcm9taXNlPERvY3VtZW50SXRlbT4ge1xuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gIGNvbnN0IGRvY0lkID0gdXVpZHY0KCk7XG5cbiAgY29uc3QgeyBrbm93bGVkZ2VCYXNlSWQsIG5hbWUsIGZpbGVLZXksIHRleHRGaWxlS2V5IH0gPSBkdG87XG5cbiAgY29uc3QgZG9jdW1lbnRJdGVtOiBEb2N1bWVudEl0ZW0gPSB7XG4gICAgW1BLX05BTUVdOiBET0NVTUVOVF9QSyxcbiAgICBbU0tfTkFNRV06IGBLQiMke2tub3dsZWRnZUJhc2VJZH0jRE9DIyR7ZG9jSWR9YCxcbiAgICBpZDogZG9jSWQsXG4gICAga25vd2xlZGdlQmFzZUlkLFxuICAgIG5hbWUsXG4gICAgZmlsZUtleSxcbiAgICB0ZXh0RmlsZUtleSxcbiAgICBpbmRleFN0YXR1czogJ3BlbmRpbmcnLCAvLyBpbmRleGluZyBwaXBlbGluZSB3aWxsIHVwZGF0ZSB0aGlzXG4gICAgY3JlYXRlZEF0OiBub3csXG4gICAgdXBkYXRlZEF0OiBub3csXG4gICAgLy8gaW5kZXhWZWN0b3JLZXkgaXMgb3B0aW9uYWwsIG9taXR0ZWQgaGVyZVxuICB9O1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgIEl0ZW06IGRvY3VtZW50SXRlbSxcbiAgfSk7XG5cbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgcmV0dXJuIGRvY3VtZW50SXRlbTtcbn1cbiJdfQ==