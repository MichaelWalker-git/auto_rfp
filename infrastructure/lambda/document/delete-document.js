"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const signature_v4_1 = require("@aws-sdk/signature-v4");
const sha256_js_1 = require("@aws-crypto/sha256-js");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const protocol_http_1 = require("@aws-sdk/protocol-http");
const https_1 = __importDefault(require("https"));
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const document_1 = require("../constants/document");
const document_2 = require("../schemas/document");
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
const DOCUMENTS_BUCKET_NAME = process.env.DOCUMENTS_BUCKET ||
    process.env.DOCUMENTS_BUCKET_NAME ||
    process.env.TEXT_BUCKET_NAME;
const OPENSEARCH_ENDPOINT = process.env.OPENSEARCH_ENDPOINT;
const OPENSEARCH_INDEX = process.env.OPENSEARCH_INDEX || 'documents';
const OPENSEARCH_REGION = process.env.OPENSEARCH_REGION ||
    process.env.AWS_REGION ||
    process.env.REGION ||
    'us-east-1';
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
if (!DOCUMENTS_BUCKET_NAME) {
    throw new Error('DOCUMENTS_BUCKET / DOCUMENTS_BUCKET_NAME / TEXT_BUCKET_NAME env var is not set');
}
if (!OPENSEARCH_ENDPOINT) {
    throw new Error('OPENSEARCH_ENDPOINT environment variable is not set');
}
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
const s3Client = new client_s3_1.S3Client({});
// -------------------------------------------------------------
// DELETE /document/delete-document
// Body: { id: string, knowledgeBaseId: string }
// -------------------------------------------------------------
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is missing' });
        }
        // Parse JSON
        let json;
        try {
            json = JSON.parse(event.body);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON format' });
        }
        // Validate with Zod
        const parsed = document_2.DeleteDocumentDTOSchema.safeParse(json);
        if (!parsed.success) {
            const errors = parsed.error.issues.map((i) => ({
                path: i.path.join('.'),
                message: i.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: 'Validation failed',
                errors,
            });
        }
        const dto = parsed.data;
        await deleteDocument(dto);
        return (0, api_1.apiResponse)(200, {
            success: true,
            id: dto.id,
            knowledgeBaseId: dto.knowledgeBaseId,
        });
    }
    catch (err) {
        console.error('Error in delete-document handler:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Internal server error',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
// -------------------------------------------------------------
// Core logic: remove document files from S3, delete from OpenSearch,
// then remove record from DynamoDB
// -------------------------------------------------------------
async function deleteDocument(dto) {
    const sk = `KB#${dto.knowledgeBaseId}#DOC#${dto.id}`;
    // 1) Load DB record so we know the file keys
    const getRes = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: document_1.DOCUMENT_PK,
            [common_1.SK_NAME]: sk,
        },
    }));
    if (!getRes.Item) {
        console.warn(`deleteDocument: no document found for PK=${document_1.DOCUMENT_PK}, SK=${sk}; nothing to delete`);
    }
    else {
        const item = getRes.Item;
        const deletes = [];
        if (item.fileKey) {
            console.log('Deleting original file from S3:', DOCUMENTS_BUCKET_NAME, item.fileKey);
            deletes.push(s3Client.send(new client_s3_1.DeleteObjectCommand({
                Bucket: DOCUMENTS_BUCKET_NAME,
                Key: item.fileKey,
            })));
        }
        else {
            console.log(`deleteDocument: no fileKey on item PK=${document_1.DOCUMENT_PK}, SK=${sk}`);
        }
        if (item.textFileKey) {
            console.log('Deleting text file from S3:', DOCUMENTS_BUCKET_NAME, item.textFileKey);
            deletes.push(s3Client.send(new client_s3_1.DeleteObjectCommand({
                Bucket: DOCUMENTS_BUCKET_NAME,
                Key: item.textFileKey,
            })));
        }
        else {
            console.log(`deleteDocument: no textFileKey on item PK=${document_1.DOCUMENT_PK}, SK=${sk}`);
        }
        if (deletes.length > 0) {
            await Promise.all(deletes);
        }
    }
    // 2) Delete from OpenSearch by documentId (delete-by-query)
    try {
        await deleteFromOpenSearch(dto.id);
    }
    catch (err) {
        console.error(`Failed to delete documentId=${dto.id} from OpenSearch index=${OPENSEARCH_INDEX}:`, err);
        // depending on how strict you want to be, you can throw here
        // throw err;
    }
    // 3) Delete DynamoDB record
    console.log('Deleting document record from DynamoDB', DB_TABLE_NAME, document_1.DOCUMENT_PK, sk);
    await docClient.send(new lib_dynamodb_1.DeleteCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: document_1.DOCUMENT_PK,
            [common_1.SK_NAME]: sk,
        },
    }));
}
// -------------------------------------------------------------
// OpenSearch delete-by-query helper
// -------------------------------------------------------------
async function deleteFromOpenSearch(documentId) {
    const endpointUrl = new URL(OPENSEARCH_ENDPOINT);
    const body = {
        query: {
            term: {
                documentId: documentId,
            },
        },
    };
    const payload = JSON.stringify(body);
    const request = new protocol_http_1.HttpRequest({
        method: 'POST',
        protocol: endpointUrl.protocol,
        hostname: endpointUrl.hostname,
        path: `/${OPENSEARCH_INDEX}/_delete_by_query`,
        headers: {
            'Content-Type': 'application/json',
            'Content-Length': Buffer.byteLength(payload).toString(),
            host: endpointUrl.hostname,
        },
        body: payload,
    });
    const signer = new signature_v4_1.SignatureV4({
        service: 'aoss',
        region: OPENSEARCH_REGION,
        credentials: (0, credential_provider_node_1.defaultProvider)(),
        sha256: sha256_js_1.Sha256,
    });
    const signed = await signer.sign(request);
    await new Promise((resolve, reject) => {
        const req = https_1.default.request({
            method: signed.method,
            hostname: signed.hostname,
            path: signed.path,
            headers: signed.headers,
        }, (res) => {
            const chunks = [];
            res.on('data', (chunk) => chunks.push(chunk));
            res.on('end', () => {
                const bodyStr = Buffer.concat(chunks).toString('utf-8');
                if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {
                    console.log(`OpenSearch delete-by-query OK for documentId=${documentId}:`, bodyStr);
                    resolve();
                }
                else {
                    reject(new Error(`OpenSearch delete-by-query error: ${res.statusCode} ${res.statusMessage} - ${bodyStr}`));
                }
            });
        });
        req.on('error', reject);
        if (signed.body) {
            req.write(signed.body);
        }
        req.end();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLWRvY3VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGVsZXRlLWRvY3VtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLDhEQUEwRDtBQUMxRCx3REFBMkY7QUFFM0Ysa0RBQW1FO0FBRW5FLHdEQUFvRDtBQUNwRCxxREFBK0M7QUFDL0MsZ0ZBQW9FO0FBQ3BFLDBEQUFxRDtBQUNyRCxrREFBMEI7QUFFMUIsd0NBQTZDO0FBQzdDLGdEQUF1RDtBQUN2RCxvREFBb0Q7QUFFcEQsa0RBQWtGO0FBRWxGLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ2hELE1BQU0scUJBQXFCLEdBQ3pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCO0lBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCO0lBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7QUFFL0IsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDO0FBQzVELE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxXQUFXLENBQUM7QUFDckUsTUFBTSxpQkFBaUIsR0FDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUI7SUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO0lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTTtJQUNsQixXQUFXLENBQUM7QUFFZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO0FBQ25FLENBQUM7QUFDRCxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMzQixNQUFNLElBQUksS0FBSyxDQUNiLGdGQUFnRixDQUNqRixDQUFDO0FBQ0osQ0FBQztBQUNELElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lB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b250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEZWxldGVDb21tYW5kLCBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBHZXRDb21tYW5kLCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbmltcG9ydCB7IERlbGV0ZU9iamVjdENvbW1hbmQsIFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcblxuaW1wb3J0IHsgU2lnbmF0dXJlVjQgfSBmcm9tICdAYXdzLXNkay9zaWduYXR1cmUtdjQnO1xuaW1wb3J0IHsgU2hhMjU2IH0gZnJvbSAnQGF3cy1jcnlwdG8vc2hhMjU2LWpzJztcbmltcG9ydCB7IGRlZmF1bHRQcm92aWRlciB9IGZyb20gJ0Bhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItbm9kZSc7XG5pbXBvcnQgeyBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhd3Mtc2RrL3Byb3RvY29sLWh0dHAnO1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJztcblxuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBET0NVTUVOVF9QSyB9IGZyb20gJy4uL2NvbnN0YW50cy9kb2N1bWVudCc7XG5cbmltcG9ydCB7IERlbGV0ZURvY3VtZW50RFRPLCBEZWxldGVEb2N1bWVudERUT1NjaGVtYSwgfSBmcm9tICcuLi9zY2hlbWFzL2RvY3VtZW50JztcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5jb25zdCBET0NVTUVOVFNfQlVDS0VUX05BTUUgPVxuICBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUIHx8XG4gIHByb2Nlc3MuZW52LkRPQ1VNRU5UU19CVUNLRVRfTkFNRSB8fFxuICBwcm9jZXNzLmVudi5URVhUX0JVQ0tFVF9OQU1FO1xuXG5jb25zdCBPUEVOU0VBUkNIX0VORFBPSU5UID0gcHJvY2Vzcy5lbnYuT1BFTlNFQVJDSF9FTkRQT0lOVDtcbmNvbnN0IE9QRU5TRUFSQ0hfSU5ERVggPSBwcm9jZXNzLmVudi5PUEVOU0VBUkNIX0lOREVYIHx8ICdkb2N1bWVudHMnO1xuY29uc3QgT1BFTlNFQVJDSF9SRUdJT04gPVxuICBwcm9jZXNzLmVudi5PUEVOU0VBUkNIX1JFR0lPTiB8fFxuICBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8XG4gIHByb2Nlc3MuZW52LlJFR0lPTiB8fFxuICAndXMtZWFzdC0xJztcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5pZiAoIURPQ1VNRU5UU19CVUNLRVRfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgJ0RPQ1VNRU5UU19CVUNLRVQgLyBET0NVTUVOVFNfQlVDS0VUX05BTUUgLyBURVhUX0JVQ0tFVF9OQU1FIGVudiB2YXIgaXMgbm90IHNldCcsXG4gICk7XG59XG5pZiAoIU9QRU5TRUFSQ0hfRU5EUE9JTlQpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdPUEVOU0VBUkNIX0VORFBPSU5UIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gREVMRVRFIC9kb2N1bWVudC9kZWxldGUtZG9jdW1lbnRcbi8vIEJvZHk6IHsgaWQ6IHN0cmluZywga25vd2xlZGdlQmFzZUlkOiBzdHJpbmcgfVxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICB0cnkge1xuICAgIGlmICghZXZlbnQuYm9keSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnIH0pO1xuICAgIH1cblxuICAgIC8vIFBhcnNlIEpTT05cbiAgICBsZXQganNvbjogYW55O1xuICAgIHRyeSB7XG4gICAgICBqc29uID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBmb3JtYXQnIH0pO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHdpdGggWm9kXG4gICAgY29uc3QgcGFyc2VkID0gRGVsZXRlRG9jdW1lbnREVE9TY2hlbWEuc2FmZVBhcnNlKGpzb24pO1xuICAgIGlmICghcGFyc2VkLnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGVycm9ycyA9IHBhcnNlZC5lcnJvci5pc3N1ZXMubWFwKChpKSA9PiAoe1xuICAgICAgICBwYXRoOiBpLnBhdGguam9pbignLicpLFxuICAgICAgICBtZXNzYWdlOiBpLm1lc3NhZ2UsXG4gICAgICB9KSk7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGVycm9ycyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGR0bzogRGVsZXRlRG9jdW1lbnREVE8gPSBwYXJzZWQuZGF0YTtcblxuICAgIGF3YWl0IGRlbGV0ZURvY3VtZW50KGR0byk7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoMjAwLCB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgaWQ6IGR0by5pZCxcbiAgICAgIGtub3dsZWRnZUJhc2VJZDogZHRvLmtub3dsZWRnZUJhc2VJZCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZGVsZXRlLWRvY3VtZW50IGhhbmRsZXI6JywgZXJyKTtcblxuICAgIHJldHVybiBhcGlSZXNwb25zZSg1MDAsIHtcbiAgICAgIG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgZXJyb3I6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIENvcmUgbG9naWM6IHJlbW92ZSBkb2N1bWVudCBmaWxlcyBmcm9tIFMzLCBkZWxldGUgZnJvbSBPcGVuU2VhcmNoLFxuLy8gdGhlbiByZW1vdmUgcmVjb3JkIGZyb20gRHluYW1vREJcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZURvY3VtZW50KGR0bzogRGVsZXRlRG9jdW1lbnREVE8pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3Qgc2sgPSBgS0IjJHtkdG8ua25vd2xlZGdlQmFzZUlkfSNET0MjJHtkdG8uaWR9YDtcblxuICAvLyAxKSBMb2FkIERCIHJlY29yZCBzbyB3ZSBrbm93IHRoZSBmaWxlIGtleXNcbiAgY29uc3QgZ2V0UmVzID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoXG4gICAgbmV3IEdldENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgS2V5OiB7XG4gICAgICAgIFtQS19OQU1FXTogRE9DVU1FTlRfUEssXG4gICAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgICB9LFxuICAgIH0pLFxuICApO1xuXG4gIGlmICghZ2V0UmVzLkl0ZW0pIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBgZGVsZXRlRG9jdW1lbnQ6IG5vIGRvY3VtZW50IGZvdW5kIGZvciBQSz0ke0RPQ1VNRU5UX1BLfSwgU0s9JHtza307IG5vdGhpbmcgdG8gZGVsZXRlYCxcbiAgICApO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGl0ZW0gPSBnZXRSZXMuSXRlbSBhcyB7XG4gICAgICBmaWxlS2V5Pzogc3RyaW5nO1xuICAgICAgdGV4dEZpbGVLZXk/OiBzdHJpbmc7XG4gICAgfTtcblxuICAgIGNvbnN0IGRlbGV0ZXM6IFByb21pc2U8YW55PltdID0gW107XG5cbiAgICBpZiAoaXRlbS5maWxlS2V5KSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgJ0RlbGV0aW5nIG9yaWdpbmFsIGZpbGUgZnJvbSBTMzonLFxuICAgICAgICBET0NVTUVOVFNfQlVDS0VUX05BTUUsXG4gICAgICAgIGl0ZW0uZmlsZUtleSxcbiAgICAgICk7XG4gICAgICBkZWxldGVzLnB1c2goXG4gICAgICAgIHMzQ2xpZW50LnNlbmQoXG4gICAgICAgICAgbmV3IERlbGV0ZU9iamVjdENvbW1hbmQoe1xuICAgICAgICAgICAgQnVja2V0OiBET0NVTUVOVFNfQlVDS0VUX05BTUUsXG4gICAgICAgICAgICBLZXk6IGl0ZW0uZmlsZUtleSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgZGVsZXRlRG9jdW1lbnQ6IG5vIGZpbGVLZXkgb24gaXRlbSBQSz0ke0RPQ1VNRU5UX1BLfSwgU0s9JHtza31gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoaXRlbS50ZXh0RmlsZUtleSkge1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICdEZWxldGluZyB0ZXh0IGZpbGUgZnJvbSBTMzonLFxuICAgICAgICBET0NVTUVOVFNfQlVDS0VUX05BTUUsXG4gICAgICAgIGl0ZW0udGV4dEZpbGVLZXksXG4gICAgICApO1xuICAgICAgZGVsZXRlcy5wdXNoKFxuICAgICAgICBzM0NsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBEZWxldGVPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogRE9DVU1FTlRTX0JVQ0tFVF9OQU1FLFxuICAgICAgICAgICAgS2V5OiBpdGVtLnRleHRGaWxlS2V5LFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGBkZWxldGVEb2N1bWVudDogbm8gdGV4dEZpbGVLZXkgb24gaXRlbSBQSz0ke0RPQ1VNRU5UX1BLfSwgU0s9JHtza31gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZGVsZXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChkZWxldGVzKTtcbiAgICB9XG4gIH1cblxuICAvLyAyKSBEZWxldGUgZnJvbSBPcGVuU2VhcmNoIGJ5IGRvY3VtZW50SWQgKGRlbGV0ZS1ieS1xdWVyeSlcbiAgdHJ5IHtcbiAgICBhd2FpdCBkZWxldGVGcm9tT3BlblNlYXJjaChkdG8uaWQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKFxuICAgICAgYEZhaWxlZCB0byBkZWxldGUgZG9jdW1lbnRJZD0ke2R0by5pZH0gZnJvbSBPcGVuU2VhcmNoIGluZGV4PSR7T1BFTlNFQVJDSF9JTkRFWH06YCxcbiAgICAgIGVycixcbiAgICApO1xuICAgIC8vIGRlcGVuZGluZyBvbiBob3cgc3RyaWN0IHlvdSB3YW50IHRvIGJlLCB5b3UgY2FuIHRocm93IGhlcmVcbiAgICAvLyB0aHJvdyBlcnI7XG4gIH1cblxuICAvLyAzKSBEZWxldGUgRHluYW1vREIgcmVjb3JkXG4gIGNvbnNvbGUubG9nKFxuICAgICdEZWxldGluZyBkb2N1bWVudCByZWNvcmQgZnJvbSBEeW5hbW9EQicsXG4gICAgREJfVEFCTEVfTkFNRSxcbiAgICBET0NVTUVOVF9QSyxcbiAgICBzayxcbiAgKTtcblxuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgRGVsZXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERCX1RBQkxFX05BTUUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgW1BLX05BTUVdOiBET0NVTUVOVF9QSyxcbiAgICAgICAgW1NLX05BTUVdOiBzayxcbiAgICAgIH0sXG4gICAgfSksXG4gICk7XG59XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIE9wZW5TZWFyY2ggZGVsZXRlLWJ5LXF1ZXJ5IGhlbHBlclxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlRnJvbU9wZW5TZWFyY2goZG9jdW1lbnRJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGVuZHBvaW50VXJsID0gbmV3IFVSTChPUEVOU0VBUkNIX0VORFBPSU5UISk7XG5cbiAgY29uc3QgYm9keSA9IHtcbiAgICBxdWVyeToge1xuICAgICAgdGVybToge1xuICAgICAgICBkb2N1bWVudElkOiBkb2N1bWVudElkLFxuICAgICAgfSxcbiAgICB9LFxuICB9O1xuXG4gIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcblxuICBjb25zdCByZXF1ZXN0ID0gbmV3IEh0dHBSZXF1ZXN0KHtcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBwcm90b2NvbDogZW5kcG9pbnRVcmwucHJvdG9jb2wsXG4gICAgaG9zdG5hbWU6IGVuZHBvaW50VXJsLmhvc3RuYW1lLFxuICAgIHBhdGg6IGAvJHtPUEVOU0VBUkNIX0lOREVYfS9fZGVsZXRlX2J5X3F1ZXJ5YCxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogQnVmZmVyLmJ5dGVMZW5ndGgocGF5bG9hZCkudG9TdHJpbmcoKSxcbiAgICAgIGhvc3Q6IGVuZHBvaW50VXJsLmhvc3RuYW1lLFxuICAgIH0sXG4gICAgYm9keTogcGF5bG9hZCxcbiAgfSk7XG5cbiAgY29uc3Qgc2lnbmVyID0gbmV3IFNpZ25hdHVyZVY0KHtcbiAgICBzZXJ2aWNlOiAnYW9zcycsXG4gICAgcmVnaW9uOiBPUEVOU0VBUkNIX1JFR0lPTixcbiAgICBjcmVkZW50aWFsczogZGVmYXVsdFByb3ZpZGVyKCksXG4gICAgc2hhMjU2OiBTaGEyNTYsXG4gIH0pO1xuXG4gIGNvbnN0IHNpZ25lZCA9IGF3YWl0IHNpZ25lci5zaWduKHJlcXVlc3QpO1xuXG4gIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBtZXRob2Q6IHNpZ25lZC5tZXRob2QsXG4gICAgICAgIGhvc3RuYW1lOiBzaWduZWQuaG9zdG5hbWUsXG4gICAgICAgIHBhdGg6IHNpZ25lZC5wYXRoLFxuICAgICAgICBoZWFkZXJzOiBzaWduZWQuaGVhZGVycyBhcyBhbnksXG4gICAgICB9LFxuICAgICAgKHJlcykgPT4ge1xuICAgICAgICBjb25zdCBjaHVua3M6IEJ1ZmZlcltdID0gW107XG4gICAgICAgIHJlcy5vbignZGF0YScsIChjaHVuaykgPT4gY2h1bmtzLnB1c2goY2h1bmspKTtcbiAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgYm9keVN0ciA9IEJ1ZmZlci5jb25jYXQoY2h1bmtzKS50b1N0cmluZygndXRmLTgnKTtcbiAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgJiYgcmVzLnN0YXR1c0NvZGUgPj0gMjAwICYmIHJlcy5zdGF0dXNDb2RlIDwgMzAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgYE9wZW5TZWFyY2ggZGVsZXRlLWJ5LXF1ZXJ5IE9LIGZvciBkb2N1bWVudElkPSR7ZG9jdW1lbnRJZH06YCxcbiAgICAgICAgICAgICAgYm9keVN0cixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChcbiAgICAgICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGBPcGVuU2VhcmNoIGRlbGV0ZS1ieS1xdWVyeSBlcnJvcjogJHtyZXMuc3RhdHVzQ29kZX0gJHtyZXMuc3RhdHVzTWVzc2FnZX0gLSAke2JvZHlTdHJ9YCxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHJlcS5vbignZXJyb3InLCByZWplY3QpO1xuICAgIGlmIChzaWduZWQuYm9keSkge1xuICAgICAgcmVxLndyaXRlKHNpZ25lZC5ib2R5KTtcbiAgICB9XG4gICAgcmVxLmVuZCgpO1xuICB9KTtcbn1cbiJdfQ==