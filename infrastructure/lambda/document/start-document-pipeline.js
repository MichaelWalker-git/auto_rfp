"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_sfn_1 = require("@aws-sdk/client-sfn");
const sfnClient = new client_sfn_1.SFNClient({});
const STATE_MACHINE_ARN = process.env.STATE_MACHINE_ARN;
if (!STATE_MACHINE_ARN) {
    throw new Error('STATE_MACHINE_ARN environment variable is not set');
}
const handler = async (event) => {
    console.log('start-document-pipeline event:', JSON.stringify(event));
    if (!event.body) {
        return {
            statusCode: 400,
            body: JSON.stringify({ message: 'Request body is required' }),
        };
    }
    let body;
    try {
        body = JSON.parse(event.body);
    }
    catch {
        return {
            statusCode: 400,
            body: JSON.stringify({ message: 'Invalid JSON body' }),
        };
    }
    const { documentId } = body;
    if (!documentId) {
        return {
            statusCode: 400,
            body: JSON.stringify({ message: 'documentId is required' }),
        };
    }
    // Optional: you can add tenant/org validation here based on auth claims
    // Step Functions input â€“ must match what StartTextractJobLambda expects
    const input = {
        documentId,
    };
    try {
        const startRes = await sfnClient.send(new client_sfn_1.StartExecutionCommand({
            stateMachineArn: STATE_MACHINE_ARN,
            input: JSON.stringify(input),
        }));
        return {
            statusCode: 202,
            body: JSON.stringify({
                message: 'Document pipeline started',
                executionArn: startRes.executionArn,
                startDate: startRes.startDate,
            }),
        };
    }
    catch (err) {
        console.error('Error starting state machine:', err);
        return {
            statusCode: 500,
            body: JSON.stringify({
                message: 'Failed to start document pipeline',
                error: err instanceof Error ? err.message : 'Unknown error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtZG9jdW1lbnQtcGlwZWxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1kb2N1bWVudC1waXBlbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxvREFBdUU7QUFFdkUsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztBQUV4RCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7QUFDdkUsQ0FBQztBQU1NLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRXJFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDaEIsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQztTQUM5RCxDQUFDO0lBQ0osQ0FBQztJQUVELElBQUksSUFBOEIsQ0FBQztJQUNuQyxJQUFJLENBQUM7UUFDSCxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUFDLE1BQU0sQ0FBQztRQUNQLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUM7U0FDdkQsQ0FBQztJQUNKLENBQUM7SUFFRCxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQzVCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNoQixPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxDQUFDO1NBQzVELENBQUM7SUFDSixDQUFDO0lBRUQsd0VBQXdFO0lBRXhFLHdFQUF3RTtJQUN4RSxNQUFNLEtBQUssR0FBRztRQUNaLFVBQVU7S0FDWCxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUNuQyxJQUFJLGtDQUFxQixDQUFDO1lBQ3hCLGVBQWUsRUFBRSxpQkFBaUI7WUFDbEMsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1NBQzdCLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSwyQkFBMkI7Z0JBQ3BDLFlBQVksRUFBRSxRQUFRLENBQUMsWUFBWTtnQkFDbkMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTO2FBQzlCLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLCtCQUErQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixPQUFPLEVBQUUsbUNBQW1DO2dCQUM1QyxLQUFLLEVBQUUsR0FBRyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTthQUM1RCxDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUEvRFcsUUFBQSxPQUFPLFdBK0RsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgU0ZOQ2xpZW50LCBTdGFydEV4ZWN1dGlvbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc2ZuJztcblxuY29uc3Qgc2ZuQ2xpZW50ID0gbmV3IFNGTkNsaWVudCh7fSk7XG5jb25zdCBTVEFURV9NQUNISU5FX0FSTiA9IHByb2Nlc3MuZW52LlNUQVRFX01BQ0hJTkVfQVJOO1xuXG5pZiAoIVNUQVRFX01BQ0hJTkVfQVJOKSB7XG4gIHRocm93IG5ldyBFcnJvcignU1RBVEVfTUFDSElORV9BUk4gZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xufVxuXG5pbnRlcmZhY2UgU3RhcnRQaXBlbGluZVJlcXVlc3RCb2R5IHtcbiAgZG9jdW1lbnRJZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4gPT4ge1xuICBjb25zb2xlLmxvZygnc3RhcnQtZG9jdW1lbnQtcGlwZWxpbmUgZXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBpZiAoIWV2ZW50LmJvZHkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgbGV0IGJvZHk6IFN0YXJ0UGlwZWxpbmVSZXF1ZXN0Qm9keTtcbiAgdHJ5IHtcbiAgICBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgfSBjYXRjaCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogJ0ludmFsaWQgSlNPTiBib2R5JyB9KSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgeyBkb2N1bWVudElkIH0gPSBib2R5O1xuICBpZiAoIWRvY3VtZW50SWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnZG9jdW1lbnRJZCBpcyByZXF1aXJlZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIE9wdGlvbmFsOiB5b3UgY2FuIGFkZCB0ZW5hbnQvb3JnIHZhbGlkYXRpb24gaGVyZSBiYXNlZCBvbiBhdXRoIGNsYWltc1xuXG4gIC8vIFN0ZXAgRnVuY3Rpb25zIGlucHV0IOKAkyBtdXN0IG1hdGNoIHdoYXQgU3RhcnRUZXh0cmFjdEpvYkxhbWJkYSBleHBlY3RzXG4gIGNvbnN0IGlucHV0ID0ge1xuICAgIGRvY3VtZW50SWQsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzdGFydFJlcyA9IGF3YWl0IHNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IFN0YXJ0RXhlY3V0aW9uQ29tbWFuZCh7XG4gICAgICAgIHN0YXRlTWFjaGluZUFybjogU1RBVEVfTUFDSElORV9BUk4sXG4gICAgICAgIGlucHV0OiBKU09OLnN0cmluZ2lmeShpbnB1dCksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMixcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbWVzc2FnZTogJ0RvY3VtZW50IHBpcGVsaW5lIHN0YXJ0ZWQnLFxuICAgICAgICBleGVjdXRpb25Bcm46IHN0YXJ0UmVzLmV4ZWN1dGlvbkFybixcbiAgICAgICAgc3RhcnREYXRlOiBzdGFydFJlcy5zdGFydERhdGUsXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzdGFydGluZyBzdGF0ZSBtYWNoaW5lOicsIGVycik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBzdGFydCBkb2N1bWVudCBwaXBlbGluZScsXG4gICAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==