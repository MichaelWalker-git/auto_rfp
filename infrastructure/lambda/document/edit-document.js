"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const common_1 = require("../constants/common");
const document_1 = require("../schemas/document");
const document_2 = require("../constants/document");
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!DB_TABLE_NAME) {
    throw new Error("DB_TABLE_NAME environment variable is not set");
}
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: { removeUndefinedValues: true },
});
// -------------------------------------------------------------
// PATCH /documents/edit-document
// Body: { id, knowledgeBaseId, name? }
// -------------------------------------------------------------
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: "Request body is missing" });
        }
        let json;
        try {
            json = JSON.parse(event.body);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: "Invalid JSON in request body" });
        }
        // Validate input with Zod
        const parsed = document_1.UpdateDocumentDTOSchema.safeParse(json);
        if (!parsed.success) {
            const errors = parsed.error.issues.map((i) => ({
                path: i.path.join("."),
                message: i.message,
            }));
            return (0, api_1.apiResponse)(400, {
                message: "Validation failed",
                errors,
            });
        }
        const dto = parsed.data;
        const updated = await updateDocument(dto);
        return (0, api_1.apiResponse)(200, updated);
    }
    catch (err) {
        console.error("Error in edit-document handler:", err);
        return (0, api_1.apiResponse)(500, {
            message: "Internal server error",
            error: err instanceof Error ? err.message : "Unknown error",
        });
    }
};
exports.handler = handler;
// -------------------------------------------------------------
// Core: Update document
// -------------------------------------------------------------
async function updateDocument(dto) {
    const now = new Date().toISOString();
    const sk = `KB#${dto.knowledgeBaseId}#DOC#${dto.id}`;
    // Build dynamic update expression
    const updates = [];
    const values = {
        ":updatedAt": now,
    };
    if (dto.name !== undefined) {
        updates.push("#name = :name");
        values[":name"] = dto.name;
    }
    if (updates.length === 0) {
        return { message: "Nothing to update" };
    }
    updates.push("updatedAt = :updatedAt");
    const command = new lib_dynamodb_1.UpdateCommand({
        TableName: DB_TABLE_NAME,
        Key: {
            [common_1.PK_NAME]: document_2.DOCUMENT_PK,
            [common_1.SK_NAME]: sk,
        },
        UpdateExpression: `SET ${updates.join(", ")}`,
        ExpressionAttributeNames: {
            "#name": "name",
        },
        ExpressionAttributeValues: values,
        ReturnValues: "ALL_NEW",
    });
    const res = await docClient.send(command);
    return res.Attributes;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC1kb2N1bWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVkaXQtZG9jdW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsOERBQTBEO0FBQzFELHdEQUcrQjtBQUUvQix3Q0FBNkM7QUFDN0MsZ0RBQXVEO0FBRXZELGtEQUc2QjtBQUM3QixvREFBb0Q7QUFFcEQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7QUFFaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztBQUNuRSxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7SUFDdkQsZUFBZSxFQUFFLEVBQUUscUJBQXFCLEVBQUUsSUFBSSxFQUFFO0NBQ2pELENBQUMsQ0FBQztBQUVILGdFQUFnRTtBQUNoRSxpQ0FBaUM7QUFDakMsdUNBQXVDO0FBQ3ZDLGdFQUFnRTtBQUN6RCxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQzFCLEtBQTZCLEVBQ0ssRUFBRTtJQUNwQyxJQUFJLENBQUM7UUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hCLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxDQUFDLENBQUM7UUFDbEUsQ0FBQztRQUVELElBQUksSUFBUyxDQUFDO1FBQ2QsSUFBSSxDQUFDO1lBQ0gsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUs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QyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUMsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDO0FBQ3hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBUElHYXRld2F5UHJveHlFdmVudFYyLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHRWMixcbn0gZnJvbSBcImF3cy1sYW1iZGFcIjtcblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBVcGRhdGVDb21tYW5kLFxufSBmcm9tIFwiQGF3cy1zZGsvbGliLWR5bmFtb2RiXCI7XG5cbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSBcIi4uL2hlbHBlcnMvYXBpXCI7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSBcIi4uL2NvbnN0YW50cy9jb21tb25cIjtcblxuaW1wb3J0IHtcbiAgVXBkYXRlRG9jdW1lbnREVE9TY2hlbWEsXG4gIFVwZGF0ZURvY3VtZW50RFRPLFxufSBmcm9tIFwiLi4vc2NoZW1hcy9kb2N1bWVudFwiO1xuaW1wb3J0IHsgRE9DVU1FTlRfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvZG9jdW1lbnQnO1xuXG5jb25zdCBEQl9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRTtcblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcihcIkRCX1RBQkxFX05BTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldFwiKTtcbn1cblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7IHJlbW92ZVVuZGVmaW5lZFZhbHVlczogdHJ1ZSB9LFxufSk7XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIFBBVENIIC9kb2N1bWVudHMvZWRpdC1kb2N1bWVudFxuLy8gQm9keTogeyBpZCwga25vd2xlZGdlQmFzZUlkLCBuYW1lPyB9XG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6IFwiUmVxdWVzdCBib2R5IGlzIG1pc3NpbmdcIiB9KTtcbiAgICB9XG5cbiAgICBsZXQganNvbjogYW55O1xuICAgIHRyeSB7XG4gICAgICBqc29uID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogXCJJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5XCIgfSk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgaW5wdXQgd2l0aCBab2RcbiAgICBjb25zdCBwYXJzZWQgPSBVcGRhdGVEb2N1bWVudERUT1NjaGVtYS5zYWZlUGFyc2UoanNvbik7XG4gICAgaWYgKCFwYXJzZWQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZXJyb3JzID0gcGFyc2VkLmVycm9yLmlzc3Vlcy5tYXAoKGkpID0+ICh7XG4gICAgICAgIHBhdGg6IGkucGF0aC5qb2luKFwiLlwiKSxcbiAgICAgICAgbWVzc2FnZTogaS5tZXNzYWdlLFxuICAgICAgfSkpO1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiBcIlZhbGlkYXRpb24gZmFpbGVkXCIsXG4gICAgICAgIGVycm9ycyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGR0bzogVXBkYXRlRG9jdW1lbnREVE8gPSBwYXJzZWQuZGF0YTtcblxuICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVEb2N1bWVudChkdG8pO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwgdXBkYXRlZCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBpbiBlZGl0LWRvY3VtZW50IGhhbmRsZXI6XCIsIGVycik7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiBcIkludGVybmFsIHNlcnZlciBlcnJvclwiLFxuICAgICAgZXJyb3I6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIixcbiAgICB9KTtcbiAgfVxufTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gQ29yZTogVXBkYXRlIGRvY3VtZW50XG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVEb2N1bWVudChkdG86IFVwZGF0ZURvY3VtZW50RFRPKSB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgY29uc3Qgc2sgPSBgS0IjJHtkdG8ua25vd2xlZGdlQmFzZUlkfSNET0MjJHtkdG8uaWR9YDtcblxuICAvLyBCdWlsZCBkeW5hbWljIHVwZGF0ZSBleHByZXNzaW9uXG4gIGNvbnN0IHVwZGF0ZXM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHZhbHVlczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICBcIjp1cGRhdGVkQXRcIjogbm93LFxuICB9O1xuXG4gIGlmIChkdG8ubmFtZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdXBkYXRlcy5wdXNoKFwiI25hbWUgPSA6bmFtZVwiKTtcbiAgICB2YWx1ZXNbXCI6bmFtZVwiXSA9IGR0by5uYW1lO1xuICB9XG5cbiAgaWYgKHVwZGF0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHsgbWVzc2FnZTogXCJOb3RoaW5nIHRvIHVwZGF0ZVwiIH07XG4gIH1cblxuICB1cGRhdGVzLnB1c2goXCJ1cGRhdGVkQXQgPSA6dXBkYXRlZEF0XCIpO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgIEtleToge1xuICAgICAgW1BLX05BTUVdOiBET0NVTUVOVF9QSyxcbiAgICAgIFtTS19OQU1FXTogc2ssXG4gICAgfSxcbiAgICBVcGRhdGVFeHByZXNzaW9uOiBgU0VUICR7dXBkYXRlcy5qb2luKFwiLCBcIil9YCxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgIFwiI25hbWVcIjogXCJuYW1lXCIsXG4gICAgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB2YWx1ZXMsXG4gICAgUmV0dXJuVmFsdWVzOiBcIkFMTF9ORVdcIixcbiAgfSk7XG5cbiAgY29uc3QgcmVzID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIHJldHVybiByZXMuQXR0cmlidXRlcztcbn1cbiJdfQ==