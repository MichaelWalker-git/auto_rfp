"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_sfn_1 = require("@aws-sdk/client-sfn");
const api_1 = require("../helpers/api");
const REGION = process.env.AWS_REGION ||
    process.env.AWS_DEFAULT_REGION ||
    'us-east-1';
const STATE_MACHINE_ARN = process.env.STATE_MACHINE_ARN;
if (!STATE_MACHINE_ARN) {
    throw new Error('STATE_MACHINE_ARN environment variable is not set');
}
const sfnClient = new client_sfn_1.SFNClient({ region: REGION });
// Lambda is designed to be invoked via API Gateway HTTP API / REST API
// with JSON body: { "documentId": "..." }
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, {
                message: 'Request body is required',
            });
        }
        let parsedBody;
        try {
            parsedBody = JSON.parse(event.body);
        }
        catch {
            return (0, api_1.apiResponse)(400, {
                message: 'Invalid JSON in request body',
            });
        }
        const documentId = parsedBody.documentId;
        if (!documentId || typeof documentId !== 'string') {
            return (0, api_1.apiResponse)(400, {
                message: '`documentId` is required and must be a string',
            });
        }
        // Optional: you can pass additional metadata if needed (orgId, kbId, etc.)
        const input = JSON.stringify({
            documentId,
        });
        const startCommand = new client_sfn_1.StartExecutionCommand({
            stateMachineArn: STATE_MACHINE_ARN,
            input,
        });
        const resp = await sfnClient.send(startCommand);
        // Return 202 Accepted â€“ indexing is async
        return (0, api_1.apiResponse)(202, {
            message: 'Indexing pipeline started',
            documentId,
            executionArn: resp.executionArn,
            startDate: resp.startDate?.toISOString?.() ?? resp.startDate,
        });
    }
    catch (err) {
        console.error('Error starting indexing state machine:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to start indexing pipeline',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtaW5kZXhpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1pbmRleGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxvREFBd0U7QUFDeEUsd0NBQTZDO0FBRTdDLE1BQU0sTUFBTSxHQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtJQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQjtJQUM5QixXQUFXLENBQUM7QUFFZCxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUM7QUFFeEQsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO0FBQ3ZFLENBQUM7QUFFRCxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUVwRCx1RUFBdUU7QUFDdkUsMENBQTBDO0FBQ25DLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO2dCQUN0QixPQUFPLEVBQUUsMEJBQTBCO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLFVBQWUsQ0FBQztRQUNwQixJQUFJLENBQUM7WUFDSCxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLE9BQU8sSUFBQSxpQkFBVyxFQUFDLEdBQUcsRUFBRTtnQkFDdEIsT0FBTyxFQUFFLDhCQUE4QjthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxVQUFVLEdBQUcsVUFBVSxDQUFDLFVBQWdDLENBQUM7UUFFL0QsSUFBSSxDQUFDLFVBQVUsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUNsRCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7Z0JBQ3RCLE9BQU8sRUFBRSwrQ0FBK0M7YUFDekQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELDJFQUEyRTtRQUMzRSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQzNCLFVBQVU7U0FDWCxDQUFDLENBQUM7UUFFSCxNQUFNLFlBQVksR0FBRyxJQUFJLGtDQUFxQixDQUFDO1lBQzdDLGVBQWUsRUFBRSxpQkFBaUI7WUFDbEMsS0FBSztTQUNOLENBQUMsQ0FBQztRQUVILE1BQU0sSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUVoRCwwQ0FBMEM7UUFDMUMsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sRUFBRSwyQkFBMkI7WUFDcEMsVUFBVTtZQUNWLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsRUFBRSxJQUFJLElBQUksQ0FBQyxTQUFTO1NBQzdELENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUU3RCxPQUFPLElBQUEsaUJBQVcsRUFBQyxHQUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLG1DQUFtQztZQUM1QyxLQUFLLEVBQUUsR0FBRyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtTQUM1RCxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBdERXLFFBQUEsT0FBTyxXQXNEbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiwgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFNGTkNsaWVudCwgU3RhcnRFeGVjdXRpb25Db21tYW5kLCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZm4nO1xuaW1wb3J0IHsgYXBpUmVzcG9uc2UgfSBmcm9tICcuLi9oZWxwZXJzL2FwaSc7XG5cbmNvbnN0IFJFR0lPTiA9XG4gIHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHxcbiAgcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUkVHSU9OIHx8XG4gICd1cy1lYXN0LTEnO1xuXG5jb25zdCBTVEFURV9NQUNISU5FX0FSTiA9IHByb2Nlc3MuZW52LlNUQVRFX01BQ0hJTkVfQVJOO1xuXG5pZiAoIVNUQVRFX01BQ0hJTkVfQVJOKSB7XG4gIHRocm93IG5ldyBFcnJvcignU1RBVEVfTUFDSElORV9BUk4gZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xufVxuXG5jb25zdCBzZm5DbGllbnQgPSBuZXcgU0ZOQ2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG5cbi8vIExhbWJkYSBpcyBkZXNpZ25lZCB0byBiZSBpbnZva2VkIHZpYSBBUEkgR2F0ZXdheSBIVFRQIEFQSSAvIFJFU1QgQVBJXG4vLyB3aXRoIEpTT04gYm9keTogeyBcImRvY3VtZW50SWRcIjogXCIuLi5cIiB9XG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHBhcnNlZEJvZHk6IGFueTtcbiAgICB0cnkge1xuICAgICAgcGFyc2VkQm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGRvY3VtZW50SWQgPSBwYXJzZWRCb2R5LmRvY3VtZW50SWQgYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKCFkb2N1bWVudElkIHx8IHR5cGVvZiBkb2N1bWVudElkICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiAnYGRvY3VtZW50SWRgIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgc3RyaW5nJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIE9wdGlvbmFsOiB5b3UgY2FuIHBhc3MgYWRkaXRpb25hbCBtZXRhZGF0YSBpZiBuZWVkZWQgKG9yZ0lkLCBrYklkLCBldGMuKVxuICAgIGNvbnN0IGlucHV0ID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZG9jdW1lbnRJZCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHN0YXJ0Q29tbWFuZCA9IG5ldyBTdGFydEV4ZWN1dGlvbkNvbW1hbmQoe1xuICAgICAgc3RhdGVNYWNoaW5lQXJuOiBTVEFURV9NQUNISU5FX0FSTixcbiAgICAgIGlucHV0LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcCA9IGF3YWl0IHNmbkNsaWVudC5zZW5kKHN0YXJ0Q29tbWFuZCk7XG5cbiAgICAvLyBSZXR1cm4gMjAyIEFjY2VwdGVkIOKAkyBpbmRleGluZyBpcyBhc3luY1xuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDIsIHtcbiAgICAgIG1lc3NhZ2U6ICdJbmRleGluZyBwaXBlbGluZSBzdGFydGVkJyxcbiAgICAgIGRvY3VtZW50SWQsXG4gICAgICBleGVjdXRpb25Bcm46IHJlc3AuZXhlY3V0aW9uQXJuLFxuICAgICAgc3RhcnREYXRlOiByZXNwLnN0YXJ0RGF0ZT8udG9JU09TdHJpbmc/LigpID8/IHJlc3Auc3RhcnREYXRlLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBzdGFydGluZyBpbmRleGluZyBzdGF0ZSBtYWNoaW5lOicsIGVycik7XG5cbiAgICByZXR1cm4gYXBpUmVzcG9uc2UoNTAwLCB7XG4gICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHN0YXJ0IGluZGV4aW5nIHBpcGVsaW5lJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuIl19