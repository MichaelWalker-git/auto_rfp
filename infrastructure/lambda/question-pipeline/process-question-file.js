"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_textract_1 = require("@aws-sdk/client-textract");
const client_s3_1 = require("@aws-sdk/client-s3");
const common_1 = require("../constants/common");
const question_file_1 = require("../constants/question-file");
// --------------------------------------------------
// Clients
// --------------------------------------------------
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({}), {
    marshallOptions: { removeUndefinedValues: true }
});
const textract = new client_textract_1.TextractClient({});
const s3 = new client_s3_1.S3Client({});
// --------------------------------------------------
// Env
// --------------------------------------------------
const TABLE = process.env.DB_TABLE_NAME;
const BUCKET = process.env.DOCUMENTS_BUCKET_NAME;
if (!TABLE)
    throw new Error("DB_TABLE_NAME env not set");
if (!BUCKET)
    throw new Error("DOCUMENTS_BUCKET_NAME env not set");
// --------------------------------------------------
// Main Handler
// --------------------------------------------------
const handler = async (event, _ctx) => {
    console.log("process-question-file event:", JSON.stringify(event));
    const { questionFileId, projectId, jobId } = event;
    if (!questionFileId || !projectId || !jobId) {
        throw new Error("questionFileId, projectId, jobId are required");
    }
    // 1) Run Textract pagination
    const { text, status } = await getTextractText(jobId);
    if (status !== "SUCCEEDED") {
        await updateStatus(questionFileId, projectId, "error");
        throw new Error(`Textract job failed: status=${status}`);
    }
    // 2) Save the full extracted text to S3
    const textFileKey = `${jobId}/${projectId}/${questionFileId}.txt`;
    await s3.send(new client_s3_1.PutObjectCommand({
        Bucket: BUCKET,
        Key: textFileKey,
        Body: text,
        ContentType: "text/plain; charset=utf-8"
    }));
    // 3) Update question_file record
    await updateStatus(questionFileId, projectId, "text_ready", textFileKey);
    return { questionFileId, projectId, textFileKey };
};
exports.handler = handler;
// --------------------------------------------------
// Textract Pagination Helper
// --------------------------------------------------
async function getTextractText(jobId) {
    let nextToken;
    const lines = [];
    let jobStatus;
    do {
        const res = await textract.send(new client_textract_1.GetDocumentTextDetectionCommand({
            JobId: jobId,
            NextToken: nextToken
        }));
        jobStatus = res.JobStatus;
        if (!jobStatus)
            return { text: "", status: "UNKNOWN" };
        if (jobStatus !== "SUCCEEDED")
            return { text: "", status: jobStatus };
        if (Array.isArray(res.Blocks)) {
            for (const block of res.Blocks) {
                if (block.BlockType === "LINE" && block.Text) {
                    lines.push(block.Text);
                }
            }
        }
        nextToken = res.NextToken;
    } while (nextToken);
    return {
        text: lines.join("\n"),
        status: jobStatus
    };
}
// --------------------------------------------------
// DynamoDB Update Helper
// --------------------------------------------------
async function updateStatus(questionFileId, projectId, status, textFileKey) {
    const sk = `${projectId}#${questionFileId}`;
    const fields = ["#status = :status", "#updatedAt = :now"];
    const names = {
        "#status": "status",
        "#updatedAt": "updatedAt"
    };
    const values = {
        ":status": status,
        ":now": new Date().toISOString()
    };
    if (textFileKey) {
        fields.push("#textFileKey = :key");
        names["#textFileKey"] = "textFileKey";
        values[":key"] = textFileKey;
    }
    await ddb.send(new lib_dynamodb_1.UpdateCommand({
        TableName: TABLE,
        Key: {
            [common_1.PK_NAME]: question_file_1.QUESTION_FILE_PK,
            [common_1.SK_NAME]: sk
        },
        UpdateExpression: "SET " + fields.join(", "),
        ExpressionAttributeNames: names,
        ExpressionAttributeValues: values
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1xdWVzdGlvbi1maWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvY2Vzcy1xdWVzdGlvbi1maWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDhEQUEwRDtBQUMxRCx3REFBOEU7QUFDOUUsOERBQTJGO0FBQzNGLGtEQUFnRTtBQUVoRSxnREFBdUQ7QUFDdkQsOERBQThEO0FBRTlELHFEQUFxRDtBQUNyRCxVQUFVO0FBQ1YscURBQXFEO0FBQ3JELE1BQU0sR0FBRyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLEVBQUU7SUFDOUQsZUFBZSxFQUFFLEVBQUUscUJBQXFCLEVBQUUsSUFBSSxFQUFFO0NBQ2pELENBQUMsQ0FBQztBQUVILE1BQU0sUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QyxNQUFNLEVBQUUsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFNUIscURBQXFEO0FBQ3JELE1BQU07QUFDTixxREFBcUQ7QUFDckQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUM7QUFDekMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0IsQ0FBQztBQUNsRCxJQUFJLENBQUMsS0FBSztJQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUN6RCxJQUFJLENBQUMsTUFBTTtJQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztBQWdCbEUscURBQXFEO0FBQ3JELGVBQWU7QUFDZixxREFBcUQ7QUFDOUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUFZLEVBQ1osSUFBYSxFQUNnRSxFQUFFO0lBQy9FLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRW5FLE1BQU0sRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEtBQUssQ0FBQztJQUVuRCxJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFFRCw2QkFBNkI7SUFDN0IsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxNQUFNLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUV0RCxJQUFJLE1BQU0sS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUMzQixNQUFNLFlBQVksQ0FBQyxjQUFjLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxNQUFNLFdBQVcsR0FBRyxHQUFHLEtBQUssSUFBSSxTQUFTLElBQUksY0FBYyxNQUFNLENBQUM7SUFFbEUsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUNYLElBQUksNEJBQWdCLENBQUM7UUFDbkIsTUFBTSxFQUFFLE1BQU07UUFDZCxHQUFHLEVBQUUsV0FBVztRQUNoQixJQUFJLEVBQUUsSUFBSTtRQUNWLFdBQVcsRUFBRSwyQkFBMkI7S0FDekMsQ0FBQyxDQUNILENBQUM7SUFFRixpQ0FBaUM7SUFDakMsTUFBTSxZQUFZLENBQUMsY0FBYyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFekUsT0FBTyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLENBQUM7QUFDcEQsQ0FBQyxDQUFDO0FBcENXLFFBQUEsT0FBTyxXQW9DbEI7QUFFRixxREFBcUQ7QUFDckQsNkJBQTZCO0FBQzdCLHFEQUFxRDtBQUNyRCxLQUFLLFVBQVUsZUFBZSxDQUFDLEtBQWE7SUFDMUMsSUFBSSxTQUE2QixDQUFDO0lBQ2xDLE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztJQUMzQixJQUFJLFNBQTZCLENBQUM7SUFFbEMsR0FBRyxDQUFDO1FBQ0YsTUFBTSxHQUFHLEdBQVEsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUNsQyxJQUFJLGlEQUErQixDQUFDO1lBQ2xDLEtBQUssRUFBRSxLQUFLO1lBQ1osU0FBUyxFQUFFLFNBQVM7U0FDckIsQ0FBQyxDQUNILENBQUM7UUFFRixTQUFTLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUMxQixJQUFJLENBQUMsU0FBUztZQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUN2RCxJQUFJLFNBQVMsS0FBSyxXQUFXO1lBQzNCLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUV6QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDOUIsS0FBSyxNQUFNLEtBQUssSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQy9CLElBQUksS0FBSyxDQUFDLFNBQVMsS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO29CQUM3QyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekIsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBRUQsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUM7SUFDNUIsQ0FBQyxRQUFRLFNBQVMsRUFBRTtJQUVwQixPQUFPO1FBQ0wsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLE1BQU0sRUFBRSxTQUFTO0tBQ2xCLENBQUM7QUFDSixDQUFDO0FBRUQscURBQXFEO0FBQ3JELHlCQUF5QjtBQUN6QixxREFBcUQ7QUFDckQsS0FBSyxVQUFVLFlBQVksQ0FDekIsY0FBc0IsRUFDdEIsU0FBaUIsRUFDakIsTUFBcUUsRUFDckUsV0FBb0I7SUFFcEIsTUFBTSxFQUFFLEdBQUcsR0FBRyxTQUFTLElBQUksY0FBYyxFQUFFLENBQUM7SUFFNUMsTUFBTSxNQUFNLEdBQWEsQ0FBQyxtQkFBbUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLE1BQU0sS0FBSyxHQUEyQjtRQUNwQyxTQUFTLEVBQUUsUUFBUTtRQUNuQixZQUFZLEVBQUUsV0FBVztLQUMxQixDQUFDO0lBQ0YsTUFBTSxNQUFNLEdBQXdCO1FBQ2xDLFNBQVMsRUFBRSxNQUFNO1FBQ2pCLE1BQU0sRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtLQUNqQyxDQUFDO0lBRUYsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDbkMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxHQUFHLGFBQWEsQ0FBQztRQUN0QyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ1osSUFBSSw0QkFBYSxDQUFDO1FBQ2hCLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLEdBQUcsRUFBRTtZQUNILENBQUMsZ0JBQU8sQ0FBQyxFQUFFLGdDQUFnQjtZQUMzQixDQUFDLGdCQUFPLENBQUMsRUFBRSxFQUFFO1NBQ2Q7UUFDRCxnQkFBZ0IsRUFBRSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDNUMsd0JBQXdCLEVBQUUsS0FBSztRQUMvQix5QkFBeUIsRUFBRSxNQUFNO0tBQ2xDLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFVwZGF0ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgR2V0RG9jdW1lbnRUZXh0RGV0ZWN0aW9uQ29tbWFuZCwgVGV4dHJhY3RDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtdGV4dHJhY3QnO1xuaW1wb3J0IHsgUHV0T2JqZWN0Q29tbWFuZCwgUzNDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuXG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBRVUVTVElPTl9GSUxFX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL3F1ZXN0aW9uLWZpbGUnO1xuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gQ2xpZW50c1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmNvbnN0IGRkYiA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShuZXcgRHluYW1vREJDbGllbnQoe30pLCB7XG4gIG1hcnNoYWxsT3B0aW9uczogeyByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUgfVxufSk7XG5cbmNvbnN0IHRleHRyYWN0ID0gbmV3IFRleHRyYWN0Q2xpZW50KHt9KTtcbmNvbnN0IHMzID0gbmV3IFMzQ2xpZW50KHt9KTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIEVudlxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmNvbnN0IFRBQkxFID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSE7XG5jb25zdCBCVUNLRVQgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUX05BTUUhO1xuaWYgKCFUQUJMRSkgdGhyb3cgbmV3IEVycm9yKFwiREJfVEFCTEVfTkFNRSBlbnYgbm90IHNldFwiKTtcbmlmICghQlVDS0VUKSB0aHJvdyBuZXcgRXJyb3IoXCJET0NVTUVOVFNfQlVDS0VUX05BTUUgZW52IG5vdCBzZXRcIik7XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBUeXBlc1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmludGVyZmFjZSBFdmVudCB7XG4gIHF1ZXN0aW9uRmlsZUlkPzogc3RyaW5nO1xuICBwcm9qZWN0SWQ/OiBzdHJpbmc7XG4gIGpvYklkPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgVGV4dHJhY3RSZXN1bHQge1xuICB0ZXh0OiBzdHJpbmc7XG4gIHN0YXR1czogc3RyaW5nO1xufVxuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gTWFpbiBIYW5kbGVyXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBFdmVudCxcbiAgX2N0eDogQ29udGV4dFxuKTogUHJvbWlzZTx7IHF1ZXN0aW9uRmlsZUlkOiBzdHJpbmc7IHByb2plY3RJZDogc3RyaW5nOyB0ZXh0RmlsZUtleTogc3RyaW5nIH0+ID0+IHtcbiAgY29uc29sZS5sb2coXCJwcm9jZXNzLXF1ZXN0aW9uLWZpbGUgZXZlbnQ6XCIsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgY29uc3QgeyBxdWVzdGlvbkZpbGVJZCwgcHJvamVjdElkLCBqb2JJZCB9ID0gZXZlbnQ7XG5cbiAgaWYgKCFxdWVzdGlvbkZpbGVJZCB8fCAhcHJvamVjdElkIHx8ICFqb2JJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInF1ZXN0aW9uRmlsZUlkLCBwcm9qZWN0SWQsIGpvYklkIGFyZSByZXF1aXJlZFwiKTtcbiAgfVxuXG4gIC8vIDEpIFJ1biBUZXh0cmFjdCBwYWdpbmF0aW9uXG4gIGNvbnN0IHsgdGV4dCwgc3RhdHVzIH0gPSBhd2FpdCBnZXRUZXh0cmFjdFRleHQoam9iSWQpO1xuXG4gIGlmIChzdGF0dXMgIT09IFwiU1VDQ0VFREVEXCIpIHtcbiAgICBhd2FpdCB1cGRhdGVTdGF0dXMocXVlc3Rpb25GaWxlSWQsIHByb2plY3RJZCwgXCJlcnJvclwiKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRleHRyYWN0IGpvYiBmYWlsZWQ6IHN0YXR1cz0ke3N0YXR1c31gKTtcbiAgfVxuXG4gIC8vIDIpIFNhdmUgdGhlIGZ1bGwgZXh0cmFjdGVkIHRleHQgdG8gUzNcbiAgY29uc3QgdGV4dEZpbGVLZXkgPSBgJHtqb2JJZH0vJHtwcm9qZWN0SWR9LyR7cXVlc3Rpb25GaWxlSWR9LnR4dGA7XG5cbiAgYXdhaXQgczMuc2VuZChcbiAgICBuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICBCdWNrZXQ6IEJVQ0tFVCxcbiAgICAgIEtleTogdGV4dEZpbGVLZXksXG4gICAgICBCb2R5OiB0ZXh0LFxuICAgICAgQ29udGVudFR5cGU6IFwidGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOFwiXG4gICAgfSlcbiAgKTtcblxuICAvLyAzKSBVcGRhdGUgcXVlc3Rpb25fZmlsZSByZWNvcmRcbiAgYXdhaXQgdXBkYXRlU3RhdHVzKHF1ZXN0aW9uRmlsZUlkLCBwcm9qZWN0SWQsIFwidGV4dF9yZWFkeVwiLCB0ZXh0RmlsZUtleSk7XG5cbiAgcmV0dXJuIHsgcXVlc3Rpb25GaWxlSWQsIHByb2plY3RJZCwgdGV4dEZpbGVLZXkgfTtcbn07XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBUZXh0cmFjdCBQYWdpbmF0aW9uIEhlbHBlclxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmFzeW5jIGZ1bmN0aW9uIGdldFRleHRyYWN0VGV4dChqb2JJZDogc3RyaW5nKTogUHJvbWlzZTxUZXh0cmFjdFJlc3VsdD4ge1xuICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuICBsZXQgam9iU3RhdHVzOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgZG8ge1xuICAgIGNvbnN0IHJlczogYW55ID0gYXdhaXQgdGV4dHJhY3Quc2VuZChcbiAgICAgIG5ldyBHZXREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kKHtcbiAgICAgICAgSm9iSWQ6IGpvYklkLFxuICAgICAgICBOZXh0VG9rZW46IG5leHRUb2tlblxuICAgICAgfSlcbiAgICApO1xuXG4gICAgam9iU3RhdHVzID0gcmVzLkpvYlN0YXR1cztcbiAgICBpZiAoIWpvYlN0YXR1cykgcmV0dXJuIHsgdGV4dDogXCJcIiwgc3RhdHVzOiBcIlVOS05PV05cIiB9O1xuICAgIGlmIChqb2JTdGF0dXMgIT09IFwiU1VDQ0VFREVEXCIpXG4gICAgICByZXR1cm4geyB0ZXh0OiBcIlwiLCBzdGF0dXM6IGpvYlN0YXR1cyB9O1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVzLkJsb2NrcykpIHtcbiAgICAgIGZvciAoY29uc3QgYmxvY2sgb2YgcmVzLkJsb2Nrcykge1xuICAgICAgICBpZiAoYmxvY2suQmxvY2tUeXBlID09PSBcIkxJTkVcIiAmJiBibG9jay5UZXh0KSB7XG4gICAgICAgICAgbGluZXMucHVzaChibG9jay5UZXh0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIG5leHRUb2tlbiA9IHJlcy5OZXh0VG9rZW47XG4gIH0gd2hpbGUgKG5leHRUb2tlbik7XG5cbiAgcmV0dXJuIHtcbiAgICB0ZXh0OiBsaW5lcy5qb2luKFwiXFxuXCIpLFxuICAgIHN0YXR1czogam9iU3RhdHVzXG4gIH07XG59XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBEeW5hbW9EQiBVcGRhdGUgSGVscGVyXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlU3RhdHVzKFxuICBxdWVzdGlvbkZpbGVJZDogc3RyaW5nLFxuICBwcm9qZWN0SWQ6IHN0cmluZyxcbiAgc3RhdHVzOiBcInByb2Nlc3NpbmdcIiB8IFwidGV4dF9yZWFkeVwiIHwgXCJxdWVzdGlvbnNfZXh0cmFjdGVkXCIgfCBcImVycm9yXCIsXG4gIHRleHRGaWxlS2V5Pzogc3RyaW5nXG4pIHtcbiAgY29uc3Qgc2sgPSBgJHtwcm9qZWN0SWR9IyR7cXVlc3Rpb25GaWxlSWR9YDtcblxuICBjb25zdCBmaWVsZHM6IHN0cmluZ1tdID0gW1wiI3N0YXR1cyA9IDpzdGF0dXNcIiwgXCIjdXBkYXRlZEF0ID0gOm5vd1wiXTtcbiAgY29uc3QgbmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgXCIjc3RhdHVzXCI6IFwic3RhdHVzXCIsXG4gICAgXCIjdXBkYXRlZEF0XCI6IFwidXBkYXRlZEF0XCJcbiAgfTtcbiAgY29uc3QgdmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgIFwiOnN0YXR1c1wiOiBzdGF0dXMsXG4gICAgXCI6bm93XCI6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICB9O1xuXG4gIGlmICh0ZXh0RmlsZUtleSkge1xuICAgIGZpZWxkcy5wdXNoKFwiI3RleHRGaWxlS2V5ID0gOmtleVwiKTtcbiAgICBuYW1lc1tcIiN0ZXh0RmlsZUtleVwiXSA9IFwidGV4dEZpbGVLZXlcIjtcbiAgICB2YWx1ZXNbXCI6a2V5XCJdID0gdGV4dEZpbGVLZXk7XG4gIH1cblxuICBhd2FpdCBkZGIuc2VuZChcbiAgICBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIFtQS19OQU1FXTogUVVFU1RJT05fRklMRV9QSyxcbiAgICAgICAgW1NLX05BTUVdOiBza1xuICAgICAgfSxcbiAgICAgIFVwZGF0ZUV4cHJlc3Npb246IFwiU0VUIFwiICsgZmllbGRzLmpvaW4oXCIsIFwiKSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogbmFtZXMsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB2YWx1ZXNcbiAgICB9KVxuICApO1xufVxuIl19