"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_textract_1 = require("@aws-sdk/client-textract");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const common_1 = require("../constants/common");
const question_file_1 = require("../constants/question-file");
const textract = new client_textract_1.TextractClient({});
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({}), {
    marshallOptions: { removeUndefinedValues: true }
});
const TABLE = process.env.DB_TABLE_NAME;
const BUCKET = process.env.DOCUMENTS_BUCKET_NAME;
const TEXTRACT_ROLE_ARN = process.env.TEXTRACT_ROLE_ARN;
const TEXTRACT_SNS_TOPIC_ARN = process.env.TEXTRACT_SNS_TOPIC_ARN;
const handler = async (event) => {
    const { questionFileId, projectId, taskToken } = event;
    if (!questionFileId || !projectId)
        throw new Error("questionFileId and projectId required");
    const sk = `${projectId}#${questionFileId}`;
    // load fileKey
    const res = await ddb.send(new lib_dynamodb_1.GetCommand({
        TableName: TABLE,
        Key: {
            [common_1.PK_NAME]: question_file_1.QUESTION_FILE_PK,
            [common_1.SK_NAME]: sk
        }
    }));
    const item = res.Item;
    if (!item)
        throw new Error("question_file not found");
    const fileKey = item.fileKey;
    if (!fileKey)
        throw new Error("fileKey missing");
    const startRes = await textract.send(new client_textract_1.StartDocumentTextDetectionCommand({
        DocumentLocation: {
            S3Object: { Bucket: BUCKET, Name: fileKey }
        },
        NotificationChannel: {
            RoleArn: TEXTRACT_ROLE_ARN,
            SNSTopicArn: TEXTRACT_SNS_TOPIC_ARN
        },
        JobTag: questionFileId
    }));
    const jobId = startRes.JobId;
    await ddb.send(new lib_dynamodb_1.UpdateCommand({
        TableName: TABLE,
        Key: {
            [common_1.PK_NAME]: question_file_1.QUESTION_FILE_PK,
            [common_1.SK_NAME]: sk
        },
        UpdateExpression: "SET #jobId = :j, #status = :s, #taskToken = :taskToken",
        ExpressionAttributeNames: {
            "#jobId": "jobId",
            "#status": "status",
            "#taskToken": "taskToken",
        },
        ExpressionAttributeValues: {
            ":j": jobId,
            ":s": "textract_running",
            ":taskToken": taskToken,
        }
    }));
    return { jobId };
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtcXVlc3Rpb24tdGV4dHJhY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1xdWVzdGlvbi10ZXh0cmFjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBNkY7QUFDN0YsOERBQTBEO0FBQzFELHdEQUEwRjtBQUMxRixnREFBdUQ7QUFDdkQsOERBQThEO0FBRTlELE1BQU0sUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QyxNQUFNLEdBQUcsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0lBQzlELGVBQWUsRUFBRSxFQUFFLHFCQUFxQixFQUFFLElBQUksRUFBRTtDQUNqRCxDQUFDLENBQUM7QUFFSCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUN6QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFzQixDQUFDO0FBQ2xELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0IsQ0FBQztBQUN6RCxNQUFNLHNCQUFzQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXVCLENBQUM7QUFVNUQsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQWlCLEVBQUUsRUFBRTtJQUNqRCxNQUFNLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFFdkQsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLFNBQVM7UUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0lBRTNELE1BQU0sRUFBRSxHQUFHLEdBQUcsU0FBUyxJQUFJLGNBQWMsRUFBRSxDQUFDO0lBRTVDLGVBQWU7SUFDZixNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQ3hCLElBQUkseUJBQVUsQ0FBQztRQUNiLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLEdBQUcsRUFBRTtZQUNILENBQUMsZ0JBQU8sQ0FBQyxFQUFFLGdDQUFnQjtZQUMzQixDQUFDLGdCQUFPLENBQUMsRUFBRSxFQUFFO1NBQ2Q7S0FDRixDQUFDLENBQ0gsQ0FBQztJQUVGLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDdEIsSUFBSSxDQUFDLElBQUk7UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFFdEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUM3QixJQUFJLENBQUMsT0FBTztRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUVqRCxNQUFNLFFBQVEsR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQ2xDLElBQUksbURBQWlDLENBQUM7UUFDcEMsZ0JBQWdCLEVBQUU7WUFDaEIsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO1NBQzVDO1FBQ0QsbUJBQW1CLEVBQUU7WUFDbkIsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixXQUFXLEVBQUUsc0JBQXNCO1NBQ3BDO1FBQ0QsTUFBTSxFQUFFLGNBQWM7S0FDdkIsQ0FBQyxDQUNILENBQUM7SUFFRixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBTSxDQUFDO0lBQzlCLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FDWixJQUFJLDRCQUFhLENBQUM7UUFDaEIsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsQ0FBQyxnQkFBTyxDQUFDLEVBQUUsZ0NBQWdCO1lBQzNCLENBQUMsZ0JBQU8sQ0FBQyxFQUFFLEVBQUU7U0FDZDtRQUNELGdCQUFnQixFQUFFLHdEQUF3RDtRQUMxRSx3QkFBd0IsRUFBRTtZQUN4QixRQUFRLEVBQUUsT0FBTztZQUNqQixTQUFTLEVBQUUsUUFBUTtZQUNuQixZQUFZLEVBQUUsV0FBVztTQUMxQjtRQUNELHlCQUF5QixFQUFFO1lBQ3pCLElBQUksRUFBRSxLQUFLO1lBQ1gsSUFBSSxFQUFFLGtCQUFrQjtZQUN4QixZQUFZLEVBQUUsU0FBUztTQUN4QjtLQUNGLENBQUMsQ0FDSCxDQUFDO0lBRUYsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ25CLENBQUMsQ0FBQztBQTdEVyxRQUFBLE9BQU8sV0E2RGxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RhcnREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kLCBUZXh0cmFjdENsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10ZXh0cmFjdCc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBHZXRDb21tYW5kLCBVcGRhdGVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFBLX05BTUUsIFNLX05BTUUgfSBmcm9tICcuLi9jb25zdGFudHMvY29tbW9uJztcbmltcG9ydCB7IFFVRVNUSU9OX0ZJTEVfUEsgfSBmcm9tICcuLi9jb25zdGFudHMvcXVlc3Rpb24tZmlsZSc7XG5cbmNvbnN0IHRleHRyYWN0ID0gbmV3IFRleHRyYWN0Q2xpZW50KHt9KTtcbmNvbnN0IGRkYiA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShuZXcgRHluYW1vREJDbGllbnQoe30pLCB7XG4gIG1hcnNoYWxsT3B0aW9uczogeyByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUgfVxufSk7XG5cbmNvbnN0IFRBQkxFID0gcHJvY2Vzcy5lbnYuREJfVEFCTEVfTkFNRSE7XG5jb25zdCBCVUNLRVQgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUX05BTUUhO1xuY29uc3QgVEVYVFJBQ1RfUk9MRV9BUk4gPSBwcm9jZXNzLmVudi5URVhUUkFDVF9ST0xFX0FSTiE7XG5jb25zdCBURVhUUkFDVF9TTlNfVE9QSUNfQVJOID0gcHJvY2Vzcy5lbnYuVEVYVFJBQ1RfU05TX1RPUElDX0FSTiE7XG5cblxuXG5pbnRlcmZhY2UgU3RhcnRFdmVudCB7XG4gIHF1ZXN0aW9uRmlsZUlkOiBzdHJpbmc7XG4gIHByb2plY3RJZDogc3RyaW5nO1xuICB0YXNrVG9rZW4/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBTdGFydEV2ZW50KSA9PiB7XG4gIGNvbnN0IHsgcXVlc3Rpb25GaWxlSWQsIHByb2plY3RJZCwgdGFza1Rva2VuIH0gPSBldmVudDtcblxuICBpZiAoIXF1ZXN0aW9uRmlsZUlkIHx8ICFwcm9qZWN0SWQpXG4gICAgdGhyb3cgbmV3IEVycm9yKFwicXVlc3Rpb25GaWxlSWQgYW5kIHByb2plY3RJZCByZXF1aXJlZFwiKTtcblxuICBjb25zdCBzayA9IGAke3Byb2plY3RJZH0jJHtxdWVzdGlvbkZpbGVJZH1gO1xuXG4gIC8vIGxvYWQgZmlsZUtleVxuICBjb25zdCByZXMgPSBhd2FpdCBkZGIuc2VuZChcbiAgICBuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFLFxuICAgICAgS2V5OiB7XG4gICAgICAgIFtQS19OQU1FXTogUVVFU1RJT05fRklMRV9QSyxcbiAgICAgICAgW1NLX05BTUVdOiBza1xuICAgICAgfVxuICAgIH0pXG4gICk7XG5cbiAgY29uc3QgaXRlbSA9IHJlcy5JdGVtO1xuICBpZiAoIWl0ZW0pIHRocm93IG5ldyBFcnJvcihcInF1ZXN0aW9uX2ZpbGUgbm90IGZvdW5kXCIpO1xuXG4gIGNvbnN0IGZpbGVLZXkgPSBpdGVtLmZpbGVLZXk7XG4gIGlmICghZmlsZUtleSkgdGhyb3cgbmV3IEVycm9yKFwiZmlsZUtleSBtaXNzaW5nXCIpO1xuXG4gIGNvbnN0IHN0YXJ0UmVzID0gYXdhaXQgdGV4dHJhY3Quc2VuZChcbiAgICBuZXcgU3RhcnREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kKHtcbiAgICAgIERvY3VtZW50TG9jYXRpb246IHtcbiAgICAgICAgUzNPYmplY3Q6IHsgQnVja2V0OiBCVUNLRVQsIE5hbWU6IGZpbGVLZXkgfVxuICAgICAgfSxcbiAgICAgIE5vdGlmaWNhdGlvbkNoYW5uZWw6IHtcbiAgICAgICAgUm9sZUFybjogVEVYVFJBQ1RfUk9MRV9BUk4sXG4gICAgICAgIFNOU1RvcGljQXJuOiBURVhUUkFDVF9TTlNfVE9QSUNfQVJOXG4gICAgICB9LFxuICAgICAgSm9iVGFnOiBxdWVzdGlvbkZpbGVJZFxuICAgIH0pXG4gICk7XG5cbiAgY29uc3Qgam9iSWQgPSBzdGFydFJlcy5Kb2JJZCE7XG4gIGF3YWl0IGRkYi5zZW5kKFxuICAgIG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVEFCTEUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgW1BLX05BTUVdOiBRVUVTVElPTl9GSUxFX1BLLFxuICAgICAgICBbU0tfTkFNRV06IHNrXG4gICAgICB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogXCJTRVQgI2pvYklkID0gOmosICNzdGF0dXMgPSA6cywgI3Rhc2tUb2tlbiA9IDp0YXNrVG9rZW5cIixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICBcIiNqb2JJZFwiOiBcImpvYklkXCIsXG4gICAgICAgIFwiI3N0YXR1c1wiOiBcInN0YXR1c1wiLFxuICAgICAgICBcIiN0YXNrVG9rZW5cIjogXCJ0YXNrVG9rZW5cIixcbiAgICAgIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgIFwiOmpcIjogam9iSWQsXG4gICAgICAgIFwiOnNcIjogXCJ0ZXh0cmFjdF9ydW5uaW5nXCIsXG4gICAgICAgIFwiOnRhc2tUb2tlblwiOiB0YXNrVG9rZW4sXG4gICAgICB9XG4gICAgfSlcbiAgKTtcblxuICByZXR1cm4geyBqb2JJZCB9O1xufTtcbiJdfQ==