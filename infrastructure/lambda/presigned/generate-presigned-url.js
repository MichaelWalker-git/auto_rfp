"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3_request_presigner_1 = require("@aws-sdk/s3-request-presigner");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const api_1 = require("../helpers/api");
const uuid_1 = require("uuid");
const common_1 = require("../constants/common");
const file_1 = require("../constants/file");
const BUCKET_NAME = process.env.DOCUMENTS_BUCKET;
const REGION = process.env.AWS_REGION || 'us-east-1';
const URL_EXPIRATION_SECONDS = Number(process.env.PRESIGN_EXPIRES_IN || 900);
const DB_TABLE_NAME = process.env.DB_TABLE_NAME;
if (!BUCKET_NAME) {
    throw new Error('DOCUMENTS_BUCKET environment variable is not set');
}
if (!DB_TABLE_NAME) {
    throw new Error('DB_TABLE_NAME environment variable is not set');
}
const s3Client = new client_s3_1.S3Client({ region: REGION });
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient, {
    marshallOptions: {
        removeUndefinedValues: true,
    },
});
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: 'Request body is required' });
        }
        let body;
        try {
            body = JSON.parse(event.body);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: 'Invalid JSON in request body' });
        }
        const { operation, key, fileName, contentType, prefix } = body;
        if (operation !== 'upload' && operation !== 'download') {
            return (0, api_1.apiResponse)(400, {
                message: "Invalid 'operation'. Must be 'upload' or 'download'.",
            });
        }
        // Normalize prefix to "prefix/" or "".
        const safePrefix = prefix
            ? prefix.replace(/^\/+/, '').replace(/\/+$/, '') + '/'
            : '';
        if (operation === 'upload') {
            // Extra validations for upload
            if (!contentType) {
                return (0, api_1.apiResponse)(400, {
                    message: "For 'upload', 'contentType' is required.",
                });
            }
            const fileId = (0, uuid_1.v4)();
            // If caller passed a key, use it; otherwise generate one based on fileName/uuid
            const objectKey = key ??
                (fileName
                    ? `${safePrefix}${fileId}-${sanitizeFileName(fileName)}`
                    : `${safePrefix}${fileId}`);
            const putObjectCmd = new client_s3_1.PutObjectCommand({
                Bucket: BUCKET_NAME,
                Key: objectKey,
                ContentType: contentType,
            });
            const url = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, putObjectCmd, {
                expiresIn: URL_EXPIRATION_SECONDS,
            });
            // --- Save metadata to DynamoDB ---
            const now = new Date().toISOString();
            const sortKey = `${fileId}`;
            const fileItem = {
                [common_1.PK_NAME]: file_1.FILE_PK,
                [common_1.SK_NAME]: sortKey,
                fileId,
                bucket: BUCKET_NAME,
                key: objectKey,
                fileName: fileName ?? null,
                contentType,
                createdAt: now,
                updatedAt: now,
                // you can add more fields later: uploadedBy, size (once known), etc.
            };
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: DB_TABLE_NAME,
                Item: fileItem,
            }));
            return (0, api_1.apiResponse)(200, {
                operation: 'upload',
                bucket: BUCKET_NAME,
                key: objectKey,
                url,
                method: 'PUT',
                expiresIn: URL_EXPIRATION_SECONDS,
                file: {
                    fileId,
                    sortKey,
                },
            });
        }
        // operation === 'download'
        if (!key) {
            return (0, api_1.apiResponse)(400, {
                message: "For 'download', 'key' is required.",
            });
        }
        const objectKey = key;
        const getObjectCmd = new client_s3_1.GetObjectCommand({
            Bucket: BUCKET_NAME,
            Key: objectKey,
        });
        const url = await (0, s3_request_presigner_1.getSignedUrl)(s3Client, getObjectCmd, {
            expiresIn: URL_EXPIRATION_SECONDS,
        });
        return (0, api_1.apiResponse)(200, {
            operation: 'download',
            bucket: BUCKET_NAME,
            key: objectKey,
            url,
            method: 'GET',
            expiresIn: URL_EXPIRATION_SECONDS,
        });
    }
    catch (err) {
        console.error('Error generating presigned URL:', err);
        return (0, api_1.apiResponse)(500, {
            message: 'Failed to generate presigned URL',
            error: err instanceof Error ? err.message : 'Unknown error',
        });
    }
};
exports.handler = handler;
function sanitizeFileName(name) {
    // Simple filename sanitization: strip path separators
    return name.replace(/[\/\\]/g, '_');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUtcHJlc2lnbmVkLXVybC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdlbmVyYXRlLXByZXNpZ25lZC11cmwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEsa0RBSTRCO0FBQzVCLHdFQUE2RDtBQUM3RCw4REFBMEQ7QUFDMUQsd0RBRytCO0FBQy9CLHdDQUE2QztBQUM3QywrQkFBb0M7QUFDcEMsZ0RBQXVEO0FBQ3ZELDRDQUE0QztBQUU1QyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0FBQ2pELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVcsQ0FBQztBQUNyRCxNQUFNLHNCQUFzQixHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBRTdFLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBRWhELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7QUFDdEUsQ0FBQztBQUVELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQ2xELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO0lBQ3ZELGVBQWUsRUFBRTtRQUNmLHFCQUFxQixFQUFFLElBQUk7S0FDNUI7Q0FDRixDQUFDLENBQUM7QUFZSSxNQUFNLE9BQU8sR0FB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QUFHLEVBQUU7WUFDdEIsT0FBTyxFQUFFLGtDQUFrQztZQUMzQyxLQUFLLEVBQUUsR0FBRyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTtTQUM1RCxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBN0hXLFFBQUEsT0FBTyxXQTZIbEI7QUFFRixTQUFTLGdCQUFnQixDQUFDLElBQVk7SUFDcEMsc0RBQXNEO0lBQ3RELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDdEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4gIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7XG4gIFMzQ2xpZW50LFxuICBQdXRPYmplY3RDb21tYW5kLFxuICBHZXRPYmplY3RDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgZ2V0U2lnbmVkVXJsIH0gZnJvbSAnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgUHV0Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IGFwaVJlc3BvbnNlIH0gZnJvbSAnLi4vaGVscGVycy9hcGknO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBQS19OQU1FLCBTS19OQU1FIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbW1vbic7XG5pbXBvcnQgeyBGSUxFX1BLIH0gZnJvbSAnLi4vY29uc3RhbnRzL2ZpbGUnO1xuXG5jb25zdCBCVUNLRVRfTkFNRSA9IHByb2Nlc3MuZW52LkRPQ1VNRU5UU19CVUNLRVQ7XG5jb25zdCBSRUdJT04gPSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnO1xuY29uc3QgVVJMX0VYUElSQVRJT05fU0VDT05EUyA9IE51bWJlcihwcm9jZXNzLmVudi5QUkVTSUdOX0VYUElSRVNfSU4gfHwgOTAwKTtcblxuY29uc3QgREJfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkRCX1RBQkxFX05BTUU7XG5cbmlmICghQlVDS0VUX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdET0NVTUVOVFNfQlVDS0VUIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIG5vdCBzZXQnKTtcbn1cblxuaWYgKCFEQl9UQUJMRV9OQU1FKSB7XG4gIHRocm93IG5ldyBFcnJvcignREJfVEFCTEVfTkFNRSBlbnZpcm9ubWVudCB2YXJpYWJsZSBpcyBub3Qgc2V0Jyk7XG59XG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gIH0sXG59KTtcblxudHlwZSBPcGVyYXRpb24gPSAndXBsb2FkJyB8ICdkb3dubG9hZCc7XG5cbmludGVyZmFjZSBQcmVzaWduUmVxdWVzdEJvZHkge1xuICBvcGVyYXRpb24/OiBPcGVyYXRpb247ICAgICAgLy8gXCJ1cGxvYWRcIiB8IFwiZG93bmxvYWRcIlxuICBrZXk/OiBzdHJpbmc7ICAgICAgICAgICAgICAgLy8gZXhpc3Rpbmcga2V5IGZvciBkb3dubG9hZCBPUiBjdXN0b20ga2V5IGZvciB1cGxvYWRcbiAgZmlsZU5hbWU/OiBzdHJpbmc7ICAgICAgICAgIC8vIG9wdGlvbmFsLCBmb3IgdXBsb2FkIOKAkyB1c2VkIHRvIGJ1aWxkIGtleVxuICBjb250ZW50VHlwZT86IHN0cmluZzsgICAgICAgLy8gcmVxdWlyZWQgZm9yIHVwbG9hZFxuICBwcmVmaXg/OiBzdHJpbmc7ICAgICAgICAgICAgLy8gb3B0aW9uYWwgZm9sZGVyLCBlLmcuIFwib3JnLTEyMy9cIlxufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnIH0pO1xuICAgIH1cblxuICAgIGxldCBib2R5OiBQcmVzaWduUmVxdWVzdEJvZHk7XG4gICAgdHJ5IHtcbiAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwgeyBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGluIHJlcXVlc3QgYm9keScgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBvcGVyYXRpb24sIGtleSwgZmlsZU5hbWUsIGNvbnRlbnRUeXBlLCBwcmVmaXggfSA9IGJvZHk7XG5cbiAgICBpZiAob3BlcmF0aW9uICE9PSAndXBsb2FkJyAmJiBvcGVyYXRpb24gIT09ICdkb3dubG9hZCcpIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHtcbiAgICAgICAgbWVzc2FnZTogXCJJbnZhbGlkICdvcGVyYXRpb24nLiBNdXN0IGJlICd1cGxvYWQnIG9yICdkb3dubG9hZCcuXCIsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBOb3JtYWxpemUgcHJlZml4IHRvIFwicHJlZml4L1wiIG9yIFwiXCIuXG4gICAgY29uc3Qgc2FmZVByZWZpeCA9IHByZWZpeFxuICAgICAgPyBwcmVmaXgucmVwbGFjZSgvXlxcLysvLCAnJykucmVwbGFjZSgvXFwvKyQvLCAnJykgKyAnLydcbiAgICAgIDogJyc7XG5cbiAgICBpZiAob3BlcmF0aW9uID09PSAndXBsb2FkJykge1xuICAgICAgLy8gRXh0cmEgdmFsaWRhdGlvbnMgZm9yIHVwbG9hZFxuICAgICAgaWYgKCFjb250ZW50VHlwZSkge1xuICAgICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgICAgbWVzc2FnZTogXCJGb3IgJ3VwbG9hZCcsICdjb250ZW50VHlwZScgaXMgcmVxdWlyZWQuXCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgZmlsZUlkID0gdXVpZHY0KCk7XG5cbiAgICAgIC8vIElmIGNhbGxlciBwYXNzZWQgYSBrZXksIHVzZSBpdDsgb3RoZXJ3aXNlIGdlbmVyYXRlIG9uZSBiYXNlZCBvbiBmaWxlTmFtZS91dWlkXG4gICAgICBjb25zdCBvYmplY3RLZXkgPVxuICAgICAgICBrZXkgPz9cbiAgICAgICAgKGZpbGVOYW1lXG4gICAgICAgICAgPyBgJHtzYWZlUHJlZml4fSR7ZmlsZUlkfS0ke3Nhbml0aXplRmlsZU5hbWUoZmlsZU5hbWUpfWBcbiAgICAgICAgICA6IGAke3NhZmVQcmVmaXh9JHtmaWxlSWR9YCk7XG5cbiAgICAgIGNvbnN0IHB1dE9iamVjdENtZCA9IG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBCVUNLRVRfTkFNRSxcbiAgICAgICAgS2V5OiBvYmplY3RLZXksXG4gICAgICAgIENvbnRlbnRUeXBlOiBjb250ZW50VHlwZSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB1cmwgPSBhd2FpdCBnZXRTaWduZWRVcmwoczNDbGllbnQgYXMgYW55LCBwdXRPYmplY3RDbWQsIHtcbiAgICAgICAgZXhwaXJlc0luOiBVUkxfRVhQSVJBVElPTl9TRUNPTkRTLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIC0tLSBTYXZlIG1ldGFkYXRhIHRvIER5bmFtb0RCIC0tLVxuICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgY29uc3Qgc29ydEtleSA9IGAke2ZpbGVJZH1gO1xuXG4gICAgICBjb25zdCBmaWxlSXRlbSA9IHtcbiAgICAgICAgW1BLX05BTUVdOiBGSUxFX1BLLFxuICAgICAgICBbU0tfTkFNRV06IHNvcnRLZXksXG4gICAgICAgIGZpbGVJZCxcbiAgICAgICAgYnVja2V0OiBCVUNLRVRfTkFNRSxcbiAgICAgICAga2V5OiBvYmplY3RLZXksXG4gICAgICAgIGZpbGVOYW1lOiBmaWxlTmFtZSA/PyBudWxsLFxuICAgICAgICBjb250ZW50VHlwZSxcbiAgICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICAgIHVwZGF0ZWRBdDogbm93LFxuICAgICAgICAvLyB5b3UgY2FuIGFkZCBtb3JlIGZpZWxkcyBsYXRlcjogdXBsb2FkZWRCeSwgc2l6ZSAob25jZSBrbm93biksIGV0Yy5cbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgICAgVGFibGVOYW1lOiBEQl9UQUJMRV9OQU1FLFxuICAgICAgICAgIEl0ZW06IGZpbGVJdGVtLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHtcbiAgICAgICAgb3BlcmF0aW9uOiAndXBsb2FkJyxcbiAgICAgICAgYnVja2V0OiBCVUNLRVRfTkFNRSxcbiAgICAgICAga2V5OiBvYmplY3RLZXksXG4gICAgICAgIHVybCxcbiAgICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgICAgZXhwaXJlc0luOiBVUkxfRVhQSVJBVElPTl9TRUNPTkRTLFxuICAgICAgICBmaWxlOiB7XG4gICAgICAgICAgZmlsZUlkLFxuICAgICAgICAgIHNvcnRLZXksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBvcGVyYXRpb24gPT09ICdkb3dubG9hZCdcbiAgICBpZiAoIWtleSkge1xuICAgICAgcmV0dXJuIGFwaVJlc3BvbnNlKDQwMCwge1xuICAgICAgICBtZXNzYWdlOiBcIkZvciAnZG93bmxvYWQnLCAna2V5JyBpcyByZXF1aXJlZC5cIixcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IG9iamVjdEtleSA9IGtleTtcblxuICAgIGNvbnN0IGdldE9iamVjdENtZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogQlVDS0VUX05BTUUsXG4gICAgICBLZXk6IG9iamVjdEtleSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHVybCA9IGF3YWl0IGdldFNpZ25lZFVybChzM0NsaWVudCBhcyBhbnksIGdldE9iamVjdENtZCwge1xuICAgICAgZXhwaXJlc0luOiBVUkxfRVhQSVJBVElPTl9TRUNPTkRTLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDIwMCwge1xuICAgICAgb3BlcmF0aW9uOiAnZG93bmxvYWQnLFxuICAgICAgYnVja2V0OiBCVUNLRVRfTkFNRSxcbiAgICAgIGtleTogb2JqZWN0S2V5LFxuICAgICAgdXJsLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGV4cGlyZXNJbjogVVJMX0VYUElSQVRJT05fU0VDT05EUyxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyBwcmVzaWduZWQgVVJMOicsIGVycik7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBnZW5lcmF0ZSBwcmVzaWduZWQgVVJMJyxcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH0pO1xuICB9XG59O1xuXG5mdW5jdGlvbiBzYW5pdGl6ZUZpbGVOYW1lKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gIC8vIFNpbXBsZSBmaWxlbmFtZSBzYW5pdGl6YXRpb246IHN0cmlwIHBhdGggc2VwYXJhdG9yc1xuICByZXR1cm4gbmFtZS5yZXBsYWNlKC9bXFwvXFxcXF0vZywgJ18nKTtcbn1cbiJdfQ==