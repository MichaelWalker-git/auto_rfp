"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const api_1 = require("../helpers/api");
const REGION = process.env.AWS_REGION || "us-east-1";
const DEFAULT_BUCKET = process.env.DOCUMENTS_BUCKET;
if (!DEFAULT_BUCKET) {
    throw new Error("DOCUMENTS_BUCKET environment variable is not set");
}
const s3 = new client_s3_1.S3Client({ region: REGION });
const handler = async (event) => {
    try {
        if (!event.body) {
            return (0, api_1.apiResponse)(400, { message: "Request body is required" });
        }
        // Parse JSON body
        const raw = event.isBase64Encoded
            ? Buffer.from(event.body, "base64").toString("utf8")
            : event.body;
        let body;
        try {
            body = JSON.parse(raw);
        }
        catch {
            return (0, api_1.apiResponse)(400, { message: "Invalid JSON in request body" });
        }
        const { s3Key, s3Bucket } = body;
        if (!s3Key) {
            return (0, api_1.apiResponse)(400, {
                message: "'s3Key' is required in the request body",
            });
        }
        const bucketToUse = s3Bucket || DEFAULT_BUCKET;
        // 1) Load text file from S3
        const text = await getTextFromS3(bucketToUse, s3Key);
        if (!text.trim()) {
            return (0, api_1.apiResponse)(404, {
                message: "Text file is empty or unreadable",
                s3Key,
                bucket: bucketToUse,
            });
        }
        // 2) Return content
        return (0, api_1.apiResponse)(200, {
            bucket: bucketToUse,
            key: s3Key,
            length: text.length,
            content: text,
        });
    }
    catch (err) {
        console.error("Error in get-text Lambda:", err);
        return (0, api_1.apiResponse)(500, {
            message: "Failed to read text from S3",
            error: err instanceof Error ? err.message : "Unknown error",
        });
    }
};
exports.handler = handler;
// ðŸ”§ Helper: read entire S3 object into a UTF-8 string
async function getTextFromS3(bucket, key) {
    const res = await s3.send(new client_s3_1.GetObjectCommand({
        Bucket: bucket,
        Key: key,
    }));
    if (!res.Body) {
        throw new Error("Empty S3 object body");
    }
    const body = res.Body;
    // Modern AWS SDK: Body.transformToString()
    if (typeof body.transformToString === "function") {
        return await body.transformToString("utf8");
    }
    // Older SDK stream fallback
    return await new Promise((resolve, reject) => {
        const chunks = [];
        body.on("data", (chunk) => chunks.push(chunk));
        body.on("error", reject);
        body.on("end", () => resolve(Buffer.concat(chunks).toString("utf8")));
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LXRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZXQtdGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBZ0U7QUFDaEUsd0NBQTZDO0FBRTdDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVcsQ0FBQztBQUNyRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0FBRXBELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7QUFDdEUsQ0FBQztBQUVELE1BQU0sRUFBRSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBT3JDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBNkIsRUFDSyxFQUFFO0lBQ3BDLElBQUksQ0FBQztRQUNILElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsT0FBTyxJQUFBLGlCQUFXLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsa0JBQWtCO1FBQ2xCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxlQUFlO1lBQy9CLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUNwRCxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztRQUVmLElBQUksSUFBd0IsQ0FBQztRQUM3QixJQUFJLENBQUM7WUFDSCxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ1AsT0FBTyxJQUFBLGlCQUFXLEVBQUMs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QUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIsIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBHZXRPYmplY3RDb21tYW5kLCBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBhcGlSZXNwb25zZSB9IGZyb20gJy4uL2hlbHBlcnMvYXBpJztcblxuY29uc3QgUkVHSU9OID0gcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCBcInVzLWVhc3QtMVwiO1xuY29uc3QgREVGQVVMVF9CVUNLRVQgPSBwcm9jZXNzLmVudi5ET0NVTUVOVFNfQlVDS0VUO1xuXG5pZiAoIURFRkFVTFRfQlVDS0VUKSB7XG4gIHRocm93IG5ldyBFcnJvcihcIkRPQ1VNRU5UU19CVUNLRVQgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldFwiKTtcbn1cblxuY29uc3QgczMgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IFJFR0lPTiB9KTtcblxuaW50ZXJmYWNlIEdldFRleHRSZXF1ZXN0Qm9keSB7XG4gIHMzS2V5Pzogc3RyaW5nO1xuICBzM0J1Y2tldD86IHN0cmluZzsgLy8gb3B0aW9uYWwgb3ZlcnJpZGVcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7IG1lc3NhZ2U6IFwiUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkXCIgfSk7XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgSlNPTiBib2R5XG4gICAgY29uc3QgcmF3ID0gZXZlbnQuaXNCYXNlNjRFbmNvZGVkXG4gICAgICA/IEJ1ZmZlci5mcm9tKGV2ZW50LmJvZHksIFwiYmFzZTY0XCIpLnRvU3RyaW5nKFwidXRmOFwiKVxuICAgICAgOiBldmVudC5ib2R5O1xuXG4gICAgbGV0IGJvZHk6IEdldFRleHRSZXF1ZXN0Qm9keTtcbiAgICB0cnkge1xuICAgICAgYm9keSA9IEpTT04ucGFyc2UocmF3KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBhcGlSZXNwb25zZSg0MDAsIHsgbWVzc2FnZTogXCJJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5XCIgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBzM0tleSwgczNCdWNrZXQgfSA9IGJvZHk7XG5cbiAgICBpZiAoIXMzS2V5KSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDAwLCB7XG4gICAgICAgIG1lc3NhZ2U6IFwiJ3MzS2V5JyBpcyByZXF1aXJlZCBpbiB0aGUgcmVxdWVzdCBib2R5XCIsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBidWNrZXRUb1VzZSA9IHMzQnVja2V0IHx8IERFRkFVTFRfQlVDS0VUO1xuXG4gICAgLy8gMSkgTG9hZCB0ZXh0IGZpbGUgZnJvbSBTM1xuICAgIGNvbnN0IHRleHQgPSBhd2FpdCBnZXRUZXh0RnJvbVMzKGJ1Y2tldFRvVXNlLCBzM0tleSk7XG5cbiAgICBpZiAoIXRleHQudHJpbSgpKSB7XG4gICAgICByZXR1cm4gYXBpUmVzcG9uc2UoNDA0LCB7XG4gICAgICAgIG1lc3NhZ2U6IFwiVGV4dCBmaWxlIGlzIGVtcHR5IG9yIHVucmVhZGFibGVcIixcbiAgICAgICAgczNLZXksXG4gICAgICAgIGJ1Y2tldDogYnVja2V0VG9Vc2UsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyAyKSBSZXR1cm4gY29udGVudFxuICAgIHJldHVybiBhcGlSZXNwb25zZSgyMDAsIHtcbiAgICAgIGJ1Y2tldDogYnVja2V0VG9Vc2UsXG4gICAgICBrZXk6IHMzS2V5LFxuICAgICAgbGVuZ3RoOiB0ZXh0Lmxlbmd0aCxcbiAgICAgIGNvbnRlbnQ6IHRleHQsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBpbiBnZXQtdGV4dCBMYW1iZGE6XCIsIGVycik7XG4gICAgcmV0dXJuIGFwaVJlc3BvbnNlKDUwMCwge1xuICAgICAgbWVzc2FnZTogXCJGYWlsZWQgdG8gcmVhZCB0ZXh0IGZyb20gUzNcIixcbiAgICAgIGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCIsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIPCflKcgSGVscGVyOiByZWFkIGVudGlyZSBTMyBvYmplY3QgaW50byBhIFVURi04IHN0cmluZ1xuYXN5bmMgZnVuY3Rpb24gZ2V0VGV4dEZyb21TMyhidWNrZXQ6IHN0cmluZywga2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCByZXMgPSBhd2FpdCBzMy5zZW5kKFxuICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgS2V5OiBrZXksXG4gICAgfSlcbiAgKTtcblxuICBpZiAoIXJlcy5Cb2R5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRW1wdHkgUzMgb2JqZWN0IGJvZHlcIik7XG4gIH1cblxuICBjb25zdCBib2R5OiBhbnkgPSByZXMuQm9keTtcblxuICAvLyBNb2Rlcm4gQVdTIFNESzogQm9keS50cmFuc2Zvcm1Ub1N0cmluZygpXG4gIGlmICh0eXBlb2YgYm9keS50cmFuc2Zvcm1Ub1N0cmluZyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgcmV0dXJuIGF3YWl0IGJvZHkudHJhbnNmb3JtVG9TdHJpbmcoXCJ1dGY4XCIpO1xuICB9XG5cbiAgLy8gT2xkZXIgU0RLIHN0cmVhbSBmYWxsYmFja1xuICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY2h1bmtzOiBCdWZmZXJbXSA9IFtdO1xuICAgIGJvZHkub24oXCJkYXRhXCIsIChjaHVuazogQnVmZmVyKSA9PiBjaHVua3MucHVzaChjaHVuaykpO1xuICAgIGJvZHkub24oXCJlcnJvclwiLCByZWplY3QpO1xuICAgIGJvZHkub24oXCJlbmRcIiwgKCkgPT4gcmVzb2x2ZShCdWZmZXIuY29uY2F0KGNodW5rcykudG9TdHJpbmcoXCJ1dGY4XCIpKSk7XG4gIH0pO1xufVxuIl19